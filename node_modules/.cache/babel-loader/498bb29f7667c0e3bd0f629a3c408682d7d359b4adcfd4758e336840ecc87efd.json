{"ast":null,"code":"import React,{useLayoutEffect,useRef,useEffect}from\"react\";import\"./Popover.scss\";import{unstable_batchedUpdates}from\"react-dom\";import{queryFocusableElements}from\"../utils\";import{KEYS}from\"../keys\";import{jsx as _jsx}from\"react/jsx-runtime\";export var Popover=function Popover(_ref){var children=_ref.children,left=_ref.left,top=_ref.top,onCloseRequest=_ref.onCloseRequest,_ref$fitInViewport=_ref.fitInViewport,fitInViewport=_ref$fitInViewport===void 0?false:_ref$fitInViewport,_ref$offsetLeft=_ref.offsetLeft,offsetLeft=_ref$offsetLeft===void 0?0:_ref$offsetLeft,_ref$offsetTop=_ref.offsetTop,offsetTop=_ref$offsetTop===void 0?0:_ref$offsetTop,_ref$viewportWidth=_ref.viewportWidth,viewportWidth=_ref$viewportWidth===void 0?window.innerWidth:_ref$viewportWidth,_ref$viewportHeight=_ref.viewportHeight,viewportHeight=_ref$viewportHeight===void 0?window.innerHeight:_ref$viewportHeight;var popoverRef=useRef(null);useEffect(function(){var container=popoverRef.current;if(!container){return;}// focus popover only if the caller didn't focus on something else nested\n// within the popover, which should take precedence. Fixes cases\n// like color picker listening to keydown events on containers nested\n// in the popover.\nif(!container.contains(document.activeElement)){container.focus();}var handleKeyDown=function handleKeyDown(event){if(event.key===KEYS.TAB){var focusableElements=queryFocusableElements(container);var _document=document,activeElement=_document.activeElement;var currentIndex=focusableElements.findIndex(function(element){return element===activeElement;});if(activeElement===container){if(event.shiftKey){var _focusableElements;(_focusableElements=focusableElements[focusableElements.length-1])===null||_focusableElements===void 0?void 0:_focusableElements.focus();}else{focusableElements[0].focus();}event.preventDefault();event.stopImmediatePropagation();}else if(currentIndex===0&&event.shiftKey){var _focusableElements2;(_focusableElements2=focusableElements[focusableElements.length-1])===null||_focusableElements2===void 0?void 0:_focusableElements2.focus();event.preventDefault();event.stopImmediatePropagation();}else if(currentIndex===focusableElements.length-1&&!event.shiftKey){var _focusableElements$;(_focusableElements$=focusableElements[0])===null||_focusableElements$===void 0?void 0:_focusableElements$.focus();event.preventDefault();event.stopImmediatePropagation();}}};container.addEventListener(\"keydown\",handleKeyDown);return function(){return container.removeEventListener(\"keydown\",handleKeyDown);};},[]);var lastInitializedPosRef=useRef(null);// ensure the popover doesn't overflow the viewport\nuseLayoutEffect(function(){if(fitInViewport&&popoverRef.current&&top!=null&&left!=null){var _lastInitializedPosRe,_lastInitializedPosRe2;var container=popoverRef.current;var _container$getBoundin=container.getBoundingClientRect(),width=_container$getBoundin.width,height=_container$getBoundin.height;// hack for StrictMode so this effect only runs once for\n// the same top/left position, otherwise\n// we'd potentically reposition twice (once for viewport overflow)\n// and once for top/left position afterwards\nif(((_lastInitializedPosRe=lastInitializedPosRef.current)===null||_lastInitializedPosRe===void 0?void 0:_lastInitializedPosRe.top)===top&&((_lastInitializedPosRe2=lastInitializedPosRef.current)===null||_lastInitializedPosRe2===void 0?void 0:_lastInitializedPosRe2.left)===left){return;}lastInitializedPosRef.current={top:top,left:left};if(width>=viewportWidth){container.style.width=\"\".concat(viewportWidth,\"px\");container.style.left=\"0px\";container.style.overflowX=\"scroll\";}else if(left+width-offsetLeft>viewportWidth){container.style.left=\"\".concat(viewportWidth-width-10,\"px\");}else{container.style.left=\"\".concat(left,\"px\");}if(height>=viewportHeight){container.style.height=\"\".concat(viewportHeight-20,\"px\");container.style.top=\"10px\";container.style.overflowY=\"scroll\";}else if(top+height-offsetTop>viewportHeight){container.style.top=\"\".concat(viewportHeight-height,\"px\");}else{container.style.top=\"\".concat(top,\"px\");}}},[top,left,fitInViewport,viewportWidth,viewportHeight,offsetLeft,offsetTop]);useEffect(function(){if(onCloseRequest){var handler=function handler(event){var _popoverRef$current;if(!((_popoverRef$current=popoverRef.current)!==null&&_popoverRef$current!==void 0&&_popoverRef$current.contains(event.target))){unstable_batchedUpdates(function(){return onCloseRequest(event);});}};document.addEventListener(\"pointerdown\",handler,false);return function(){return document.removeEventListener(\"pointerdown\",handler,false);};}},[onCloseRequest]);return/*#__PURE__*/_jsx(\"div\",{className:\"popover\",ref:popoverRef,tabIndex:-1,children:children});};","map":{"version":3,"names":["React","useLayoutEffect","useRef","useEffect","unstable_batchedUpdates","queryFocusableElements","KEYS","jsx","_jsx","Popover","_ref","children","left","top","onCloseRequest","_ref$fitInViewport","fitInViewport","_ref$offsetLeft","offsetLeft","_ref$offsetTop","offsetTop","_ref$viewportWidth","viewportWidth","window","innerWidth","_ref$viewportHeight","viewportHeight","innerHeight","popoverRef","container","current","contains","document","activeElement","focus","handleKeyDown","event","key","TAB","focusableElements","_document","currentIndex","findIndex","element","shiftKey","_focusableElements","length","preventDefault","stopImmediatePropagation","_focusableElements2","_focusableElements$","addEventListener","removeEventListener","lastInitializedPosRef","_lastInitializedPosRe","_lastInitializedPosRe2","_container$getBoundin","getBoundingClientRect","width","height","style","concat","overflowX","overflowY","handler","_popoverRef$current","target","className","ref","tabIndex"],"sources":["D:/project/excalidraw-cn/src/components/Popover.tsx"],"sourcesContent":["import React, { useLayoutEffect, useRef, useEffect } from \"react\";\nimport \"./Popover.scss\";\nimport { unstable_batchedUpdates } from \"react-dom\";\nimport { queryFocusableElements } from \"../utils\";\nimport { KEYS } from \"../keys\";\n\ntype Props = {\n  top?: number;\n  left?: number;\n  children?: React.ReactNode;\n  onCloseRequest?(event: PointerEvent): void;\n  fitInViewport?: boolean;\n  offsetLeft?: number;\n  offsetTop?: number;\n  viewportWidth?: number;\n  viewportHeight?: number;\n};\n\nexport const Popover = ({\n  children,\n  left,\n  top,\n  onCloseRequest,\n  fitInViewport = false,\n  offsetLeft = 0,\n  offsetTop = 0,\n  viewportWidth = window.innerWidth,\n  viewportHeight = window.innerHeight,\n}: Props) => {\n  const popoverRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    const container = popoverRef.current;\n\n    if (!container) {\n      return;\n    }\n\n    // focus popover only if the caller didn't focus on something else nested\n    // within the popover, which should take precedence. Fixes cases\n    // like color picker listening to keydown events on containers nested\n    // in the popover.\n    if (!container.contains(document.activeElement)) {\n      container.focus();\n    }\n\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (event.key === KEYS.TAB) {\n        const focusableElements = queryFocusableElements(container);\n        const { activeElement } = document;\n        const currentIndex = focusableElements.findIndex(\n          (element) => element === activeElement,\n        );\n\n        if (activeElement === container) {\n          if (event.shiftKey) {\n            focusableElements[focusableElements.length - 1]?.focus();\n          } else {\n            focusableElements[0].focus();\n          }\n          event.preventDefault();\n          event.stopImmediatePropagation();\n        } else if (currentIndex === 0 && event.shiftKey) {\n          focusableElements[focusableElements.length - 1]?.focus();\n          event.preventDefault();\n          event.stopImmediatePropagation();\n        } else if (\n          currentIndex === focusableElements.length - 1 &&\n          !event.shiftKey\n        ) {\n          focusableElements[0]?.focus();\n          event.preventDefault();\n          event.stopImmediatePropagation();\n        }\n      }\n    };\n\n    container.addEventListener(\"keydown\", handleKeyDown);\n\n    return () => container.removeEventListener(\"keydown\", handleKeyDown);\n  }, []);\n\n  const lastInitializedPosRef = useRef<{ top: number; left: number } | null>(\n    null,\n  );\n\n  // ensure the popover doesn't overflow the viewport\n  useLayoutEffect(() => {\n    if (fitInViewport && popoverRef.current && top != null && left != null) {\n      const container = popoverRef.current;\n      const { width, height } = container.getBoundingClientRect();\n\n      // hack for StrictMode so this effect only runs once for\n      // the same top/left position, otherwise\n      // we'd potentically reposition twice (once for viewport overflow)\n      // and once for top/left position afterwards\n      if (\n        lastInitializedPosRef.current?.top === top &&\n        lastInitializedPosRef.current?.left === left\n      ) {\n        return;\n      }\n      lastInitializedPosRef.current = { top, left };\n\n      if (width >= viewportWidth) {\n        container.style.width = `${viewportWidth}px`;\n        container.style.left = \"0px\";\n        container.style.overflowX = \"scroll\";\n      } else if (left + width - offsetLeft > viewportWidth) {\n        container.style.left = `${viewportWidth - width - 10}px`;\n      } else {\n        container.style.left = `${left}px`;\n      }\n\n      if (height >= viewportHeight) {\n        container.style.height = `${viewportHeight - 20}px`;\n        container.style.top = \"10px\";\n        container.style.overflowY = \"scroll\";\n      } else if (top + height - offsetTop > viewportHeight) {\n        container.style.top = `${viewportHeight - height}px`;\n      } else {\n        container.style.top = `${top}px`;\n      }\n    }\n  }, [\n    top,\n    left,\n    fitInViewport,\n    viewportWidth,\n    viewportHeight,\n    offsetLeft,\n    offsetTop,\n  ]);\n\n  useEffect(() => {\n    if (onCloseRequest) {\n      const handler = (event: PointerEvent) => {\n        if (!popoverRef.current?.contains(event.target as Node)) {\n          unstable_batchedUpdates(() => onCloseRequest(event));\n        }\n      };\n      document.addEventListener(\"pointerdown\", handler, false);\n      return () => document.removeEventListener(\"pointerdown\", handler, false);\n    }\n  }, [onCloseRequest]);\n\n  return (\n    <div className=\"popover\" ref={popoverRef} tabIndex={-1}>\n      {children}\n    </div>\n  );\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}