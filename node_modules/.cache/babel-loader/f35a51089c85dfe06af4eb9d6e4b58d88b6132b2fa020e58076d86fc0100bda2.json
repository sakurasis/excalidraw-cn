{"ast":null,"code":"import _createForOfIteratorHelper from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _toConsumableArray from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _defineProperty from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";import _regeneratorRuntime from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _classCallCheck from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _inherits from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import _objectSpread from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useContext}from\"react\";import{flushSync}from\"react-dom\";import rough from\"roughjs/bin/rough\";import clsx from\"clsx\";import{nanoid}from\"nanoid\";import{actionAddToLibrary,actionBringForward,actionBringToFront,actionCopy,actionCopyAsPng,actionCopyAsSvg,copyText,actionCopyStyles,actionCut,actionDeleteSelected,actionDuplicateSelection,actionFinalize,actionFlipHorizontal,actionFlipVertical,actionGroup,actionPasteStyles,actionSelectAll,actionSendBackward,actionSendToBack,actionToggleGridMode,actionToggleStats,actionToggleZenMode,actionUnbindText,actionBindText,actionUngroup,actionLink,actionToggleElementLock,actionToggleLinearEditor}from\"../actions\";import{createRedoAction,createUndoAction}from\"../actions/actionHistory\";import{ActionManager}from\"../actions/manager\";import{actions}from\"../actions/register\";import{trackEvent}from\"../analytics\";import{getDefaultAppState,isEraserActive,isHandToolActive}from\"../appState\";import{parseClipboard}from\"../clipboard\";import{APP_NAME,CURSOR_TYPE,DEFAULT_MAX_IMAGE_WIDTH_OR_HEIGHT,DEFAULT_UI_OPTIONS,DEFAULT_VERTICAL_ALIGN,DRAGGING_THRESHOLD,ELEMENT_READY_TO_ERASE_OPACITY,ELEMENT_SHIFT_TRANSLATE_AMOUNT,ELEMENT_TRANSLATE_AMOUNT,ENV,EVENT,FRAME_STYLE,GRID_SIZE,IMAGE_MIME_TYPES,IMAGE_RENDER_TIMEOUT,isAndroid,isBrave,LINE_CONFIRM_THRESHOLD,MAX_ALLOWED_FILE_BYTES,MIME_TYPES,MQ_MAX_HEIGHT_LANDSCAPE,MQ_MAX_WIDTH_LANDSCAPE,MQ_MAX_WIDTH_PORTRAIT,MQ_RIGHT_SIDEBAR_MIN_WIDTH,MQ_SM_MAX_WIDTH,POINTER_BUTTON,ROUNDNESS,SCROLL_TIMEOUT,TAP_TWICE_TIMEOUT,TEXT_TO_CENTER_SNAP_THRESHOLD,THEME,THEME_FILTER,TOUCH_CTX_MENU_TIMEOUT,VERTICAL_ALIGN,ZOOM_STEP}from\"../constants\";import{exportCanvas,loadFromBlob}from\"../data\";import Library,{distributeLibraryItemsOnSquareGrid}from\"../data/library\";import{restore,restoreElements}from\"../data/restore\";import{dragNewElement,dragSelectedElements,duplicateElement,getCommonBounds,getCursorForResizingElement,getDragOffsetXY,getElementWithTransformHandleType,getNormalizedDimensions,getResizeArrowDirection,getResizeOffsetXY,getLockedLinearCursorAlignSize,getTransformHandleTypeFromCoords,hitTest,isHittingElementBoundingBoxWithoutHittingElement,isInvisiblySmallElement,isNonDeletedElement,isTextElement,newElement,newLinearElement,newTextElement,newImageElement,textWysiwyg,transformElements,updateTextElement,redrawTextBoundingBox}from\"../element\";import{bindOrUnbindLinearElement,bindOrUnbindSelectedElements,fixBindingsAfterDeletion,fixBindingsAfterDuplication,getEligibleElementsForBinding,getHoveredElementForBinding,isBindingEnabled,isLinearElementSimpleAndAlreadyBound,maybeBindLinearElement,shouldEnableBindingForPointerEvent,unbindLinearElements,updateBoundElements}from\"../element/binding\";import{LinearElementEditor}from\"../element/linearElementEditor\";import{mutateElement,newElementWith}from\"../element/mutateElement\";import{deepCopyElement,duplicateElements,newFrameElement,newFreeDrawElement}from\"../element/newElement\";import{hasBoundTextElement,isArrowElement,isBindingElement,isBindingElementType,isBoundToContainer,isFrameElement,isImageElement,isInitializedImageElement,isLinearElement,isLinearElementType,isUsingAdaptiveRadius}from\"../element/typeChecks\";import{getCenter,getDistance}from\"../gesture\";import{editGroupForSelectedElement,getElementsInGroup,getSelectedGroupIdForElement,getSelectedGroupIds,isElementInGroup,isSelectedViaGroup,selectGroupsForSelectedElements}from\"../groups\";import History from\"../history\";import{defaultLang,getLanguage,languages,setLanguage,t}from\"../i18n\";import{CODES,shouldResizeFromCenter,shouldMaintainAspectRatio,shouldRotateWithDiscreteAngle,isArrowKey,KEYS}from\"../keys\";import{distance2d,getGridPoint,isPathALoop}from\"../math\";import{isVisibleElement,renderScene}from\"../renderer/renderScene\";import{invalidateShapeForElement}from\"../renderer/renderElement\";import{calculateScrollCenter,getElementsAtPosition as _getElementsAtPosition,getElementsWithinSelection,getNormalizedZoom,getSelectedElements,hasBackground,isOverScrollBars,isSomeElementSelected}from\"../scene\";import Scene from\"../scene/Scene\";import{getStateForZoom}from\"../scene/zoom\";import{findShapeByKey}from\"../shapes\";import{debounce,distance,getFontString,getNearestScrollableContainer,isInputLike,isToolIcon,isWritableElement,resetCursor,resolvablePromise,sceneCoordsToViewportCoords,setCursor,setCursorForShape,tupleToCoors,viewportCoordsToSceneCoords,withBatchedUpdates,wrapEvent,withBatchedUpdatesThrottled,updateObject,setEraserCursor,updateActiveTool,getShortcutKey,isTransparent,easeToValuesRAF,muteFSAbortError,easeOut}from\"../utils\";import{ContextMenu,CONTEXT_MENU_SEPARATOR}from\"./ContextMenu\";import LayerUI from\"./LayerUI\";import{Toast}from\"./Toast\";import{actionToggleViewMode}from\"../actions/actionToggleViewMode\";import{dataURLToFile,generateIdFromFile,getDataURL,getFileFromEvent,isImageFileHandle,isSupportedImageFile,loadSceneOrLibraryFromBlob,normalizeFile,parseLibraryJSON,resizeImageFile,SVGStringToFile}from\"../data/blob\";import{getInitializedImageElements,loadHTMLImageElement,normalizeSVG,updateImageCache as _updateImageCache}from\"../element/image\";import throttle from\"lodash.throttle\";import{fileOpen}from\"../data/filesystem\";import{bindTextToShapeAfterDuplication,getApproxMinLineHeight,getApproxMinLineWidth,getBoundTextElement,getContainerCenter,getContainerDims,getContainerElement,getDefaultLineHeight,getLineHeightInPx,getTextBindableContainerAtPosition,isMeasureTextSupported,isValidTextContainer}from\"../element/textElement\";import{isHittingElementNotConsideringBoundingBox}from\"../element/collision\";import{showHyperlinkTooltip,hideHyperlinkToolip,Hyperlink,isPointHittingLinkIcon}from\"../element/Hyperlink\";import{isLocalLink,normalizeLink}from\"../data/url\";import{shouldShowBoundingBox}from\"../element/transformHandles\";import{actionUnlockAllElements}from\"../actions/actionElementLock\";import{Fonts}from\"../scene/Fonts\";import{getFrameElements,isCursorInFrame,bindElementsToFramesAfterDuplication,addElementsToFrame,replaceAllElementsInFrame,removeElementsFromFrame,getElementsInResizingFrame,getElementsInNewFrame,getContainingFrame,elementOverlapsWithFrame,updateFrameMembershipOfSelectedElements,isElementInFrame}from\"../frame\";import{excludeElementsInFramesFromSelection,makeNextSelectedElementIds}from\"../scene/selection\";import{actionPaste}from\"../actions/actionClipboard\";import{actionRemoveAllElementsFromFrame,actionSelectAllElementsInFrame}from\"../actions/actionFrame\";import{actionToggleHandTool,zoomToFit}from\"../actions/actionCanvas\";import{jotaiStore}from\"../jotai\";import{activeConfirmDialogAtom}from\"./ActiveConfirmDialog\";import{actionWrapTextInContainer}from\"../actions/actionBoundText\";import BraveMeasureTextError from\"./BraveMeasureTextError\";import{activeEyeDropperAtom}from\"./EyeDropper\";import{isSidebarDockedAtom}from\"./Sidebar/Sidebar\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var AppContext=/*#__PURE__*/React.createContext(null);var AppPropsContext=/*#__PURE__*/React.createContext(null);var deviceContextInitialValue={isSmScreen:false,isMobile:false,isTouchScreen:false,canDeviceFitSidebar:false,isLandscape:false};var DeviceContext=/*#__PURE__*/React.createContext(deviceContextInitialValue);DeviceContext.displayName=\"DeviceContext\";export var ExcalidrawContainerContext=/*#__PURE__*/React.createContext({container:null,id:null});ExcalidrawContainerContext.displayName=\"ExcalidrawContainerContext\";var ExcalidrawElementsContext=/*#__PURE__*/React.createContext([]);ExcalidrawElementsContext.displayName=\"ExcalidrawElementsContext\";var ExcalidrawAppStateContext=/*#__PURE__*/React.createContext(_objectSpread(_objectSpread({},getDefaultAppState()),{},{width:0,height:0,offsetLeft:0,offsetTop:0}));ExcalidrawAppStateContext.displayName=\"ExcalidrawAppStateContext\";var ExcalidrawSetAppStateContext=/*#__PURE__*/React.createContext(function(){console.warn(\"unitialized ExcalidrawSetAppStateContext context!\");});ExcalidrawSetAppStateContext.displayName=\"ExcalidrawSetAppStateContext\";var ExcalidrawActionManagerContext=/*#__PURE__*/React.createContext(null);ExcalidrawActionManagerContext.displayName=\"ExcalidrawActionManagerContext\";export var useApp=function useApp(){return useContext(AppContext);};export var useAppProps=function useAppProps(){return useContext(AppPropsContext);};export var useDevice=function useDevice(){return useContext(DeviceContext);};export var useExcalidrawContainer=function useExcalidrawContainer(){return useContext(ExcalidrawContainerContext);};export var useExcalidrawElements=function useExcalidrawElements(){return useContext(ExcalidrawElementsContext);};export var useExcalidrawAppState=function useExcalidrawAppState(){return useContext(ExcalidrawAppStateContext);};export var useExcalidrawSetAppState=function useExcalidrawSetAppState(){return useContext(ExcalidrawSetAppStateContext);};export var useExcalidrawActionManager=function useExcalidrawActionManager(){return useContext(ExcalidrawActionManagerContext);};var didTapTwice=false;var tappedTwiceTimer=0;var isHoldingSpace=false;var isPanning=false;var isDraggingScrollBar=false;var currentScrollBars={horizontal:null,vertical:null};var touchTimeout=0;var invalidateContextMenu=false;// remove this hack when we can sync render & resizeObserver (state update)\n// to rAF. See #5439\nvar THROTTLE_NEXT_RENDER=true;var IS_PLAIN_PASTE=false;var IS_PLAIN_PASTE_TIMER=0;var PLAIN_PASTE_TOAST_SHOWN=false;var _lastPointerUp=null;var gesture={pointers:new Map(),lastCenter:null,initialDistance:null,initialScale:null};var App=/*#__PURE__*/function(_React$Component){_inherits(App,_React$Component);var _super=_createSuper(App);function App(props){var _this;_classCallCheck(this,App);_this=_super.call(this,props);_this.canvas=null;_this.rc=null;_this.unmounted=false;_this.actionManager=void 0;_this.device=deviceContextInitialValue;_this.detachIsMobileMqHandler=void 0;_this.excalidrawContainerRef=/*#__PURE__*/React.createRef();_this.scene=void 0;_this.fonts=void 0;_this.resizeObserver=void 0;_this.nearestScrollableContainer=void 0;_this.library=void 0;_this.libraryItemsFromStorage=void 0;_this.id=void 0;_this.history=void 0;_this.excalidrawContainerValue=void 0;_this.files={};_this.imageCache=new Map();_this.hitLinkElement=void 0;_this.lastPointerDown=null;_this.lastPointerUp=null;_this.lastViewportPosition={x:0,y:0};_this.getFrameNameDOMId=function(frameElement){return\"\".concat(_this.id,\"-frame-name-\").concat(frameElement.id);};_this.frameNameBoundsCache={get:function get(frameElement){var bounds=_this.frameNameBoundsCache._cache.get(frameElement.id);if(!bounds||bounds.zoom!==_this.state.zoom.value||bounds.versionNonce!==frameElement.versionNonce){var frameNameDiv=document.getElementById(_this.getFrameNameDOMId(frameElement));if(frameNameDiv){var box=frameNameDiv.getBoundingClientRect();var boxSceneTopLeft=viewportCoordsToSceneCoords({clientX:box.x,clientY:box.y},_this.state);var boxSceneBottomRight=viewportCoordsToSceneCoords({clientX:box.right,clientY:box.bottom},_this.state);bounds={x:boxSceneTopLeft.x,y:boxSceneTopLeft.y,width:boxSceneBottomRight.x-boxSceneTopLeft.x,height:boxSceneBottomRight.y-boxSceneTopLeft.y,angle:0,zoom:_this.state.zoom.value,versionNonce:frameElement.versionNonce};_this.frameNameBoundsCache._cache.set(frameElement.id,bounds);return bounds;}return null;}return bounds;},/**\n     * @private\n     */_cache:new Map()};_this.renderFrameNames=function(){if(!_this.state.frameRendering.enabled||!_this.state.frameRendering.name){return null;}var isDarkTheme=_this.state.theme===\"dark\";return _this.scene.getNonDeletedFrames().map(function(f,index){if(!_this.canvas||!isVisibleElement(f,_this.canvas.width/window.devicePixelRatio,_this.canvas.height/window.devicePixelRatio,{offsetLeft:_this.state.offsetLeft,offsetTop:_this.state.offsetTop,scrollX:_this.state.scrollX,scrollY:_this.state.scrollY,zoom:_this.state.zoom})){// if frame not visible, don't render its name\nreturn null;}var _sceneCoordsToViewpor=sceneCoordsToViewportCoords({sceneX:f.x,sceneY:f.y},_this.state),x1=_sceneCoordsToViewpor.x,y1=_sceneCoordsToViewpor.y;var _sceneCoordsToViewpor2=sceneCoordsToViewportCoords({sceneX:f.x+f.width,sceneY:f.y+f.height},_this.state),x2=_sceneCoordsToViewpor2.x;var FRAME_NAME_GAP=20;var FRAME_NAME_EDIT_PADDING=6;var reset=function reset(){var _f$name;if(((_f$name=f.name)===null||_f$name===void 0?void 0:_f$name.trim())===\"\"){mutateElement(f,{name:null});}_this.setState({editingFrame:null});};var frameNameJSX;if(f.id===_this.state.editingFrame){var frameNameInEdit=f.name==null?\"Frame \".concat(index+1):f.name;frameNameJSX=/*#__PURE__*/_jsx(\"input\",{autoFocus:true,value:frameNameInEdit,onChange:function onChange(e){mutateElement(f,{name:e.target.value});},onBlur:function onBlur(){return reset();},onKeyDown:function onKeyDown(event){// for some inexplicable reason, `onBlur` triggered on ESC\n// does not reset `state.editingFrame` despite being called,\n// and we need to reset it here as well\nif(event.key===KEYS.ESCAPE||event.key===KEYS.ENTER){reset();}},style:{background:_this.state.viewBackgroundColor,filter:isDarkTheme?THEME_FILTER:\"none\",zIndex:2,border:\"none\",display:\"block\",padding:\"\".concat(FRAME_NAME_EDIT_PADDING,\"px\"),borderRadius:4,boxShadow:\"inset 0 0 0 1px var(--color-primary)\",fontFamily:\"Assistant\",fontSize:\"14px\",transform:\"translateY(-\".concat(FRAME_NAME_EDIT_PADDING,\"px)\"),color:\"var(--color-gray-80)\",overflow:\"hidden\",maxWidth:\"\".concat(Math.min(x2-x1-FRAME_NAME_EDIT_PADDING,document.body.clientWidth-x1-FRAME_NAME_EDIT_PADDING),\"px\")},size:frameNameInEdit.length+1||1,dir:\"auto\",autoComplete:\"off\",autoCapitalize:\"off\",autoCorrect:\"off\"});}else{frameNameJSX=f.name==null||f.name.trim()===\"\"?\"Frame \".concat(index+1):f.name.trim();}return/*#__PURE__*/_jsx(\"div\",{id:_this.getFrameNameDOMId(f),style:{position:\"absolute\",top:\"\".concat(y1-FRAME_NAME_GAP-_this.state.offsetTop,\"px\"),left:\"\".concat(x1-_this.state.offsetLeft-(_this.state.editingFrame===f.id?FRAME_NAME_EDIT_PADDING:0),\"px\"),zIndex:2,fontSize:\"14px\",color:isDarkTheme?\"var(--color-gray-60)\":\"var(--color-gray-50)\",width:\"max-content\",maxWidth:\"\".concat(x2-x1+FRAME_NAME_EDIT_PADDING*2,\"px\"),overflow:f.id===_this.state.editingFrame?\"visible\":\"hidden\",whiteSpace:\"nowrap\",textOverflow:\"ellipsis\",cursor:CURSOR_TYPE.MOVE,// disable all interaction (e.g. cursor change) when in view\n// mode\npointerEvents:_this.state.viewModeEnabled?\"none\":\"all\"},onPointerDown:function onPointerDown(event){return _this.handleCanvasPointerDown(event);},onWheel:function onWheel(event){return _this.handleWheel(event);},onContextMenu:function onContextMenu(event){_this.handleCanvasContextMenu(event);},onDoubleClick:function onDoubleClick(){_this.setState({editingFrame:f.id});},children:frameNameJSX},f.id);});};_this.focusContainer=function(){var _this$excalidrawConta;(_this$excalidrawConta=_this.excalidrawContainerRef.current)===null||_this$excalidrawConta===void 0?void 0:_this$excalidrawConta.focus();};_this.getSceneElementsIncludingDeleted=function(){return _this.scene.getElementsIncludingDeleted();};_this.getSceneElements=function(){return _this.scene.getNonDeletedElements();};_this.onInsertElements=function(elements){_this.addElementsFromPasteOrLibrary({elements:elements,position:\"center\",files:null});};_this.onExportImage=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(type,elements){var fileHandle;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:trackEvent(\"export\",type,\"ui\");_context.next=3;return exportCanvas(type,elements,_this.state,_this.files,{exportBackground:_this.state.exportBackground,name:_this.state.name,viewBackgroundColor:_this.state.viewBackgroundColor}).catch(muteFSAbortError).catch(function(error){console.error(error);_this.setState({errorMessage:error.message});});case 3:fileHandle=_context.sent;if(_this.state.exportEmbedScene&&fileHandle&&isImageFileHandle(fileHandle)){_this.setState({fileHandle:fileHandle});}case 5:case\"end\":return _context.stop();}},_callee);}));return function(_x,_x2){return _ref.apply(this,arguments);};}();_this.openEyeDropper=function(_ref2){var type=_ref2.type;jotaiStore.set(activeEyeDropperAtom,{swapPreviewOnAlt:true,previewType:type===\"stroke\"?\"strokeColor\":\"backgroundColor\",onSelect:function onSelect(color,event){var shouldUpdateStrokeColor=type===\"background\"&&event.altKey||type===\"stroke\"&&!event.altKey;var selectedElements=_this.scene.getSelectedElements(_this.state);if(!selectedElements.length||_this.state.activeTool.type!==\"selection\"){if(shouldUpdateStrokeColor){_this.setState({currentItemStrokeColor:color});}else{_this.setState({currentItemBackgroundColor:color});}}else{_this.updateScene({elements:_this.scene.getElementsIncludingDeleted().map(function(el){if(_this.state.selectedElementIds[el.id]){return newElementWith(el,_defineProperty({},shouldUpdateStrokeColor?\"strokeColor\":\"backgroundColor\",color));}return el;})});}},keepOpenOnAlt:false});};_this.syncActionResult=withBatchedUpdates(function(actionResult){if(_this.unmounted||actionResult===false){return;}var editingElement=null;if(actionResult.elements){actionResult.elements.forEach(function(element){var _this$state$editingEl;if(((_this$state$editingEl=_this.state.editingElement)===null||_this$state$editingEl===void 0?void 0:_this$state$editingEl.id)===element.id&&_this.state.editingElement!==element&&isNonDeletedElement(element)){editingElement=element;}});_this.scene.replaceAllElements(actionResult.elements);if(actionResult.commitToHistory){_this.history.resumeRecording();}}if(actionResult.files){_this.files=actionResult.replaceFiles?actionResult.files:_objectSpread(_objectSpread({},_this.files),actionResult.files);_this.addNewImagesToImageCache();}if(actionResult.appState||editingElement||_this.state.contextMenu){var _actionResult$appStat,_actionResult$appStat2,_actionResult$appStat3,_actionResult$appStat4,_actionResult$appStat5,_actionResult$appStat6,_actionResult$appStat7,_actionResult$appStat8,_actionResult$appStat9,_editingElement;if(actionResult.commitToHistory){_this.history.resumeRecording();}var viewModeEnabled=(actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat=actionResult.appState)===null||_actionResult$appStat===void 0?void 0:_actionResult$appStat.viewModeEnabled)||false;var zenModeEnabled=(actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat2=actionResult.appState)===null||_actionResult$appStat2===void 0?void 0:_actionResult$appStat2.zenModeEnabled)||false;var gridSize=(actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat3=actionResult.appState)===null||_actionResult$appStat3===void 0?void 0:_actionResult$appStat3.gridSize)||null;var theme=(actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat4=actionResult.appState)===null||_actionResult$appStat4===void 0?void 0:_actionResult$appStat4.theme)||_this.props.theme||THEME.LIGHT;var name=(_actionResult$appStat5=actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat6=actionResult.appState)===null||_actionResult$appStat6===void 0?void 0:_actionResult$appStat6.name)!==null&&_actionResult$appStat5!==void 0?_actionResult$appStat5:_this.state.name;var errorMessage=(_actionResult$appStat7=actionResult===null||actionResult===void 0?void 0:(_actionResult$appStat8=actionResult.appState)===null||_actionResult$appStat8===void 0?void 0:_actionResult$appStat8.errorMessage)!==null&&_actionResult$appStat7!==void 0?_actionResult$appStat7:_this.state.errorMessage;if(typeof _this.props.viewModeEnabled!==\"undefined\"){viewModeEnabled=_this.props.viewModeEnabled;}if(typeof _this.props.zenModeEnabled!==\"undefined\"){zenModeEnabled=_this.props.zenModeEnabled;}if(typeof _this.props.gridModeEnabled!==\"undefined\"){gridSize=_this.props.gridModeEnabled?GRID_SIZE:null;}if(typeof _this.props.name!==\"undefined\"){name=_this.props.name;}editingElement=editingElement||((_actionResult$appStat9=actionResult.appState)===null||_actionResult$appStat9===void 0?void 0:_actionResult$appStat9.editingElement)||null;if((_editingElement=editingElement)!==null&&_editingElement!==void 0&&_editingElement.isDeleted){editingElement=null;}_this.setState(function(state){// using Object.assign instead of spread to fool TS 4.2.2+ into\n// regarding the resulting type as not containing undefined\n// (which the following expression will never contain)\nreturn Object.assign(actionResult.appState||{},{// NOTE this will prevent opening context menu using an action\n// or programmatically from the host, so it will need to be\n// rewritten later\ncontextMenu:null,editingElement:editingElement,viewModeEnabled:viewModeEnabled,zenModeEnabled:zenModeEnabled,gridSize:gridSize,theme:theme,name:name,errorMessage:errorMessage});},function(){if(actionResult.syncHistory){_this.history.setCurrentState(_this.state,_this.scene.getElementsIncludingDeleted());}});}});// Lifecycle\n_this.onBlur=withBatchedUpdates(function(){isHoldingSpace=false;_this.setState({isBindingEnabled:true});});_this.onUnload=function(){_this.onBlur();};_this.disableEvent=function(event){event.preventDefault();};_this.resetHistory=function(){_this.history.clear();};/**\n   * Resets scene & history.\n   * ! Do not use to clear scene user action !\n   */_this.resetScene=withBatchedUpdates(function(opts){_this.scene.replaceAllElements([]);_this.setState(function(state){return _objectSpread(_objectSpread({},getDefaultAppState()),{},{isLoading:opts!==null&&opts!==void 0&&opts.resetLoadingState?false:state.isLoading,theme:_this.state.theme});});_this.resetHistory();});_this.initializeScene=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var _scene$appState,_initialData2;var initialData,_initialData,scene;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:if(\"launchQueue\"in window&&\"LaunchParams\"in window){window.launchQueue.setConsumer(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(launchParams){var fileHandle,blob;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:if(launchParams.files.length){_context2.next=2;break;}return _context2.abrupt(\"return\");case 2:fileHandle=launchParams.files[0];_context2.next=5;return fileHandle.getFile();case 5:blob=_context2.sent;_this.loadFileToCanvas(new File([blob],blob.name||\"\",{type:blob.type}),fileHandle);case 7:case\"end\":return _context2.stop();}},_callee2);}));return function(_x3){return _ref4.apply(this,arguments);};}());}if(_this.props.theme){_this.setState({theme:_this.props.theme});}if(!_this.state.isLoading){_this.setState({isLoading:true});}initialData=null;_context3.prev=4;_context3.next=7;return _this.props.initialData;case 7:_context3.t0=_context3.sent;if(_context3.t0){_context3.next=10;break;}_context3.t0=null;case 10:initialData=_context3.t0;if((_initialData=initialData)!==null&&_initialData!==void 0&&_initialData.libraryItems){_this.library.updateLibrary({libraryItems:initialData.libraryItems,merge:true}).catch(function(error){console.error(error);});}_context3.next=18;break;case 14:_context3.prev=14;_context3.t1=_context3[\"catch\"](4);console.error(_context3.t1);initialData={appState:{errorMessage:_context3.t1.message||\"Encountered an error during importing or restoring scene data\"}};case 18:scene=restore(initialData,null,null,{repairBindings:true});scene.appState=_objectSpread(_objectSpread({},scene.appState),{},{theme:_this.props.theme||scene.appState.theme,// we're falling back to current (pre-init) state when deciding\n// whether to open the library, to handle a case where we\n// update the state outside of initialData (e.g. when loading the app\n// with a library install link, which should auto-open the library)\nopenSidebar:((_scene$appState=scene.appState)===null||_scene$appState===void 0?void 0:_scene$appState.openSidebar)||_this.state.openSidebar,activeTool:scene.appState.activeTool.type===\"image\"?_objectSpread(_objectSpread({},scene.appState.activeTool),{},{type:\"selection\"}):scene.appState.activeTool,isLoading:false,toast:_this.state.toast});if((_initialData2=initialData)!==null&&_initialData2!==void 0&&_initialData2.scrollToContent){scene.appState=_objectSpread(_objectSpread({},scene.appState),calculateScrollCenter(scene.elements,_objectSpread(_objectSpread({},scene.appState),{},{width:_this.state.width,height:_this.state.height,offsetTop:_this.state.offsetTop,offsetLeft:_this.state.offsetLeft}),null));}// FontFaceSet loadingdone event we listen on may not always fire\n// (looking at you Safari), so on init we manually load fonts for current\n// text elements on canvas, and rerender them once done. This also\n// seems faster even in browsers that do fire the loadingdone event.\n_this.fonts.loadFontsForElements(scene.elements);_this.resetHistory();_this.syncActionResult(_objectSpread(_objectSpread({},scene),{},{commitToHistory:true}));case 24:case\"end\":return _context3.stop();}},_callee3,null,[[4,14]]);}));_this.refreshDeviceState=function(container){var _container$getBoundin=container.getBoundingClientRect(),width=_container$getBoundin.width,height=_container$getBoundin.height;var sidebarBreakpoint=_this.props.UIOptions.dockedSidebarBreakpoint!=null?_this.props.UIOptions.dockedSidebarBreakpoint:MQ_RIGHT_SIDEBAR_MIN_WIDTH;_this.device=updateObject(_this.device,{isLandscape:width>height,isSmScreen:width<MQ_SM_MAX_WIDTH,isMobile:width<MQ_MAX_WIDTH_PORTRAIT||height<MQ_MAX_HEIGHT_LANDSCAPE&&width<MQ_MAX_WIDTH_LANDSCAPE,canDeviceFitSidebar:width>sidebarBreakpoint});};_this.onResize=withBatchedUpdates(function(){_this.scene.getElementsIncludingDeleted().forEach(function(element){return invalidateShapeForElement(element);});_this.setState({});});_this.renderScene=function(){var cursorButton={};var pointerViewportCoords={};var remoteSelectedElementIds={};var pointerUsernames={};var pointerUserStates={};_this.state.collaborators.forEach(function(user,socketId){if(user.selectedElementIds){for(var _i=0,_Object$keys=Object.keys(user.selectedElementIds);_i<_Object$keys.length;_i++){var _id=_Object$keys[_i];if(!(_id in remoteSelectedElementIds)){remoteSelectedElementIds[_id]=[];}remoteSelectedElementIds[_id].push(socketId);}}if(!user.pointer){return;}if(user.username){pointerUsernames[socketId]=user.username;}if(user.userState){pointerUserStates[socketId]=user.userState;}pointerViewportCoords[socketId]=sceneCoordsToViewportCoords({sceneX:user.pointer.x,sceneY:user.pointer.y},_this.state);cursorButton[socketId]=user.button;});var renderingElements=_this.scene.getNonDeletedElements().filter(function(element){if(isImageElement(element)){if(// not placed on canvas yet (but in elements array)\n_this.state.pendingImageElementId===element.id){return false;}}// don't render text element that's being currently edited (it's\n// rendered on remote only)\nreturn!_this.state.editingElement||_this.state.editingElement.type!==\"text\"||element.id!==_this.state.editingElement.id;});var selectionColor=getComputedStyle(document.querySelector(\".excalidraw\")).getPropertyValue(\"--color-selection\");renderScene({elements:renderingElements,appState:_this.state,scale:window.devicePixelRatio,rc:_this.rc,canvas:_this.canvas,renderConfig:{selectionColor:selectionColor,scrollX:_this.state.scrollX,scrollY:_this.state.scrollY,viewBackgroundColor:_this.state.viewBackgroundColor,zoom:_this.state.zoom,remotePointerViewportCoords:pointerViewportCoords,remotePointerButton:cursorButton,remoteSelectedElementIds:remoteSelectedElementIds,remotePointerUsernames:pointerUsernames,remotePointerUserStates:pointerUserStates,shouldCacheIgnoreZoom:_this.state.shouldCacheIgnoreZoom,theme:_this.state.theme,imageCache:_this.imageCache,isExporting:false,renderScrollbars:false},callback:function callback(_ref5){var atLeastOneVisibleElement=_ref5.atLeastOneVisibleElement,scrollBars=_ref5.scrollBars;if(scrollBars){currentScrollBars=scrollBars;}var scrolledOutside=// hide when editing text\nisTextElement(_this.state.editingElement)?false:!atLeastOneVisibleElement&&renderingElements.length>0;if(_this.state.scrolledOutside!==scrolledOutside){_this.setState({scrolledOutside:scrolledOutside});}_this.scheduleImageRefresh();}},THROTTLE_NEXT_RENDER&&window.EXCALIDRAW_THROTTLE_RENDER===true);if(!THROTTLE_NEXT_RENDER){THROTTLE_NEXT_RENDER=true;}};_this.onScroll=debounce(function(){var _this$getCanvasOffset=_this.getCanvasOffsets(),offsetTop=_this$getCanvasOffset.offsetTop,offsetLeft=_this$getCanvasOffset.offsetLeft;_this.setState(function(state){if(state.offsetLeft===offsetLeft&&state.offsetTop===offsetTop){return null;}return{offsetTop:offsetTop,offsetLeft:offsetLeft};});},SCROLL_TIMEOUT);// Copy/paste\n_this.onCut=withBatchedUpdates(function(event){var _this$excalidrawConta2;var isExcalidrawActive=(_this$excalidrawConta2=_this.excalidrawContainerRef.current)===null||_this$excalidrawConta2===void 0?void 0:_this$excalidrawConta2.contains(document.activeElement);if(!isExcalidrawActive||isWritableElement(event.target)){return;}_this.cutAll();event.preventDefault();event.stopPropagation();});_this.onCopy=withBatchedUpdates(function(event){var _this$excalidrawConta3;var isExcalidrawActive=(_this$excalidrawConta3=_this.excalidrawContainerRef.current)===null||_this$excalidrawConta3===void 0?void 0:_this$excalidrawConta3.contains(document.activeElement);if(!isExcalidrawActive||isWritableElement(event.target)){return;}_this.copyAll();event.preventDefault();event.stopPropagation();});_this.cutAll=function(){_this.actionManager.executeAction(actionCut,\"keyboard\");};_this.copyAll=function(){_this.actionManager.executeAction(actionCopy,\"keyboard\");};_this.onTapStart=function(event){// fix for Apple Pencil Scribble\n// On Android, preventing the event would disable contextMenu on tap-hold\nif(!isAndroid){event.preventDefault();}if(!didTapTwice){didTapTwice=true;clearTimeout(tappedTwiceTimer);tappedTwiceTimer=window.setTimeout(App.resetTapTwice,TAP_TWICE_TIMEOUT);return;}// insert text only if we tapped twice with a single finger\n// event.touches.length === 1 will also prevent inserting text when user's zooming\nif(didTapTwice&&event.touches.length===1){var _event$touches=_slicedToArray(event.touches,1),touch=_event$touches[0];// @ts-ignore\n_this.handleCanvasDoubleClick({clientX:touch.clientX,clientY:touch.clientY});didTapTwice=false;clearTimeout(tappedTwiceTimer);}if(isAndroid){event.preventDefault();}if(event.touches.length===2){_this.setState({selectedElementIds:makeNextSelectedElementIds({},_this.state)});}};_this.onTapEnd=function(event){_this.resetContextMenuTimer();if(event.touches.length>0){_this.setState({previousSelectedElementIds:{},selectedElementIds:makeNextSelectedElementIds(_this.state.previousSelectedElementIds,_this.state)});}else{gesture.pointers.clear();}};_this.pasteFromClipboard=withBatchedUpdates(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(event){var _this$excalidrawConta4,_event$clipboardData;var isPlainPaste,target,isExcalidrawActive,elementUnderCursor,file,data,string,_viewportCoordsToScen,sceneX,sceneY,imageElement;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:isPlainPaste=!!(IS_PLAIN_PASTE&&event);// #686\ntarget=document.activeElement;isExcalidrawActive=(_this$excalidrawConta4=_this.excalidrawContainerRef.current)===null||_this$excalidrawConta4===void 0?void 0:_this$excalidrawConta4.contains(target);if(!(event&&!isExcalidrawActive)){_context4.next=5;break;}return _context4.abrupt(\"return\");case 5:elementUnderCursor=document.elementFromPoint(_this.lastViewportPosition.x,_this.lastViewportPosition.y);if(!(event&&(!(elementUnderCursor instanceof HTMLCanvasElement)||isWritableElement(target)))){_context4.next=8;break;}return _context4.abrupt(\"return\");case 8:// must be called in the same frame (thus before any awaits) as the paste\n// event else some browsers (FF...) will clear the clipboardData\n// (something something security)\nfile=event===null||event===void 0?void 0:(_event$clipboardData=event.clipboardData)===null||_event$clipboardData===void 0?void 0:_event$clipboardData.files[0];_context4.next=11;return parseClipboard(event,isPlainPaste);case 11:data=_context4.sent;if(!file&&data.text&&!isPlainPaste){string=data.text.trim();if(string.startsWith(\"<svg\")&&string.endsWith(\"</svg>\")){// ignore SVG validation/normalization which will be done during image\n// initialization\nfile=SVGStringToFile(string);}}// prefer spreadsheet data over image file (MS Office/Libre Office)\nif(!(isSupportedImageFile(file)&&!data.spreadsheet)){_context4.next=20;break;}_viewportCoordsToScen=viewportCoordsToSceneCoords({clientX:_this.lastViewportPosition.x,clientY:_this.lastViewportPosition.y},_this.state),sceneX=_viewportCoordsToScen.x,sceneY=_viewportCoordsToScen.y;imageElement=_this.createImageElement({sceneX:sceneX,sceneY:sceneY});_this.insertImageElement(imageElement,file);_this.initializeImageDimensions(imageElement);_this.setState({selectedElementIds:makeNextSelectedElementIds(_defineProperty({},imageElement.id,true),_this.state)});return _context4.abrupt(\"return\");case 20:if(!_this.props.onPaste){_context4.next=32;break;}_context4.prev=21;_context4.next=24;return _this.props.onPaste(data,event);case 24:_context4.t0=_context4.sent;if(!(_context4.t0===false)){_context4.next=27;break;}return _context4.abrupt(\"return\");case 27:_context4.next=32;break;case 29:_context4.prev=29;_context4.t1=_context4[\"catch\"](21);console.error(_context4.t1);case 32:if(data.errorMessage){_this.setState({errorMessage:data.errorMessage});}else if(data.spreadsheet&&!isPlainPaste){_this.setState({pasteDialog:{data:data.spreadsheet,shown:true}});}else if(data.elements){// TODO remove formatting from elements if isPlainPaste\n_this.addElementsFromPasteOrLibrary({elements:data.elements,files:data.files||null,position:\"cursor\",retainSeed:isPlainPaste});}else if(data.text){_this.addTextFromPaste(data.text,isPlainPaste);}_this.setActiveTool({type:\"selection\"});event===null||event===void 0?void 0:event.preventDefault();case 35:case\"end\":return _context4.stop();}},_callee4,null,[[21,29]]);}));return function(_x4){return _ref6.apply(this,arguments);};}());_this.addElementsFromPasteOrLibrary=function(opts){var elements=restoreElements(opts.elements,null);var _getCommonBounds=getCommonBounds(elements),_getCommonBounds2=_slicedToArray(_getCommonBounds,4),minX=_getCommonBounds2[0],minY=_getCommonBounds2[1],maxX=_getCommonBounds2[2],maxY=_getCommonBounds2[3];var elementsCenterX=distance(minX,maxX)/2;var elementsCenterY=distance(minY,maxY)/2;var clientX=typeof opts.position===\"object\"?opts.position.clientX:opts.position===\"cursor\"?_this.lastViewportPosition.x:_this.state.width/2+_this.state.offsetLeft;var clientY=typeof opts.position===\"object\"?opts.position.clientY:opts.position===\"cursor\"?_this.lastViewportPosition.y:_this.state.height/2+_this.state.offsetTop;var _viewportCoordsToScen2=viewportCoordsToSceneCoords({clientX:clientX,clientY:clientY},_this.state),x=_viewportCoordsToScen2.x,y=_viewportCoordsToScen2.y;var dx=x-elementsCenterX;var dy=y-elementsCenterY;var _getGridPoint=getGridPoint(dx,dy,_this.state.gridSize),_getGridPoint2=_slicedToArray(_getGridPoint,2),gridX=_getGridPoint2[0],gridY=_getGridPoint2[1];var newElements=duplicateElements(elements.map(function(element){return newElementWith(element,{x:element.x+gridX-minX,y:element.y+gridY-minY});}),{randomizeSeed:!opts.retainSeed});var nextElements=[].concat(_toConsumableArray(_this.scene.getElementsIncludingDeleted()),_toConsumableArray(newElements));_this.scene.replaceAllElements(nextElements);newElements.forEach(function(newElement){if(isTextElement(newElement)&&isBoundToContainer(newElement)){var container=getContainerElement(newElement);redrawTextBoundingBox(newElement,container);}});if(opts.files){_this.files=_objectSpread(_objectSpread({},_this.files),opts.files);}_this.history.resumeRecording();var nextElementsToSelect=excludeElementsInFramesFromSelection(newElements);_this.setState(selectGroupsForSelectedElements(_objectSpread(_objectSpread({},_this.state),{},{// keep sidebar (presumably the library) open if it's docked and\n// can fit.\n//\n// Note, we should close the sidebar only if we're dropping items\n// from library, not when pasting from clipboard. Alas.\nopenSidebar:_this.state.openSidebar&&_this.device.canDeviceFitSidebar&&jotaiStore.get(isSidebarDockedAtom)?_this.state.openSidebar:null,selectedElementIds:nextElementsToSelect.reduce(function(acc,element){if(!isBoundToContainer(element)){acc[element.id]=true;}return acc;},{}),selectedGroupIds:{}}),_this.scene.getNonDeletedElements(),_this.state,_assertThisInitialized(_this)),function(){if(opts.files){_this.addNewImagesToImageCache();}});_this.setActiveTool({type:\"selection\"});};_this.setAppState=function(state,callback){_this.setState(state,callback);};_this.removePointer=function(event){if(touchTimeout){_this.resetContextMenuTimer();}gesture.pointers.delete(event.pointerId);};_this.toggleLock=function(){var source=arguments.length>0&&arguments[0]!==undefined?arguments[0]:\"ui\";if(!_this.state.activeTool.locked){trackEvent(\"toolbar\",\"toggleLock\",\"\".concat(source,\" (\").concat(_this.device.isMobile?\"mobile\":\"desktop\",\")\"));}_this.setState(function(prevState){return{activeTool:_objectSpread(_objectSpread(_objectSpread({},prevState.activeTool),updateActiveTool(_this.state,prevState.activeTool.locked?{type:\"selection\"}:prevState.activeTool)),{},{locked:!prevState.activeTool.locked})};});};_this.updateFrameRendering=function(opts){_this.setState(function(prevState){var _next$enabled,_next$clip,_next$name,_next$outline;var next=typeof opts===\"function\"?opts(prevState.frameRendering):opts;return{frameRendering:{enabled:(_next$enabled=next===null||next===void 0?void 0:next.enabled)!==null&&_next$enabled!==void 0?_next$enabled:prevState.frameRendering.enabled,clip:(_next$clip=next===null||next===void 0?void 0:next.clip)!==null&&_next$clip!==void 0?_next$clip:prevState.frameRendering.clip,name:(_next$name=next===null||next===void 0?void 0:next.name)!==null&&_next$name!==void 0?_next$name:prevState.frameRendering.name,outline:(_next$outline=next===null||next===void 0?void 0:next.outline)!==null&&_next$outline!==void 0?_next$outline:prevState.frameRendering.outline}};});};_this.togglePenMode=function(){_this.setState(function(prevState){return{penMode:!prevState.penMode};});};_this.onHandToolToggle=function(){_this.actionManager.executeAction(actionToggleHandTool);};/**\n   * Zooms on canvas viewport center\n   */_this.zoomCanvas=function(value){_this.setState(_objectSpread({},getStateForZoom({viewportX:_this.state.width/2+_this.state.offsetLeft,viewportY:_this.state.height/2+_this.state.offsetTop,nextZoom:getNormalizedZoom(value)},_this.state)));};_this.cancelInProgresAnimation=null;_this.scrollToContent=function(){var _this$cancelInProgres,_this2;var target=arguments.length>0&&arguments[0]!==undefined?arguments[0]:_this.scene.getNonDeletedElements();var opts=arguments.length>1?arguments[1]:undefined;(_this$cancelInProgres=(_this2=_this).cancelInProgresAnimation)===null||_this$cancelInProgres===void 0?void 0:_this$cancelInProgres.call(_this2);// convert provided target into ExcalidrawElement[] if necessary\nvar targetElements=Array.isArray(target)?target:[target];var zoom=_this.state.zoom;var scrollX=_this.state.scrollX;var scrollY=_this.state.scrollY;if(opts!==null&&opts!==void 0&&opts.fitToContent||opts!==null&&opts!==void 0&&opts.fitToViewport){var _zoomToFit=zoomToFit({targetElements:targetElements,appState:_this.state,fitToViewport:!!(opts!==null&&opts!==void 0&&opts.fitToViewport),viewportZoomFactor:opts===null||opts===void 0?void 0:opts.viewportZoomFactor}),appState=_zoomToFit.appState;zoom=appState.zoom;scrollX=appState.scrollX;scrollY=appState.scrollY;}else{// compute only the viewport location, without any zoom adjustment\nvar scroll=calculateScrollCenter(targetElements,_this.state,_this.canvas);scrollX=scroll.scrollX;scrollY=scroll.scrollY;}// when animating, we use RequestAnimationFrame to prevent the animation\n// from slowing down other processes\nif(opts!==null&&opts!==void 0&&opts.animate){var _opts$duration;var origScrollX=_this.state.scrollX;var origScrollY=_this.state.scrollY;var origZoom=_this.state.zoom.value;var cancel=easeToValuesRAF({fromValues:{scrollX:origScrollX,scrollY:origScrollY,zoom:origZoom},toValues:{scrollX:scrollX,scrollY:scrollY,zoom:zoom.value},interpolateValue:function interpolateValue(from,to,progress,key){// for zoom, use different easing\nif(key===\"zoom\"){return from*Math.pow(to/from,easeOut(progress));}// handle using default\nreturn undefined;},onStep:function onStep(_ref7){var scrollX=_ref7.scrollX,scrollY=_ref7.scrollY,zoom=_ref7.zoom;_this.setState({scrollX:scrollX,scrollY:scrollY,zoom:{value:zoom}});},onStart:function onStart(){_this.setState({shouldCacheIgnoreZoom:true});},onEnd:function onEnd(){_this.setState({shouldCacheIgnoreZoom:false});},onCancel:function onCancel(){_this.setState({shouldCacheIgnoreZoom:false});},duration:(_opts$duration=opts===null||opts===void 0?void 0:opts.duration)!==null&&_opts$duration!==void 0?_opts$duration:500});_this.cancelInProgresAnimation=function(){cancel();_this.cancelInProgresAnimation=null;};}else{_this.setState({scrollX:scrollX,scrollY:scrollY,zoom:zoom});}};/** use when changing scrollX/scrollY/zoom based on user interaction */_this.translateCanvas=function(state){var _this$cancelInProgres2,_this3;(_this$cancelInProgres2=(_this3=_this).cancelInProgresAnimation)===null||_this$cancelInProgres2===void 0?void 0:_this$cancelInProgres2.call(_this3);_this.setState(state);};_this.setToast=function(toast){_this.setState({toast:toast});};_this.restoreFileFromShare=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(){var webShareTargetCache,response,blob,file;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:_context5.prev=0;_context5.next=3;return caches.open(\"web-share-target\");case 3:webShareTargetCache=_context5.sent;_context5.next=6;return webShareTargetCache.match(\"shared-file\");case 6:response=_context5.sent;if(!response){_context5.next=16;break;}_context5.next=10;return response.blob();case 10:blob=_context5.sent;file=new File([blob],blob.name||\"\",{type:blob.type});_this.loadFileToCanvas(file,null);_context5.next=15;return webShareTargetCache.delete(\"shared-file\");case 15:window.history.replaceState(null,APP_NAME,window.location.pathname);case 16:_context5.next=21;break;case 18:_context5.prev=18;_context5.t0=_context5[\"catch\"](0);_this.setState({errorMessage:_context5.t0.message});case 21:case\"end\":return _context5.stop();}},_callee5,null,[[0,18]]);}));/** adds supplied files to existing files in the appState */_this.addFiles=withBatchedUpdates(function(files){var filesMap=files.reduce(function(acc,fileData){acc.set(fileData.id,fileData);return acc;},new Map());_this.files=_objectSpread(_objectSpread({},_this.files),Object.fromEntries(filesMap));_this.scene.getNonDeletedElements().forEach(function(element){if(isInitializedImageElement(element)&&filesMap.has(element.fileId)){_this.imageCache.delete(element.fileId);invalidateShapeForElement(element);}});_this.scene.informMutation();_this.addNewImagesToImageCache();});_this.updateScene=withBatchedUpdates(function(sceneData){if(sceneData.commitToHistory){_this.history.resumeRecording();}if(sceneData.appState){_this.setState(sceneData.appState);}if(sceneData.elements){_this.scene.replaceAllElements(sceneData.elements);}if(sceneData.collaborators){_this.setState({collaborators:sceneData.collaborators});}});_this.onSceneUpdated=function(){_this.setState({});};/**\n   * @returns whether the menu was toggled on or off\n   */_this.toggleSidebar=function(_ref9){var name=_ref9.name,tab=_ref9.tab,force=_ref9.force;var nextName;if(force===undefined){var _this$state$openSideb;nextName=((_this$state$openSideb=_this.state.openSidebar)===null||_this$state$openSideb===void 0?void 0:_this$state$openSideb.name)===name?null:name;}else{nextName=force?name:null;}_this.setState({openSidebar:nextName?{name:nextName,tab:tab}:null});return!!nextName;};_this.updateCurrentCursorPosition=withBatchedUpdates(function(event){_this.lastViewportPosition.x=event.clientX;_this.lastViewportPosition.y=event.clientY;});// Input handling\n_this.onKeyDown=withBatchedUpdates(function(event){// normalize `event.key` when CapsLock is pressed #2372\nif(\"Proxy\"in window&&(!event.shiftKey&&/^[A-Z]$/.test(event.key)||event.shiftKey&&/^[a-z]$/.test(event.key))){event=new Proxy(event,{get:function get(ev,prop){var value=ev[prop];if(typeof value===\"function\"){// fix for Proxies hijacking `this`\nreturn value.bind(ev);}return prop===\"key\"?// CapsLock inverts capitalization based on ShiftKey, so invert\n// it back\nevent.shiftKey?ev.key.toUpperCase():ev.key.toLowerCase():value;}});}if(event[KEYS.CTRL_OR_CMD]&&event.key.toLowerCase()===KEYS.V){IS_PLAIN_PASTE=event.shiftKey;clearTimeout(IS_PLAIN_PASTE_TIMER);// reset (100ms to be safe that we it runs after the ensuing\n// paste event). Though, technically unnecessary to reset since we\n// (re)set the flag before each paste event.\nIS_PLAIN_PASTE_TIMER=window.setTimeout(function(){IS_PLAIN_PASTE=false;},100);}// prevent browser zoom in input fields\nif(event[KEYS.CTRL_OR_CMD]&&isWritableElement(event.target)){if(event.code===CODES.MINUS||event.code===CODES.EQUAL){event.preventDefault();return;}}// bail if\nif(// inside an input\nisWritableElement(event.target)&&// unless pressing escape (finalize action)\nevent.key!==KEYS.ESCAPE||// or unless using arrows (to move between buttons)\nisArrowKey(event.key)&&isInputLike(event.target)){return;}if(event.key===KEYS.QUESTION_MARK){_this.setState({openDialog:\"help\"});return;}else if(event.key.toLowerCase()===KEYS.E&&event.shiftKey&&event[KEYS.CTRL_OR_CMD]){event.preventDefault();_this.setState({openDialog:\"imageExport\"});return;}if(event.key===KEYS.PAGE_UP||event.key===KEYS.PAGE_DOWN){var offset=(event.shiftKey?_this.state.width:_this.state.height)/_this.state.zoom.value;if(event.key===KEYS.PAGE_DOWN){offset=-offset;}if(event.shiftKey){_this.translateCanvas(function(state){return{scrollX:state.scrollX+offset};});}else{_this.translateCanvas(function(state){return{scrollY:state.scrollY+offset};});}}if(_this.actionManager.handleKeyDown(event)){return;}if(_this.state.viewModeEnabled){return;}if(event[KEYS.CTRL_OR_CMD]&&_this.state.isBindingEnabled){_this.setState({isBindingEnabled:false});}if(isArrowKey(event.key)){var step=_this.state.gridSize&&(event.shiftKey?ELEMENT_TRANSLATE_AMOUNT:_this.state.gridSize)||(event.shiftKey?ELEMENT_SHIFT_TRANSLATE_AMOUNT:ELEMENT_TRANSLATE_AMOUNT);var offsetX=0;var offsetY=0;if(event.key===KEYS.ARROW_LEFT){offsetX=-step;}else if(event.key===KEYS.ARROW_RIGHT){offsetX=step;}else if(event.key===KEYS.ARROW_UP){offsetY=-step;}else if(event.key===KEYS.ARROW_DOWN){offsetY=step;}var selectedElements=_this.scene.getSelectedElements({selectedElementIds:_this.state.selectedElementIds,includeBoundTextElement:true,includeElementsInFrames:true});selectedElements.forEach(function(element){mutateElement(element,{x:element.x+offsetX,y:element.y+offsetY});updateBoundElements(element,{simultaneouslyUpdated:selectedElements});});_this.maybeSuggestBindingForAll(selectedElements);event.preventDefault();}else if(event.key===KEYS.ENTER){var _selectedElements=_this.scene.getSelectedElements(_this.state);if(_selectedElements.length===1){var selectedElement=_selectedElements[0];if(event[KEYS.CTRL_OR_CMD]){if(isLinearElement(selectedElement)){if(!_this.state.editingLinearElement||_this.state.editingLinearElement.elementId!==_selectedElements[0].id){_this.history.resumeRecording();_this.setState({editingLinearElement:new LinearElementEditor(selectedElement,_this.scene)});}}}else if(isTextElement(selectedElement)||isValidTextContainer(selectedElement)){var container;if(!isTextElement(selectedElement)){container=selectedElement;}var midPoint=getContainerCenter(selectedElement,_this.state);var sceneX=midPoint.x;var sceneY=midPoint.y;_this.startTextEditing({sceneX:sceneX,sceneY:sceneY,container:container});event.preventDefault();return;}else if(isFrameElement(selectedElement)){_this.setState({editingFrame:selectedElement.id});}}}else if(!event.ctrlKey&&!event.altKey&&!event.metaKey&&_this.state.draggingElement===null){var shape=findShapeByKey(event.key);if(shape){if(_this.state.activeTool.type!==shape){trackEvent(\"toolbar\",shape,\"keyboard (\".concat(_this.device.isMobile?\"mobile\":\"desktop\",\")\"));}_this.setActiveTool({type:shape});event.stopPropagation();}else if(event.key===KEYS.Q){_this.toggleLock(\"keyboard\");event.stopPropagation();}}if(event.key===KEYS.SPACE&&gesture.pointers.size===0){isHoldingSpace=true;setCursor(_this.canvas,CURSOR_TYPE.GRAB);event.preventDefault();}if((event.key===KEYS.G||event.key===KEYS.S)&&!event.altKey&&!event[KEYS.CTRL_OR_CMD]){var _selectedElements2=_this.scene.getSelectedElements(_this.state);if(_this.state.activeTool.type===\"selection\"&&!_selectedElements2.length){return;}if(event.key===KEYS.G&&(hasBackground(_this.state.activeTool.type)||_selectedElements2.some(function(element){return hasBackground(element.type);}))){_this.setState({openPopup:\"elementBackground\"});event.stopPropagation();}if(event.key===KEYS.S){_this.setState({openPopup:\"elementStroke\"});event.stopPropagation();}}if(event[KEYS.CTRL_OR_CMD]&&(event.key===KEYS.BACKSPACE||event.key===KEYS.DELETE)){jotaiStore.set(activeConfirmDialogAtom,\"clearCanvas\");}// eye dropper\n// -----------------------------------------------------------------------\nvar lowerCased=event.key.toLocaleLowerCase();var isPickingStroke=lowerCased===KEYS.S&&event.shiftKey;var isPickingBackground=event.key===KEYS.I||lowerCased===KEYS.G&&event.shiftKey;if(isPickingStroke||isPickingBackground){_this.openEyeDropper({type:isPickingStroke?\"stroke\":\"background\"});}// -----------------------------------------------------------------------\n});_this.onWheel=withBatchedUpdates(function(event){// prevent browser pinch zoom on DOM elements\nif(!(event.target instanceof HTMLCanvasElement)&&event.ctrlKey){event.preventDefault();}});_this.onKeyUp=withBatchedUpdates(function(event){if(event.key===KEYS.SPACE){if(_this.state.viewModeEnabled){setCursor(_this.canvas,CURSOR_TYPE.GRAB);}else if(_this.state.activeTool.type===\"selection\"){resetCursor(_this.canvas);}else{setCursorForShape(_this.canvas,_this.state);_this.setState({selectedElementIds:makeNextSelectedElementIds({},_this.state),selectedGroupIds:{},editingGroupId:null});}isHoldingSpace=false;}if(!event[KEYS.CTRL_OR_CMD]&&!_this.state.isBindingEnabled){_this.setState({isBindingEnabled:true});}if(isArrowKey(event.key)){var selectedElements=_this.scene.getSelectedElements(_this.state);isBindingEnabled(_this.state)?bindOrUnbindSelectedElements(selectedElements):unbindLinearElements(selectedElements);_this.setState({suggestedBindings:[]});}});_this.setActiveTool=function(tool){var nextActiveTool=updateActiveTool(_this.state,tool);if(nextActiveTool.type===\"hand\"){setCursor(_this.canvas,CURSOR_TYPE.GRAB);}else if(!isHoldingSpace){setCursorForShape(_this.canvas,_this.state);}if(isToolIcon(document.activeElement)){_this.focusContainer();}if(!isLinearElementType(nextActiveTool.type)){_this.setState({suggestedBindings:[]});}if(nextActiveTool.type===\"image\"){_this.onImageAction();}if(nextActiveTool.type!==\"selection\"){_this.setState({activeTool:nextActiveTool,selectedElementIds:makeNextSelectedElementIds({},_this.state),selectedGroupIds:{},editingGroupId:null});}else{_this.setState({activeTool:nextActiveTool});}};_this.setCursor=function(cursor){setCursor(_this.canvas,cursor);};_this.resetCursor=function(){resetCursor(_this.canvas);};/**\n   * returns whether user is making a gesture with >= 2 fingers (points)\n   * on o touch screen (not on a trackpad). Currently only relates to Darwin\n   * (iOS/iPadOS,MacOS), but may work on other devices in the future if\n   * GestureEvent is standardized.\n   */_this.isTouchScreenMultiTouchGesture=function(){// we don't want to deselect when using trackpad, and multi-point gestures\n// only work on touch screens, so checking for >= pointers means we're on a\n// touchscreen\nreturn gesture.pointers.size>=2;};// fires only on Safari\n_this.onGestureStart=withBatchedUpdates(function(event){event.preventDefault();// we only want to deselect on touch screens because user may have selected\n// elements by mistake while zooming\nif(_this.isTouchScreenMultiTouchGesture()){_this.setState({selectedElementIds:makeNextSelectedElementIds({},_this.state)});}gesture.initialScale=_this.state.zoom.value;});// fires only on Safari\n_this.onGestureChange=withBatchedUpdates(function(event){event.preventDefault();// onGestureChange only has zoom factor but not the center.\n// If we're on iPad or iPhone, then we recognize multi-touch and will\n// zoom in at the right location in the touchmove handler\n// (handleCanvasPointerMove).\n//\n// On Macbook trackpad, we don't have those events so will zoom in at the\n// current location instead.\n//\n// As such, bail from this handler on touch devices.\nif(_this.isTouchScreenMultiTouchGesture()){return;}var initialScale=gesture.initialScale;if(initialScale){_this.setState(function(state){return _objectSpread({},getStateForZoom({viewportX:_this.lastViewportPosition.x,viewportY:_this.lastViewportPosition.y,nextZoom:getNormalizedZoom(initialScale*event.scale)},state));});}});// fires only on Safari\n_this.onGestureEnd=withBatchedUpdates(function(event){event.preventDefault();// reselect elements only on touch screens (see onGestureStart)\nif(_this.isTouchScreenMultiTouchGesture()){_this.setState({previousSelectedElementIds:{},selectedElementIds:makeNextSelectedElementIds(_this.state.previousSelectedElementIds,_this.state)});}gesture.initialScale=null;});_this.startTextEditing=function(_ref10){var _existingTextElement,_existingTextElement2,_container$groupIds,_container$angle;var sceneX=_ref10.sceneX,sceneY=_ref10.sceneY,_ref10$insertAtParent=_ref10.insertAtParentCenter,insertAtParentCenter=_ref10$insertAtParent===void 0?true:_ref10$insertAtParent,container=_ref10.container;var shouldBindToContainer=false;var parentCenterPosition=insertAtParentCenter&&_this.getTextWysiwygSnappedToCenterPosition(sceneX,sceneY,_this.state,container);if(container&&parentCenterPosition){var boundTextElementToContainer=getBoundTextElement(container);if(!boundTextElementToContainer){shouldBindToContainer=true;}}var existingTextElement=null;var selectedElements=_this.scene.getSelectedElements(_this.state);if(selectedElements.length===1){if(isTextElement(selectedElements[0])){existingTextElement=selectedElements[0];}else if(container){existingTextElement=getBoundTextElement(selectedElements[0]);}else{existingTextElement=_this.getTextElementAtPosition(sceneX,sceneY);}}else{existingTextElement=_this.getTextElementAtPosition(sceneX,sceneY);}var fontFamily=((_existingTextElement=existingTextElement)===null||_existingTextElement===void 0?void 0:_existingTextElement.fontFamily)||_this.state.currentItemFontFamily;var lineHeight=((_existingTextElement2=existingTextElement)===null||_existingTextElement2===void 0?void 0:_existingTextElement2.lineHeight)||getDefaultLineHeight(fontFamily);var fontSize=_this.state.currentItemFontSize;if(!existingTextElement&&shouldBindToContainer&&container&&!isArrowElement(container)){var fontString={fontSize:fontSize,fontFamily:fontFamily};var minWidth=getApproxMinLineWidth(getFontString(fontString),lineHeight);var minHeight=getApproxMinLineHeight(fontSize,lineHeight);var containerDims=getContainerDims(container);var newHeight=Math.max(containerDims.height,minHeight);var newWidth=Math.max(containerDims.width,minWidth);mutateElement(container,{height:newHeight,width:newWidth});sceneX=container.x+newWidth/2;sceneY=container.y+newHeight/2;if(parentCenterPosition){parentCenterPosition=_this.getTextWysiwygSnappedToCenterPosition(sceneX,sceneY,_this.state,container);}}var topLayerFrame=_this.getTopLayerFrameAtSceneCoords({x:sceneX,y:sceneY});var element=existingTextElement?existingTextElement:newTextElement({x:parentCenterPosition?parentCenterPosition.elementCenterX:sceneX,y:parentCenterPosition?parentCenterPosition.elementCenterY:sceneY,strokeColor:_this.state.currentItemStrokeColor,backgroundColor:_this.state.currentItemBackgroundColor,fillStyle:_this.state.currentItemFillStyle,strokeWidth:_this.state.currentItemStrokeWidth,strokeStyle:_this.state.currentItemStrokeStyle,roughness:_this.state.currentItemRoughness,opacity:_this.state.currentItemOpacity,text:\"\",fontSize:fontSize,fontFamily:fontFamily,textAlign:parentCenterPosition?\"center\":_this.state.currentItemTextAlign,verticalAlign:parentCenterPosition?VERTICAL_ALIGN.MIDDLE:DEFAULT_VERTICAL_ALIGN,containerId:shouldBindToContainer?container===null||container===void 0?void 0:container.id:undefined,groupIds:(_container$groupIds=container===null||container===void 0?void 0:container.groupIds)!==null&&_container$groupIds!==void 0?_container$groupIds:[],lineHeight:lineHeight,angle:(_container$angle=container===null||container===void 0?void 0:container.angle)!==null&&_container$angle!==void 0?_container$angle:0,frameId:topLayerFrame?topLayerFrame.id:null});if(!existingTextElement&&shouldBindToContainer&&container){mutateElement(container,{boundElements:(container.boundElements||[]).concat({type:\"text\",id:element.id})});}_this.setState({editingElement:element});if(!existingTextElement){if(container&&shouldBindToContainer){var containerIndex=_this.scene.getElementIndex(container.id);_this.scene.insertElementAtIndex(element,containerIndex+1);}else{_this.scene.addNewElement(element);}}_this.setState({editingElement:element});_this.handleTextWysiwyg(element,{isExistingElement:!!existingTextElement});};_this.handleCanvasDoubleClick=function(event){// case: double-clicking with arrow/line tool selected would both create\n// text and enter multiElement mode\nif(_this.state.multiElement){return;}// we should only be able to double click when mode is selection\nif(_this.state.activeTool.type!==\"selection\"){return;}var selectedElements=_this.scene.getSelectedElements(_this.state);if(selectedElements.length===1&&isLinearElement(selectedElements[0])){if(event[KEYS.CTRL_OR_CMD]&&(!_this.state.editingLinearElement||_this.state.editingLinearElement.elementId!==selectedElements[0].id)){_this.history.resumeRecording();_this.setState({editingLinearElement:new LinearElementEditor(selectedElements[0],_this.scene)});return;}else if(_this.state.editingLinearElement&&_this.state.editingLinearElement.elementId===selectedElements[0].id){return;}}resetCursor(_this.canvas);var _viewportCoordsToScen3=viewportCoordsToSceneCoords(event,_this.state),sceneX=_viewportCoordsToScen3.x,sceneY=_viewportCoordsToScen3.y;var selectedGroupIds=getSelectedGroupIds(_this.state);if(selectedGroupIds.length>0){var hitElement=_this.getElementAtPosition(sceneX,sceneY);var selectedGroupId=hitElement&&getSelectedGroupIdForElement(hitElement,_this.state.selectedGroupIds);if(selectedGroupId){_this.setState(function(prevState){return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{editingGroupId:selectedGroupId,selectedElementIds:_defineProperty({},hitElement.id,true),selectedGroupIds:{}}),_this.scene.getNonDeletedElements(),prevState,_assertThisInitialized(_this));});return;}}resetCursor(_this.canvas);if(!event[KEYS.CTRL_OR_CMD]&&!_this.state.viewModeEnabled){var container=getTextBindableContainerAtPosition(_this.scene.getNonDeletedElements(),_this.state,sceneX,sceneY);if(container){if(hasBoundTextElement(container)||!isTransparent(container.backgroundColor)||isHittingElementNotConsideringBoundingBox(container,_this.state,_this.frameNameBoundsCache,[sceneX,sceneY])){var midPoint=getContainerCenter(container,_this.state);sceneX=midPoint.x;sceneY=midPoint.y;}}_this.startTextEditing({sceneX:sceneX,sceneY:sceneY,insertAtParentCenter:!event.altKey,container:container});}};_this.getElementLinkAtPosition=function(scenePointer,hitElement){// Reversing so we traverse the elements in decreasing order\n// of z-index\nvar elements=_this.scene.getNonDeletedElements().slice().reverse();var hitElementIndex=Infinity;return elements.find(function(element,index){if(hitElement&&element.id===hitElement.id){hitElementIndex=index;}return element.link&&index<=hitElementIndex&&isPointHittingLinkIcon(element,_this.state,[scenePointer.x,scenePointer.y],_this.device.isMobile);});};_this.redirectToLink=function(event,isTouchScreen){var draggedDistance=distance2d(_this.lastPointerDown.clientX,_this.lastPointerDown.clientY,_this.lastPointerUp.clientX,_this.lastPointerUp.clientY);if(!_this.hitLinkElement||// For touch screen allow dragging threshold else strict check\nisTouchScreen&&draggedDistance>DRAGGING_THRESHOLD||!isTouchScreen&&draggedDistance!==0){return;}var lastPointerDownCoords=viewportCoordsToSceneCoords(_this.lastPointerDown,_this.state);var lastPointerDownHittingLinkIcon=isPointHittingLinkIcon(_this.hitLinkElement,_this.state,[lastPointerDownCoords.x,lastPointerDownCoords.y],_this.device.isMobile);var lastPointerUpCoords=viewportCoordsToSceneCoords(_this.lastPointerUp,_this.state);var lastPointerUpHittingLinkIcon=isPointHittingLinkIcon(_this.hitLinkElement,_this.state,[lastPointerUpCoords.x,lastPointerUpCoords.y],_this.device.isMobile);if(lastPointerDownHittingLinkIcon&&lastPointerUpHittingLinkIcon){var url=_this.hitLinkElement.link;if(url){var _customEvent;url=normalizeLink(url);var customEvent;if(_this.props.onLinkOpen){customEvent=wrapEvent(EVENT.EXCALIDRAW_LINK,event.nativeEvent);_this.props.onLinkOpen(_objectSpread(_objectSpread({},_this.hitLinkElement),{},{link:url}),customEvent);}if(!((_customEvent=customEvent)!==null&&_customEvent!==void 0&&_customEvent.defaultPrevented)){var target=isLocalLink(url)?\"_self\":\"_blank\";var newWindow=window.open(undefined,target);// https://mathiasbynens.github.io/rel-noopener/\nif(newWindow){newWindow.opener=null;newWindow.location=url;}}}}};_this.getTopLayerFrameAtSceneCoords=function(sceneCoords){var frames=_this.scene.getNonDeletedFrames().filter(function(frame){return isCursorInFrame(sceneCoords,frame);});return frames.length?frames[frames.length-1]:null;};_this.handleCanvasPointerMove=function(event){_this.savePointer(event.clientX,event.clientY,_this.state.cursorButton);if(gesture.pointers.has(event.pointerId)){gesture.pointers.set(event.pointerId,{x:event.clientX,y:event.clientY});}var initialScale=gesture.initialScale;if(gesture.pointers.size===2&&gesture.lastCenter&&initialScale&&gesture.initialDistance){var center=getCenter(gesture.pointers);var deltaX=center.x-gesture.lastCenter.x;var deltaY=center.y-gesture.lastCenter.y;gesture.lastCenter=center;var _distance=getDistance(Array.from(gesture.pointers.values()));var scaleFactor=_this.state.activeTool.type===\"freedraw\"&&_this.state.penMode?1:_distance/gesture.initialDistance;var nextZoom=scaleFactor?getNormalizedZoom(initialScale*scaleFactor):_this.state.zoom.value;_this.setState(function(state){var zoomState=getStateForZoom({viewportX:center.x,viewportY:center.y,nextZoom:nextZoom},state);_this.translateCanvas({zoom:zoomState.zoom,scrollX:zoomState.scrollX+deltaX/nextZoom,scrollY:zoomState.scrollY+deltaY/nextZoom,shouldCacheIgnoreZoom:true});});_this.resetShouldCacheIgnoreZoomDebounced();}else{gesture.lastCenter=gesture.initialDistance=gesture.initialScale=null;}if(isHoldingSpace||isPanning||isDraggingScrollBar||isHandToolActive(_this.state)){return;}var isPointerOverScrollBars=isOverScrollBars(currentScrollBars,event.clientX-_this.state.offsetLeft,event.clientY-_this.state.offsetTop);var isOverScrollBar=isPointerOverScrollBars.isOverEither;if(!_this.state.draggingElement&&!_this.state.multiElement){if(isOverScrollBar){resetCursor(_this.canvas);}else{setCursorForShape(_this.canvas,_this.state);}}var scenePointer=viewportCoordsToSceneCoords(event,_this.state);var scenePointerX=scenePointer.x,scenePointerY=scenePointer.y;if(_this.state.editingLinearElement&&!_this.state.editingLinearElement.isDragging){var editingLinearElement=LinearElementEditor.handlePointerMove(event,scenePointerX,scenePointerY,_this.state);if(editingLinearElement&&editingLinearElement!==_this.state.editingLinearElement){// Since we are reading from previous state which is not possible with\n// automatic batching in React 18 hence using flush sync to synchronously\n// update the state. Check https://github.com/excalidraw/excalidraw/pull/5508 for more details.\nflushSync(function(){_this.setState({editingLinearElement:editingLinearElement});});}if((editingLinearElement===null||editingLinearElement===void 0?void 0:editingLinearElement.lastUncommittedPoint)!=null){_this.maybeSuggestBindingAtCursor(scenePointer);}else{// causes stack overflow if not sync\nflushSync(function(){_this.setState({suggestedBindings:[]});});}}if(isBindingElementType(_this.state.activeTool.type)){// Hovering with a selected tool or creating new linear element via click\n// and point\nvar draggingElement=_this.state.draggingElement;if(isBindingElement(draggingElement,false)){_this.maybeSuggestBindingsForLinearElementAtCoords(draggingElement,[scenePointer],_this.state.startBoundElement);}else{_this.maybeSuggestBindingAtCursor(scenePointer);}}if(_this.state.multiElement){var multiElement=_this.state.multiElement;var rx=multiElement.x,ry=multiElement.y;var points=multiElement.points,lastCommittedPoint=multiElement.lastCommittedPoint;var lastPoint=points[points.length-1];setCursorForShape(_this.canvas,_this.state);if(lastPoint===lastCommittedPoint){// if we haven't yet created a temp point and we're beyond commit-zone\n// threshold, add a point\nif(distance2d(scenePointerX-rx,scenePointerY-ry,lastPoint[0],lastPoint[1])>=LINE_CONFIRM_THRESHOLD){mutateElement(multiElement,{points:[].concat(_toConsumableArray(points),[[scenePointerX-rx,scenePointerY-ry]])});}else{setCursor(_this.canvas,CURSOR_TYPE.POINTER);// in this branch, we're inside the commit zone, and no uncommitted\n// point exists. Thus do nothing (don't add/remove points).\n}}else if(points.length>2&&lastCommittedPoint&&distance2d(scenePointerX-rx,scenePointerY-ry,lastCommittedPoint[0],lastCommittedPoint[1])<LINE_CONFIRM_THRESHOLD){setCursor(_this.canvas,CURSOR_TYPE.POINTER);mutateElement(multiElement,{points:points.slice(0,-1)});}else{var _multiElement$lastCom;var _getGridPoint3=getGridPoint(scenePointerX,scenePointerY,_this.state.gridSize),_getGridPoint4=_slicedToArray(_getGridPoint3,2),gridX=_getGridPoint4[0],gridY=_getGridPoint4[1];var _ref11=(_multiElement$lastCom=multiElement===null||multiElement===void 0?void 0:multiElement.lastCommittedPoint)!==null&&_multiElement$lastCom!==void 0?_multiElement$lastCom:[0,0],_ref12=_slicedToArray(_ref11,2),lastCommittedX=_ref12[0],lastCommittedY=_ref12[1];var dxFromLastCommitted=gridX-rx-lastCommittedX;var dyFromLastCommitted=gridY-ry-lastCommittedY;if(shouldRotateWithDiscreteAngle(event)){var _getLockedLinearCurso=getLockedLinearCursorAlignSize(// actual coordinate of the last committed point\nlastCommittedX+rx,lastCommittedY+ry,// cursor-grid coordinate\ngridX,gridY);dxFromLastCommitted=_getLockedLinearCurso.width;dyFromLastCommitted=_getLockedLinearCurso.height;}if(isPathALoop(points,_this.state.zoom.value)){setCursor(_this.canvas,CURSOR_TYPE.POINTER);}// update last uncommitted point\nmutateElement(multiElement,{points:[].concat(_toConsumableArray(points.slice(0,-1)),[[lastCommittedX+dxFromLastCommitted,lastCommittedY+dyFromLastCommitted]])});}return;}var hasDeselectedButton=Boolean(event.buttons);if(hasDeselectedButton||_this.state.activeTool.type!==\"selection\"&&_this.state.activeTool.type!==\"text\"&&_this.state.activeTool.type!==\"eraser\"){return;}var elements=_this.scene.getNonDeletedElements();var selectedElements=_this.scene.getSelectedElements(_this.state);if(selectedElements.length===1&&!isOverScrollBar&&!_this.state.editingLinearElement){var elementWithTransformHandleType=getElementWithTransformHandleType(elements,_this.state,scenePointerX,scenePointerY,_this.state.zoom,event.pointerType);if(elementWithTransformHandleType&&elementWithTransformHandleType.transformHandleType){setCursor(_this.canvas,getCursorForResizingElement(elementWithTransformHandleType));return;}}else if(selectedElements.length>1&&!isOverScrollBar){var transformHandleType=getTransformHandleTypeFromCoords(getCommonBounds(selectedElements),scenePointerX,scenePointerY,_this.state.zoom,event.pointerType);if(transformHandleType){setCursor(_this.canvas,getCursorForResizingElement({transformHandleType:transformHandleType}));return;}}var hitElement=_this.getElementAtPosition(scenePointer.x,scenePointer.y);_this.hitLinkElement=_this.getElementLinkAtPosition(scenePointer,hitElement);if(isEraserActive(_this.state)){return;}if(_this.hitLinkElement&&!_this.state.selectedElementIds[_this.hitLinkElement.id]){setCursor(_this.canvas,CURSOR_TYPE.POINTER);showHyperlinkTooltip(_this.hitLinkElement,_this.state);}else{hideHyperlinkToolip();if(hitElement&&hitElement.link&&_this.state.selectedElementIds[hitElement.id]&&!_this.state.contextMenu&&!_this.state.showHyperlinkPopup){_this.setState({showHyperlinkPopup:\"info\"});}else if(_this.state.activeTool.type===\"text\"){setCursor(_this.canvas,isTextElement(hitElement)?CURSOR_TYPE.TEXT:CURSOR_TYPE.CROSSHAIR);}else if(_this.state.viewModeEnabled){setCursor(_this.canvas,CURSOR_TYPE.GRAB);}else if(isOverScrollBar){setCursor(_this.canvas,CURSOR_TYPE.AUTO);}else if(_this.state.selectedLinearElement){_this.handleHoverSelectedLinearElement(_this.state.selectedLinearElement,scenePointerX,scenePointerY);}else if(// if using cmd/ctrl, we're not dragging\n!event[KEYS.CTRL_OR_CMD]){if((hitElement||_this.isHittingCommonBoundingBoxOfSelectedElements(scenePointer,selectedElements))&&!(hitElement!==null&&hitElement!==void 0&&hitElement.locked)){setCursor(_this.canvas,CURSOR_TYPE.MOVE);}}else{setCursor(_this.canvas,CURSOR_TYPE.AUTO);}}};_this.handleEraser=function(event,pointerDownState,scenePointer){var updateElementIds=function updateElementIds(elements){elements.forEach(function(element){if(element.locked){return;}idsToUpdate.push(element.id);if(event.altKey){if(pointerDownState.elementIdsToErase[element.id]&&pointerDownState.elementIdsToErase[element.id].erase){pointerDownState.elementIdsToErase[element.id].erase=false;}}else if(!pointerDownState.elementIdsToErase[element.id]){pointerDownState.elementIdsToErase[element.id]={erase:true,opacity:element.opacity};}});};var idsToUpdate=[];var distance=distance2d(pointerDownState.lastCoords.x,pointerDownState.lastCoords.y,scenePointer.x,scenePointer.y);var threshold=10/_this.state.zoom.value;var point=_objectSpread({},pointerDownState.lastCoords);var samplingInterval=0;while(samplingInterval<=distance){var hitElements=_this.getElementsAtPosition(point.x,point.y);updateElementIds(hitElements);// Exit since we reached current point\nif(samplingInterval===distance){break;}// Calculate next point in the line at a distance of sampling interval\nsamplingInterval=Math.min(samplingInterval+threshold,distance);var distanceRatio=samplingInterval/distance;var nextX=(1-distanceRatio)*point.x+distanceRatio*scenePointer.x;var nextY=(1-distanceRatio)*point.y+distanceRatio*scenePointer.y;point.x=nextX;point.y=nextY;}var elements=_this.scene.getElementsIncludingDeleted().map(function(ele){var id=isBoundToContainer(ele)&&idsToUpdate.includes(ele.containerId)?ele.containerId:ele.id;if(idsToUpdate.includes(id)){if(event.altKey){if(pointerDownState.elementIdsToErase[id]&&pointerDownState.elementIdsToErase[id].erase===false){return newElementWith(ele,{opacity:pointerDownState.elementIdsToErase[id].opacity});}}else{return newElementWith(ele,{opacity:ELEMENT_READY_TO_ERASE_OPACITY});}}return ele;});_this.scene.replaceAllElements(elements);pointerDownState.lastCoords.x=scenePointer.x;pointerDownState.lastCoords.y=scenePointer.y;};// set touch moving for mobile context menu\n_this.handleTouchMove=function(event){invalidateContextMenu=true;};_this.handleCanvasPointerDown=function(event){var _this$props,_this$props$onPointer;// since contextMenu options are potentially evaluated on each render,\n// and an contextMenu action may depend on selection state, we must\n// close the contextMenu before we update the selection on pointerDown\n// (e.g. resetting selection)\nif(_this.state.contextMenu){_this.setState({contextMenu:null});}_this.updateGestureOnPointerDown(event);// if dragging element is freedraw and another pointerdown event occurs\n// a second finger is on the screen\n// discard the freedraw element if it is very short because it is likely\n// just a spike, otherwise finalize the freedraw element when the second\n// finger is lifted\nif(event.pointerType===\"touch\"&&_this.state.draggingElement&&_this.state.draggingElement.type===\"freedraw\"){var element=_this.state.draggingElement;_this.updateScene(_objectSpread(_objectSpread({},element.points.length<10?{elements:_this.scene.getElementsIncludingDeleted().filter(function(el){return el.id!==element.id;})}:{}),{},{appState:{draggingElement:null,editingElement:null,startBoundElement:null,suggestedBindings:[],selectedElementIds:makeNextSelectedElementIds(Object.keys(_this.state.selectedElementIds).filter(function(key){return key!==element.id;}).reduce(function(obj,key){obj[key]=_this.state.selectedElementIds[key];return obj;},{}),_this.state)}}));return;}// remove any active selection when we start to interact with canvas\n// (mainly, we care about removing selection outside the component which\n//  would prevent our copy handling otherwise)\nvar selection=document.getSelection();if(selection!==null&&selection!==void 0&&selection.anchorNode){selection.removeAllRanges();}_this.maybeOpenContextMenuAfterPointerDownOnTouchDevices(event);_this.maybeCleanupAfterMissingPointerUp(event);//fires only once, if pen is detected, penMode is enabled\n//the user can disable this by toggling the penMode button\nif(!_this.state.penDetected&&event.pointerType===\"pen\"){_this.setState(function(prevState){return{penMode:true,penDetected:true};});}if(!_this.device.isTouchScreen&&[\"pen\",\"touch\"].includes(event.pointerType)){_this.device=updateObject(_this.device,{isTouchScreen:true});}if(isPanning){return;}_this.lastPointerDown=event;_this.setState({lastPointerDownWith:event.pointerType,cursorButton:\"down\"});_this.savePointer(event.clientX,event.clientY,\"down\");if(_this.handleCanvasPanUsingWheelOrSpaceDrag(event)){return;}// only handle left mouse button or touch\nif(event.button!==POINTER_BUTTON.MAIN&&event.button!==POINTER_BUTTON.TOUCH){return;}// don't select while panning\nif(gesture.pointers.size>1){return;}// State for the duration of a pointer interaction, which starts with a\n// pointerDown event, ends with a pointerUp event (or another pointerDown)\nvar pointerDownState=_this.initialPointerDownState(event);_this.setState({selectedElementsAreBeingDragged:false});if(_this.handleDraggingScrollBar(event,pointerDownState)){return;}_this.clearSelectionIfNotUsingSelection();_this.updateBindingEnabledOnPointerMove(event);if(_this.handleSelectionOnPointerDown(event,pointerDownState)){return;}var allowOnPointerDown=!_this.state.penMode||event.pointerType!==\"touch\"||_this.state.activeTool.type===\"selection\"||_this.state.activeTool.type===\"text\"||_this.state.activeTool.type===\"image\";if(!allowOnPointerDown){return;}if(_this.state.activeTool.type===\"text\"){_this.handleTextOnPointerDown(event,pointerDownState);return;}else if(_this.state.activeTool.type===\"arrow\"||_this.state.activeTool.type===\"line\"){_this.handleLinearElementOnPointerDown(event,_this.state.activeTool.type,pointerDownState);}else if(_this.state.activeTool.type===\"image\"){// reset image preview on pointerdown\nsetCursor(_this.canvas,CURSOR_TYPE.CROSSHAIR);// retrieve the latest element as the state may be stale\nvar pendingImageElement=_this.state.pendingImageElementId&&_this.scene.getElement(_this.state.pendingImageElementId);if(!pendingImageElement){return;}_this.setState({draggingElement:pendingImageElement,editingElement:pendingImageElement,pendingImageElementId:null,multiElement:null});var _viewportCoordsToScen4=viewportCoordsToSceneCoords(event,_this.state),x=_viewportCoordsToScen4.x,y=_viewportCoordsToScen4.y;mutateElement(pendingImageElement,{x:x,y:y});}else if(_this.state.activeTool.type===\"freedraw\"){_this.handleFreeDrawElementOnPointerDown(event,_this.state.activeTool.type,pointerDownState);}else if(_this.state.activeTool.type===\"custom\"){setCursor(_this.canvas,CURSOR_TYPE.AUTO);}else if(_this.state.activeTool.type===\"frame\"){_this.createFrameElementOnPointerDown(pointerDownState);}else if(_this.state.activeTool.type!==\"eraser\"&&_this.state.activeTool.type!==\"hand\"){_this.createGenericElementOnPointerDown(_this.state.activeTool.type,pointerDownState);}(_this$props=_this.props)===null||_this$props===void 0?void 0:(_this$props$onPointer=_this$props.onPointerDown)===null||_this$props$onPointer===void 0?void 0:_this$props$onPointer.call(_this$props,_this.state.activeTool,pointerDownState);var onPointerMove=_this.onPointerMoveFromPointerDownHandler(pointerDownState);var onPointerUp=_this.onPointerUpFromPointerDownHandler(pointerDownState);var onKeyDown=_this.onKeyDownFromPointerDownHandler(pointerDownState);var onKeyUp=_this.onKeyUpFromPointerDownHandler(pointerDownState);_lastPointerUp=onPointerUp;if(!_this.state.viewModeEnabled){window.addEventListener(EVENT.POINTER_MOVE,onPointerMove);window.addEventListener(EVENT.POINTER_UP,onPointerUp);window.addEventListener(EVENT.KEYDOWN,onKeyDown);window.addEventListener(EVENT.KEYUP,onKeyUp);pointerDownState.eventListeners.onMove=onPointerMove;pointerDownState.eventListeners.onUp=onPointerUp;pointerDownState.eventListeners.onKeyUp=onKeyUp;pointerDownState.eventListeners.onKeyDown=onKeyDown;}};_this.handleCanvasPointerUp=function(event){_this.lastPointerUp=event;if(_this.device.isTouchScreen){var scenePointer=viewportCoordsToSceneCoords({clientX:event.clientX,clientY:event.clientY},_this.state);var hitElement=_this.getElementAtPosition(scenePointer.x,scenePointer.y);_this.hitLinkElement=_this.getElementLinkAtPosition(scenePointer,hitElement);}if(_this.hitLinkElement&&!_this.state.selectedElementIds[_this.hitLinkElement.id]){_this.redirectToLink(event,_this.device.isTouchScreen);}_this.removePointer(event);};_this.maybeOpenContextMenuAfterPointerDownOnTouchDevices=function(event){// deal with opening context menu on touch devices\nif(event.pointerType===\"touch\"){invalidateContextMenu=false;if(touchTimeout){// If there's already a touchTimeout, this means that there's another\n// touch down and we are doing another touch, so we shouldn't open the\n// context menu.\ninvalidateContextMenu=true;}else{// open the context menu with the first touch's clientX and clientY\n// if the touch is not moving\ntouchTimeout=window.setTimeout(function(){touchTimeout=0;if(!invalidateContextMenu){_this.handleCanvasContextMenu(event);}},TOUCH_CTX_MENU_TIMEOUT);}}};_this.resetContextMenuTimer=function(){clearTimeout(touchTimeout);touchTimeout=0;invalidateContextMenu=false;};// Returns whether the event is a panning\n_this.handleCanvasPanUsingWheelOrSpaceDrag=function(event){if(!(gesture.pointers.size<=1&&(event.button===POINTER_BUTTON.WHEEL||event.button===POINTER_BUTTON.MAIN&&isHoldingSpace||isHandToolActive(_this.state)||_this.state.viewModeEnabled))||isTextElement(_this.state.editingElement)){return false;}isPanning=true;event.preventDefault();var nextPastePrevented=false;var isLinux=/Linux/.test(window.navigator.platform);setCursor(_this.canvas,CURSOR_TYPE.GRABBING);var lastX=event.clientX,lastY=event.clientY;var onPointerMove=withBatchedUpdatesThrottled(function(event){var deltaX=lastX-event.clientX;var deltaY=lastY-event.clientY;lastX=event.clientX;lastY=event.clientY;/*\n       * Prevent paste event if we move while middle clicking on Linux.\n       * See issue #1383.\n       */if(isLinux&&!nextPastePrevented&&(Math.abs(deltaX)>1||Math.abs(deltaY)>1)){nextPastePrevented=true;/* Prevent the next paste event */var preventNextPaste=function preventNextPaste(event){document.body.removeEventListener(EVENT.PASTE,preventNextPaste);event.stopPropagation();};/*\n         * Reenable next paste in case of disabled middle click paste for\n         * any reason:\n         * - right click paste\n         * - empty clipboard\n         */var enableNextPaste=function enableNextPaste(){setTimeout(function(){document.body.removeEventListener(EVENT.PASTE,preventNextPaste);window.removeEventListener(EVENT.POINTER_UP,enableNextPaste);},100);};document.body.addEventListener(EVENT.PASTE,preventNextPaste);window.addEventListener(EVENT.POINTER_UP,enableNextPaste);}_this.translateCanvas({scrollX:_this.state.scrollX-deltaX/_this.state.zoom.value,scrollY:_this.state.scrollY-deltaY/_this.state.zoom.value});});var teardown=withBatchedUpdates(_lastPointerUp=function lastPointerUp(){_lastPointerUp=null;isPanning=false;if(!isHoldingSpace){if(_this.state.viewModeEnabled){setCursor(_this.canvas,CURSOR_TYPE.GRAB);}else{setCursorForShape(_this.canvas,_this.state);}}_this.setState({cursorButton:\"up\"});_this.savePointer(event.clientX,event.clientY,\"up\");window.removeEventListener(EVENT.POINTER_MOVE,onPointerMove);window.removeEventListener(EVENT.POINTER_UP,teardown);window.removeEventListener(EVENT.BLUR,teardown);onPointerMove.flush();});window.addEventListener(EVENT.BLUR,teardown);window.addEventListener(EVENT.POINTER_MOVE,onPointerMove,{passive:true});window.addEventListener(EVENT.POINTER_UP,teardown);return true;};_this.clearSelectionIfNotUsingSelection=function(){if(_this.state.activeTool.type!==\"selection\"){_this.setState({selectedElementIds:makeNextSelectedElementIds({},_this.state),selectedGroupIds:{},editingGroupId:null});}};/**\n   * @returns whether the pointer event has been completely handled\n   */_this.handleSelectionOnPointerDown=function(event,pointerDownState){if(_this.state.activeTool.type===\"selection\"){var elements=_this.scene.getNonDeletedElements();var selectedElements=_this.scene.getSelectedElements(_this.state);if(selectedElements.length===1&&!_this.state.editingLinearElement){var elementWithTransformHandleType=getElementWithTransformHandleType(elements,_this.state,pointerDownState.origin.x,pointerDownState.origin.y,_this.state.zoom,event.pointerType);if(elementWithTransformHandleType!=null){_this.setState({resizingElement:elementWithTransformHandleType.element});pointerDownState.resize.handleType=elementWithTransformHandleType.transformHandleType;}}else if(selectedElements.length>1){pointerDownState.resize.handleType=getTransformHandleTypeFromCoords(getCommonBounds(selectedElements),pointerDownState.origin.x,pointerDownState.origin.y,_this.state.zoom,event.pointerType);}if(pointerDownState.resize.handleType){pointerDownState.resize.isResizing=true;pointerDownState.resize.offset=tupleToCoors(getResizeOffsetXY(pointerDownState.resize.handleType,selectedElements,pointerDownState.origin.x,pointerDownState.origin.y));if(selectedElements.length===1&&isLinearElement(selectedElements[0])&&selectedElements[0].points.length===2){pointerDownState.resize.arrowDirection=getResizeArrowDirection(pointerDownState.resize.handleType,selectedElements[0]);}}else{var _pointerDownState$hit;if(_this.state.selectedLinearElement){var linearElementEditor=_this.state.editingLinearElement||_this.state.selectedLinearElement;var ret=LinearElementEditor.handlePointerDown(event,_this.state,_this.history,pointerDownState.origin,linearElementEditor);if(ret.hitElement){pointerDownState.hit.element=ret.hitElement;}if(ret.linearElementEditor){_this.setState({selectedLinearElement:ret.linearElementEditor});if(_this.state.editingLinearElement){_this.setState({editingLinearElement:ret.linearElementEditor});}}if(ret.didAddPoint){return true;}}// hitElement may already be set above, so check first\npointerDownState.hit.element=(_pointerDownState$hit=pointerDownState.hit.element)!==null&&_pointerDownState$hit!==void 0?_pointerDownState$hit:_this.getElementAtPosition(pointerDownState.origin.x,pointerDownState.origin.y);if(pointerDownState.hit.element){// Early return if pointer is hitting link icon\nvar hitLinkElement=_this.getElementLinkAtPosition({x:pointerDownState.origin.x,y:pointerDownState.origin.y},pointerDownState.hit.element);if(hitLinkElement){return false;}}// For overlapped elements one position may hit\n// multiple elements\npointerDownState.hit.allHitElements=_this.getElementsAtPosition(pointerDownState.origin.x,pointerDownState.origin.y);var hitElement=pointerDownState.hit.element;var someHitElementIsSelected=pointerDownState.hit.allHitElements.some(function(element){return _this.isASelectedElement(element);});if((hitElement===null||!someHitElementIsSelected)&&!event.shiftKey&&!pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements){_this.clearSelection(hitElement);}if(_this.state.editingLinearElement){_this.setState({selectedElementIds:makeNextSelectedElementIds(_defineProperty({},_this.state.editingLinearElement.elementId,true),_this.state)});// If we click on something\n}else if(hitElement!=null){// on CMD/CTRL, drill down to hit element regardless of groups etc.\nif(event[KEYS.CTRL_OR_CMD]){if(!_this.state.selectedElementIds[hitElement.id]){pointerDownState.hit.wasAddedToSelection=true;}_this.setState(function(prevState){return _objectSpread(_objectSpread({},editGroupForSelectedElement(prevState,hitElement)),{},{previousSelectedElementIds:_this.state.selectedElementIds});});// mark as not completely handled so as to allow dragging etc.\nreturn false;}// deselect if item is selected\n// if shift is not clicked, this will always return true\n// otherwise, it will trigger selection based on current\n// state of the box\nif(!_this.state.selectedElementIds[hitElement.id]){// if we are currently editing a group, exiting editing mode and deselect the group.\nif(_this.state.editingGroupId&&!isElementInGroup(hitElement,_this.state.editingGroupId)){_this.setState({selectedElementIds:makeNextSelectedElementIds({},_this.state),selectedGroupIds:{},editingGroupId:null});}// Add hit element to selection. At this point if we're not holding\n// SHIFT the previously selected element(s) were deselected above\n// (make sure you use setState updater to use latest state)\n// With shift-selection, we want to make sure that frames and their containing\n// elements are not selected at the same time.\nif(!someHitElementIsSelected&&!pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements){_this.setState(function(prevState){var nextSelectedElementIds=_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},hitElement.id,true));var previouslySelectedElements=[];Object.keys(prevState.selectedElementIds).forEach(function(id){var element=_this.scene.getElement(id);element&&previouslySelectedElements.push(element);});// if hitElement is frame, deselect all of its elements if they are selected\nif(hitElement.type===\"frame\"){getFrameElements(previouslySelectedElements,hitElement.id).forEach(function(element){delete nextSelectedElementIds[element.id];});}else if(hitElement.frameId){// if hitElement is in a frame and its frame has been selected\n// disable selection for the given element\nif(nextSelectedElementIds[hitElement.frameId]){delete nextSelectedElementIds[hitElement.id];}}else{// hitElement is neither a frame nor an element in a frame\n// but since hitElement could be in a group with some frames\n// this means selecting hitElement will have the frames selected as well\n// because we want to keep the invariant:\n// - frames and their elements are not selected at the same time\n// we deselect elements in those frames that were previously selected\nvar groupIds=hitElement.groupIds;var framesInGroups=new Set(groupIds.flatMap(function(gid){return getElementsInGroup(_this.scene.getNonDeletedElements(),gid);}).filter(function(element){return element.type===\"frame\";}).map(function(frame){return frame.id;}));if(framesInGroups.size>0){previouslySelectedElements.forEach(function(element){if(element.frameId&&framesInGroups.has(element.frameId)){// deselect element and groups containing the element\ndelete nextSelectedElementIds[element.id];element.groupIds.flatMap(function(gid){return getElementsInGroup(_this.scene.getNonDeletedElements(),gid);}).forEach(function(element){delete nextSelectedElementIds[element.id];});}});}}return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:nextSelectedElementIds,showHyperlinkPopup:hitElement.link?\"info\":false}),_this.scene.getNonDeletedElements(),prevState,_assertThisInitialized(_this));});pointerDownState.hit.wasAddedToSelection=true;}}}_this.setState({previousSelectedElementIds:_this.state.selectedElementIds});}}return false;};_this.handleTextOnPointerDown=function(event,pointerDownState){// if we're currently still editing text, clicking outside\n// should only finalize it, not create another (irrespective\n// of state.activeTool.locked)\nif(isTextElement(_this.state.editingElement)){return;}var sceneX=pointerDownState.origin.x;var sceneY=pointerDownState.origin.y;var element=_this.getElementAtPosition(sceneX,sceneY,{includeBoundTextElement:true});var container=getTextBindableContainerAtPosition(_this.scene.getNonDeletedElements(),_this.state,sceneX,sceneY);if(hasBoundTextElement(element)){container=element;sceneX=element.x+element.width/2;sceneY=element.y+element.height/2;}_this.startTextEditing({sceneX:sceneX,sceneY:sceneY,insertAtParentCenter:!event.altKey,container:container});resetCursor(_this.canvas);if(!_this.state.activeTool.locked){_this.setState({activeTool:updateActiveTool(_this.state,{type:\"selection\"})});}};_this.handleFreeDrawElementOnPointerDown=function(event,elementType,pointerDownState){// Begin a mark capture. This does not have to update state yet.\nvar _getGridPoint5=getGridPoint(pointerDownState.origin.x,pointerDownState.origin.y,null),_getGridPoint6=_slicedToArray(_getGridPoint5,2),gridX=_getGridPoint6[0],gridY=_getGridPoint6[1];var topLayerFrame=_this.getTopLayerFrameAtSceneCoords({x:gridX,y:gridY});var element=newFreeDrawElement({type:elementType,x:gridX,y:gridY,strokeColor:_this.state.currentItemStrokeColor,backgroundColor:_this.state.currentItemBackgroundColor,fillStyle:_this.state.currentItemFillStyle,strokeWidth:_this.state.currentItemStrokeWidth,strokeStyle:_this.state.currentItemStrokeStyle,roughness:_this.state.currentItemRoughness,opacity:_this.state.currentItemOpacity,roundness:null,simulatePressure:event.pressure===0.5,locked:false,frameId:topLayerFrame?topLayerFrame.id:null});_this.setState(function(prevState){var nextSelectedElementIds=_objectSpread({},prevState.selectedElementIds);delete nextSelectedElementIds[element.id];return{selectedElementIds:makeNextSelectedElementIds(nextSelectedElementIds,prevState)};});var pressures=element.simulatePressure?element.pressures:[].concat(_toConsumableArray(element.pressures),[event.pressure]);mutateElement(element,{points:[[0,0]],pressures:pressures});var boundElement=getHoveredElementForBinding(pointerDownState.origin,_this.scene);_this.scene.addNewElement(element);_this.setState({draggingElement:element,editingElement:element,startBoundElement:boundElement,suggestedBindings:[]});};_this.createImageElement=function(_ref13){var sceneX=_ref13.sceneX,sceneY=_ref13.sceneY;var _getGridPoint7=getGridPoint(sceneX,sceneY,_this.state.gridSize),_getGridPoint8=_slicedToArray(_getGridPoint7,2),gridX=_getGridPoint8[0],gridY=_getGridPoint8[1];var topLayerFrame=_this.getTopLayerFrameAtSceneCoords({x:gridX,y:gridY});var element=newImageElement({type:\"image\",x:gridX,y:gridY,strokeColor:_this.state.currentItemStrokeColor,backgroundColor:_this.state.currentItemBackgroundColor,fillStyle:_this.state.currentItemFillStyle,strokeWidth:_this.state.currentItemStrokeWidth,strokeStyle:_this.state.currentItemStrokeStyle,roughness:_this.state.currentItemRoughness,roundness:null,opacity:_this.state.currentItemOpacity,locked:false,frameId:topLayerFrame?topLayerFrame.id:null});return element;};_this.handleLinearElementOnPointerDown=function(event,elementType,pointerDownState){if(_this.state.multiElement){var multiElement=_this.state.multiElement;// finalize if completing a loop\nif(multiElement.type===\"line\"&&isPathALoop(multiElement.points,_this.state.zoom.value)){mutateElement(multiElement,{lastCommittedPoint:multiElement.points[multiElement.points.length-1]});_this.actionManager.executeAction(actionFinalize);return;}var rx=multiElement.x,ry=multiElement.y,lastCommittedPoint=multiElement.lastCommittedPoint;// clicking inside commit zone  finalize arrow\nif(multiElement.points.length>1&&lastCommittedPoint&&distance2d(pointerDownState.origin.x-rx,pointerDownState.origin.y-ry,lastCommittedPoint[0],lastCommittedPoint[1])<LINE_CONFIRM_THRESHOLD){_this.actionManager.executeAction(actionFinalize);return;}_this.setState(function(prevState){return{selectedElementIds:makeNextSelectedElementIds(_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},multiElement.id,true)),prevState)};});// clicking outside commit zone  update reference for last committed\n// point\nmutateElement(multiElement,{lastCommittedPoint:multiElement.points[multiElement.points.length-1]});setCursor(_this.canvas,CURSOR_TYPE.POINTER);}else{var _getGridPoint9=getGridPoint(pointerDownState.origin.x,pointerDownState.origin.y,_this.state.gridSize),_getGridPoint10=_slicedToArray(_getGridPoint9,2),gridX=_getGridPoint10[0],gridY=_getGridPoint10[1];var topLayerFrame=_this.getTopLayerFrameAtSceneCoords({x:gridX,y:gridY});/* If arrow is pre-arrowheads, it will have undefined for both start and end arrowheads.\n      If so, we want it to be null for start and \"arrow\" for end. If the linear item is not\n      an arrow, we want it to be null for both. Otherwise, we want it to use the\n      values from appState. */var _this$state=_this.state,currentItemStartArrowhead=_this$state.currentItemStartArrowhead,currentItemEndArrowhead=_this$state.currentItemEndArrowhead;var _ref14=elementType===\"arrow\"?[currentItemStartArrowhead,currentItemEndArrowhead]:[null,null],_ref15=_slicedToArray(_ref14,2),startArrowhead=_ref15[0],endArrowhead=_ref15[1];var element=newLinearElement({type:elementType,x:gridX,y:gridY,strokeColor:_this.state.currentItemStrokeColor,backgroundColor:_this.state.currentItemBackgroundColor,fillStyle:_this.state.currentItemFillStyle,strokeWidth:_this.state.currentItemStrokeWidth,strokeStyle:_this.state.currentItemStrokeStyle,roughness:_this.state.currentItemRoughness,opacity:_this.state.currentItemOpacity,roundness:_this.state.currentItemRoundness===\"round\"?{type:ROUNDNESS.PROPORTIONAL_RADIUS}:null,startArrowhead:startArrowhead,endArrowhead:endArrowhead,locked:false,frameId:topLayerFrame?topLayerFrame.id:null});_this.setState(function(prevState){var nextSelectedElementIds=_objectSpread({},prevState.selectedElementIds);delete nextSelectedElementIds[element.id];return{selectedElementIds:makeNextSelectedElementIds(nextSelectedElementIds,prevState)};});mutateElement(element,{points:[].concat(_toConsumableArray(element.points),[[0,0]])});var boundElement=getHoveredElementForBinding(pointerDownState.origin,_this.scene);_this.scene.addNewElement(element);_this.setState({draggingElement:element,editingElement:element,startBoundElement:boundElement,suggestedBindings:[]});}};_this.createGenericElementOnPointerDown=function(elementType,pointerDownState){var _getGridPoint11=getGridPoint(pointerDownState.origin.x,pointerDownState.origin.y,_this.state.gridSize),_getGridPoint12=_slicedToArray(_getGridPoint11,2),gridX=_getGridPoint12[0],gridY=_getGridPoint12[1];var topLayerFrame=_this.getTopLayerFrameAtSceneCoords({x:gridX,y:gridY});var element=newElement({type:elementType,x:gridX,y:gridY,strokeColor:_this.state.currentItemStrokeColor,backgroundColor:_this.state.currentItemBackgroundColor,fillStyle:_this.state.currentItemFillStyle,strokeWidth:_this.state.currentItemStrokeWidth,strokeStyle:_this.state.currentItemStrokeStyle,roughness:_this.state.currentItemRoughness,opacity:_this.state.currentItemOpacity,roundness:_this.state.currentItemRoundness===\"round\"?{type:isUsingAdaptiveRadius(elementType)?ROUNDNESS.ADAPTIVE_RADIUS:ROUNDNESS.PROPORTIONAL_RADIUS}:null,locked:false,frameId:topLayerFrame?topLayerFrame.id:null});if(element.type===\"selection\"){_this.setState({selectionElement:element,draggingElement:element});}else{_this.scene.addNewElement(element);_this.setState({multiElement:null,draggingElement:element,editingElement:element});}};_this.createFrameElementOnPointerDown=function(pointerDownState){var _getGridPoint13=getGridPoint(pointerDownState.origin.x,pointerDownState.origin.y,_this.state.gridSize),_getGridPoint14=_slicedToArray(_getGridPoint13,2),gridX=_getGridPoint14[0],gridY=_getGridPoint14[1];var frame=newFrameElement(_objectSpread({x:gridX,y:gridY,opacity:_this.state.currentItemOpacity,locked:false},FRAME_STYLE));_this.scene.replaceAllElements([].concat(_toConsumableArray(_this.scene.getElementsIncludingDeleted()),[frame]));_this.setState({multiElement:null,draggingElement:frame,editingElement:frame});};_this.restoreReadyToEraseElements=function(pointerDownState){var elements=_this.scene.getElementsIncludingDeleted().map(function(ele){if(pointerDownState.elementIdsToErase[ele.id]&&pointerDownState.elementIdsToErase[ele.id].erase){return newElementWith(ele,{opacity:pointerDownState.elementIdsToErase[ele.id].opacity});}else if(isBoundToContainer(ele)&&pointerDownState.elementIdsToErase[ele.containerId]&&pointerDownState.elementIdsToErase[ele.containerId].erase){return newElementWith(ele,{opacity:pointerDownState.elementIdsToErase[ele.containerId].opacity});}else if(ele.frameId&&pointerDownState.elementIdsToErase[ele.frameId]&&pointerDownState.elementIdsToErase[ele.frameId].erase){return newElementWith(ele,{opacity:pointerDownState.elementIdsToErase[ele.frameId].opacity});}return ele;});_this.scene.replaceAllElements(elements);};_this.eraseElements=function(pointerDownState){var elements=_this.scene.getElementsIncludingDeleted().map(function(ele){if(pointerDownState.elementIdsToErase[ele.id]&&pointerDownState.elementIdsToErase[ele.id].erase){return newElementWith(ele,{isDeleted:true});}else if(isBoundToContainer(ele)&&pointerDownState.elementIdsToErase[ele.containerId]&&pointerDownState.elementIdsToErase[ele.containerId].erase){return newElementWith(ele,{isDeleted:true});}else if(ele.frameId&&pointerDownState.elementIdsToErase[ele.frameId]&&pointerDownState.elementIdsToErase[ele.frameId].erase){return newElementWith(ele,{isDeleted:true});}return ele;});_this.history.resumeRecording();_this.scene.replaceAllElements(elements);};_this.initializeImage=/*#__PURE__*/function(){var _ref17=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(_ref16){var _this$props$generateI,_this$props2,_this$files$fileId2;var imageFile,_imageElement,_ref16$showCursorImag,showCursorImagePreview,mimeType,fileId,existingFileData,_this$files$fileId,_dataURL,resizedFile,dataURL,imageElement;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:imageFile=_ref16.imageFile,_imageElement=_ref16.imageElement,_ref16$showCursorImag=_ref16.showCursorImagePreview,showCursorImagePreview=_ref16$showCursorImag===void 0?false:_ref16$showCursorImag;if(isSupportedImageFile(imageFile)){_context7.next=3;break;}throw new Error(t(\"errors.unsupportedFileType\"));case 3:mimeType=imageFile.type;setCursor(_this.canvas,\"wait\");if(!(mimeType===MIME_TYPES.svg)){_context7.next=23;break;}_context7.prev=6;_context7.t0=SVGStringToFile;_context7.t1=normalizeSVG;_context7.next=11;return imageFile.text();case 11:_context7.t2=_context7.sent;_context7.next=14;return(0,_context7.t1)(_context7.t2);case 14:_context7.t3=_context7.sent;_context7.t4=imageFile.name;imageFile=(0,_context7.t0)(_context7.t3,_context7.t4);_context7.next=23;break;case 19:_context7.prev=19;_context7.t5=_context7[\"catch\"](6);console.warn(_context7.t5);throw new Error(t(\"errors.svgImageInsertError\"));case 23:_context7.next=25;return((_this$props$generateI=(_this$props2=_this.props).generateIdForFile)===null||_this$props$generateI===void 0?void 0:_this$props$generateI.call(_this$props2,imageFile))||generateIdFromFile(imageFile);case 25:fileId=_context7.sent;if(fileId){_context7.next=29;break;}console.warn(\"Couldn't generate file id or the supplied `generateIdForFile` didn't resolve to one.\");throw new Error(t(\"errors.imageInsertError\"));case 29:existingFileData=_this.files[fileId];if(existingFileData!==null&&existingFileData!==void 0&&existingFileData.dataURL){_context7.next=42;break;}_context7.prev=31;_context7.next=34;return resizeImageFile(imageFile,{maxWidthOrHeight:DEFAULT_MAX_IMAGE_WIDTH_OR_HEIGHT});case 34:imageFile=_context7.sent;_context7.next=40;break;case 37:_context7.prev=37;_context7.t6=_context7[\"catch\"](31);console.error(\"error trying to resing image file on insertion\",_context7.t6);case 40:if(!(imageFile.size>MAX_ALLOWED_FILE_BYTES)){_context7.next=42;break;}throw new Error(t(\"errors.fileTooBig\",{maxSize:\"\".concat(Math.trunc(MAX_ALLOWED_FILE_BYTES/1024/1024),\"MB\")}));case 42:if(showCursorImagePreview){_dataURL=(_this$files$fileId=_this.files[fileId])===null||_this$files$fileId===void 0?void 0:_this$files$fileId.dataURL;// optimization so that we don't unnecessarily resize the original\n// full-size file for cursor preview\n// (it's much faster to convert the resized dataURL to File)\nresizedFile=_dataURL&&dataURLToFile(_dataURL);_this.setImagePreviewCursor(resizedFile||imageFile);}_context7.t7=(_this$files$fileId2=_this.files[fileId])===null||_this$files$fileId2===void 0?void 0:_this$files$fileId2.dataURL;if(_context7.t7){_context7.next=48;break;}_context7.next=47;return getDataURL(imageFile);case 47:_context7.t7=_context7.sent;case 48:dataURL=_context7.t7;imageElement=mutateElement(_imageElement,{fileId:fileId},false);return _context7.abrupt(\"return\",new Promise(/*#__PURE__*/function(){var _ref18=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(resolve,reject){var _this$state$draggingE,cachedImageData;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:_context6.prev=0;_this.files=_objectSpread(_objectSpread({},_this.files),{},_defineProperty({},fileId,{mimeType:mimeType,id:fileId,dataURL:dataURL,created:Date.now(),lastRetrieved:Date.now()}));cachedImageData=_this.imageCache.get(fileId);if(cachedImageData){_context6.next=7;break;}_this.addNewImagesToImageCache();_context6.next=7;return _this.updateImageCache([imageElement]);case 7:if(!((cachedImageData===null||cachedImageData===void 0?void 0:cachedImageData.image)instanceof Promise)){_context6.next=10;break;}_context6.next=10;return cachedImageData.image;case 10:if(_this.state.pendingImageElementId!==imageElement.id&&((_this$state$draggingE=_this.state.draggingElement)===null||_this$state$draggingE===void 0?void 0:_this$state$draggingE.id)!==imageElement.id){_this.initializeImageDimensions(imageElement,true);}resolve(imageElement);_context6.next=18;break;case 14:_context6.prev=14;_context6.t0=_context6[\"catch\"](0);console.error(_context6.t0);reject(new Error(t(\"errors.imageInsertError\")));case 18:_context6.prev=18;if(!showCursorImagePreview){resetCursor(_this.canvas);}return _context6.finish(18);case 21:case\"end\":return _context6.stop();}},_callee6,null,[[0,14,18,21]]);}));return function(_x6,_x7){return _ref18.apply(this,arguments);};}()));case 51:case\"end\":return _context7.stop();}},_callee7,null,[[6,19],[31,37]]);}));return function(_x5){return _ref17.apply(this,arguments);};}();/**\n   * inserts image into elements array and rerenders\n   */_this.insertImageElement=/*#__PURE__*/function(){var _ref19=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(imageElement,imageFile,showCursorImagePreview){return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:_this.scene.addNewElement(imageElement);_context8.prev=1;_context8.next=4;return _this.initializeImage({imageFile:imageFile,imageElement:imageElement,showCursorImagePreview:showCursorImagePreview});case 4:_context8.next=11;break;case 6:_context8.prev=6;_context8.t0=_context8[\"catch\"](1);mutateElement(imageElement,{isDeleted:true});_this.actionManager.executeAction(actionFinalize);_this.setState({errorMessage:_context8.t0.message||t(\"errors.imageInsertError\")});case 11:case\"end\":return _context8.stop();}},_callee8,null,[[1,6]]);}));return function(_x8,_x9,_x10){return _ref19.apply(this,arguments);};}();_this.setImagePreviewCursor=/*#__PURE__*/function(){var _ref20=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(imageFile){var cursorImageSizePx,imagePreview,previewDataURL,img,height,width,canvas,context;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:// mustn't be larger than 128 px\n// https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Basic_User_Interface/Using_URL_values_for_the_cursor_property\ncursorImageSizePx=96;_context9.next=3;return resizeImageFile(imageFile,{maxWidthOrHeight:cursorImageSizePx});case 3:imagePreview=_context9.sent;_context9.next=6;return getDataURL(imagePreview);case 6:previewDataURL=_context9.sent;if(!(imageFile.type===MIME_TYPES.svg)){_context9.next=20;break;}_context9.next=10;return loadHTMLImageElement(previewDataURL);case 10:img=_context9.sent;height=Math.min(img.height,cursorImageSizePx);width=height*(img.width/img.height);if(width>cursorImageSizePx){width=cursorImageSizePx;height=width*(img.height/img.width);}canvas=document.createElement(\"canvas\");canvas.height=height;canvas.width=width;context=canvas.getContext(\"2d\");context.drawImage(img,0,0,width,height);previewDataURL=canvas.toDataURL(MIME_TYPES.svg);case 20:if(_this.state.pendingImageElementId){setCursor(_this.canvas,\"url(\".concat(previewDataURL,\") 4 4, auto\"));}case 21:case\"end\":return _context9.stop();}},_callee9);}));return function(_x11){return _ref20.apply(this,arguments);};}();_this.onImageAction=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(){var _ref22,insertOnCanvasDirectly,clientX,clientY,_viewportCoordsToScen5,x,y,imageFile,imageElement,_args10=arguments;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:_ref22=_args10.length>0&&_args10[0]!==undefined?_args10[0]:{insertOnCanvasDirectly:false},insertOnCanvasDirectly=_ref22.insertOnCanvasDirectly;_context10.prev=1;clientX=_this.state.width/2+_this.state.offsetLeft;clientY=_this.state.height/2+_this.state.offsetTop;_viewportCoordsToScen5=viewportCoordsToSceneCoords({clientX:clientX,clientY:clientY},_this.state),x=_viewportCoordsToScen5.x,y=_viewportCoordsToScen5.y;_context10.next=7;return fileOpen({description:\"Image\",extensions:Object.keys(IMAGE_MIME_TYPES)});case 7:imageFile=_context10.sent;imageElement=_this.createImageElement({sceneX:x,sceneY:y});if(insertOnCanvasDirectly){_this.insertImageElement(imageElement,imageFile);_this.initializeImageDimensions(imageElement);_this.setState({selectedElementIds:makeNextSelectedElementIds(_defineProperty({},imageElement.id,true),_this.state)},function(){_this.actionManager.executeAction(actionFinalize);});}else{_this.setState({pendingImageElementId:imageElement.id},function(){_this.insertImageElement(imageElement,imageFile,/* showCursorImagePreview */true);});}_context10.next=16;break;case 12:_context10.prev=12;_context10.t0=_context10[\"catch\"](1);if(_context10.t0.name!==\"AbortError\"){console.error(_context10.t0);}else{console.warn(_context10.t0);}_this.setState({pendingImageElementId:null,editingElement:null,activeTool:updateActiveTool(_this.state,{type:\"selection\"})},function(){_this.actionManager.executeAction(actionFinalize);});case 16:case\"end\":return _context10.stop();}},_callee10,null,[[1,12]]);}));_this.initializeImageDimensions=function(imageElement){var _this$imageCache$get;var forceNaturalSize=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var image=isInitializedImageElement(imageElement)&&((_this$imageCache$get=_this.imageCache.get(imageElement.fileId))===null||_this$imageCache$get===void 0?void 0:_this$imageCache$get.image);if(!image||image instanceof Promise){if(imageElement.width<DRAGGING_THRESHOLD/_this.state.zoom.value&&imageElement.height<DRAGGING_THRESHOLD/_this.state.zoom.value){var placeholderSize=100/_this.state.zoom.value;mutateElement(imageElement,{x:imageElement.x-placeholderSize/2,y:imageElement.y-placeholderSize/2,width:placeholderSize,height:placeholderSize});}return;}if(forceNaturalSize||// if user-created bounding box is below threshold, assume the\n// intention was to click instead of drag, and use the image's\n// intrinsic size\nimageElement.width<DRAGGING_THRESHOLD/_this.state.zoom.value&&imageElement.height<DRAGGING_THRESHOLD/_this.state.zoom.value){var minHeight=Math.max(_this.state.height-120,160);// max 65% of canvas height, clamped to <300px, vh - 120px>\nvar maxHeight=Math.min(minHeight,Math.floor(_this.state.height*0.5)/_this.state.zoom.value);var height=Math.min(image.naturalHeight,maxHeight);var width=height*(image.naturalWidth/image.naturalHeight);// add current imageElement width/height to account for previous centering\n// of the placeholder image\nvar x=imageElement.x+imageElement.width/2-width/2;var y=imageElement.y+imageElement.height/2-height/2;mutateElement(imageElement,{x:x,y:y,width:width,height:height});}};/** updates image cache, refreshing updated elements and/or setting status\n      to error for images that fail during <img> element creation */_this.updateImageCache=/*#__PURE__*/function(){var _ref23=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(elements){var files,_yield$_updateImageCa,updatedFiles,erroredFiles,_iterator,_step,element,_args11=arguments;return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:files=_args11.length>1&&_args11[1]!==undefined?_args11[1]:_this.files;_context11.next=3;return _updateImageCache({imageCache:_this.imageCache,fileIds:elements.map(function(element){return element.fileId;}),files:files});case 3:_yield$_updateImageCa=_context11.sent;updatedFiles=_yield$_updateImageCa.updatedFiles;erroredFiles=_yield$_updateImageCa.erroredFiles;if(updatedFiles.size||erroredFiles.size){_iterator=_createForOfIteratorHelper(elements);try{for(_iterator.s();!(_step=_iterator.n()).done;){element=_step.value;if(updatedFiles.has(element.fileId)){invalidateShapeForElement(element);}}}catch(err){_iterator.e(err);}finally{_iterator.f();}}if(erroredFiles.size){_this.scene.replaceAllElements(_this.scene.getElementsIncludingDeleted().map(function(element){if(isInitializedImageElement(element)&&erroredFiles.has(element.fileId)){return newElementWith(element,{status:\"error\"});}return element;}));}return _context11.abrupt(\"return\",{updatedFiles:updatedFiles,erroredFiles:erroredFiles});case 9:case\"end\":return _context11.stop();}},_callee11);}));return function(_x12){return _ref23.apply(this,arguments);};}();/** adds new images to imageCache and re-renders if needed */_this.addNewImagesToImageCache=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(){var imageElements,files,uncachedImageElements,_yield$_this$updateIm,updatedFiles,_args12=arguments;return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:imageElements=_args12.length>0&&_args12[0]!==undefined?_args12[0]:getInitializedImageElements(_this.scene.getNonDeletedElements());files=_args12.length>1&&_args12[1]!==undefined?_args12[1]:_this.files;uncachedImageElements=imageElements.filter(function(element){return!element.isDeleted&&!_this.imageCache.has(element.fileId);});if(!uncachedImageElements.length){_context12.next=9;break;}_context12.next=6;return _this.updateImageCache(uncachedImageElements,files);case 6:_yield$_this$updateIm=_context12.sent;updatedFiles=_yield$_this$updateIm.updatedFiles;if(updatedFiles.size){_this.scene.informMutation();}case 9:case\"end\":return _context12.stop();}},_callee12);}));/** generally you should use `addNewImagesToImageCache()` directly if you need\n   *  to render new images. This is just a failsafe  */_this.scheduleImageRefresh=throttle(function(){_this.addNewImagesToImageCache();},IMAGE_RENDER_TIMEOUT);_this.updateBindingEnabledOnPointerMove=function(event){var shouldEnableBinding=shouldEnableBindingForPointerEvent(event);if(_this.state.isBindingEnabled!==shouldEnableBinding){_this.setState({isBindingEnabled:shouldEnableBinding});}};_this.maybeSuggestBindingAtCursor=function(pointerCoords){var hoveredBindableElement=getHoveredElementForBinding(pointerCoords,_this.scene);_this.setState({suggestedBindings:hoveredBindableElement!=null?[hoveredBindableElement]:[]});};_this.maybeSuggestBindingsForLinearElementAtCoords=function(linearElement,pointerCoords,oppositeBindingBoundElement){if(!pointerCoords.length){return;}var suggestedBindings=pointerCoords.reduce(function(acc,coords){var hoveredBindableElement=getHoveredElementForBinding(coords,_this.scene);if(hoveredBindableElement!=null&&!isLinearElementSimpleAndAlreadyBound(linearElement,oppositeBindingBoundElement===null||oppositeBindingBoundElement===void 0?void 0:oppositeBindingBoundElement.id,hoveredBindableElement)){acc.push(hoveredBindableElement);}return acc;},[]);_this.setState({suggestedBindings:suggestedBindings});};_this.handleCanvasRef=function(canvas){// canvas is null when unmounting\nif(canvas!==null){_this.canvas=canvas;_this.rc=rough.canvas(_this.canvas);_this.canvas.addEventListener(EVENT.WHEEL,_this.handleWheel,{passive:false});_this.canvas.addEventListener(EVENT.TOUCH_START,_this.onTapStart);_this.canvas.addEventListener(EVENT.TOUCH_END,_this.onTapEnd);}else{var _this$canvas,_this$canvas2,_this$canvas3;(_this$canvas=_this.canvas)===null||_this$canvas===void 0?void 0:_this$canvas.removeEventListener(EVENT.WHEEL,_this.handleWheel);(_this$canvas2=_this.canvas)===null||_this$canvas2===void 0?void 0:_this$canvas2.removeEventListener(EVENT.TOUCH_START,_this.onTapStart);(_this$canvas3=_this.canvas)===null||_this$canvas3===void 0?void 0:_this$canvas3.removeEventListener(EVENT.TOUCH_END,_this.onTapEnd);}};_this.handleAppOnDrop=/*#__PURE__*/function(){var _ref25=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(event){var _yield$getFileFromEve,file,fileHandle,scene,_viewportCoordsToScen6,sceneX,sceneY,imageElement,libraryJSON,libraryItems;return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:_context13.next=2;return getFileFromEvent(event);case 2:_yield$getFileFromEve=_context13.sent;file=_yield$getFileFromEve.file;fileHandle=_yield$getFileFromEve.fileHandle;_context13.prev=5;if(!isSupportedImageFile(file)){_context13.next=26;break;}if(!((file===null||file===void 0?void 0:file.type)===MIME_TYPES.png||(file===null||file===void 0?void 0:file.type)===MIME_TYPES.svg)){_context13.next=20;break;}_context13.prev=8;_context13.next=11;return loadFromBlob(file,_this.state,_this.scene.getElementsIncludingDeleted(),fileHandle);case 11:scene=_context13.sent;_this.syncActionResult(_objectSpread(_objectSpread({},scene),{},{appState:_objectSpread(_objectSpread({},scene.appState||_this.state),{},{isLoading:false}),replaceFiles:true,commitToHistory:true}));return _context13.abrupt(\"return\");case 16:_context13.prev=16;_context13.t0=_context13[\"catch\"](8);if(!(_context13.t0.name!==\"EncodingError\")){_context13.next=20;break;}throw _context13.t0;case 20:// if no scene is embedded or we fail for whatever reason, fall back\n// to importing as regular image\n// ---------------------------------------------------------------------\n_viewportCoordsToScen6=viewportCoordsToSceneCoords(event,_this.state),sceneX=_viewportCoordsToScen6.x,sceneY=_viewportCoordsToScen6.y;imageElement=_this.createImageElement({sceneX:sceneX,sceneY:sceneY});_this.insertImageElement(imageElement,file);_this.initializeImageDimensions(imageElement);_this.setState({selectedElementIds:makeNextSelectedElementIds(_defineProperty({},imageElement.id,true),_this.state)});return _context13.abrupt(\"return\");case 26:_context13.next=31;break;case 28:_context13.prev=28;_context13.t1=_context13[\"catch\"](5);return _context13.abrupt(\"return\",_this.setState({isLoading:false,errorMessage:_context13.t1.message}));case 31:libraryJSON=event.dataTransfer.getData(MIME_TYPES.excalidrawlib);if(!(libraryJSON&&typeof libraryJSON===\"string\")){_context13.next=35;break;}try{libraryItems=parseLibraryJSON(libraryJSON);_this.addElementsFromPasteOrLibrary({elements:distributeLibraryItemsOnSquareGrid(libraryItems),position:event,files:null});}catch(error){_this.setState({errorMessage:error.message});}return _context13.abrupt(\"return\");case 35:if(!file){_context13.next=38;break;}_context13.next=38;return _this.loadFileToCanvas(file,fileHandle);case 38:case\"end\":return _context13.stop();}},_callee13,null,[[5,28],[8,16]]);}));return function(_x13){return _ref25.apply(this,arguments);};}();_this.loadFileToCanvas=/*#__PURE__*/function(){var _ref26=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(file,fileHandle){var ret;return _regeneratorRuntime().wrap(function _callee14$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:_context14.next=2;return normalizeFile(file);case 2:file=_context14.sent;_context14.prev=3;_context14.next=6;return loadSceneOrLibraryFromBlob(file,_this.state,_this.scene.getElementsIncludingDeleted(),fileHandle);case 6:ret=_context14.sent;if(!(ret.type===MIME_TYPES.excalidraw)){_context14.next=12;break;}_this.setState({isLoading:true});_this.syncActionResult(_objectSpread(_objectSpread({},ret.data),{},{appState:_objectSpread(_objectSpread({},ret.data.appState||_this.state),{},{isLoading:false}),replaceFiles:true,commitToHistory:true}));_context14.next=15;break;case 12:if(!(ret.type===MIME_TYPES.excalidrawlib)){_context14.next=15;break;}_context14.next=15;return _this.library.updateLibrary({libraryItems:file,merge:true,openLibraryMenu:true}).catch(function(error){console.error(error);_this.setState({errorMessage:t(\"errors.importLibraryError\")});});case 15:_context14.next=20;break;case 17:_context14.prev=17;_context14.t0=_context14[\"catch\"](3);_this.setState({isLoading:false,errorMessage:_context14.t0.message});case 20:case\"end\":return _context14.stop();}},_callee14,null,[[3,17]]);}));return function(_x14,_x15){return _ref26.apply(this,arguments);};}();_this.handleCanvasContextMenu=function(event){event.preventDefault();if((event.nativeEvent.pointerType===\"touch\"||event.nativeEvent.pointerType===\"pen\"&&// always allow if user uses a pen secondary button\nevent.button!==POINTER_BUTTON.SECONDARY)&&_this.state.activeTool.type!==\"selection\"){return;}var _viewportCoordsToScen7=viewportCoordsToSceneCoords(event,_this.state),x=_viewportCoordsToScen7.x,y=_viewportCoordsToScen7.y;var element=_this.getElementAtPosition(x,y,{preferSelected:true,includeLockedElements:true});var selectedElements=_this.scene.getSelectedElements(_this.state);var isHittignCommonBoundBox=_this.isHittingCommonBoundingBoxOfSelectedElements({x:x,y:y},selectedElements);var type=element||isHittignCommonBoundBox?\"element\":\"canvas\";var container=_this.excalidrawContainerRef.current;var _container$getBoundin2=container.getBoundingClientRect(),offsetTop=_container$getBoundin2.top,offsetLeft=_container$getBoundin2.left;var left=event.clientX-offsetLeft;var top=event.clientY-offsetTop;trackEvent(\"contextMenu\",\"openContextMenu\",type);_this.setState(_objectSpread(_objectSpread({},element&&!_this.state.selectedElementIds[element.id]?selectGroupsForSelectedElements(_objectSpread(_objectSpread({},_this.state),{},{selectedElementIds:_defineProperty({},element.id,true),selectedLinearElement:isLinearElement(element)?new LinearElementEditor(element,_this.scene):null}),_this.scene.getNonDeletedElements(),_this.state,_assertThisInitialized(_this)):_this.state),{},{showHyperlinkPopup:false}),function(){_this.setState({contextMenu:{top:top,left:left,items:_this.getContextMenuItems(type)}});});};_this.maybeDragNewGenericElement=function(pointerDownState,event){var draggingElement=_this.state.draggingElement;var pointerCoords=pointerDownState.lastCoords;if(!draggingElement){return;}if(draggingElement.type===\"selection\"&&_this.state.activeTool.type!==\"eraser\"){dragNewElement(draggingElement,_this.state.activeTool.type,pointerDownState.origin.x,pointerDownState.origin.y,pointerCoords.x,pointerCoords.y,distance(pointerDownState.origin.x,pointerCoords.x),distance(pointerDownState.origin.y,pointerCoords.y),shouldMaintainAspectRatio(event),shouldResizeFromCenter(event));}else{var _this$imageCache$get2;var _getGridPoint15=getGridPoint(pointerCoords.x,pointerCoords.y,_this.state.gridSize),_getGridPoint16=_slicedToArray(_getGridPoint15,2),gridX=_getGridPoint16[0],gridY=_getGridPoint16[1];var image=isInitializedImageElement(draggingElement)&&((_this$imageCache$get2=_this.imageCache.get(draggingElement.fileId))===null||_this$imageCache$get2===void 0?void 0:_this$imageCache$get2.image);var aspectRatio=image&&!(image instanceof Promise)?image.width/image.height:null;dragNewElement(draggingElement,_this.state.activeTool.type,pointerDownState.originInGrid.x,pointerDownState.originInGrid.y,gridX,gridY,distance(pointerDownState.originInGrid.x,gridX),distance(pointerDownState.originInGrid.y,gridY),isImageElement(draggingElement)?!shouldMaintainAspectRatio(event):shouldMaintainAspectRatio(event),shouldResizeFromCenter(event),aspectRatio);_this.maybeSuggestBindingForAll([draggingElement]);// highlight elements that are to be added to frames on frames creation\nif(_this.state.activeTool.type===\"frame\"){_this.setState({elementsToHighlight:getElementsInResizingFrame(_this.scene.getNonDeletedElements(),draggingElement,_this.state)});}}};_this.maybeHandleResize=function(pointerDownState,event){var selectedElements=_this.scene.getSelectedElements(_this.state);var selectedFrames=selectedElements.filter(function(element){return element.type===\"frame\";});var transformHandleType=pointerDownState.resize.handleType;if(selectedFrames.length>0&&transformHandleType===\"rotation\"){return false;}_this.setState({// TODO: rename this state field to \"isScaling\" to distinguish\n// it from the generic \"isResizing\" which includes scaling and\n// rotating\nisResizing:transformHandleType&&transformHandleType!==\"rotation\",isRotating:transformHandleType===\"rotation\"});var pointerCoords=pointerDownState.lastCoords;var _getGridPoint17=getGridPoint(pointerCoords.x-pointerDownState.resize.offset.x,pointerCoords.y-pointerDownState.resize.offset.y,_this.state.gridSize),_getGridPoint18=_slicedToArray(_getGridPoint17,2),resizeX=_getGridPoint18[0],resizeY=_getGridPoint18[1];var frameElementsOffsetsMap=new Map();selectedFrames.forEach(function(frame){var elementsInFrame=getFrameElements(_this.scene.getNonDeletedElements(),frame.id);elementsInFrame.forEach(function(element){frameElementsOffsetsMap.set(frame.id+element.id,{x:element.x-frame.x,y:element.y-frame.y});});});if(transformElements(pointerDownState,transformHandleType,selectedElements,pointerDownState.resize.arrowDirection,shouldRotateWithDiscreteAngle(event),shouldResizeFromCenter(event),selectedElements.length===1&&isImageElement(selectedElements[0])?!shouldMaintainAspectRatio(event):shouldMaintainAspectRatio(event),resizeX,resizeY,pointerDownState.resize.center.x,pointerDownState.resize.center.y)){_this.maybeSuggestBindingForAll(selectedElements);var elementsToHighlight=new Set();selectedFrames.forEach(function(frame){var elementsInFrame=getFrameElements(_this.scene.getNonDeletedElements(),frame.id);// keep elements' positions relative to their frames on frames resizing\nif(transformHandleType){if(transformHandleType.includes(\"w\")){elementsInFrame.forEach(function(element){var _frameElementsOffsets,_frameElementsOffsets2;mutateElement(element,{x:frame.x+(((_frameElementsOffsets=frameElementsOffsetsMap.get(frame.id+element.id))===null||_frameElementsOffsets===void 0?void 0:_frameElementsOffsets.x)||0),y:frame.y+(((_frameElementsOffsets2=frameElementsOffsetsMap.get(frame.id+element.id))===null||_frameElementsOffsets2===void 0?void 0:_frameElementsOffsets2.y)||0)});});}if(transformHandleType.includes(\"n\")){elementsInFrame.forEach(function(element){var _frameElementsOffsets3,_frameElementsOffsets4;mutateElement(element,{x:frame.x+(((_frameElementsOffsets3=frameElementsOffsetsMap.get(frame.id+element.id))===null||_frameElementsOffsets3===void 0?void 0:_frameElementsOffsets3.x)||0),y:frame.y+(((_frameElementsOffsets4=frameElementsOffsetsMap.get(frame.id+element.id))===null||_frameElementsOffsets4===void 0?void 0:_frameElementsOffsets4.y)||0)});});}}getElementsInResizingFrame(_this.scene.getNonDeletedElements(),frame,_this.state).forEach(function(element){return elementsToHighlight.add(element);});});_this.setState({elementsToHighlight:_toConsumableArray(elementsToHighlight)});return true;}return false;};_this.getContextMenuItems=function(type){var options=[];options.push(actionCopyAsPng,actionCopyAsSvg);// canvas contextMenu\n// -------------------------------------------------------------------------\nif(type===\"canvas\"){if(_this.state.viewModeEnabled){return[].concat(options,[actionToggleGridMode,actionToggleZenMode,actionToggleViewMode,actionToggleStats]);}return[actionPaste,CONTEXT_MENU_SEPARATOR,actionCopyAsPng,actionCopyAsSvg,copyText,CONTEXT_MENU_SEPARATOR,actionSelectAll,actionUnlockAllElements,CONTEXT_MENU_SEPARATOR,actionToggleGridMode,actionToggleZenMode,actionToggleViewMode,actionToggleStats];}// element contextMenu\n// -------------------------------------------------------------------------\noptions.push(copyText);if(_this.state.viewModeEnabled){return[actionCopy].concat(options);}return[actionCut,actionCopy,actionPaste,actionSelectAllElementsInFrame,actionRemoveAllElementsFromFrame,CONTEXT_MENU_SEPARATOR].concat(options,[CONTEXT_MENU_SEPARATOR,actionCopyStyles,actionPasteStyles,CONTEXT_MENU_SEPARATOR,actionGroup,actionUnbindText,actionBindText,actionWrapTextInContainer,actionUngroup,CONTEXT_MENU_SEPARATOR,actionAddToLibrary,CONTEXT_MENU_SEPARATOR,actionSendBackward,actionBringForward,actionSendToBack,actionBringToFront,CONTEXT_MENU_SEPARATOR,actionFlipHorizontal,actionFlipVertical,CONTEXT_MENU_SEPARATOR,actionToggleLinearEditor,actionLink,actionDuplicateSelection,actionToggleElementLock,CONTEXT_MENU_SEPARATOR,actionDeleteSelected]);};_this.handleWheel=withBatchedUpdates(function(event){event.preventDefault();if(isPanning){return;}var deltaX=event.deltaX,deltaY=event.deltaY;// note that event.ctrlKey is necessary to handle pinch zooming\nif(event.metaKey||event.ctrlKey){var sign=Math.sign(deltaY);var MAX_STEP=ZOOM_STEP*100;var absDelta=Math.abs(deltaY);var delta=deltaY;if(absDelta>MAX_STEP){delta=MAX_STEP*sign;}var newZoom=_this.state.zoom.value-delta/100;// increase zoom steps the more zoomed-in we are (applies to >100% only)\nnewZoom+=Math.log10(Math.max(1,_this.state.zoom.value))*-sign*// reduced amplification for small deltas (small movements on a trackpad)\nMath.min(1,absDelta/20);_this.translateCanvas(function(state){return _objectSpread(_objectSpread({},getStateForZoom({viewportX:_this.lastViewportPosition.x,viewportY:_this.lastViewportPosition.y,nextZoom:getNormalizedZoom(newZoom)},state)),{},{shouldCacheIgnoreZoom:true});});_this.resetShouldCacheIgnoreZoomDebounced();return;}// scroll horizontally when shift pressed\nif(event.shiftKey){_this.translateCanvas(function(_ref27){var zoom=_ref27.zoom,scrollX=_ref27.scrollX;return{// on Mac, shift+wheel tends to result in deltaX\nscrollX:scrollX-(deltaY||deltaX)/zoom.value};});return;}_this.translateCanvas(function(_ref28){var zoom=_ref28.zoom,scrollX=_ref28.scrollX,scrollY=_ref28.scrollY;return{scrollX:scrollX-deltaX/zoom.value,scrollY:scrollY-deltaY/zoom.value};});});_this.savePointer=function(x,y,button){var _this$props$onPointer2,_this$props3;if(!x||!y){return;}var pointer=viewportCoordsToSceneCoords({clientX:x,clientY:y},_this.state);if(isNaN(pointer.x)||isNaN(pointer.y)){// sometimes the pointer goes off screen\n}(_this$props$onPointer2=(_this$props3=_this.props).onPointerUpdate)===null||_this$props$onPointer2===void 0?void 0:_this$props$onPointer2.call(_this$props3,{pointer:pointer,button:button,pointersMap:gesture.pointers});};_this.resetShouldCacheIgnoreZoomDebounced=debounce(function(){if(!_this.unmounted){_this.setState({shouldCacheIgnoreZoom:false});}},300);_this.updateDOMRect=function(cb){var _this$excalidrawConta5;if((_this$excalidrawConta5=_this.excalidrawContainerRef)!==null&&_this$excalidrawConta5!==void 0&&_this$excalidrawConta5.current){var excalidrawContainer=_this.excalidrawContainerRef.current;var _excalidrawContainer$=excalidrawContainer.getBoundingClientRect(),width=_excalidrawContainer$.width,height=_excalidrawContainer$.height,offsetLeft=_excalidrawContainer$.left,offsetTop=_excalidrawContainer$.top;var _this$state2=_this.state,currentWidth=_this$state2.width,currentHeight=_this$state2.height,currentOffsetTop=_this$state2.offsetTop,currentOffsetLeft=_this$state2.offsetLeft;if(width===currentWidth&&height===currentHeight&&offsetLeft===currentOffsetLeft&&offsetTop===currentOffsetTop){if(cb){cb();}return;}_this.setState({width:width,height:height,offsetLeft:offsetLeft,offsetTop:offsetTop},function(){cb&&cb();});}};_this.refresh=function(){_this.setState(_objectSpread({},_this.getCanvasOffsets()));};var defaultAppState=getDefaultAppState();var excalidrawRef=props.excalidrawRef,_props$viewModeEnable=props.viewModeEnabled,_viewModeEnabled=_props$viewModeEnable===void 0?false:_props$viewModeEnable,_props$zenModeEnabled=props.zenModeEnabled,_zenModeEnabled=_props$zenModeEnabled===void 0?false:_props$zenModeEnabled,_props$gridModeEnable=props.gridModeEnabled,gridModeEnabled=_props$gridModeEnable===void 0?false:_props$gridModeEnable,_props$theme=props.theme,_theme=_props$theme===void 0?defaultAppState.theme:_props$theme,_props$name=props.name,_name=_props$name===void 0?defaultAppState.name:_props$name;_this.state=_objectSpread(_objectSpread(_objectSpread({},defaultAppState),{},{theme:_theme,isLoading:true},_this.getCanvasOffsets()),{},{viewModeEnabled:_viewModeEnabled,zenModeEnabled:_zenModeEnabled,gridSize:gridModeEnabled?GRID_SIZE:null,name:_name,width:window.innerWidth,height:window.innerHeight});_this.id=nanoid();_this.library=new Library(_assertThisInitialized(_this));if(excalidrawRef){var _excalidrawRef$curren;var readyPromise=\"current\"in excalidrawRef&&((_excalidrawRef$curren=excalidrawRef.current)===null||_excalidrawRef$curren===void 0?void 0:_excalidrawRef$curren.readyPromise)||resolvablePromise();var api={ready:true,readyPromise:readyPromise,updateScene:_this.updateScene,updateLibrary:_this.library.updateLibrary,addFiles:_this.addFiles,resetScene:_this.resetScene,getSceneElementsIncludingDeleted:_this.getSceneElementsIncludingDeleted,history:{clear:_this.resetHistory},scrollToContent:_this.scrollToContent,getSceneElements:_this.getSceneElements,getAppState:function getAppState(){return _this.state;},getFiles:function getFiles(){return _this.files;},refresh:_this.refresh,setToast:_this.setToast,id:_this.id,setActiveTool:_this.setActiveTool,setCursor:_this.setCursor,resetCursor:_this.resetCursor,updateFrameRendering:_this.updateFrameRendering,toggleSidebar:_this.toggleSidebar};if(typeof excalidrawRef===\"function\"){excalidrawRef(api);}else{excalidrawRef.current=api;}readyPromise.resolve(api);}_this.excalidrawContainerValue={container:_this.excalidrawContainerRef.current,id:_this.id};_this.scene=new Scene();_this.fonts=new Fonts({scene:_this.scene,onSceneUpdated:_this.onSceneUpdated});_this.history=new History();_this.actionManager=new ActionManager(_this.syncActionResult,function(){return _this.state;},function(){return _this.scene.getElementsIncludingDeleted();},_assertThisInitialized(_this));_this.actionManager.registerAll(actions);_this.actionManager.registerAction(createUndoAction(_this.history));_this.actionManager.registerAction(createRedoAction(_this.history));return _this;}_createClass(App,[{key:\"renderCanvas\",value:function renderCanvas(){var _this4=this;var canvasScale=window.devicePixelRatio;var _this$state3=this.state,canvasDOMWidth=_this$state3.width,canvasDOMHeight=_this$state3.height,viewModeEnabled=_this$state3.viewModeEnabled;var canvasWidth=canvasDOMWidth*canvasScale;var canvasHeight=canvasDOMHeight*canvasScale;if(viewModeEnabled){return/*#__PURE__*/_jsx(\"canvas\",{className:\"excalidraw__canvas\",style:{width:canvasDOMWidth,height:canvasDOMHeight,cursor:CURSOR_TYPE.GRAB},width:canvasWidth,height:canvasHeight,ref:this.handleCanvasRef,onContextMenu:function onContextMenu(event){return _this4.handleCanvasContextMenu(event);},onPointerMove:this.handleCanvasPointerMove,onPointerUp:this.handleCanvasPointerUp,onPointerCancel:this.removePointer,onTouchMove:this.handleTouchMove,onPointerDown:this.handleCanvasPointerDown,children:t(\"labels.drawingCanvas\")});}return/*#__PURE__*/_jsx(\"canvas\",{className:\"excalidraw__canvas\",style:{width:canvasDOMWidth,height:canvasDOMHeight},width:canvasWidth,height:canvasHeight,ref:this.handleCanvasRef,onContextMenu:function onContextMenu(event){return _this4.handleCanvasContextMenu(event);},onPointerDown:this.handleCanvasPointerDown,onDoubleClick:this.handleCanvasDoubleClick,onPointerMove:this.handleCanvasPointerMove,onPointerUp:this.handleCanvasPointerUp,onPointerCancel:this.removePointer,onTouchMove:this.handleTouchMove,children:t(\"labels.drawingCanvas\")});}},{key:\"render\",value:function render(){var _this$props5,_this5=this;var selectedElement=this.scene.getSelectedElements(this.state);var _this$props4=this.props,renderTopRightUI=_this$props4.renderTopRightUI,renderCustomStats=_this$props4.renderCustomStats;return/*#__PURE__*/_jsx(\"div\",{className:clsx(\"excalidraw excalidraw-container\",{\"excalidraw--view-mode\":this.state.viewModeEnabled,\"excalidraw--mobile\":this.device.isMobile}),ref:this.excalidrawContainerRef,onDrop:this.handleAppOnDrop,tabIndex:0,onKeyDown:this.props.handleKeyboardGlobally?undefined:this.onKeyDown,children:/*#__PURE__*/_jsx(AppContext.Provider,{value:this,children:/*#__PURE__*/_jsx(AppPropsContext.Provider,{value:this.props,children:/*#__PURE__*/_jsx(ExcalidrawContainerContext.Provider,{value:this.excalidrawContainerValue,children:/*#__PURE__*/_jsx(DeviceContext.Provider,{value:this.device,children:/*#__PURE__*/_jsx(ExcalidrawSetAppStateContext.Provider,{value:this.setAppState,children:/*#__PURE__*/_jsx(ExcalidrawAppStateContext.Provider,{value:this.state,children:/*#__PURE__*/_jsx(ExcalidrawElementsContext.Provider,{value:this.scene.getNonDeletedElements(),children:/*#__PURE__*/_jsxs(ExcalidrawActionManagerContext.Provider,{value:this.actionManager,children:[/*#__PURE__*/_jsx(LayerUI,{canvas:this.canvas,appState:this.state,files:this.files,setAppState:this.setAppState,actionManager:this.actionManager,elements:this.scene.getNonDeletedElements(),onLockToggle:this.toggleLock,onPenModeToggle:this.togglePenMode,onHandToolToggle:this.onHandToolToggle,langCode:getLanguage().code,renderTopRightUI:renderTopRightUI,renderCustomStats:renderCustomStats,showExitZenModeBtn:typeof((_this$props5=this.props)===null||_this$props5===void 0?void 0:_this$props5.zenModeEnabled)===\"undefined\"&&this.state.zenModeEnabled,UIOptions:this.props.UIOptions,onImageAction:this.onImageAction,onExportImage:this.onExportImage,renderWelcomeScreen:!this.state.isLoading&&this.state.showWelcomeScreen&&this.state.activeTool.type===\"selection\"&&!this.state.zenModeEnabled&&!this.scene.getElementsIncludingDeleted().length,app:this,children:this.props.children}),/*#__PURE__*/_jsx(\"div\",{className:\"excalidraw-textEditorContainer\"}),/*#__PURE__*/_jsx(\"div\",{className:\"excalidraw-contextMenuContainer\"}),/*#__PURE__*/_jsx(\"div\",{className:\"excalidraw-eye-dropper-container\"}),selectedElement.length===1&&!this.state.contextMenu&&this.state.showHyperlinkPopup&&/*#__PURE__*/_jsx(Hyperlink,{element:selectedElement[0],setAppState:this.setAppState,onLinkOpen:this.props.onLinkOpen},selectedElement[0].id),this.state.toast!==null&&/*#__PURE__*/_jsx(Toast,{message:this.state.toast.message,onClose:function onClose(){return _this5.setToast(null);},duration:this.state.toast.duration,closable:this.state.toast.closable}),this.state.contextMenu&&/*#__PURE__*/_jsx(ContextMenu,{items:this.state.contextMenu.items,top:this.state.contextMenu.top,left:this.state.contextMenu.left,actionManager:this.actionManager}),/*#__PURE__*/_jsx(\"main\",{children:this.renderCanvas()}),this.renderFrameNames()]})})})})})})})})});}},{key:\"componentDidMount\",value:function(){var _componentDidMount=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(){var _this6=this,_this$excalidrawConta6;var setState,_this$resizeObserver,mdScreenQuery,smScreenQuery,canDeviceFitSidebarMediaQuery,handler,searchParams;return _regeneratorRuntime().wrap(function _callee15$(_context15){while(1)switch(_context15.prev=_context15.next){case 0:this.unmounted=false;this.excalidrawContainerValue.container=this.excalidrawContainerRef.current;if(process.env.NODE_ENV===ENV.TEST||process.env.NODE_ENV===ENV.DEVELOPMENT){setState=this.setState.bind(this);Object.defineProperties(window.h,{state:{configurable:true,get:function get(){return _this6.state;}},setState:{configurable:true,value:function value(){return _this6.setState.apply(_this6,arguments);}},app:{configurable:true,value:this},history:{configurable:true,value:this.history}});}this.scene.addCallback(this.onSceneUpdated);this.addEventListeners();if(this.props.autoFocus&&this.excalidrawContainerRef.current){this.focusContainer();}if(this.excalidrawContainerRef.current&&// bounding rects don't work in tests so updating\n// the state on init would result in making the test enviro run\n// in mobile breakpoint (0 width/height), making everything fail\nprocess.env.NODE_ENV!==\"test\"){this.refreshDeviceState(this.excalidrawContainerRef.current);}if(\"ResizeObserver\"in window&&(_this$excalidrawConta6=this.excalidrawContainerRef)!==null&&_this$excalidrawConta6!==void 0&&_this$excalidrawConta6.current){this.resizeObserver=new ResizeObserver(function(){THROTTLE_NEXT_RENDER=false;// recompute device dimensions state\n// ---------------------------------------------------------------------\n_this6.refreshDeviceState(_this6.excalidrawContainerRef.current);// refresh offsets\n// ---------------------------------------------------------------------\n_this6.updateDOMRect();});(_this$resizeObserver=this.resizeObserver)===null||_this$resizeObserver===void 0?void 0:_this$resizeObserver.observe(this.excalidrawContainerRef.current);}else if(window.matchMedia){mdScreenQuery=window.matchMedia(\"(max-width: \".concat(MQ_MAX_WIDTH_PORTRAIT,\"px), (max-height: \").concat(MQ_MAX_HEIGHT_LANDSCAPE,\"px) and (max-width: \").concat(MQ_MAX_WIDTH_LANDSCAPE,\"px)\"));smScreenQuery=window.matchMedia(\"(max-width: \".concat(MQ_SM_MAX_WIDTH,\"px)\"));canDeviceFitSidebarMediaQuery=window.matchMedia(\"(min-width: \".concat(// NOTE this won't update if a different breakpoint is supplied\n// after mount\nthis.props.UIOptions.dockedSidebarBreakpoint!=null?this.props.UIOptions.dockedSidebarBreakpoint:MQ_RIGHT_SIDEBAR_MIN_WIDTH,\"px)\"));handler=function handler(){_this6.excalidrawContainerRef.current.getBoundingClientRect();_this6.device=updateObject(_this6.device,{isSmScreen:smScreenQuery.matches,isMobile:mdScreenQuery.matches,canDeviceFitSidebar:canDeviceFitSidebarMediaQuery.matches});};mdScreenQuery.addListener(handler);this.detachIsMobileMqHandler=function(){return mdScreenQuery.removeListener(handler);};}searchParams=new URLSearchParams(window.location.search.slice(1));if(searchParams.has(\"web-share-target\")){// Obtain a file that was shared via the Web Share Target API.\nthis.restoreFileFromShare();}else{this.updateDOMRect(this.initializeScene);}// note that this check seems to always pass in localhost\nif(isBrave()&&!isMeasureTextSupported()){this.setState({errorMessage:/*#__PURE__*/_jsx(BraveMeasureTextError,{})});}case 11:case\"end\":return _context15.stop();}},_callee15,this);}));function componentDidMount(){return _componentDidMount.apply(this,arguments);}return componentDidMount;}()},{key:\"componentWillUnmount\",value:function componentWillUnmount(){var _this$resizeObserver2;this.files={};this.imageCache.clear();(_this$resizeObserver2=this.resizeObserver)===null||_this$resizeObserver2===void 0?void 0:_this$resizeObserver2.disconnect();this.unmounted=true;this.removeEventListeners();this.scene.destroy();this.library.destroy();clearTimeout(touchTimeout);isSomeElementSelected.clearCache();touchTimeout=0;}},{key:\"removeEventListeners\",value:function removeEventListeners(){var _this$excalidrawConta7,_this$nearestScrollab,_this$excalidrawConta8,_this$excalidrawConta9,_this$detachIsMobileM;document.removeEventListener(EVENT.POINTER_UP,this.removePointer);document.removeEventListener(EVENT.COPY,this.onCopy);document.removeEventListener(EVENT.PASTE,this.pasteFromClipboard);document.removeEventListener(EVENT.CUT,this.onCut);(_this$excalidrawConta7=this.excalidrawContainerRef.current)===null||_this$excalidrawConta7===void 0?void 0:_this$excalidrawConta7.removeEventListener(EVENT.WHEEL,this.onWheel);(_this$nearestScrollab=this.nearestScrollableContainer)===null||_this$nearestScrollab===void 0?void 0:_this$nearestScrollab.removeEventListener(EVENT.SCROLL,this.onScroll);document.removeEventListener(EVENT.KEYDOWN,this.onKeyDown,false);document.removeEventListener(EVENT.MOUSE_MOVE,this.updateCurrentCursorPosition,false);document.removeEventListener(EVENT.KEYUP,this.onKeyUp);window.removeEventListener(EVENT.RESIZE,this.onResize,false);window.removeEventListener(EVENT.UNLOAD,this.onUnload,false);window.removeEventListener(EVENT.BLUR,this.onBlur,false);(_this$excalidrawConta8=this.excalidrawContainerRef.current)===null||_this$excalidrawConta8===void 0?void 0:_this$excalidrawConta8.removeEventListener(EVENT.DRAG_OVER,this.disableEvent,false);(_this$excalidrawConta9=this.excalidrawContainerRef.current)===null||_this$excalidrawConta9===void 0?void 0:_this$excalidrawConta9.removeEventListener(EVENT.DROP,this.disableEvent,false);document.removeEventListener(EVENT.GESTURE_START,this.onGestureStart,false);document.removeEventListener(EVENT.GESTURE_CHANGE,this.onGestureChange,false);document.removeEventListener(EVENT.GESTURE_END,this.onGestureEnd,false);(_this$detachIsMobileM=this.detachIsMobileMqHandler)===null||_this$detachIsMobileM===void 0?void 0:_this$detachIsMobileM.call(this);}},{key:\"addEventListeners\",value:function addEventListeners(){var _this$excalidrawConta10,_document$fonts,_document$fonts$addEv,_this7=this,_this$excalidrawConta11,_this$excalidrawConta12;this.removeEventListeners();document.addEventListener(EVENT.POINTER_UP,this.removePointer);// #3553\ndocument.addEventListener(EVENT.COPY,this.onCopy);(_this$excalidrawConta10=this.excalidrawContainerRef.current)===null||_this$excalidrawConta10===void 0?void 0:_this$excalidrawConta10.addEventListener(EVENT.WHEEL,this.onWheel,{passive:false});if(this.props.handleKeyboardGlobally){document.addEventListener(EVENT.KEYDOWN,this.onKeyDown,false);}document.addEventListener(EVENT.KEYUP,this.onKeyUp,{passive:true});document.addEventListener(EVENT.MOUSE_MOVE,this.updateCurrentCursorPosition);// rerender text elements on font load to fix #637 && #1553\n(_document$fonts=document.fonts)===null||_document$fonts===void 0?void 0:(_document$fonts$addEv=_document$fonts.addEventListener)===null||_document$fonts$addEv===void 0?void 0:_document$fonts$addEv.call(_document$fonts,\"loadingdone\",function(event){var loadedFontFaces=event.fontfaces;_this7.fonts.onFontsLoaded(loadedFontFaces);});// Safari-only desktop pinch zoom\ndocument.addEventListener(EVENT.GESTURE_START,this.onGestureStart,false);document.addEventListener(EVENT.GESTURE_CHANGE,this.onGestureChange,false);document.addEventListener(EVENT.GESTURE_END,this.onGestureEnd,false);if(this.state.viewModeEnabled){return;}document.addEventListener(EVENT.PASTE,this.pasteFromClipboard);document.addEventListener(EVENT.CUT,this.onCut);if(this.props.detectScroll){this.nearestScrollableContainer=getNearestScrollableContainer(this.excalidrawContainerRef.current);this.nearestScrollableContainer.addEventListener(EVENT.SCROLL,this.onScroll);}window.addEventListener(EVENT.RESIZE,this.onResize,false);window.addEventListener(EVENT.UNLOAD,this.onUnload,false);window.addEventListener(EVENT.BLUR,this.onBlur,false);(_this$excalidrawConta11=this.excalidrawContainerRef.current)===null||_this$excalidrawConta11===void 0?void 0:_this$excalidrawConta11.addEventListener(EVENT.DRAG_OVER,this.disableEvent,false);(_this$excalidrawConta12=this.excalidrawContainerRef.current)===null||_this$excalidrawConta12===void 0?void 0:_this$excalidrawConta12.addEventListener(EVENT.DROP,this.disableEvent,false);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps,prevState){var _this$excalidrawConta13,_this8=this,_this$state$editingEl2;if(!this.state.showWelcomeScreen&&!this.scene.getElementsIncludingDeleted().length){this.setState({showWelcomeScreen:true});}if(this.excalidrawContainerRef.current&&prevProps.UIOptions.dockedSidebarBreakpoint!==this.props.UIOptions.dockedSidebarBreakpoint){this.refreshDeviceState(this.excalidrawContainerRef.current);}if(prevState.scrollX!==this.state.scrollX||prevState.scrollY!==this.state.scrollY){var _this$props6,_this$props6$onScroll;(_this$props6=this.props)===null||_this$props6===void 0?void 0:(_this$props6$onScroll=_this$props6.onScrollChange)===null||_this$props6$onScroll===void 0?void 0:_this$props6$onScroll.call(_this$props6,this.state.scrollX,this.state.scrollY);}if(Object.keys(this.state.selectedElementIds).length&&isEraserActive(this.state)){this.setState({activeTool:updateActiveTool(this.state,{type:\"selection\"})});}if(this.state.activeTool.type===\"eraser\"&&prevState.theme!==this.state.theme){setEraserCursor(this.canvas,this.state.theme);}// Hide hyperlink popup if shown when element type is not selection\nif(prevState.activeTool.type===\"selection\"&&this.state.activeTool.type!==\"selection\"&&this.state.showHyperlinkPopup){this.setState({showHyperlinkPopup:false});}if(prevProps.langCode!==this.props.langCode){this.updateLanguage();}if(prevProps.viewModeEnabled!==this.props.viewModeEnabled){this.setState({viewModeEnabled:!!this.props.viewModeEnabled});}if(prevState.viewModeEnabled!==this.state.viewModeEnabled){this.addEventListeners();this.deselectElements();}if(prevProps.zenModeEnabled!==this.props.zenModeEnabled){this.setState({zenModeEnabled:!!this.props.zenModeEnabled});}if(prevProps.theme!==this.props.theme&&this.props.theme){this.setState({theme:this.props.theme});}if(prevProps.gridModeEnabled!==this.props.gridModeEnabled){this.setState({gridSize:this.props.gridModeEnabled?GRID_SIZE:null});}if(this.props.name&&prevProps.name!==this.props.name){this.setState({name:this.props.name});}(_this$excalidrawConta13=this.excalidrawContainerRef.current)===null||_this$excalidrawConta13===void 0?void 0:_this$excalidrawConta13.classList.toggle(\"theme--dark\",this.state.theme===\"dark\");if(this.state.editingLinearElement&&!this.state.selectedElementIds[this.state.editingLinearElement.elementId]){// defer so that the commitToHistory flag isn't reset via current update\nsetTimeout(function(){// execute only if the condition still holds when the deferred callback\n// executes (it can be scheduled multiple times depending on how\n// many times the component renders)\n_this8.state.editingLinearElement&&_this8.actionManager.executeAction(actionFinalize);});}// failsafe in case the state is being updated in incorrect order resulting\n// in the editingElement being now a deleted element\nif((_this$state$editingEl2=this.state.editingElement)!==null&&_this$state$editingEl2!==void 0&&_this$state$editingEl2.isDeleted){this.setState({editingElement:null});}if(this.state.selectedLinearElement&&!this.state.selectedElementIds[this.state.selectedLinearElement.elementId]){// To make sure `selectedLinearElement` is in sync with `selectedElementIds`, however this shouldn't be needed once\n// we have a single API to update `selectedElementIds`\nthis.setState({selectedLinearElement:null});}var multiElement=prevState.multiElement;if(prevState.activeTool!==this.state.activeTool&&multiElement!=null&&isBindingEnabled(this.state)&&isBindingElement(multiElement,false)){maybeBindLinearElement(multiElement,this.state,this.scene,tupleToCoors(LinearElementEditor.getPointAtIndexGlobalCoordinates(multiElement,-1)));}this.renderScene();this.history.record(this.state,this.scene.getElementsIncludingDeleted());// Do not notify consumers if we're still loading the scene. Among other\n// potential issues, this fixes a case where the tab isn't focused during\n// init, which would trigger onChange with empty elements, which would then\n// override whatever is in localStorage currently.\nif(!this.state.isLoading){var _this$props$onChange,_this$props7;(_this$props$onChange=(_this$props7=this.props).onChange)===null||_this$props$onChange===void 0?void 0:_this$props$onChange.call(_this$props7,this.scene.getElementsIncludingDeleted(),this.state,this.files);}}},{key:\"addTextFromPaste\",value:function addTextFromPaste(text){var _this9=this;var isPlainPaste=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var _viewportCoordsToScen8=viewportCoordsToSceneCoords({clientX:this.lastViewportPosition.x,clientY:this.lastViewportPosition.y},this.state),x=_viewportCoordsToScen8.x,y=_viewportCoordsToScen8.y;var textElementProps={x:x,y:y,strokeColor:this.state.currentItemStrokeColor,backgroundColor:this.state.currentItemBackgroundColor,fillStyle:this.state.currentItemFillStyle,strokeWidth:this.state.currentItemStrokeWidth,strokeStyle:this.state.currentItemStrokeStyle,roundness:null,roughness:this.state.currentItemRoughness,opacity:this.state.currentItemOpacity,text:text,fontSize:this.state.currentItemFontSize,fontFamily:this.state.currentItemFontFamily,textAlign:this.state.currentItemTextAlign,verticalAlign:DEFAULT_VERTICAL_ALIGN,locked:false};var LINE_GAP=10;var currentY=y;var lines=isPlainPaste?[text]:text.split(\"\\n\");var textElements=lines.reduce(function(acc,line,idx){var text=line.trim();var lineHeight=getDefaultLineHeight(textElementProps.fontFamily);if(text.length){var topLayerFrame=_this9.getTopLayerFrameAtSceneCoords({x:x,y:currentY});var element=newTextElement(_objectSpread(_objectSpread({},textElementProps),{},{x:x,y:currentY,text:text,lineHeight:lineHeight,frameId:topLayerFrame?topLayerFrame.id:null}));acc.push(element);currentY+=element.height+LINE_GAP;}else{var _lines;var prevLine=(_lines=lines[idx-1])===null||_lines===void 0?void 0:_lines.trim();// add paragraph only if previous line was not empty, IOW don't add\n// more than one empty line\nif(prevLine){currentY+=getLineHeightInPx(textElementProps.fontSize,lineHeight)+LINE_GAP;}}return acc;},[]);if(textElements.length===0){return;}var frameId=textElements[0].frameId;if(frameId){this.scene.insertElementsAtIndex(textElements,this.scene.getElementIndex(frameId));}else{this.scene.replaceAllElements([].concat(_toConsumableArray(this.scene.getElementsIncludingDeleted()),_toConsumableArray(textElements)));}this.setState({selectedElementIds:makeNextSelectedElementIds(Object.fromEntries(textElements.map(function(el){return[el.id,true];})),this.state)});if(!isPlainPaste&&textElements.length>1&&PLAIN_PASTE_TOAST_SHOWN===false&&!this.device.isMobile){this.setToast({message:t(\"toast.pasteAsSingleElement\",{shortcut:getShortcutKey(\"CtrlOrCmd+Shift+V\")}),duration:5000});PLAIN_PASTE_TOAST_SHOWN=true;}this.history.resumeRecording();}},{key:\"handleTextWysiwyg\",value:function handleTextWysiwyg(element,_ref29){var _this10=this;var _ref29$isExistingElem=_ref29.isExistingElement,isExistingElement=_ref29$isExistingElem===void 0?false:_ref29$isExistingElem;var updateElement=function updateElement(text,originalText,isDeleted){_this10.scene.replaceAllElements(_toConsumableArray(_this10.scene.getElementsIncludingDeleted().map(function(_element){if(_element.id===element.id&&isTextElement(_element)){return updateTextElement(_element,{text:text,isDeleted:isDeleted,originalText:originalText});}return _element;})));};textWysiwyg({id:element.id,canvas:this.canvas,getViewportCoords:function getViewportCoords(x,y){var _sceneCoordsToViewpor3=sceneCoordsToViewportCoords({sceneX:x,sceneY:y},_this10.state),viewportX=_sceneCoordsToViewpor3.x,viewportY=_sceneCoordsToViewpor3.y;return[viewportX-_this10.state.offsetLeft,viewportY-_this10.state.offsetTop];},onChange:withBatchedUpdates(function(text){updateElement(text,text,false);if(isNonDeletedElement(element)){updateBoundElements(element);}}),onSubmit:withBatchedUpdates(function(_ref30){var text=_ref30.text,viaKeyboard=_ref30.viaKeyboard,originalText=_ref30.originalText;var isDeleted=!text.trim();updateElement(text,originalText,isDeleted);// select the created text element only if submitting via keyboard\n// (when submitting via click it should act as signal to deselect)\nif(!isDeleted&&viaKeyboard){var elementIdToSelect=element.containerId?element.containerId:element.id;_this10.setState(function(prevState){return{selectedElementIds:makeNextSelectedElementIds(_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},elementIdToSelect,true)),prevState)};});}if(isDeleted){fixBindingsAfterDeletion(_this10.scene.getNonDeletedElements(),[element]);}if(!isDeleted||isExistingElement){_this10.history.resumeRecording();}_this10.setState({draggingElement:null,editingElement:null});if(_this10.state.activeTool.locked){setCursorForShape(_this10.canvas,_this10.state);}_this10.focusContainer();}),element:element,excalidrawContainer:this.excalidrawContainerRef.current,app:this});// deselect all other elements when inserting text\nthis.deselectElements();// do an initial update to re-initialize element position since we were\n// modifying element's x/y for sake of editor (case: syncing to remote)\nupdateElement(element.text,element.originalText,false);}},{key:\"deselectElements\",value:function deselectElements(){this.setState({selectedElementIds:makeNextSelectedElementIds({},this.state),selectedGroupIds:{},editingGroupId:null});}},{key:\"getTextElementAtPosition\",value:function getTextElementAtPosition(x,y){var element=this.getElementAtPosition(x,y,{includeBoundTextElement:true});if(element&&isTextElement(element)&&!element.isDeleted){return element;}return null;}},{key:\"getElementAtPosition\",value:function getElementAtPosition(x,y,opts){var allHitElements=this.getElementsAtPosition(x,y,opts===null||opts===void 0?void 0:opts.includeBoundTextElement,opts===null||opts===void 0?void 0:opts.includeLockedElements);if(allHitElements.length>1){if(opts!==null&&opts!==void 0&&opts.preferSelected){for(var index=allHitElements.length-1;index>-1;index--){if(this.state.selectedElementIds[allHitElements[index].id]){return allHitElements[index];}}}var elementWithHighestZIndex=allHitElements[allHitElements.length-1];// If we're hitting element with highest z-index only on its bounding box\n// while also hitting other element figure, the latter should be considered.\nreturn isHittingElementBoundingBoxWithoutHittingElement(elementWithHighestZIndex,this.state,this.frameNameBoundsCache,x,y)?allHitElements[allHitElements.length-2]:elementWithHighestZIndex;}if(allHitElements.length===1){return allHitElements[0];}return null;}},{key:\"getElementsAtPosition\",value:function getElementsAtPosition(x,y){var _this11=this;var includeBoundTextElement=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var includeLockedElements=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var elements=includeBoundTextElement&&includeLockedElements?this.scene.getNonDeletedElements():this.scene.getNonDeletedElements().filter(function(element){return(includeLockedElements||!element.locked)&&(includeBoundTextElement||!(isTextElement(element)&&element.containerId));});return _getElementsAtPosition(elements,function(element){return hitTest(element,_this11.state,_this11.frameNameBoundsCache,x,y);}).filter(function(element){// hitting a frame's element from outside the frame is not considered a hit\nvar containingFrame=getContainingFrame(element);return containingFrame&&_this11.state.frameRendering.enabled&&_this11.state.frameRendering.clip?isCursorInFrame({x:x,y:y},containingFrame):true;});}},{key:\"handleHoverSelectedLinearElement\",value:function handleHoverSelectedLinearElement(linearElementEditor,scenePointerX,scenePointerY){var element=LinearElementEditor.getElement(linearElementEditor.elementId);var boundTextElement=getBoundTextElement(element);if(!element){return;}if(this.state.selectedLinearElement){var hoverPointIndex=-1;var segmentMidPointHoveredCoords=null;if(isHittingElementNotConsideringBoundingBox(element,this.state,this.frameNameBoundsCache,[scenePointerX,scenePointerY])){hoverPointIndex=LinearElementEditor.getPointIndexUnderCursor(element,this.state.zoom,scenePointerX,scenePointerY);segmentMidPointHoveredCoords=LinearElementEditor.getSegmentMidpointHitCoords(linearElementEditor,{x:scenePointerX,y:scenePointerY},this.state);if(hoverPointIndex>=0||segmentMidPointHoveredCoords){setCursor(this.canvas,CURSOR_TYPE.POINTER);}else{setCursor(this.canvas,CURSOR_TYPE.MOVE);}}else if(shouldShowBoundingBox([element],this.state)&&isHittingElementBoundingBoxWithoutHittingElement(element,this.state,this.frameNameBoundsCache,scenePointerX,scenePointerY)){setCursor(this.canvas,CURSOR_TYPE.MOVE);}else if(boundTextElement&&hitTest(boundTextElement,this.state,this.frameNameBoundsCache,scenePointerX,scenePointerY)){setCursor(this.canvas,CURSOR_TYPE.MOVE);}if(this.state.selectedLinearElement.hoverPointIndex!==hoverPointIndex){this.setState({selectedLinearElement:_objectSpread(_objectSpread({},this.state.selectedLinearElement),{},{hoverPointIndex:hoverPointIndex})});}if(!LinearElementEditor.arePointsEqual(this.state.selectedLinearElement.segmentMidPointHoveredCoords,segmentMidPointHoveredCoords)){this.setState({selectedLinearElement:_objectSpread(_objectSpread({},this.state.selectedLinearElement),{},{segmentMidPointHoveredCoords:segmentMidPointHoveredCoords})});}}else{setCursor(this.canvas,CURSOR_TYPE.AUTO);}}},{key:\"maybeCleanupAfterMissingPointerUp\",value:function maybeCleanupAfterMissingPointerUp(event){if(_lastPointerUp!==null){// Unfortunately, sometimes we don't get a pointerup after a pointerdown,\n// this can happen when a contextual menu or alert is triggered. In order to avoid\n// being in a weird state, we clean up on the next pointerdown\n_lastPointerUp(event);}}},{key:\"updateGestureOnPointerDown\",value:function updateGestureOnPointerDown(event){gesture.pointers.set(event.pointerId,{x:event.clientX,y:event.clientY});if(gesture.pointers.size===2){gesture.lastCenter=getCenter(gesture.pointers);gesture.initialScale=this.state.zoom.value;gesture.initialDistance=getDistance(Array.from(gesture.pointers.values()));}}},{key:\"initialPointerDownState\",value:function initialPointerDownState(event){var origin=viewportCoordsToSceneCoords(event,this.state);var selectedElements=this.scene.getSelectedElements(this.state);var _getCommonBounds3=getCommonBounds(selectedElements),_getCommonBounds4=_slicedToArray(_getCommonBounds3,4),minX=_getCommonBounds4[0],minY=_getCommonBounds4[1],maxX=_getCommonBounds4[2],maxY=_getCommonBounds4[3];return{origin:origin,withCmdOrCtrl:event[KEYS.CTRL_OR_CMD],originInGrid:tupleToCoors(getGridPoint(origin.x,origin.y,this.state.gridSize)),scrollbars:isOverScrollBars(currentScrollBars,event.clientX-this.state.offsetLeft,event.clientY-this.state.offsetTop),// we need to duplicate because we'll be updating this state\nlastCoords:_objectSpread({},origin),originalElements:this.scene.getNonDeletedElements().reduce(function(acc,element){acc.set(element.id,deepCopyElement(element));return acc;},new Map()),resize:{handleType:false,isResizing:false,offset:{x:0,y:0},arrowDirection:\"origin\",center:{x:(maxX+minX)/2,y:(maxY+minY)/2}},hit:{element:null,allHitElements:[],wasAddedToSelection:false,hasBeenDuplicated:false,hasHitCommonBoundingBoxOfSelectedElements:this.isHittingCommonBoundingBoxOfSelectedElements(origin,selectedElements)},drag:{hasOccurred:false,offset:null},eventListeners:{onMove:null,onUp:null,onKeyUp:null,onKeyDown:null},boxSelection:{hasOccurred:false},elementIdsToErase:{}};}// Returns whether the event is a dragging a scrollbar\n},{key:\"handleDraggingScrollBar\",value:function handleDraggingScrollBar(event,pointerDownState){var _this12=this;if(!(pointerDownState.scrollbars.isOverEither&&!this.state.multiElement)){return false;}isDraggingScrollBar=true;pointerDownState.lastCoords.x=event.clientX;pointerDownState.lastCoords.y=event.clientY;var onPointerMove=withBatchedUpdatesThrottled(function(event){var target=event.target;if(!(target instanceof HTMLElement)){return;}_this12.handlePointerMoveOverScrollbars(event,pointerDownState);});var onPointerUp=withBatchedUpdates(function(){isDraggingScrollBar=false;setCursorForShape(_this12.canvas,_this12.state);_lastPointerUp=null;_this12.setState({cursorButton:\"up\"});_this12.savePointer(event.clientX,event.clientY,\"up\");window.removeEventListener(EVENT.POINTER_MOVE,onPointerMove);window.removeEventListener(EVENT.POINTER_UP,onPointerUp);onPointerMove.flush();});_lastPointerUp=onPointerUp;window.addEventListener(EVENT.POINTER_MOVE,onPointerMove);window.addEventListener(EVENT.POINTER_UP,onPointerUp);return true;}},{key:\"isASelectedElement\",value:function isASelectedElement(hitElement){return hitElement!=null&&this.state.selectedElementIds[hitElement.id];}},{key:\"isHittingCommonBoundingBoxOfSelectedElements\",value:function isHittingCommonBoundingBoxOfSelectedElements(point,selectedElements){if(selectedElements.length<2){return false;}// How many pixels off the shape boundary we still consider a hit\nvar threshold=10/this.state.zoom.value;var _getCommonBounds5=getCommonBounds(selectedElements),_getCommonBounds6=_slicedToArray(_getCommonBounds5,4),x1=_getCommonBounds6[0],y1=_getCommonBounds6[1],x2=_getCommonBounds6[2],y2=_getCommonBounds6[3];return point.x>x1-threshold&&point.x<x2+threshold&&point.y>y1-threshold&&point.y<y2+threshold;}},{key:\"onKeyDownFromPointerDownHandler\",value:function onKeyDownFromPointerDownHandler(pointerDownState){var _this13=this;return withBatchedUpdates(function(event){if(_this13.maybeHandleResize(pointerDownState,event)){return;}_this13.maybeDragNewGenericElement(pointerDownState,event);});}},{key:\"onKeyUpFromPointerDownHandler\",value:function onKeyUpFromPointerDownHandler(pointerDownState){var _this14=this;return withBatchedUpdates(function(event){// Prevents focus from escaping excalidraw tab\nevent.key===KEYS.ALT&&event.preventDefault();if(_this14.maybeHandleResize(pointerDownState,event)){return;}_this14.maybeDragNewGenericElement(pointerDownState,event);});}},{key:\"onPointerMoveFromPointerDownHandler\",value:function onPointerMoveFromPointerDownHandler(pointerDownState){var _this15=this;return withBatchedUpdatesThrottled(function(event){var _pointerDownState$hit2;// We need to initialize dragOffsetXY only after we've updated\n// `state.selectedElementIds` on pointerDown. Doing it here in pointerMove\n// event handler should hopefully ensure we're already working with\n// the updated state.\nif(pointerDownState.drag.offset===null){pointerDownState.drag.offset=tupleToCoors(getDragOffsetXY(_this15.scene.getSelectedElements(_this15.state),pointerDownState.origin.x,pointerDownState.origin.y));}var target=event.target;if(!(target instanceof HTMLElement)){return;}if(_this15.handlePointerMoveOverScrollbars(event,pointerDownState)){return;}var pointerCoords=viewportCoordsToSceneCoords(event,_this15.state);if(isEraserActive(_this15.state)){_this15.handleEraser(event,pointerDownState,pointerCoords);return;}var _getGridPoint19=getGridPoint(pointerCoords.x,pointerCoords.y,_this15.state.gridSize),_getGridPoint20=_slicedToArray(_getGridPoint19,2),gridX=_getGridPoint20[0],gridY=_getGridPoint20[1];// for arrows/lines, don't start dragging until a given threshold\n// to ensure we don't create a 2-point arrow by mistake when\n// user clicks mouse in a way that it moves a tiny bit (thus\n// triggering pointermove)\nif(!pointerDownState.drag.hasOccurred&&(_this15.state.activeTool.type===\"arrow\"||_this15.state.activeTool.type===\"line\")){if(distance2d(pointerCoords.x,pointerCoords.y,pointerDownState.origin.x,pointerDownState.origin.y)<DRAGGING_THRESHOLD){return;}}if(pointerDownState.resize.isResizing){pointerDownState.lastCoords.x=pointerCoords.x;pointerDownState.lastCoords.y=pointerCoords.y;if(_this15.maybeHandleResize(pointerDownState,event)){return true;}}if(_this15.state.selectedLinearElement){var linearElementEditor=_this15.state.editingLinearElement||_this15.state.selectedLinearElement;if(LinearElementEditor.shouldAddMidpoint(_this15.state.selectedLinearElement,pointerCoords,_this15.state)){var ret=LinearElementEditor.addMidpoint(_this15.state.selectedLinearElement,pointerCoords,_this15.state);if(!ret){return;}// Since we are reading from previous state which is not possible with\n// automatic batching in React 18 hence using flush sync to synchronously\n// update the state. Check https://github.com/excalidraw/excalidraw/pull/5508 for more details.\nflushSync(function(){if(_this15.state.selectedLinearElement){_this15.setState({selectedLinearElement:_objectSpread(_objectSpread({},_this15.state.selectedLinearElement),{},{pointerDownState:ret.pointerDownState,selectedPointsIndices:ret.selectedPointsIndices})});}if(_this15.state.editingLinearElement){_this15.setState({editingLinearElement:_objectSpread(_objectSpread({},_this15.state.editingLinearElement),{},{pointerDownState:ret.pointerDownState,selectedPointsIndices:ret.selectedPointsIndices})});}});return;}else if(linearElementEditor.pointerDownState.segmentMidpoint.value!==null&&!linearElementEditor.pointerDownState.segmentMidpoint.added){return;}var didDrag=LinearElementEditor.handlePointDragging(event,_this15.state,pointerCoords.x,pointerCoords.y,function(element,pointsSceneCoords){_this15.maybeSuggestBindingsForLinearElementAtCoords(element,pointsSceneCoords);},linearElementEditor);if(didDrag){pointerDownState.lastCoords.x=pointerCoords.x;pointerDownState.lastCoords.y=pointerCoords.y;pointerDownState.drag.hasOccurred=true;if(_this15.state.editingLinearElement&&!_this15.state.editingLinearElement.isDragging){_this15.setState({editingLinearElement:_objectSpread(_objectSpread({},_this15.state.editingLinearElement),{},{isDragging:true})});}if(!_this15.state.selectedLinearElement.isDragging){_this15.setState({selectedLinearElement:_objectSpread(_objectSpread({},_this15.state.selectedLinearElement),{},{isDragging:true})});}return;}}var hasHitASelectedElement=pointerDownState.hit.allHitElements.some(function(element){return _this15.isASelectedElement(element);});var isSelectingPointsInLineEditor=_this15.state.editingLinearElement&&event.shiftKey&&_this15.state.editingLinearElement.elementId===((_pointerDownState$hit2=pointerDownState.hit.element)===null||_pointerDownState$hit2===void 0?void 0:_pointerDownState$hit2.id);if((hasHitASelectedElement||pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements)&&!isSelectingPointsInLineEditor){var selectedElements=_this15.scene.getSelectedElements(_this15.state);if(selectedElements.every(function(element){return element.locked;})){return;}var selectedElementsHasAFrame=selectedElements.find(function(e){return isFrameElement(e);});var topLayerFrame=_this15.getTopLayerFrameAtSceneCoords(pointerCoords);_this15.setState({frameToHighlight:topLayerFrame&&!selectedElementsHasAFrame?topLayerFrame:null});// Marking that click was used for dragging to check\n// if elements should be deselected on pointerup\npointerDownState.drag.hasOccurred=true;_this15.setState({selectedElementsAreBeingDragged:true});// prevent dragging even if we're no longer holding cmd/ctrl otherwise\n// it would have weird results (stuff jumping all over the screen)\n// Checking for editingElement to avoid jump while editing on mobile #6503\nif(selectedElements.length>0&&!pointerDownState.withCmdOrCtrl&&!_this15.state.editingElement){var _getGridPoint21=getGridPoint(pointerCoords.x-pointerDownState.drag.offset.x,pointerCoords.y-pointerDownState.drag.offset.y,_this15.state.gridSize),_getGridPoint22=_slicedToArray(_getGridPoint21,2),dragX=_getGridPoint22[0],dragY=_getGridPoint22[1];var _ref31=[Math.abs(pointerCoords.x-pointerDownState.origin.x),Math.abs(pointerCoords.y-pointerDownState.origin.y)],dragDistanceX=_ref31[0],dragDistanceY=_ref31[1];// We only drag in one direction if shift is pressed\nvar lockDirection=event.shiftKey;// when we're editing the name of a frame, we want the user to be\n// able to select and interact with the text input\n!_this15.state.editingFrame&&dragSelectedElements(pointerDownState,selectedElements,dragX,dragY,lockDirection,dragDistanceX,dragDistanceY,_this15.state,_this15.scene);_this15.maybeSuggestBindingForAll(selectedElements);// We duplicate the selected element if alt is pressed on pointer move\nif(event.altKey&&!pointerDownState.hit.hasBeenDuplicated){// Move the currently selected elements to the top of the z index stack, and\n// put the duplicates where the selected elements used to be.\n// (the origin point where the dragging started)\npointerDownState.hit.hasBeenDuplicated=true;var nextElements=[];var elementsToAppend=[];var groupIdMap=new Map();var oldIdToDuplicatedId=new Map();var hitElement=pointerDownState.hit.element;var selectedElementIds=new Set(_this15.scene.getSelectedElements({selectedElementIds:_this15.state.selectedElementIds,includeBoundTextElement:true,includeElementsInFrames:true}).map(function(element){return element.id;}));var elements=_this15.scene.getNonDeletedElements();var _iterator2=_createForOfIteratorHelper(elements),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var element=_step2.value;if(selectedElementIds.has(element.id)||// case: the state.selectedElementIds might not have been\n// updated yet by the time this mousemove event is fired\nelement.id===(hitElement===null||hitElement===void 0?void 0:hitElement.id)&&pointerDownState.hit.wasAddedToSelection){var duplicatedElement=duplicateElement(_this15.state.editingGroupId,groupIdMap,element);var _getGridPoint23=getGridPoint(pointerDownState.origin.x-pointerDownState.drag.offset.x,pointerDownState.origin.y-pointerDownState.drag.offset.y,_this15.state.gridSize),_getGridPoint24=_slicedToArray(_getGridPoint23,2),originDragX=_getGridPoint24[0],originDragY=_getGridPoint24[1];mutateElement(duplicatedElement,{x:duplicatedElement.x+(originDragX-dragX),y:duplicatedElement.y+(originDragY-dragY)});nextElements.push(duplicatedElement);elementsToAppend.push(element);oldIdToDuplicatedId.set(element.id,duplicatedElement.id);}else{nextElements.push(element);}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}var nextSceneElements=[].concat(nextElements,elementsToAppend);bindTextToShapeAfterDuplication(nextElements,elementsToAppend,oldIdToDuplicatedId);fixBindingsAfterDuplication(nextSceneElements,elementsToAppend,oldIdToDuplicatedId,\"duplicatesServeAsOld\");bindElementsToFramesAfterDuplication(nextSceneElements,elementsToAppend,oldIdToDuplicatedId);_this15.scene.replaceAllElements(nextSceneElements);}return;}}// It is very important to read this.state within each move event,\n// otherwise we would read a stale one!\nvar draggingElement=_this15.state.draggingElement;if(!draggingElement){return;}if(draggingElement.type===\"freedraw\"){var points=draggingElement.points;var dx=pointerCoords.x-draggingElement.x;var dy=pointerCoords.y-draggingElement.y;var lastPoint=points.length>0&&points[points.length-1];var discardPoint=lastPoint&&lastPoint[0]===dx&&lastPoint[1]===dy;if(!discardPoint){var pressures=draggingElement.simulatePressure?draggingElement.pressures:[].concat(_toConsumableArray(draggingElement.pressures),[event.pressure]);mutateElement(draggingElement,{points:[].concat(_toConsumableArray(points),[[dx,dy]]),pressures:pressures});}}else if(isLinearElement(draggingElement)){pointerDownState.drag.hasOccurred=true;_this15.setState({selectedElementsAreBeingDragged:true});var _points=draggingElement.points;var _dx=gridX-draggingElement.x;var _dy=gridY-draggingElement.y;if(shouldRotateWithDiscreteAngle(event)&&_points.length===2){var _getLockedLinearCurso2=getLockedLinearCursorAlignSize(draggingElement.x,draggingElement.y,pointerCoords.x,pointerCoords.y);_dx=_getLockedLinearCurso2.width;_dy=_getLockedLinearCurso2.height;}if(_points.length===1){mutateElement(draggingElement,{points:[].concat(_toConsumableArray(_points),[[_dx,_dy]])});}else if(_points.length===2){mutateElement(draggingElement,{points:[].concat(_toConsumableArray(_points.slice(0,-1)),[[_dx,_dy]])});}if(isBindingElement(draggingElement,false)){// When creating a linear element by dragging\n_this15.maybeSuggestBindingsForLinearElementAtCoords(draggingElement,[pointerCoords],_this15.state.startBoundElement);}}else{pointerDownState.lastCoords.x=pointerCoords.x;pointerDownState.lastCoords.y=pointerCoords.y;_this15.maybeDragNewGenericElement(pointerDownState,event);}if(_this15.state.activeTool.type===\"selection\"){pointerDownState.boxSelection.hasOccurred=true;var _elements=_this15.scene.getNonDeletedElements();if(!event.shiftKey&&// allows for box-selecting points (without shift)\n!_this15.state.editingLinearElement&&isSomeElementSelected(_elements,_this15.state)){if(pointerDownState.withCmdOrCtrl&&pointerDownState.hit.element){_this15.setState(function(prevState){return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:_defineProperty({},pointerDownState.hit.element.id,true)}),_this15.scene.getNonDeletedElements(),prevState,_this15);});}}// box-select line editor points\nif(_this15.state.editingLinearElement){LinearElementEditor.handleBoxSelection(event,_this15.state,_this15.setState.bind(_this15));// regular box-select\n}else{var elementsWithinSelection=getElementsWithinSelection(_elements,draggingElement);_this15.setState(function(prevState){var nextSelectedElementIds=elementsWithinSelection.reduce(function(acc,element){acc[element.id]=true;return acc;},{});if(pointerDownState.hit.element){// if using ctrl/cmd, select the hitElement only if we\n// haven't box-selected anything else\nif(!elementsWithinSelection.length){nextSelectedElementIds[pointerDownState.hit.element.id]=true;}else{delete nextSelectedElementIds[pointerDownState.hit.element.id];}}return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:nextSelectedElementIds,showHyperlinkPopup:elementsWithinSelection.length===1&&elementsWithinSelection[0].link?\"info\":false,// select linear element only when we haven't box-selected anything else\nselectedLinearElement:elementsWithinSelection.length===1&&isLinearElement(elementsWithinSelection[0])?new LinearElementEditor(elementsWithinSelection[0],_this15.scene):null}),_this15.scene.getNonDeletedElements(),prevState,_this15);});}}});}// Returns whether the pointer move happened over either scrollbar\n},{key:\"handlePointerMoveOverScrollbars\",value:function handlePointerMoveOverScrollbars(event,pointerDownState){if(pointerDownState.scrollbars.isOverHorizontal){var x=event.clientX;var dx=x-pointerDownState.lastCoords.x;this.translateCanvas({scrollX:this.state.scrollX-dx/this.state.zoom.value});pointerDownState.lastCoords.x=x;return true;}if(pointerDownState.scrollbars.isOverVertical){var y=event.clientY;var dy=y-pointerDownState.lastCoords.y;this.translateCanvas({scrollY:this.state.scrollY-dy/this.state.zoom.value});pointerDownState.lastCoords.y=y;return true;}return false;}},{key:\"onPointerUpFromPointerDownHandler\",value:function onPointerUpFromPointerDownHandler(pointerDownState){var _this16=this;return withBatchedUpdates(function(childEvent){var _this16$state$selecte;if(pointerDownState.eventListeners.onMove){pointerDownState.eventListeners.onMove.flush();}var _this16$state=_this16.state,draggingElement=_this16$state.draggingElement,resizingElement=_this16$state.resizingElement,multiElement=_this16$state.multiElement,activeTool=_this16$state.activeTool,isResizing=_this16$state.isResizing,isRotating=_this16$state.isRotating;_this16.setState({isResizing:false,isRotating:false,resizingElement:null,selectionElement:null,frameToHighlight:null,elementsToHighlight:null,cursorButton:\"up\",// text elements are reset on finalize, and resetting on pointerup\n// may cause issues with double taps\neditingElement:multiElement||isTextElement(_this16.state.editingElement)?_this16.state.editingElement:null});_this16.savePointer(childEvent.clientX,childEvent.clientY,\"up\");_this16.setState({selectedElementsAreBeingDragged:false});// Handle end of dragging a point of a linear element, might close a loop\n// and sets binding element\nif(_this16.state.editingLinearElement){var _pointerDownState$hit3,_pointerDownState$hit4;if(!pointerDownState.boxSelection.hasOccurred&&((_pointerDownState$hit3=pointerDownState.hit)===null||_pointerDownState$hit3===void 0?void 0:(_pointerDownState$hit4=_pointerDownState$hit3.element)===null||_pointerDownState$hit4===void 0?void 0:_pointerDownState$hit4.id)!==_this16.state.editingLinearElement.elementId){_this16.actionManager.executeAction(actionFinalize);}else{var editingLinearElement=LinearElementEditor.handlePointerUp(childEvent,_this16.state.editingLinearElement,_this16.state);if(editingLinearElement!==_this16.state.editingLinearElement){_this16.setState({editingLinearElement:editingLinearElement,suggestedBindings:[]});}}}else if(_this16.state.selectedLinearElement){var _pointerDownState$hit5,_pointerDownState$hit6;if(((_pointerDownState$hit5=pointerDownState.hit)===null||_pointerDownState$hit5===void 0?void 0:(_pointerDownState$hit6=_pointerDownState$hit5.element)===null||_pointerDownState$hit6===void 0?void 0:_pointerDownState$hit6.id)!==_this16.state.selectedLinearElement.elementId){var selectedELements=_this16.scene.getSelectedElements(_this16.state);// set selectedLinearElement to null if there is more than one element selected since we don't want to show linear element handles\nif(selectedELements.length>1){_this16.setState({selectedLinearElement:null});}}else{var linearElementEditor=LinearElementEditor.handlePointerUp(childEvent,_this16.state.selectedLinearElement,_this16.state);var startBindingElement=linearElementEditor.startBindingElement,endBindingElement=linearElementEditor.endBindingElement;var element=_this16.scene.getElement(linearElementEditor.elementId);if(isBindingElement(element)){bindOrUnbindLinearElement(element,startBindingElement,endBindingElement);}if(linearElementEditor!==_this16.state.selectedLinearElement){_this16.setState({selectedLinearElement:_objectSpread(_objectSpread({},linearElementEditor),{},{selectedPointsIndices:null}),suggestedBindings:[]});}}}_lastPointerUp=null;window.removeEventListener(EVENT.POINTER_MOVE,pointerDownState.eventListeners.onMove);window.removeEventListener(EVENT.POINTER_UP,pointerDownState.eventListeners.onUp);window.removeEventListener(EVENT.KEYDOWN,pointerDownState.eventListeners.onKeyDown);window.removeEventListener(EVENT.KEYUP,pointerDownState.eventListeners.onKeyUp);if(_this16.state.pendingImageElementId){_this16.setState({pendingImageElementId:null});}if((draggingElement===null||draggingElement===void 0?void 0:draggingElement.type)===\"freedraw\"){var pointerCoords=viewportCoordsToSceneCoords(childEvent,_this16.state);var points=draggingElement.points;var dx=pointerCoords.x-draggingElement.x;var dy=pointerCoords.y-draggingElement.y;// Allows dots to avoid being flagged as infinitely small\nif(dx===points[0][0]&&dy===points[0][1]){dy+=0.0001;dx+=0.0001;}var pressures=draggingElement.simulatePressure?[]:[].concat(_toConsumableArray(draggingElement.pressures),[childEvent.pressure]);mutateElement(draggingElement,{points:[].concat(_toConsumableArray(points),[[dx,dy]]),pressures:pressures,lastCommittedPoint:[dx,dy]});_this16.actionManager.executeAction(actionFinalize);return;}if(isImageElement(draggingElement)){var imageElement=draggingElement;try{_this16.initializeImageDimensions(imageElement);_this16.setState({selectedElementIds:makeNextSelectedElementIds(_defineProperty({},imageElement.id,true),_this16.state)},function(){_this16.actionManager.executeAction(actionFinalize);});}catch(error){console.error(error);_this16.scene.replaceAllElements(_this16.scene.getElementsIncludingDeleted().filter(function(el){return el.id!==imageElement.id;}));_this16.actionManager.executeAction(actionFinalize);}return;}if(isLinearElement(draggingElement)){if(draggingElement.points.length>1){_this16.history.resumeRecording();}var _pointerCoords=viewportCoordsToSceneCoords(childEvent,_this16.state);if(!pointerDownState.drag.hasOccurred&&draggingElement&&!multiElement){mutateElement(draggingElement,{points:[].concat(_toConsumableArray(draggingElement.points),[[_pointerCoords.x-draggingElement.x,_pointerCoords.y-draggingElement.y]])});_this16.setState({multiElement:draggingElement,editingElement:_this16.state.draggingElement});}else if(pointerDownState.drag.hasOccurred&&!multiElement){if(isBindingEnabled(_this16.state)&&isBindingElement(draggingElement,false)){maybeBindLinearElement(draggingElement,_this16.state,_this16.scene,_pointerCoords);}_this16.setState({suggestedBindings:[],startBoundElement:null});if(!activeTool.locked){resetCursor(_this16.canvas);_this16.setState(function(prevState){return{draggingElement:null,activeTool:updateActiveTool(_this16.state,{type:\"selection\"}),selectedElementIds:makeNextSelectedElementIds(_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},draggingElement.id,true)),prevState),selectedLinearElement:new LinearElementEditor(draggingElement,_this16.scene)};});}else{_this16.setState(function(prevState){return{draggingElement:null};});}}return;}if(activeTool.type!==\"selection\"&&draggingElement&&isInvisiblySmallElement(draggingElement)){// remove invisible element which was added in onPointerDown\n_this16.scene.replaceAllElements(_this16.scene.getElementsIncludingDeleted().slice(0,-1));_this16.setState({draggingElement:null});return;}if(draggingElement){if(pointerDownState.drag.hasOccurred){var sceneCoords=viewportCoordsToSceneCoords(childEvent,_this16.state);// when editing the points of a linear element, we check if the\n// linear element still is in the frame afterwards\n// if not, the linear element will be removed from its frame (if any)\nif(_this16.state.selectedLinearElement&&_this16.state.selectedLinearElement.isDragging){var linearElement=_this16.scene.getElement(_this16.state.selectedLinearElement.elementId);if(linearElement!==null&&linearElement!==void 0&&linearElement.frameId){var frame=getContainingFrame(linearElement);if(frame&&linearElement){if(!elementOverlapsWithFrame(linearElement,frame)){// remove the linear element from all groups\n// before removing it from the frame as well\nmutateElement(linearElement,{groupIds:[]});_this16.scene.replaceAllElements(removeElementsFromFrame(_this16.scene.getElementsIncludingDeleted(),[linearElement],_this16.state));}}}}else{// update the relationships between selected elements and frames\nvar topLayerFrame=_this16.getTopLayerFrameAtSceneCoords(sceneCoords);var selectedElements=_this16.scene.getSelectedElements(_this16.state);var nextElements=_this16.scene.getElementsIncludingDeleted();var updateGroupIdsAfterEditingGroup=function updateGroupIdsAfterEditingGroup(elements){if(elements.length>0){var _iterator3=_createForOfIteratorHelper(elements),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _element2=_step3.value;var index=_element2.groupIds.indexOf(_this16.state.editingGroupId);mutateElement(_element2,{groupIds:_element2.groupIds.slice(0,index)},false);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}nextElements.forEach(function(element){if(element.groupIds.length&&getElementsInGroup(nextElements,element.groupIds[element.groupIds.length-1]).length<2){mutateElement(element,{groupIds:[]},false);}});_this16.setState({editingGroupId:null});}};if(topLayerFrame&&!_this16.state.selectedElementIds[topLayerFrame.id]){var elementsToAdd=selectedElements.filter(function(element){return element.frameId!==topLayerFrame.id&&isElementInFrame(element,nextElements,_this16.state);});if(_this16.state.editingGroupId){updateGroupIdsAfterEditingGroup(elementsToAdd);}nextElements=addElementsToFrame(nextElements,elementsToAdd,topLayerFrame);}else if(!topLayerFrame){if(_this16.state.editingGroupId){var elementsToRemove=selectedElements.filter(function(element){return element.frameId&&!isElementInFrame(element,nextElements,_this16.state);});updateGroupIdsAfterEditingGroup(elementsToRemove);}}nextElements=updateFrameMembershipOfSelectedElements(_this16.scene.getElementsIncludingDeleted(),_this16.state,_this16);_this16.scene.replaceAllElements(nextElements);}}if(draggingElement.type===\"frame\"){var elementsInsideFrame=getElementsInNewFrame(_this16.scene.getElementsIncludingDeleted(),draggingElement);_this16.scene.replaceAllElements(addElementsToFrame(_this16.scene.getElementsIncludingDeleted(),elementsInsideFrame,draggingElement));}mutateElement(draggingElement,getNormalizedDimensions(draggingElement));}if(resizingElement){_this16.history.resumeRecording();}if(resizingElement&&isInvisiblySmallElement(resizingElement)){_this16.scene.replaceAllElements(_this16.scene.getElementsIncludingDeleted().filter(function(el){return el.id!==resizingElement.id;}));}// handle frame membership for resizing frames and/or selected elements\nif(pointerDownState.resize.isResizing){var _nextElements=updateFrameMembershipOfSelectedElements(_this16.scene.getElementsIncludingDeleted(),_this16.state,_this16);var selectedFrames=_this16.scene.getSelectedElements(_this16.state).filter(function(element){return element.type===\"frame\";});var _iterator4=_createForOfIteratorHelper(selectedFrames),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _frame=_step4.value;_nextElements=replaceAllElementsInFrame(_nextElements,getElementsInResizingFrame(_this16.scene.getElementsIncludingDeleted(),_frame,_this16.state),_frame,_this16.state);}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}_this16.scene.replaceAllElements(_nextElements);}// Code below handles selection when element(s) weren't\n// drag or added to selection on pointer down phase.\nvar hitElement=pointerDownState.hit.element;if(((_this16$state$selecte=_this16.state.selectedLinearElement)===null||_this16$state$selecte===void 0?void 0:_this16$state$selecte.elementId)!==(hitElement===null||hitElement===void 0?void 0:hitElement.id)&&isLinearElement(hitElement)){var _selectedELements=_this16.scene.getSelectedElements(_this16.state);// set selectedLinearElement when no other element selected except\n// the one we've hit\nif(_selectedELements.length===1){_this16.setState({selectedLinearElement:new LinearElementEditor(hitElement,_this16.scene)});}}if(isEraserActive(_this16.state)){var draggedDistance=distance2d(_this16.lastPointerDown.clientX,_this16.lastPointerDown.clientY,_this16.lastPointerUp.clientX,_this16.lastPointerUp.clientY);if(draggedDistance===0){var scenePointer=viewportCoordsToSceneCoords({clientX:_this16.lastPointerUp.clientX,clientY:_this16.lastPointerUp.clientY},_this16.state);var hitElements=_this16.getElementsAtPosition(scenePointer.x,scenePointer.y);hitElements.forEach(function(hitElement){return pointerDownState.elementIdsToErase[hitElement.id]={erase:true,opacity:hitElement.opacity};});}_this16.eraseElements(pointerDownState);return;}else if(Object.keys(pointerDownState.elementIdsToErase).length){_this16.restoreReadyToEraseElements(pointerDownState);}if(hitElement&&!pointerDownState.drag.hasOccurred&&!pointerDownState.hit.wasAddedToSelection&&(// if we're editing a line, pointerup shouldn't switch selection if\n// box selected\n!_this16.state.editingLinearElement||!pointerDownState.boxSelection.hasOccurred)){// when inside line editor, shift selects points instead\nif(childEvent.shiftKey&&!_this16.state.editingLinearElement){if(_this16.state.selectedElementIds[hitElement.id]){var _this16$state$selecte2;if(isSelectedViaGroup(_this16.state,hitElement)){_this16.setState(function(_prevState){var nextSelectedElementIds=_objectSpread({},_prevState.selectedElementIds);// We want to unselect all groups hitElement is part of\n// as well as all elements that are part of the groups\n// hitElement is part of\nvar _iterator5=_createForOfIteratorHelper(hitElement.groupIds.flatMap(function(groupId){return getElementsInGroup(_this16.scene.getNonDeletedElements(),groupId);})),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var groupedElement=_step5.value;delete nextSelectedElementIds[groupedElement.id];}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}return{selectedGroupIds:_objectSpread(_objectSpread({},_prevState.selectedElementIds),hitElement.groupIds.map(function(gId){return _defineProperty({},gId,false);}).reduce(function(prev,acc){return _objectSpread(_objectSpread({},prev),acc);},{})),selectedElementIds:makeNextSelectedElementIds(nextSelectedElementIds,_prevState)};});// if not gragging a linear element point (outside editor)\n}else if(!((_this16$state$selecte2=_this16.state.selectedLinearElement)!==null&&_this16$state$selecte2!==void 0&&_this16$state$selecte2.isDragging)){// remove element from selection while\n// keeping prev elements selected\n_this16.setState(function(prevState){var newSelectedElementIds=_objectSpread({},prevState.selectedElementIds);delete newSelectedElementIds[hitElement.id];var newSelectedElements=getSelectedElements(_this16.scene.getNonDeletedElements(),{selectedElementIds:newSelectedElementIds});return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:newSelectedElementIds,// set selectedLinearElement only if thats the only element selected\nselectedLinearElement:newSelectedElements.length===1&&isLinearElement(newSelectedElements[0])?new LinearElementEditor(newSelectedElements[0],_this16.scene):prevState.selectedLinearElement}),_this16.scene.getNonDeletedElements(),prevState,_this16);});}}else if(hitElement.frameId&&_this16.state.selectedElementIds[hitElement.frameId]){// when hitElement is part of a selected frame, deselect the frame\n// to avoid frame and containing elements selected simultaneously\n_this16.setState(function(prevState){var _this16$scene$getElem,_this16$scene$getElem2;var nextSelectedElementIds=_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},hitElement.id,true));// deselect the frame\ndelete nextSelectedElementIds[hitElement.frameId];// deselect groups containing the frame\n((_this16$scene$getElem=(_this16$scene$getElem2=_this16.scene.getElement(hitElement.frameId))===null||_this16$scene$getElem2===void 0?void 0:_this16$scene$getElem2.groupIds)!==null&&_this16$scene$getElem!==void 0?_this16$scene$getElem:[]).flatMap(function(gid){return getElementsInGroup(_this16.scene.getNonDeletedElements(),gid);}).forEach(function(element){delete nextSelectedElementIds[element.id];});return selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:nextSelectedElementIds,showHyperlinkPopup:hitElement.link?\"info\":false}),_this16.scene.getNonDeletedElements(),prevState,_this16);});}else{// add element to selection while keeping prev elements selected\n_this16.setState(function(_prevState){return{selectedElementIds:makeNextSelectedElementIds(_objectSpread(_objectSpread({},_prevState.selectedElementIds),{},_defineProperty({},hitElement.id,true)),_prevState)};});}}else{_this16.setState(function(prevState){var _prevState$selectedLi;return _objectSpread({},selectGroupsForSelectedElements(_objectSpread(_objectSpread({},prevState),{},{selectedElementIds:_defineProperty({},hitElement.id,true),selectedLinearElement:isLinearElement(hitElement)&&// Don't set `selectedLinearElement` if its same as the hitElement, this is mainly to prevent resetting the `hoverPointIndex` to -1.\n// Future we should update the API to take care of setting the correct `hoverPointIndex` when initialized\n((_prevState$selectedLi=prevState.selectedLinearElement)===null||_prevState$selectedLi===void 0?void 0:_prevState$selectedLi.elementId)!==hitElement.id?new LinearElementEditor(hitElement,_this16.scene):prevState.selectedLinearElement}),_this16.scene.getNonDeletedElements(),prevState,_this16));});}}if(!pointerDownState.drag.hasOccurred&&!_this16.state.isResizing&&(hitElement&&isHittingElementBoundingBoxWithoutHittingElement(hitElement,_this16.state,_this16.frameNameBoundsCache,pointerDownState.origin.x,pointerDownState.origin.y)||!hitElement&&pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements)){if(_this16.state.editingLinearElement){_this16.setState({editingLinearElement:null});}else{// Deselect selected elements\n_this16.setState({selectedElementIds:makeNextSelectedElementIds({},_this16.state),selectedGroupIds:{},editingGroupId:null});}return;}if(!activeTool.locked&&activeTool.type!==\"freedraw\"&&draggingElement&&draggingElement.type!==\"selection\"){_this16.setState(function(prevState){return{selectedElementIds:makeNextSelectedElementIds(_objectSpread(_objectSpread({},prevState.selectedElementIds),{},_defineProperty({},draggingElement.id,true)),prevState)};});}if(activeTool.type!==\"selection\"||isSomeElementSelected(_this16.scene.getNonDeletedElements(),_this16.state)){_this16.history.resumeRecording();}if(pointerDownState.drag.hasOccurred||isResizing||isRotating){(isBindingEnabled(_this16.state)?bindOrUnbindSelectedElements:unbindLinearElements)(_this16.scene.getSelectedElements(_this16.state));}if(!activeTool.locked&&activeTool.type!==\"freedraw\"){resetCursor(_this16.canvas);_this16.setState({draggingElement:null,suggestedBindings:[],activeTool:updateActiveTool(_this16.state,{type:\"selection\"})});}else{_this16.setState({draggingElement:null,suggestedBindings:[]});}});}},{key:\"maybeSuggestBindingForAll\",value:function maybeSuggestBindingForAll(selectedElements){var suggestedBindings=getEligibleElementsForBinding(selectedElements);this.setState({suggestedBindings:suggestedBindings});}},{key:\"clearSelection\",value:function clearSelection(hitElement){this.setState(function(prevState){return{selectedElementIds:makeNextSelectedElementIds({},prevState),selectedGroupIds:{},// Continue editing the same group if the user selected a different\n// element from it\neditingGroupId:prevState.editingGroupId&&hitElement!=null&&isElementInGroup(hitElement,prevState.editingGroupId)?prevState.editingGroupId:null};});this.setState({selectedElementIds:makeNextSelectedElementIds({},this.state),previousSelectedElementIds:this.state.selectedElementIds});}},{key:\"getTextWysiwygSnappedToCenterPosition\",value:function getTextWysiwygSnappedToCenterPosition(x,y,appState,container){if(container){var elementCenterX=container.x+container.width/2;var elementCenterY=container.y+container.height/2;var elementCenter=getContainerCenter(container,appState);if(elementCenter){elementCenterX=elementCenter.x;elementCenterY=elementCenter.y;}var distanceToCenter=Math.hypot(x-elementCenterX,y-elementCenterY);var isSnappedToCenter=distanceToCenter<TEXT_TO_CENTER_SNAP_THRESHOLD;if(isSnappedToCenter){var _sceneCoordsToViewpor4=sceneCoordsToViewportCoords({sceneX:elementCenterX,sceneY:elementCenterY},appState),viewportX=_sceneCoordsToViewpor4.x,viewportY=_sceneCoordsToViewpor4.y;return{viewportX:viewportX,viewportY:viewportY,elementCenterX:elementCenterX,elementCenterY:elementCenterY};}}}},{key:\"getCanvasOffsets\",value:function getCanvasOffsets(){var _this$excalidrawConta14;if((_this$excalidrawConta14=this.excalidrawContainerRef)!==null&&_this$excalidrawConta14!==void 0&&_this$excalidrawConta14.current){var excalidrawContainer=this.excalidrawContainerRef.current;var _excalidrawContainer$2=excalidrawContainer.getBoundingClientRect(),left=_excalidrawContainer$2.left,top=_excalidrawContainer$2.top;return{offsetLeft:left,offsetTop:top};}return{offsetLeft:0,offsetTop:0};}},{key:\"updateLanguage\",value:function(){var _updateLanguage=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){var _this17=this;var currentLang;return _regeneratorRuntime().wrap(function _callee16$(_context16){while(1)switch(_context16.prev=_context16.next){case 0:currentLang=languages.find(function(lang){return lang.code===_this17.props.langCode;})||defaultLang;_context16.next=3;return setLanguage(currentLang);case 3:this.setAppState({});case 4:case\"end\":return _context16.stop();}},_callee16,this);}));function updateLanguage(){return _updateLanguage.apply(this,arguments);}return updateLanguage;}()}],[{key:\"resetTapTwice\",value:function resetTapTwice(){didTapTwice=false;}}]);return App;}(React.Component);// -----------------------------------------------------------------------------\n// TEST HOOKS\n// -----------------------------------------------------------------------------\nApp.defaultProps={// needed for tests to pass since we directly render App in many tests\nUIOptions:DEFAULT_UI_OPTIONS};if(process.env.NODE_ENV===ENV.TEST||process.env.NODE_ENV===ENV.DEVELOPMENT){window.h=window.h||{};Object.defineProperties(window.h,{elements:{configurable:true,get:function get(){var _this$app;return(_this$app=this.app)===null||_this$app===void 0?void 0:_this$app.scene.getElementsIncludingDeleted();},set:function set(elements){var _this$app2;return(_this$app2=this.app)===null||_this$app2===void 0?void 0:_this$app2.scene.replaceAllElements(elements);}}});}export default App;","map":{"version":3,"names":["React","useContext","flushSync","rough","clsx","nanoid","actionAddToLibrary","actionBringForward","actionBringToFront","actionCopy","actionCopyAsPng","actionCopyAsSvg","copyText","actionCopyStyles","actionCut","actionDeleteSelected","actionDuplicateSelection","actionFinalize","actionFlipHorizontal","actionFlipVertical","actionGroup","actionPasteStyles","actionSelectAll","actionSendBackward","actionSendToBack","actionToggleGridMode","actionToggleStats","actionToggleZenMode","actionUnbindText","actionBindText","actionUngroup","actionLink","actionToggleElementLock","actionToggleLinearEditor","createRedoAction","createUndoAction","ActionManager","actions","trackEvent","getDefaultAppState","isEraserActive","isHandToolActive","parseClipboard","APP_NAME","CURSOR_TYPE","DEFAULT_MAX_IMAGE_WIDTH_OR_HEIGHT","DEFAULT_UI_OPTIONS","DEFAULT_VERTICAL_ALIGN","DRAGGING_THRESHOLD","ELEMENT_READY_TO_ERASE_OPACITY","ELEMENT_SHIFT_TRANSLATE_AMOUNT","ELEMENT_TRANSLATE_AMOUNT","ENV","EVENT","FRAME_STYLE","GRID_SIZE","IMAGE_MIME_TYPES","IMAGE_RENDER_TIMEOUT","isAndroid","isBrave","LINE_CONFIRM_THRESHOLD","MAX_ALLOWED_FILE_BYTES","MIME_TYPES","MQ_MAX_HEIGHT_LANDSCAPE","MQ_MAX_WIDTH_LANDSCAPE","MQ_MAX_WIDTH_PORTRAIT","MQ_RIGHT_SIDEBAR_MIN_WIDTH","MQ_SM_MAX_WIDTH","POINTER_BUTTON","ROUNDNESS","SCROLL_TIMEOUT","TAP_TWICE_TIMEOUT","TEXT_TO_CENTER_SNAP_THRESHOLD","THEME","THEME_FILTER","TOUCH_CTX_MENU_TIMEOUT","VERTICAL_ALIGN","ZOOM_STEP","exportCanvas","loadFromBlob","Library","distributeLibraryItemsOnSquareGrid","restore","restoreElements","dragNewElement","dragSelectedElements","duplicateElement","getCommonBounds","getCursorForResizingElement","getDragOffsetXY","getElementWithTransformHandleType","getNormalizedDimensions","getResizeArrowDirection","getResizeOffsetXY","getLockedLinearCursorAlignSize","getTransformHandleTypeFromCoords","hitTest","isHittingElementBoundingBoxWithoutHittingElement","isInvisiblySmallElement","isNonDeletedElement","isTextElement","newElement","newLinearElement","newTextElement","newImageElement","textWysiwyg","transformElements","updateTextElement","redrawTextBoundingBox","bindOrUnbindLinearElement","bindOrUnbindSelectedElements","fixBindingsAfterDeletion","fixBindingsAfterDuplication","getEligibleElementsForBinding","getHoveredElementForBinding","isBindingEnabled","isLinearElementSimpleAndAlreadyBound","maybeBindLinearElement","shouldEnableBindingForPointerEvent","unbindLinearElements","updateBoundElements","LinearElementEditor","mutateElement","newElementWith","deepCopyElement","duplicateElements","newFrameElement","newFreeDrawElement","hasBoundTextElement","isArrowElement","isBindingElement","isBindingElementType","isBoundToContainer","isFrameElement","isImageElement","isInitializedImageElement","isLinearElement","isLinearElementType","isUsingAdaptiveRadius","getCenter","getDistance","editGroupForSelectedElement","getElementsInGroup","getSelectedGroupIdForElement","getSelectedGroupIds","isElementInGroup","isSelectedViaGroup","selectGroupsForSelectedElements","History","defaultLang","getLanguage","languages","setLanguage","t","CODES","shouldResizeFromCenter","shouldMaintainAspectRatio","shouldRotateWithDiscreteAngle","isArrowKey","KEYS","distance2d","getGridPoint","isPathALoop","isVisibleElement","renderScene","invalidateShapeForElement","calculateScrollCenter","getElementsAtPosition","getElementsWithinSelection","getNormalizedZoom","getSelectedElements","hasBackground","isOverScrollBars","isSomeElementSelected","Scene","getStateForZoom","findShapeByKey","debounce","distance","getFontString","getNearestScrollableContainer","isInputLike","isToolIcon","isWritableElement","resetCursor","resolvablePromise","sceneCoordsToViewportCoords","setCursor","setCursorForShape","tupleToCoors","viewportCoordsToSceneCoords","withBatchedUpdates","wrapEvent","withBatchedUpdatesThrottled","updateObject","setEraserCursor","updateActiveTool","getShortcutKey","isTransparent","easeToValuesRAF","muteFSAbortError","easeOut","ContextMenu","CONTEXT_MENU_SEPARATOR","LayerUI","Toast","actionToggleViewMode","dataURLToFile","generateIdFromFile","getDataURL","getFileFromEvent","isImageFileHandle","isSupportedImageFile","loadSceneOrLibraryFromBlob","normalizeFile","parseLibraryJSON","resizeImageFile","SVGStringToFile","getInitializedImageElements","loadHTMLImageElement","normalizeSVG","updateImageCache","_updateImageCache","throttle","fileOpen","bindTextToShapeAfterDuplication","getApproxMinLineHeight","getApproxMinLineWidth","getBoundTextElement","getContainerCenter","getContainerDims","getContainerElement","getDefaultLineHeight","getLineHeightInPx","getTextBindableContainerAtPosition","isMeasureTextSupported","isValidTextContainer","isHittingElementNotConsideringBoundingBox","showHyperlinkTooltip","hideHyperlinkToolip","Hyperlink","isPointHittingLinkIcon","isLocalLink","normalizeLink","shouldShowBoundingBox","actionUnlockAllElements","Fonts","getFrameElements","isCursorInFrame","bindElementsToFramesAfterDuplication","addElementsToFrame","replaceAllElementsInFrame","removeElementsFromFrame","getElementsInResizingFrame","getElementsInNewFrame","getContainingFrame","elementOverlapsWithFrame","updateFrameMembershipOfSelectedElements","isElementInFrame","excludeElementsInFramesFromSelection","makeNextSelectedElementIds","actionPaste","actionRemoveAllElementsFromFrame","actionSelectAllElementsInFrame","actionToggleHandTool","zoomToFit","jotaiStore","activeConfirmDialogAtom","actionWrapTextInContainer","BraveMeasureTextError","activeEyeDropperAtom","isSidebarDockedAtom","jsx","_jsx","jsxs","_jsxs","AppContext","createContext","AppPropsContext","deviceContextInitialValue","isSmScreen","isMobile","isTouchScreen","canDeviceFitSidebar","isLandscape","DeviceContext","displayName","ExcalidrawContainerContext","container","id","ExcalidrawElementsContext","ExcalidrawAppStateContext","_objectSpread","width","height","offsetLeft","offsetTop","ExcalidrawSetAppStateContext","console","warn","ExcalidrawActionManagerContext","useApp","useAppProps","useDevice","useExcalidrawContainer","useExcalidrawElements","useExcalidrawAppState","useExcalidrawSetAppState","useExcalidrawActionManager","didTapTwice","tappedTwiceTimer","isHoldingSpace","isPanning","isDraggingScrollBar","currentScrollBars","horizontal","vertical","touchTimeout","invalidateContextMenu","THROTTLE_NEXT_RENDER","IS_PLAIN_PASTE","IS_PLAIN_PASTE_TIMER","PLAIN_PASTE_TOAST_SHOWN","lastPointerUp","gesture","pointers","Map","lastCenter","initialDistance","initialScale","App","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","canvas","rc","unmounted","actionManager","device","detachIsMobileMqHandler","excalidrawContainerRef","createRef","scene","fonts","resizeObserver","nearestScrollableContainer","library","libraryItemsFromStorage","history","excalidrawContainerValue","files","imageCache","hitLinkElement","lastPointerDown","lastViewportPosition","x","y","getFrameNameDOMId","frameElement","concat","frameNameBoundsCache","get","bounds","_cache","zoom","state","value","versionNonce","frameNameDiv","document","getElementById","box","getBoundingClientRect","boxSceneTopLeft","clientX","clientY","boxSceneBottomRight","right","bottom","angle","set","renderFrameNames","frameRendering","enabled","name","isDarkTheme","theme","getNonDeletedFrames","map","f","index","window","devicePixelRatio","scrollX","scrollY","_sceneCoordsToViewpor","sceneX","sceneY","x1","y1","_sceneCoordsToViewpor2","x2","FRAME_NAME_GAP","FRAME_NAME_EDIT_PADDING","reset","_f$name","trim","setState","editingFrame","frameNameJSX","frameNameInEdit","autoFocus","onChange","e","target","onBlur","onKeyDown","event","key","ESCAPE","ENTER","style","background","viewBackgroundColor","filter","zIndex","border","display","padding","borderRadius","boxShadow","fontFamily","fontSize","transform","color","overflow","maxWidth","Math","min","body","clientWidth","size","length","dir","autoComplete","autoCapitalize","autoCorrect","position","top","left","whiteSpace","textOverflow","cursor","MOVE","pointerEvents","viewModeEnabled","onPointerDown","handleCanvasPointerDown","onWheel","handleWheel","onContextMenu","handleCanvasContextMenu","onDoubleClick","children","focusContainer","_this$excalidrawConta","current","focus","getSceneElementsIncludingDeleted","getElementsIncludingDeleted","getSceneElements","getNonDeletedElements","onInsertElements","elements","addElementsFromPasteOrLibrary","onExportImage","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","type","fileHandle","wrap","_callee$","_context","prev","next","exportBackground","catch","error","errorMessage","message","sent","exportEmbedScene","stop","_x","_x2","apply","arguments","openEyeDropper","_ref2","swapPreviewOnAlt","previewType","onSelect","shouldUpdateStrokeColor","altKey","selectedElements","activeTool","currentItemStrokeColor","currentItemBackgroundColor","updateScene","el","selectedElementIds","_defineProperty","keepOpenOnAlt","syncActionResult","actionResult","editingElement","forEach","element","_this$state$editingEl","replaceAllElements","commitToHistory","resumeRecording","replaceFiles","addNewImagesToImageCache","appState","contextMenu","_actionResult$appStat","_actionResult$appStat2","_actionResult$appStat3","_actionResult$appStat4","_actionResult$appStat5","_actionResult$appStat6","_actionResult$appStat7","_actionResult$appStat8","_actionResult$appStat9","_editingElement","zenModeEnabled","gridSize","LIGHT","gridModeEnabled","isDeleted","Object","assign","syncHistory","setCurrentState","onUnload","disableEvent","preventDefault","resetHistory","clear","resetScene","opts","isLoading","resetLoadingState","initializeScene","_callee3","_scene$appState","_initialData2","initialData","_initialData","_callee3$","_context3","launchQueue","setConsumer","_ref4","_callee2","launchParams","blob","_callee2$","_context2","abrupt","getFile","loadFileToCanvas","File","_x3","t0","libraryItems","updateLibrary","merge","t1","repairBindings","openSidebar","toast","scrollToContent","loadFontsForElements","refreshDeviceState","_container$getBoundin","sidebarBreakpoint","UIOptions","dockedSidebarBreakpoint","onResize","cursorButton","pointerViewportCoords","remoteSelectedElementIds","pointerUsernames","pointerUserStates","collaborators","user","socketId","_i","_Object$keys","keys","push","pointer","username","userState","button","renderingElements","pendingImageElementId","selectionColor","getComputedStyle","querySelector","getPropertyValue","scale","renderConfig","remotePointerViewportCoords","remotePointerButton","remotePointerUsernames","remotePointerUserStates","shouldCacheIgnoreZoom","isExporting","renderScrollbars","callback","_ref5","atLeastOneVisibleElement","scrollBars","scrolledOutside","scheduleImageRefresh","EXCALIDRAW_THROTTLE_RENDER","onScroll","_this$getCanvasOffset","getCanvasOffsets","onCut","_this$excalidrawConta2","isExcalidrawActive","contains","activeElement","cutAll","stopPropagation","onCopy","_this$excalidrawConta3","copyAll","executeAction","onTapStart","clearTimeout","setTimeout","resetTapTwice","touches","_event$touches","_slicedToArray","touch","handleCanvasDoubleClick","onTapEnd","resetContextMenuTimer","previousSelectedElementIds","pasteFromClipboard","_ref6","_callee4","_this$excalidrawConta4","_event$clipboardData","isPlainPaste","elementUnderCursor","file","data","string","_viewportCoordsToScen","imageElement","_callee4$","_context4","elementFromPoint","HTMLCanvasElement","clipboardData","text","startsWith","endsWith","spreadsheet","createImageElement","insertImageElement","initializeImageDimensions","onPaste","pasteDialog","shown","retainSeed","addTextFromPaste","setActiveTool","_x4","_getCommonBounds","_getCommonBounds2","minX","minY","maxX","maxY","elementsCenterX","elementsCenterY","_viewportCoordsToScen2","dx","dy","_getGridPoint","_getGridPoint2","gridX","gridY","newElements","randomizeSeed","nextElements","_toConsumableArray","nextElementsToSelect","reduce","acc","selectedGroupIds","_assertThisInitialized","setAppState","removePointer","delete","pointerId","toggleLock","source","undefined","locked","prevState","updateFrameRendering","_next$enabled","_next$clip","_next$name","_next$outline","clip","outline","togglePenMode","penMode","onHandToolToggle","zoomCanvas","viewportX","viewportY","nextZoom","cancelInProgresAnimation","_this$cancelInProgres","_this2","targetElements","Array","isArray","fitToContent","fitToViewport","_zoomToFit","viewportZoomFactor","scroll","animate","_opts$duration","origScrollX","origScrollY","origZoom","cancel","fromValues","toValues","interpolateValue","from","to","progress","pow","onStep","_ref7","onStart","onEnd","onCancel","duration","translateCanvas","_this$cancelInProgres2","_this3","setToast","restoreFileFromShare","_callee5","webShareTargetCache","response","_callee5$","_context5","caches","open","match","replaceState","location","pathname","addFiles","filesMap","fileData","fromEntries","has","fileId","informMutation","sceneData","onSceneUpdated","toggleSidebar","_ref9","tab","force","nextName","_this$state$openSideb","updateCurrentCursorPosition","shiftKey","test","Proxy","ev","prop","bind","toUpperCase","toLowerCase","CTRL_OR_CMD","V","code","MINUS","EQUAL","QUESTION_MARK","openDialog","E","PAGE_UP","PAGE_DOWN","offset","handleKeyDown","step","offsetX","offsetY","ARROW_LEFT","ARROW_RIGHT","ARROW_UP","ARROW_DOWN","includeBoundTextElement","includeElementsInFrames","simultaneouslyUpdated","maybeSuggestBindingForAll","selectedElement","editingLinearElement","elementId","midPoint","startTextEditing","ctrlKey","metaKey","draggingElement","shape","Q","SPACE","GRAB","G","S","some","openPopup","BACKSPACE","DELETE","lowerCased","toLocaleLowerCase","isPickingStroke","isPickingBackground","I","onKeyUp","editingGroupId","suggestedBindings","tool","nextActiveTool","onImageAction","isTouchScreenMultiTouchGesture","onGestureStart","onGestureChange","onGestureEnd","_ref10","_existingTextElement","_existingTextElement2","_container$groupIds","_container$angle","_ref10$insertAtParent","insertAtParentCenter","shouldBindToContainer","parentCenterPosition","getTextWysiwygSnappedToCenterPosition","boundTextElementToContainer","existingTextElement","getTextElementAtPosition","currentItemFontFamily","lineHeight","currentItemFontSize","fontString","minWidth","minHeight","containerDims","newHeight","max","newWidth","topLayerFrame","getTopLayerFrameAtSceneCoords","elementCenterX","elementCenterY","strokeColor","backgroundColor","fillStyle","currentItemFillStyle","strokeWidth","currentItemStrokeWidth","strokeStyle","currentItemStrokeStyle","roughness","currentItemRoughness","opacity","currentItemOpacity","textAlign","currentItemTextAlign","verticalAlign","MIDDLE","containerId","groupIds","frameId","boundElements","containerIndex","getElementIndex","insertElementAtIndex","addNewElement","handleTextWysiwyg","isExistingElement","multiElement","_viewportCoordsToScen3","hitElement","getElementAtPosition","selectedGroupId","getElementLinkAtPosition","scenePointer","slice","reverse","hitElementIndex","Infinity","find","link","redirectToLink","draggedDistance","lastPointerDownCoords","lastPointerDownHittingLinkIcon","lastPointerUpCoords","lastPointerUpHittingLinkIcon","url","_customEvent","customEvent","onLinkOpen","EXCALIDRAW_LINK","nativeEvent","defaultPrevented","newWindow","opener","sceneCoords","frames","frame","handleCanvasPointerMove","savePointer","center","deltaX","deltaY","values","scaleFactor","zoomState","resetShouldCacheIgnoreZoomDebounced","isPointerOverScrollBars","isOverScrollBar","isOverEither","scenePointerX","scenePointerY","isDragging","handlePointerMove","lastUncommittedPoint","maybeSuggestBindingAtCursor","maybeSuggestBindingsForLinearElementAtCoords","startBoundElement","rx","ry","points","lastCommittedPoint","lastPoint","POINTER","_multiElement$lastCom","_getGridPoint3","_getGridPoint4","_ref11","_ref12","lastCommittedX","lastCommittedY","dxFromLastCommitted","dyFromLastCommitted","_getLockedLinearCurso","hasDeselectedButton","Boolean","buttons","elementWithTransformHandleType","pointerType","transformHandleType","showHyperlinkPopup","TEXT","CROSSHAIR","AUTO","selectedLinearElement","handleHoverSelectedLinearElement","isHittingCommonBoundingBoxOfSelectedElements","handleEraser","pointerDownState","updateElementIds","idsToUpdate","elementIdsToErase","erase","lastCoords","threshold","point","samplingInterval","hitElements","distanceRatio","nextX","nextY","ele","includes","handleTouchMove","_this$props","_this$props$onPointer","updateGestureOnPointerDown","obj","selection","getSelection","anchorNode","removeAllRanges","maybeOpenContextMenuAfterPointerDownOnTouchDevices","maybeCleanupAfterMissingPointerUp","penDetected","lastPointerDownWith","handleCanvasPanUsingWheelOrSpaceDrag","MAIN","TOUCH","initialPointerDownState","selectedElementsAreBeingDragged","handleDraggingScrollBar","clearSelectionIfNotUsingSelection","updateBindingEnabledOnPointerMove","handleSelectionOnPointerDown","allowOnPointerDown","handleTextOnPointerDown","handleLinearElementOnPointerDown","pendingImageElement","getElement","_viewportCoordsToScen4","handleFreeDrawElementOnPointerDown","createFrameElementOnPointerDown","createGenericElementOnPointerDown","onPointerMove","onPointerMoveFromPointerDownHandler","onPointerUp","onPointerUpFromPointerDownHandler","onKeyDownFromPointerDownHandler","onKeyUpFromPointerDownHandler","addEventListener","POINTER_MOVE","POINTER_UP","KEYDOWN","KEYUP","eventListeners","onMove","onUp","handleCanvasPointerUp","WHEEL","nextPastePrevented","isLinux","navigator","platform","GRABBING","lastX","lastY","abs","preventNextPaste","removeEventListener","PASTE","enableNextPaste","teardown","BLUR","flush","passive","origin","resizingElement","resize","handleType","isResizing","arrowDirection","_pointerDownState$hit","linearElementEditor","ret","handlePointerDown","hit","didAddPoint","allHitElements","someHitElementIsSelected","isASelectedElement","hasHitCommonBoundingBoxOfSelectedElements","clearSelection","wasAddedToSelection","nextSelectedElementIds","previouslySelectedElements","framesInGroups","Set","flatMap","gid","elementType","_getGridPoint5","_getGridPoint6","roundness","simulatePressure","pressure","pressures","boundElement","_ref13","_getGridPoint7","_getGridPoint8","_getGridPoint9","_getGridPoint10","_this$state","currentItemStartArrowhead","currentItemEndArrowhead","_ref14","_ref15","startArrowhead","endArrowhead","currentItemRoundness","PROPORTIONAL_RADIUS","_getGridPoint11","_getGridPoint12","ADAPTIVE_RADIUS","selectionElement","_getGridPoint13","_getGridPoint14","restoreReadyToEraseElements","eraseElements","initializeImage","_ref17","_callee7","_ref16","_this$props$generateI","_this$props2","_this$files$fileId2","imageFile","_imageElement","_ref16$showCursorImag","showCursorImagePreview","mimeType","existingFileData","_this$files$fileId","_dataURL","resizedFile","dataURL","_callee7$","_context7","Error","svg","t2","t3","t4","t5","generateIdForFile","maxWidthOrHeight","t6","maxSize","trunc","setImagePreviewCursor","t7","Promise","_ref18","_callee6","resolve","reject","_this$state$draggingE","cachedImageData","_callee6$","_context6","created","Date","now","lastRetrieved","image","finish","_x6","_x7","_x5","_ref19","_callee8","_callee8$","_context8","_x8","_x9","_x10","_ref20","_callee9","cursorImageSizePx","imagePreview","previewDataURL","img","context","_callee9$","_context9","createElement","getContext","drawImage","toDataURL","_x11","_callee10","_ref22","insertOnCanvasDirectly","_viewportCoordsToScen5","_args10","_callee10$","_context10","description","extensions","_this$imageCache$get","forceNaturalSize","placeholderSize","maxHeight","floor","naturalHeight","naturalWidth","_ref23","_callee11","_yield$_updateImageCa","updatedFiles","erroredFiles","_iterator","_step","_args11","_callee11$","_context11","fileIds","_createForOfIteratorHelper","s","n","done","err","status","_x12","_callee12","imageElements","uncachedImageElements","_yield$_this$updateIm","_args12","_callee12$","_context12","shouldEnableBinding","pointerCoords","hoveredBindableElement","linearElement","oppositeBindingBoundElement","coords","handleCanvasRef","TOUCH_START","TOUCH_END","_this$canvas","_this$canvas2","_this$canvas3","handleAppOnDrop","_ref25","_callee13","_yield$getFileFromEve","_viewportCoordsToScen6","libraryJSON","_callee13$","_context13","png","dataTransfer","getData","excalidrawlib","_x13","_ref26","_callee14","_callee14$","_context14","excalidraw","openLibraryMenu","_x14","_x15","SECONDARY","_viewportCoordsToScen7","preferSelected","includeLockedElements","isHittignCommonBoundBox","_container$getBoundin2","items","getContextMenuItems","maybeDragNewGenericElement","_this$imageCache$get2","_getGridPoint15","_getGridPoint16","aspectRatio","originInGrid","elementsToHighlight","maybeHandleResize","selectedFrames","isRotating","_getGridPoint17","_getGridPoint18","resizeX","resizeY","frameElementsOffsetsMap","elementsInFrame","_frameElementsOffsets","_frameElementsOffsets2","_frameElementsOffsets3","_frameElementsOffsets4","add","options","sign","MAX_STEP","absDelta","delta","newZoom","log10","_ref27","_ref28","_this$props$onPointer2","_this$props3","isNaN","onPointerUpdate","pointersMap","updateDOMRect","cb","_this$excalidrawConta5","excalidrawContainer","_excalidrawContainer$","_this$state2","currentWidth","currentHeight","currentOffsetTop","currentOffsetLeft","refresh","defaultAppState","excalidrawRef","_props$viewModeEnable","_props$zenModeEnabled","_props$gridModeEnable","_props$theme","_props$name","innerWidth","innerHeight","_excalidrawRef$curren","readyPromise","api","ready","getAppState","getFiles","registerAll","registerAction","_createClass","renderCanvas","_this4","canvasScale","_this$state3","canvasDOMWidth","canvasDOMHeight","canvasWidth","canvasHeight","className","ref","onPointerCancel","onTouchMove","render","_this$props5","_this5","_this$props4","renderTopRightUI","renderCustomStats","onDrop","tabIndex","handleKeyboardGlobally","Provider","onLockToggle","onPenModeToggle","langCode","showExitZenModeBtn","renderWelcomeScreen","showWelcomeScreen","app","onClose","closable","_componentDidMount","_callee15","_this6","_this$excalidrawConta6","_this$resizeObserver","mdScreenQuery","smScreenQuery","canDeviceFitSidebarMediaQuery","handler","searchParams","_callee15$","_context15","process","env","NODE_ENV","TEST","DEVELOPMENT","defineProperties","h","configurable","addCallback","addEventListeners","ResizeObserver","observe","matchMedia","matches","addListener","removeListener","URLSearchParams","search","componentDidMount","componentWillUnmount","_this$resizeObserver2","disconnect","removeEventListeners","destroy","clearCache","_this$excalidrawConta7","_this$nearestScrollab","_this$excalidrawConta8","_this$excalidrawConta9","_this$detachIsMobileM","COPY","CUT","SCROLL","MOUSE_MOVE","RESIZE","UNLOAD","DRAG_OVER","DROP","GESTURE_START","GESTURE_CHANGE","GESTURE_END","_this$excalidrawConta10","_document$fonts","_document$fonts$addEv","_this7","_this$excalidrawConta11","_this$excalidrawConta12","loadedFontFaces","fontfaces","onFontsLoaded","detectScroll","componentDidUpdate","prevProps","_this$excalidrawConta13","_this8","_this$state$editingEl2","_this$props6","_this$props6$onScroll","onScrollChange","updateLanguage","deselectElements","classList","toggle","getPointAtIndexGlobalCoordinates","record","_this$props$onChange","_this$props7","_this9","_viewportCoordsToScen8","textElementProps","LINE_GAP","currentY","lines","split","textElements","line","idx","_lines","prevLine","insertElementsAtIndex","shortcut","_ref29","_this10","_ref29$isExistingElem","updateElement","originalText","_element","getViewportCoords","_sceneCoordsToViewpor3","onSubmit","_ref30","viaKeyboard","elementIdToSelect","elementWithHighestZIndex","_this11","containingFrame","boundTextElement","hoverPointIndex","segmentMidPointHoveredCoords","getPointIndexUnderCursor","getSegmentMidpointHitCoords","arePointsEqual","_getCommonBounds3","_getCommonBounds4","withCmdOrCtrl","scrollbars","originalElements","hasBeenDuplicated","drag","hasOccurred","boxSelection","_this12","HTMLElement","handlePointerMoveOverScrollbars","_getCommonBounds5","_getCommonBounds6","y2","_this13","_this14","ALT","_this15","_pointerDownState$hit2","_getGridPoint19","_getGridPoint20","shouldAddMidpoint","addMidpoint","selectedPointsIndices","segmentMidpoint","added","didDrag","handlePointDragging","pointsSceneCoords","hasHitASelectedElement","isSelectingPointsInLineEditor","every","selectedElementsHasAFrame","frameToHighlight","_getGridPoint21","_getGridPoint22","dragX","dragY","_ref31","dragDistanceX","dragDistanceY","lockDirection","elementsToAppend","groupIdMap","oldIdToDuplicatedId","_iterator2","_step2","duplicatedElement","_getGridPoint23","_getGridPoint24","originDragX","originDragY","nextSceneElements","discardPoint","_getLockedLinearCurso2","handleBoxSelection","elementsWithinSelection","isOverHorizontal","isOverVertical","_this16","childEvent","_this16$state$selecte","_this16$state","_pointerDownState$hit3","_pointerDownState$hit4","handlePointerUp","_pointerDownState$hit5","_pointerDownState$hit6","selectedELements","startBindingElement","endBindingElement","updateGroupIdsAfterEditingGroup","_iterator3","_step3","indexOf","elementsToAdd","elementsToRemove","elementsInsideFrame","_iterator4","_step4","_this16$state$selecte2","_prevState","_iterator5","groupId","_step5","groupedElement","gId","newSelectedElementIds","newSelectedElements","_this16$scene$getElem","_this16$scene$getElem2","_prevState$selectedLi","elementCenter","distanceToCenter","hypot","isSnappedToCenter","_sceneCoordsToViewpor4","_this$excalidrawConta14","_excalidrawContainer$2","_updateLanguage","_callee16","_this17","currentLang","_callee16$","_context16","lang","Component","defaultProps","_this$app","_this$app2"],"sources":["D:/project/excalidraw-cn/src/components/App.tsx"],"sourcesContent":["import React, { useContext } from \"react\";\nimport { flushSync } from \"react-dom\";\n\nimport { RoughCanvas } from \"roughjs/bin/canvas\";\nimport rough from \"roughjs/bin/rough\";\nimport clsx from \"clsx\";\nimport { nanoid } from \"nanoid\";\n\nimport {\n  actionAddToLibrary,\n  actionBringForward,\n  actionBringToFront,\n  actionCopy,\n  actionCopyAsPng,\n  actionCopyAsSvg,\n  copyText,\n  actionCopyStyles,\n  actionCut,\n  actionDeleteSelected,\n  actionDuplicateSelection,\n  actionFinalize,\n  actionFlipHorizontal,\n  actionFlipVertical,\n  actionGroup,\n  actionPasteStyles,\n  actionSelectAll,\n  actionSendBackward,\n  actionSendToBack,\n  actionToggleGridMode,\n  actionToggleStats,\n  actionToggleZenMode,\n  actionUnbindText,\n  actionBindText,\n  actionUngroup,\n  actionLink,\n  actionToggleElementLock,\n  actionToggleLinearEditor,\n} from \"../actions\";\nimport { createRedoAction, createUndoAction } from \"../actions/actionHistory\";\nimport { ActionManager } from \"../actions/manager\";\nimport { actions } from \"../actions/register\";\nimport { ActionResult } from \"../actions/types\";\nimport { trackEvent } from \"../analytics\";\nimport {\n  getDefaultAppState,\n  isEraserActive,\n  isHandToolActive,\n} from \"../appState\";\nimport { parseClipboard } from \"../clipboard\";\nimport {\n  APP_NAME,\n  CURSOR_TYPE,\n  DEFAULT_MAX_IMAGE_WIDTH_OR_HEIGHT,\n  DEFAULT_UI_OPTIONS,\n  DEFAULT_VERTICAL_ALIGN,\n  DRAGGING_THRESHOLD,\n  ELEMENT_READY_TO_ERASE_OPACITY,\n  ELEMENT_SHIFT_TRANSLATE_AMOUNT,\n  ELEMENT_TRANSLATE_AMOUNT,\n  ENV,\n  EVENT,\n  FRAME_STYLE,\n  EXPORT_IMAGE_TYPES,\n  GRID_SIZE,\n  IMAGE_MIME_TYPES,\n  IMAGE_RENDER_TIMEOUT,\n  isAndroid,\n  isBrave,\n  LINE_CONFIRM_THRESHOLD,\n  MAX_ALLOWED_FILE_BYTES,\n  MIME_TYPES,\n  MQ_MAX_HEIGHT_LANDSCAPE,\n  MQ_MAX_WIDTH_LANDSCAPE,\n  MQ_MAX_WIDTH_PORTRAIT,\n  MQ_RIGHT_SIDEBAR_MIN_WIDTH,\n  MQ_SM_MAX_WIDTH,\n  POINTER_BUTTON,\n  ROUNDNESS,\n  SCROLL_TIMEOUT,\n  TAP_TWICE_TIMEOUT,\n  TEXT_TO_CENTER_SNAP_THRESHOLD,\n  THEME,\n  THEME_FILTER,\n  TOUCH_CTX_MENU_TIMEOUT,\n  VERTICAL_ALIGN,\n  ZOOM_STEP,\n} from \"../constants\";\nimport { exportCanvas, loadFromBlob } from \"../data\";\nimport Library, { distributeLibraryItemsOnSquareGrid } from \"../data/library\";\nimport { restore, restoreElements } from \"../data/restore\";\nimport {\n  dragNewElement,\n  dragSelectedElements,\n  duplicateElement,\n  getCommonBounds,\n  getCursorForResizingElement,\n  getDragOffsetXY,\n  getElementWithTransformHandleType,\n  getNormalizedDimensions,\n  getResizeArrowDirection,\n  getResizeOffsetXY,\n  getLockedLinearCursorAlignSize,\n  getTransformHandleTypeFromCoords,\n  hitTest,\n  isHittingElementBoundingBoxWithoutHittingElement,\n  isInvisiblySmallElement,\n  isNonDeletedElement,\n  isTextElement,\n  newElement,\n  newLinearElement,\n  newTextElement,\n  newImageElement,\n  textWysiwyg,\n  transformElements,\n  updateTextElement,\n  redrawTextBoundingBox,\n} from \"../element\";\nimport {\n  bindOrUnbindLinearElement,\n  bindOrUnbindSelectedElements,\n  fixBindingsAfterDeletion,\n  fixBindingsAfterDuplication,\n  getEligibleElementsForBinding,\n  getHoveredElementForBinding,\n  isBindingEnabled,\n  isLinearElementSimpleAndAlreadyBound,\n  maybeBindLinearElement,\n  shouldEnableBindingForPointerEvent,\n  unbindLinearElements,\n  updateBoundElements,\n} from \"../element/binding\";\nimport { LinearElementEditor } from \"../element/linearElementEditor\";\nimport { mutateElement, newElementWith } from \"../element/mutateElement\";\nimport {\n  deepCopyElement,\n  duplicateElements,\n  newFrameElement,\n  newFreeDrawElement,\n} from \"../element/newElement\";\nimport {\n  hasBoundTextElement,\n  isArrowElement,\n  isBindingElement,\n  isBindingElementType,\n  isBoundToContainer,\n  isFrameElement,\n  isImageElement,\n  isInitializedImageElement,\n  isLinearElement,\n  isLinearElementType,\n  isUsingAdaptiveRadius,\n} from \"../element/typeChecks\";\nimport {\n  ExcalidrawBindableElement,\n  ExcalidrawElement,\n  ExcalidrawFreeDrawElement,\n  ExcalidrawGenericElement,\n  ExcalidrawLinearElement,\n  ExcalidrawTextElement,\n  NonDeleted,\n  InitializedExcalidrawImageElement,\n  ExcalidrawImageElement,\n  FileId,\n  NonDeletedExcalidrawElement,\n  ExcalidrawTextContainer,\n  ExcalidrawFrameElement,\n} from \"../element/types\";\nimport { getCenter, getDistance } from \"../gesture\";\nimport {\n  editGroupForSelectedElement,\n  getElementsInGroup,\n  getSelectedGroupIdForElement,\n  getSelectedGroupIds,\n  isElementInGroup,\n  isSelectedViaGroup,\n  selectGroupsForSelectedElements,\n} from \"../groups\";\nimport History from \"../history\";\nimport { defaultLang, getLanguage, languages, setLanguage, t } from \"../i18n\";\nimport {\n  CODES,\n  shouldResizeFromCenter,\n  shouldMaintainAspectRatio,\n  shouldRotateWithDiscreteAngle,\n  isArrowKey,\n  KEYS,\n} from \"../keys\";\nimport { distance2d, getGridPoint, isPathALoop } from \"../math\";\nimport { isVisibleElement, renderScene } from \"../renderer/renderScene\";\nimport { invalidateShapeForElement } from \"../renderer/renderElement\";\nimport {\n  calculateScrollCenter,\n  getElementsAtPosition,\n  getElementsWithinSelection,\n  getNormalizedZoom,\n  getSelectedElements,\n  hasBackground,\n  isOverScrollBars,\n  isSomeElementSelected,\n} from \"../scene\";\nimport Scene from \"../scene/Scene\";\nimport { RenderConfig, ScrollBars } from \"../scene/types\";\nimport { getStateForZoom } from \"../scene/zoom\";\nimport { findShapeByKey, SHAPES } from \"../shapes\";\nimport {\n  AppClassProperties,\n  AppProps,\n  AppState,\n  BinaryFileData,\n  DataURL,\n  ExcalidrawImperativeAPI,\n  BinaryFiles,\n  Gesture,\n  GestureEvent,\n  LibraryItems,\n  PointerDownState,\n  SceneData,\n  Device,\n  FrameNameBoundsCache,\n  SidebarName,\n  SidebarTabName,\n} from \"../types\";\nimport {\n  debounce,\n  distance,\n  getFontString,\n  getNearestScrollableContainer,\n  isInputLike,\n  isToolIcon,\n  isWritableElement,\n  resetCursor,\n  resolvablePromise,\n  sceneCoordsToViewportCoords,\n  setCursor,\n  setCursorForShape,\n  tupleToCoors,\n  viewportCoordsToSceneCoords,\n  withBatchedUpdates,\n  wrapEvent,\n  withBatchedUpdatesThrottled,\n  updateObject,\n  setEraserCursor,\n  updateActiveTool,\n  getShortcutKey,\n  isTransparent,\n  easeToValuesRAF,\n  muteFSAbortError,\n  easeOut,\n} from \"../utils\";\nimport {\n  ContextMenu,\n  ContextMenuItems,\n  CONTEXT_MENU_SEPARATOR,\n} from \"./ContextMenu\";\nimport LayerUI from \"./LayerUI\";\nimport { Toast } from \"./Toast\";\nimport { actionToggleViewMode } from \"../actions/actionToggleViewMode\";\nimport {\n  dataURLToFile,\n  generateIdFromFile,\n  getDataURL,\n  getFileFromEvent,\n  isImageFileHandle,\n  isSupportedImageFile,\n  loadSceneOrLibraryFromBlob,\n  normalizeFile,\n  parseLibraryJSON,\n  resizeImageFile,\n  SVGStringToFile,\n} from \"../data/blob\";\nimport {\n  getInitializedImageElements,\n  loadHTMLImageElement,\n  normalizeSVG,\n  updateImageCache as _updateImageCache,\n} from \"../element/image\";\nimport throttle from \"lodash.throttle\";\nimport { fileOpen, FileSystemHandle } from \"../data/filesystem\";\nimport {\n  bindTextToShapeAfterDuplication,\n  getApproxMinLineHeight,\n  getApproxMinLineWidth,\n  getBoundTextElement,\n  getContainerCenter,\n  getContainerDims,\n  getContainerElement,\n  getDefaultLineHeight,\n  getLineHeightInPx,\n  getTextBindableContainerAtPosition,\n  isMeasureTextSupported,\n  isValidTextContainer,\n} from \"../element/textElement\";\nimport { isHittingElementNotConsideringBoundingBox } from \"../element/collision\";\nimport {\n  showHyperlinkTooltip,\n  hideHyperlinkToolip,\n  Hyperlink,\n  isPointHittingLinkIcon,\n} from \"../element/Hyperlink\";\nimport { isLocalLink, normalizeLink } from \"../data/url\";\nimport { shouldShowBoundingBox } from \"../element/transformHandles\";\nimport { actionUnlockAllElements } from \"../actions/actionElementLock\";\nimport { Fonts } from \"../scene/Fonts\";\nimport {\n  getFrameElements,\n  isCursorInFrame,\n  bindElementsToFramesAfterDuplication,\n  addElementsToFrame,\n  replaceAllElementsInFrame,\n  removeElementsFromFrame,\n  getElementsInResizingFrame,\n  getElementsInNewFrame,\n  getContainingFrame,\n  elementOverlapsWithFrame,\n  updateFrameMembershipOfSelectedElements,\n  isElementInFrame,\n} from \"../frame\";\nimport {\n  excludeElementsInFramesFromSelection,\n  makeNextSelectedElementIds,\n} from \"../scene/selection\";\nimport { actionPaste } from \"../actions/actionClipboard\";\nimport {\n  actionRemoveAllElementsFromFrame,\n  actionSelectAllElementsInFrame,\n} from \"../actions/actionFrame\";\nimport { actionToggleHandTool, zoomToFit } from \"../actions/actionCanvas\";\nimport { jotaiStore } from \"../jotai\";\nimport { activeConfirmDialogAtom } from \"./ActiveConfirmDialog\";\nimport { actionWrapTextInContainer } from \"../actions/actionBoundText\";\nimport BraveMeasureTextError from \"./BraveMeasureTextError\";\nimport { activeEyeDropperAtom } from \"./EyeDropper\";\nimport { isSidebarDockedAtom } from \"./Sidebar/Sidebar\";\n\nconst AppContext = React.createContext<AppClassProperties>(null!);\nconst AppPropsContext = React.createContext<AppProps>(null!);\n\nconst deviceContextInitialValue = {\n  isSmScreen: false,\n  isMobile: false,\n  isTouchScreen: false,\n  canDeviceFitSidebar: false,\n  isLandscape: false,\n};\nconst DeviceContext = React.createContext<Device>(deviceContextInitialValue);\nDeviceContext.displayName = \"DeviceContext\";\n\nexport const ExcalidrawContainerContext = React.createContext<{\n  container: HTMLDivElement | null;\n  id: string | null;\n}>({ container: null, id: null });\nExcalidrawContainerContext.displayName = \"ExcalidrawContainerContext\";\n\nconst ExcalidrawElementsContext = React.createContext<\n  readonly NonDeletedExcalidrawElement[]\n>([]);\nExcalidrawElementsContext.displayName = \"ExcalidrawElementsContext\";\n\nconst ExcalidrawAppStateContext = React.createContext<AppState>({\n  ...getDefaultAppState(),\n  width: 0,\n  height: 0,\n  offsetLeft: 0,\n  offsetTop: 0,\n});\nExcalidrawAppStateContext.displayName = \"ExcalidrawAppStateContext\";\n\nconst ExcalidrawSetAppStateContext = React.createContext<\n  React.Component<any, AppState>[\"setState\"]\n>(() => {\n  console.warn(\"unitialized ExcalidrawSetAppStateContext context!\");\n});\nExcalidrawSetAppStateContext.displayName = \"ExcalidrawSetAppStateContext\";\n\nconst ExcalidrawActionManagerContext = React.createContext<ActionManager>(\n  null!,\n);\nExcalidrawActionManagerContext.displayName = \"ExcalidrawActionManagerContext\";\n\nexport const useApp = () => useContext(AppContext);\nexport const useAppProps = () => useContext(AppPropsContext);\nexport const useDevice = () => useContext<Device>(DeviceContext);\nexport const useExcalidrawContainer = () =>\n  useContext(ExcalidrawContainerContext);\nexport const useExcalidrawElements = () =>\n  useContext(ExcalidrawElementsContext);\nexport const useExcalidrawAppState = () =>\n  useContext(ExcalidrawAppStateContext);\nexport const useExcalidrawSetAppState = () =>\n  useContext(ExcalidrawSetAppStateContext);\nexport const useExcalidrawActionManager = () =>\n  useContext(ExcalidrawActionManagerContext);\n\nlet didTapTwice: boolean = false;\nlet tappedTwiceTimer = 0;\nlet isHoldingSpace: boolean = false;\nlet isPanning: boolean = false;\nlet isDraggingScrollBar: boolean = false;\nlet currentScrollBars: ScrollBars = { horizontal: null, vertical: null };\nlet touchTimeout = 0;\nlet invalidateContextMenu = false;\n\n// remove this hack when we can sync render & resizeObserver (state update)\n// to rAF. See #5439\nlet THROTTLE_NEXT_RENDER = true;\n\nlet IS_PLAIN_PASTE = false;\nlet IS_PLAIN_PASTE_TIMER = 0;\nlet PLAIN_PASTE_TOAST_SHOWN = false;\n\nlet lastPointerUp: ((event: any) => void) | null = null;\nconst gesture: Gesture = {\n  pointers: new Map(),\n  lastCenter: null,\n  initialDistance: null,\n  initialScale: null,\n};\n\nclass App extends React.Component<AppProps, AppState> {\n  canvas: AppClassProperties[\"canvas\"] = null;\n  rc: RoughCanvas | null = null;\n  unmounted: boolean = false;\n  actionManager: ActionManager;\n  device: Device = deviceContextInitialValue;\n  detachIsMobileMqHandler?: () => void;\n\n  private excalidrawContainerRef = React.createRef<HTMLDivElement>();\n\n  public static defaultProps: Partial<AppProps> = {\n    // needed for tests to pass since we directly render App in many tests\n    UIOptions: DEFAULT_UI_OPTIONS,\n  };\n\n  public scene: Scene;\n  private fonts: Fonts;\n  private resizeObserver: ResizeObserver | undefined;\n  private nearestScrollableContainer: HTMLElement | Document | undefined;\n  public library: AppClassProperties[\"library\"];\n  public libraryItemsFromStorage: LibraryItems | undefined;\n  public id: string;\n  private history: History;\n  private excalidrawContainerValue: {\n    container: HTMLDivElement | null;\n    id: string;\n  };\n\n  public files: BinaryFiles = {};\n  public imageCache: AppClassProperties[\"imageCache\"] = new Map();\n\n  hitLinkElement?: NonDeletedExcalidrawElement;\n  lastPointerDown: React.PointerEvent<HTMLElement> | null = null;\n  lastPointerUp: React.PointerEvent<HTMLElement> | PointerEvent | null = null;\n  lastViewportPosition = { x: 0, y: 0 };\n\n  constructor(props: AppProps) {\n    super(props);\n    const defaultAppState = getDefaultAppState();\n    const {\n      excalidrawRef,\n      viewModeEnabled = false,\n      zenModeEnabled = false,\n      gridModeEnabled = false,\n      theme = defaultAppState.theme,\n      name = defaultAppState.name,\n    } = props;\n    this.state = {\n      ...defaultAppState,\n      theme,\n      isLoading: true,\n      ...this.getCanvasOffsets(),\n      viewModeEnabled,\n      zenModeEnabled,\n      gridSize: gridModeEnabled ? GRID_SIZE : null,\n      name,\n      width: window.innerWidth,\n      height: window.innerHeight,\n    };\n\n    this.id = nanoid();\n    this.library = new Library(this);\n    if (excalidrawRef) {\n      const readyPromise =\n        (\"current\" in excalidrawRef && excalidrawRef.current?.readyPromise) ||\n        resolvablePromise<ExcalidrawImperativeAPI>();\n\n      const api: ExcalidrawImperativeAPI = {\n        ready: true,\n        readyPromise,\n        updateScene: this.updateScene,\n        updateLibrary: this.library.updateLibrary,\n        addFiles: this.addFiles,\n        resetScene: this.resetScene,\n        getSceneElementsIncludingDeleted: this.getSceneElementsIncludingDeleted,\n        history: {\n          clear: this.resetHistory,\n        },\n        scrollToContent: this.scrollToContent,\n        getSceneElements: this.getSceneElements,\n        getAppState: () => this.state,\n        getFiles: () => this.files,\n        refresh: this.refresh,\n        setToast: this.setToast,\n        id: this.id,\n        setActiveTool: this.setActiveTool,\n        setCursor: this.setCursor,\n        resetCursor: this.resetCursor,\n        updateFrameRendering: this.updateFrameRendering,\n        toggleSidebar: this.toggleSidebar,\n      } as const;\n      if (typeof excalidrawRef === \"function\") {\n        excalidrawRef(api);\n      } else {\n        excalidrawRef.current = api;\n      }\n      readyPromise.resolve(api);\n    }\n\n    this.excalidrawContainerValue = {\n      container: this.excalidrawContainerRef.current,\n      id: this.id,\n    };\n\n    this.scene = new Scene();\n    this.fonts = new Fonts({\n      scene: this.scene,\n      onSceneUpdated: this.onSceneUpdated,\n    });\n    this.history = new History();\n    this.actionManager = new ActionManager(\n      this.syncActionResult,\n      () => this.state,\n      () => this.scene.getElementsIncludingDeleted(),\n      this,\n    );\n    this.actionManager.registerAll(actions);\n\n    this.actionManager.registerAction(createUndoAction(this.history));\n    this.actionManager.registerAction(createRedoAction(this.history));\n  }\n\n  private renderCanvas() {\n    const canvasScale = window.devicePixelRatio;\n    const {\n      width: canvasDOMWidth,\n      height: canvasDOMHeight,\n      viewModeEnabled,\n    } = this.state;\n    const canvasWidth = canvasDOMWidth * canvasScale;\n    const canvasHeight = canvasDOMHeight * canvasScale;\n    if (viewModeEnabled) {\n      return (\n        <canvas\n          className=\"excalidraw__canvas\"\n          style={{\n            width: canvasDOMWidth,\n            height: canvasDOMHeight,\n            cursor: CURSOR_TYPE.GRAB,\n          }}\n          width={canvasWidth}\n          height={canvasHeight}\n          ref={this.handleCanvasRef}\n          onContextMenu={(event: React.PointerEvent<HTMLCanvasElement>) =>\n            this.handleCanvasContextMenu(event)\n          }\n          onPointerMove={this.handleCanvasPointerMove}\n          onPointerUp={this.handleCanvasPointerUp}\n          onPointerCancel={this.removePointer}\n          onTouchMove={this.handleTouchMove}\n          onPointerDown={this.handleCanvasPointerDown}\n        >\n          {t(\"labels.drawingCanvas\")}\n        </canvas>\n      );\n    }\n    return (\n      <canvas\n        className=\"excalidraw__canvas\"\n        style={{\n          width: canvasDOMWidth,\n          height: canvasDOMHeight,\n        }}\n        width={canvasWidth}\n        height={canvasHeight}\n        ref={this.handleCanvasRef}\n        onContextMenu={(event: React.PointerEvent<HTMLCanvasElement>) =>\n          this.handleCanvasContextMenu(event)\n        }\n        onPointerDown={this.handleCanvasPointerDown}\n        onDoubleClick={this.handleCanvasDoubleClick}\n        onPointerMove={this.handleCanvasPointerMove}\n        onPointerUp={this.handleCanvasPointerUp}\n        onPointerCancel={this.removePointer}\n        onTouchMove={this.handleTouchMove}\n      >\n        {t(\"labels.drawingCanvas\")}\n      </canvas>\n    );\n  }\n\n  private getFrameNameDOMId = (frameElement: ExcalidrawElement) => {\n    return `${this.id}-frame-name-${frameElement.id}`;\n  };\n\n  frameNameBoundsCache: FrameNameBoundsCache = {\n    get: (frameElement) => {\n      let bounds = this.frameNameBoundsCache._cache.get(frameElement.id);\n      if (\n        !bounds ||\n        bounds.zoom !== this.state.zoom.value ||\n        bounds.versionNonce !== frameElement.versionNonce\n      ) {\n        const frameNameDiv = document.getElementById(\n          this.getFrameNameDOMId(frameElement),\n        );\n\n        if (frameNameDiv) {\n          const box = frameNameDiv.getBoundingClientRect();\n          const boxSceneTopLeft = viewportCoordsToSceneCoords(\n            { clientX: box.x, clientY: box.y },\n            this.state,\n          );\n          const boxSceneBottomRight = viewportCoordsToSceneCoords(\n            { clientX: box.right, clientY: box.bottom },\n            this.state,\n          );\n\n          bounds = {\n            x: boxSceneTopLeft.x,\n            y: boxSceneTopLeft.y,\n            width: boxSceneBottomRight.x - boxSceneTopLeft.x,\n            height: boxSceneBottomRight.y - boxSceneTopLeft.y,\n            angle: 0,\n            zoom: this.state.zoom.value,\n            versionNonce: frameElement.versionNonce,\n          };\n\n          this.frameNameBoundsCache._cache.set(frameElement.id, bounds);\n\n          return bounds;\n        }\n        return null;\n      }\n\n      return bounds;\n    },\n    /**\n     * @private\n     */\n    _cache: new Map(),\n  };\n\n  private renderFrameNames = () => {\n    if (!this.state.frameRendering.enabled || !this.state.frameRendering.name) {\n      return null;\n    }\n\n    const isDarkTheme = this.state.theme === \"dark\";\n\n    return this.scene.getNonDeletedFrames().map((f, index) => {\n      if (\n        !this.canvas ||\n        !isVisibleElement(\n          f,\n          this.canvas.width / window.devicePixelRatio,\n          this.canvas.height / window.devicePixelRatio,\n          {\n            offsetLeft: this.state.offsetLeft,\n            offsetTop: this.state.offsetTop,\n            scrollX: this.state.scrollX,\n            scrollY: this.state.scrollY,\n            zoom: this.state.zoom,\n          },\n        )\n      ) {\n        // if frame not visible, don't render its name\n        return null;\n      }\n\n      const { x: x1, y: y1 } = sceneCoordsToViewportCoords(\n        { sceneX: f.x, sceneY: f.y },\n        this.state,\n      );\n\n      const { x: x2 } = sceneCoordsToViewportCoords(\n        { sceneX: f.x + f.width, sceneY: f.y + f.height },\n        this.state,\n      );\n\n      const FRAME_NAME_GAP = 20;\n      const FRAME_NAME_EDIT_PADDING = 6;\n\n      const reset = () => {\n        if (f.name?.trim() === \"\") {\n          mutateElement(f, { name: null });\n        }\n\n        this.setState({ editingFrame: null });\n      };\n\n      let frameNameJSX;\n\n      if (f.id === this.state.editingFrame) {\n        const frameNameInEdit = f.name == null ? `Frame ${index + 1}` : f.name;\n\n        frameNameJSX = (\n          <input\n            autoFocus\n            value={frameNameInEdit}\n            onChange={(e) => {\n              mutateElement(f, {\n                name: e.target.value,\n              });\n            }}\n            onBlur={() => reset()}\n            onKeyDown={(event) => {\n              // for some inexplicable reason, `onBlur` triggered on ESC\n              // does not reset `state.editingFrame` despite being called,\n              // and we need to reset it here as well\n              if (event.key === KEYS.ESCAPE || event.key === KEYS.ENTER) {\n                reset();\n              }\n            }}\n            style={{\n              background: this.state.viewBackgroundColor,\n              filter: isDarkTheme ? THEME_FILTER : \"none\",\n              zIndex: 2,\n              border: \"none\",\n              display: \"block\",\n              padding: `${FRAME_NAME_EDIT_PADDING}px`,\n              borderRadius: 4,\n              boxShadow: \"inset 0 0 0 1px var(--color-primary)\",\n              fontFamily: \"Assistant\",\n              fontSize: \"14px\",\n              transform: `translateY(-${FRAME_NAME_EDIT_PADDING}px)`,\n              color: \"var(--color-gray-80)\",\n              overflow: \"hidden\",\n              maxWidth: `${Math.min(\n                x2 - x1 - FRAME_NAME_EDIT_PADDING,\n                document.body.clientWidth - x1 - FRAME_NAME_EDIT_PADDING,\n              )}px`,\n            }}\n            size={frameNameInEdit.length + 1 || 1}\n            dir=\"auto\"\n            autoComplete=\"off\"\n            autoCapitalize=\"off\"\n            autoCorrect=\"off\"\n          />\n        );\n      } else {\n        frameNameJSX =\n          f.name == null || f.name.trim() === \"\"\n            ? `Frame ${index + 1}`\n            : f.name.trim();\n      }\n\n      return (\n        <div\n          id={this.getFrameNameDOMId(f)}\n          key={f.id}\n          style={{\n            position: \"absolute\",\n            top: `${y1 - FRAME_NAME_GAP - this.state.offsetTop}px`,\n            left: `${\n              x1 -\n              this.state.offsetLeft -\n              (this.state.editingFrame === f.id ? FRAME_NAME_EDIT_PADDING : 0)\n            }px`,\n            zIndex: 2,\n            fontSize: \"14px\",\n            color: isDarkTheme\n              ? \"var(--color-gray-60)\"\n              : \"var(--color-gray-50)\",\n            width: \"max-content\",\n            maxWidth: `${x2 - x1 + FRAME_NAME_EDIT_PADDING * 2}px`,\n            overflow: f.id === this.state.editingFrame ? \"visible\" : \"hidden\",\n            whiteSpace: \"nowrap\",\n            textOverflow: \"ellipsis\",\n            cursor: CURSOR_TYPE.MOVE,\n            // disable all interaction (e.g. cursor change) when in view\n            // mode\n            pointerEvents: this.state.viewModeEnabled ? \"none\" : \"all\",\n          }}\n          onPointerDown={(event) => this.handleCanvasPointerDown(event)}\n          onWheel={(event) => this.handleWheel(event)}\n          onContextMenu={(event: React.PointerEvent<HTMLDivElement>) => {\n            this.handleCanvasContextMenu(event);\n          }}\n          onDoubleClick={() => {\n            this.setState({\n              editingFrame: f.id,\n            });\n          }}\n        >\n          {frameNameJSX}\n        </div>\n      );\n    });\n  };\n\n  public render() {\n    const selectedElement = this.scene.getSelectedElements(this.state);\n    const { renderTopRightUI, renderCustomStats } = this.props;\n\n    return (\n      <div\n        className={clsx(\"excalidraw excalidraw-container\", {\n          \"excalidraw--view-mode\": this.state.viewModeEnabled,\n          \"excalidraw--mobile\": this.device.isMobile,\n        })}\n        ref={this.excalidrawContainerRef}\n        onDrop={this.handleAppOnDrop}\n        tabIndex={0}\n        onKeyDown={\n          this.props.handleKeyboardGlobally ? undefined : this.onKeyDown\n        }\n      >\n        <AppContext.Provider value={this}>\n          <AppPropsContext.Provider value={this.props}>\n            <ExcalidrawContainerContext.Provider\n              value={this.excalidrawContainerValue}\n            >\n              <DeviceContext.Provider value={this.device}>\n                <ExcalidrawSetAppStateContext.Provider value={this.setAppState}>\n                  <ExcalidrawAppStateContext.Provider value={this.state}>\n                    <ExcalidrawElementsContext.Provider\n                      value={this.scene.getNonDeletedElements()}\n                    >\n                      <ExcalidrawActionManagerContext.Provider\n                        value={this.actionManager}\n                      >\n                        <LayerUI\n                          canvas={this.canvas}\n                          appState={this.state}\n                          files={this.files}\n                          setAppState={this.setAppState}\n                          actionManager={this.actionManager}\n                          elements={this.scene.getNonDeletedElements()}\n                          onLockToggle={this.toggleLock}\n                          onPenModeToggle={this.togglePenMode}\n                          onHandToolToggle={this.onHandToolToggle}\n                          langCode={getLanguage().code}\n                          renderTopRightUI={renderTopRightUI}\n                          renderCustomStats={renderCustomStats}\n                          showExitZenModeBtn={\n                            typeof this.props?.zenModeEnabled === \"undefined\" &&\n                            this.state.zenModeEnabled\n                          }\n                          UIOptions={this.props.UIOptions}\n                          onImageAction={this.onImageAction}\n                          onExportImage={this.onExportImage}\n                          renderWelcomeScreen={\n                            !this.state.isLoading &&\n                            this.state.showWelcomeScreen &&\n                            this.state.activeTool.type === \"selection\" &&\n                            !this.state.zenModeEnabled &&\n                            !this.scene.getElementsIncludingDeleted().length\n                          }\n                          app={this}\n                        >\n                          {this.props.children}\n                        </LayerUI>\n                        <div className=\"excalidraw-textEditorContainer\" />\n                        <div className=\"excalidraw-contextMenuContainer\" />\n                        <div className=\"excalidraw-eye-dropper-container\" />\n                        {selectedElement.length === 1 &&\n                          !this.state.contextMenu &&\n                          this.state.showHyperlinkPopup && (\n                            <Hyperlink\n                              key={selectedElement[0].id}\n                              element={selectedElement[0]}\n                              setAppState={this.setAppState}\n                              onLinkOpen={this.props.onLinkOpen}\n                            />\n                          )}\n                        {this.state.toast !== null && (\n                          <Toast\n                            message={this.state.toast.message}\n                            onClose={() => this.setToast(null)}\n                            duration={this.state.toast.duration}\n                            closable={this.state.toast.closable}\n                          />\n                        )}\n                        {this.state.contextMenu && (\n                          <ContextMenu\n                            items={this.state.contextMenu.items}\n                            top={this.state.contextMenu.top}\n                            left={this.state.contextMenu.left}\n                            actionManager={this.actionManager}\n                          />\n                        )}\n                        <main>{this.renderCanvas()}</main>\n                        {this.renderFrameNames()}\n                      </ExcalidrawActionManagerContext.Provider>\n                    </ExcalidrawElementsContext.Provider>\n                  </ExcalidrawAppStateContext.Provider>\n                </ExcalidrawSetAppStateContext.Provider>\n              </DeviceContext.Provider>\n            </ExcalidrawContainerContext.Provider>\n          </AppPropsContext.Provider>\n        </AppContext.Provider>\n      </div>\n    );\n  }\n\n  public focusContainer: AppClassProperties[\"focusContainer\"] = () => {\n    this.excalidrawContainerRef.current?.focus();\n  };\n\n  public getSceneElementsIncludingDeleted = () => {\n    return this.scene.getElementsIncludingDeleted();\n  };\n\n  public getSceneElements = () => {\n    return this.scene.getNonDeletedElements();\n  };\n\n  public onInsertElements = (elements: readonly ExcalidrawElement[]) => {\n    this.addElementsFromPasteOrLibrary({\n      elements,\n      position: \"center\",\n      files: null,\n    });\n  };\n\n  public onExportImage = async (\n    type: keyof typeof EXPORT_IMAGE_TYPES,\n    elements: readonly NonDeletedExcalidrawElement[],\n  ) => {\n    trackEvent(\"export\", type, \"ui\");\n    const fileHandle = await exportCanvas(\n      type,\n      elements,\n      this.state,\n      this.files,\n      {\n        exportBackground: this.state.exportBackground,\n        name: this.state.name,\n        viewBackgroundColor: this.state.viewBackgroundColor,\n      },\n    )\n      .catch(muteFSAbortError)\n      .catch((error) => {\n        console.error(error);\n        this.setState({ errorMessage: error.message });\n      });\n\n    if (\n      this.state.exportEmbedScene &&\n      fileHandle &&\n      isImageFileHandle(fileHandle)\n    ) {\n      this.setState({ fileHandle });\n    }\n  };\n\n  private openEyeDropper = ({ type }: { type: \"stroke\" | \"background\" }) => {\n    jotaiStore.set(activeEyeDropperAtom, {\n      swapPreviewOnAlt: true,\n      previewType: type === \"stroke\" ? \"strokeColor\" : \"backgroundColor\",\n      onSelect: (color, event) => {\n        const shouldUpdateStrokeColor =\n          (type === \"background\" && event.altKey) ||\n          (type === \"stroke\" && !event.altKey);\n        const selectedElements = this.scene.getSelectedElements(this.state);\n        if (\n          !selectedElements.length ||\n          this.state.activeTool.type !== \"selection\"\n        ) {\n          if (shouldUpdateStrokeColor) {\n            this.setState({\n              currentItemStrokeColor: color,\n            });\n          } else {\n            this.setState({\n              currentItemBackgroundColor: color,\n            });\n          }\n        } else {\n          this.updateScene({\n            elements: this.scene.getElementsIncludingDeleted().map((el) => {\n              if (this.state.selectedElementIds[el.id]) {\n                return newElementWith(el, {\n                  [shouldUpdateStrokeColor ? \"strokeColor\" : \"backgroundColor\"]:\n                    color,\n                });\n              }\n              return el;\n            }),\n          });\n        }\n      },\n      keepOpenOnAlt: false,\n    });\n  };\n\n  private syncActionResult = withBatchedUpdates(\n    (actionResult: ActionResult) => {\n      if (this.unmounted || actionResult === false) {\n        return;\n      }\n\n      let editingElement: AppState[\"editingElement\"] | null = null;\n      if (actionResult.elements) {\n        actionResult.elements.forEach((element) => {\n          if (\n            this.state.editingElement?.id === element.id &&\n            this.state.editingElement !== element &&\n            isNonDeletedElement(element)\n          ) {\n            editingElement = element;\n          }\n        });\n        this.scene.replaceAllElements(actionResult.elements);\n        if (actionResult.commitToHistory) {\n          this.history.resumeRecording();\n        }\n      }\n\n      if (actionResult.files) {\n        this.files = actionResult.replaceFiles\n          ? actionResult.files\n          : { ...this.files, ...actionResult.files };\n        this.addNewImagesToImageCache();\n      }\n\n      if (actionResult.appState || editingElement || this.state.contextMenu) {\n        if (actionResult.commitToHistory) {\n          this.history.resumeRecording();\n        }\n\n        let viewModeEnabled = actionResult?.appState?.viewModeEnabled || false;\n        let zenModeEnabled = actionResult?.appState?.zenModeEnabled || false;\n        let gridSize = actionResult?.appState?.gridSize || null;\n        const theme =\n          actionResult?.appState?.theme || this.props.theme || THEME.LIGHT;\n        let name = actionResult?.appState?.name ?? this.state.name;\n        const errorMessage =\n          actionResult?.appState?.errorMessage ?? this.state.errorMessage;\n        if (typeof this.props.viewModeEnabled !== \"undefined\") {\n          viewModeEnabled = this.props.viewModeEnabled;\n        }\n\n        if (typeof this.props.zenModeEnabled !== \"undefined\") {\n          zenModeEnabled = this.props.zenModeEnabled;\n        }\n\n        if (typeof this.props.gridModeEnabled !== \"undefined\") {\n          gridSize = this.props.gridModeEnabled ? GRID_SIZE : null;\n        }\n\n        if (typeof this.props.name !== \"undefined\") {\n          name = this.props.name;\n        }\n\n        editingElement =\n          editingElement || actionResult.appState?.editingElement || null;\n\n        if (editingElement?.isDeleted) {\n          editingElement = null;\n        }\n\n        this.setState(\n          (state) => {\n            // using Object.assign instead of spread to fool TS 4.2.2+ into\n            // regarding the resulting type as not containing undefined\n            // (which the following expression will never contain)\n            return Object.assign(actionResult.appState || {}, {\n              // NOTE this will prevent opening context menu using an action\n              // or programmatically from the host, so it will need to be\n              // rewritten later\n              contextMenu: null,\n              editingElement,\n              viewModeEnabled,\n              zenModeEnabled,\n              gridSize,\n              theme,\n              name,\n              errorMessage,\n            });\n          },\n          () => {\n            if (actionResult.syncHistory) {\n              this.history.setCurrentState(\n                this.state,\n                this.scene.getElementsIncludingDeleted(),\n              );\n            }\n          },\n        );\n      }\n    },\n  );\n\n  // Lifecycle\n\n  private onBlur = withBatchedUpdates(() => {\n    isHoldingSpace = false;\n    this.setState({ isBindingEnabled: true });\n  });\n\n  private onUnload = () => {\n    this.onBlur();\n  };\n\n  private disableEvent: EventListener = (event) => {\n    event.preventDefault();\n  };\n\n  private resetHistory = () => {\n    this.history.clear();\n  };\n\n  /**\n   * Resets scene & history.\n   * ! Do not use to clear scene user action !\n   */\n  private resetScene = withBatchedUpdates(\n    (opts?: { resetLoadingState: boolean }) => {\n      this.scene.replaceAllElements([]);\n      this.setState((state) => ({\n        ...getDefaultAppState(),\n        isLoading: opts?.resetLoadingState ? false : state.isLoading,\n        theme: this.state.theme,\n      }));\n      this.resetHistory();\n    },\n  );\n\n  private initializeScene = async () => {\n    if (\"launchQueue\" in window && \"LaunchParams\" in window) {\n      (window as any).launchQueue.setConsumer(\n        async (launchParams: { files: any[] }) => {\n          if (!launchParams.files.length) {\n            return;\n          }\n          const fileHandle = launchParams.files[0];\n          const blob: Blob = await fileHandle.getFile();\n          this.loadFileToCanvas(\n            new File([blob], blob.name || \"\", { type: blob.type }),\n            fileHandle,\n          );\n        },\n      );\n    }\n\n    if (this.props.theme) {\n      this.setState({ theme: this.props.theme });\n    }\n    if (!this.state.isLoading) {\n      this.setState({ isLoading: true });\n    }\n    let initialData = null;\n    try {\n      initialData = (await this.props.initialData) || null;\n      if (initialData?.libraryItems) {\n        this.library\n          .updateLibrary({\n            libraryItems: initialData.libraryItems,\n            merge: true,\n          })\n          .catch((error) => {\n            console.error(error);\n          });\n      }\n    } catch (error: any) {\n      console.error(error);\n      initialData = {\n        appState: {\n          errorMessage:\n            error.message ||\n            \"Encountered an error during importing or restoring scene data\",\n        },\n      };\n    }\n    const scene = restore(initialData, null, null, { repairBindings: true });\n    scene.appState = {\n      ...scene.appState,\n      theme: this.props.theme || scene.appState.theme,\n      // we're falling back to current (pre-init) state when deciding\n      // whether to open the library, to handle a case where we\n      // update the state outside of initialData (e.g. when loading the app\n      // with a library install link, which should auto-open the library)\n      openSidebar: scene.appState?.openSidebar || this.state.openSidebar,\n      activeTool:\n        scene.appState.activeTool.type === \"image\"\n          ? { ...scene.appState.activeTool, type: \"selection\" }\n          : scene.appState.activeTool,\n      isLoading: false,\n      toast: this.state.toast,\n    };\n    if (initialData?.scrollToContent) {\n      scene.appState = {\n        ...scene.appState,\n        ...calculateScrollCenter(\n          scene.elements,\n          {\n            ...scene.appState,\n            width: this.state.width,\n            height: this.state.height,\n            offsetTop: this.state.offsetTop,\n            offsetLeft: this.state.offsetLeft,\n          },\n          null,\n        ),\n      };\n    }\n    // FontFaceSet loadingdone event we listen on may not always fire\n    // (looking at you Safari), so on init we manually load fonts for current\n    // text elements on canvas, and rerender them once done. This also\n    // seems faster even in browsers that do fire the loadingdone event.\n    this.fonts.loadFontsForElements(scene.elements);\n\n    this.resetHistory();\n    this.syncActionResult({\n      ...scene,\n      commitToHistory: true,\n    });\n  };\n\n  private refreshDeviceState = (container: HTMLDivElement) => {\n    const { width, height } = container.getBoundingClientRect();\n    const sidebarBreakpoint =\n      this.props.UIOptions.dockedSidebarBreakpoint != null\n        ? this.props.UIOptions.dockedSidebarBreakpoint\n        : MQ_RIGHT_SIDEBAR_MIN_WIDTH;\n    this.device = updateObject(this.device, {\n      isLandscape: width > height,\n      isSmScreen: width < MQ_SM_MAX_WIDTH,\n      isMobile:\n        width < MQ_MAX_WIDTH_PORTRAIT ||\n        (height < MQ_MAX_HEIGHT_LANDSCAPE && width < MQ_MAX_WIDTH_LANDSCAPE),\n      canDeviceFitSidebar: width > sidebarBreakpoint,\n    });\n  };\n\n  public async componentDidMount() {\n    this.unmounted = false;\n    this.excalidrawContainerValue.container =\n      this.excalidrawContainerRef.current;\n\n    if (\n      process.env.NODE_ENV === ENV.TEST ||\n      process.env.NODE_ENV === ENV.DEVELOPMENT\n    ) {\n      const setState = this.setState.bind(this);\n      Object.defineProperties(window.h, {\n        state: {\n          configurable: true,\n          get: () => {\n            return this.state;\n          },\n        },\n        setState: {\n          configurable: true,\n          value: (...args: Parameters<typeof setState>) => {\n            return this.setState(...args);\n          },\n        },\n        app: {\n          configurable: true,\n          value: this,\n        },\n        history: {\n          configurable: true,\n          value: this.history,\n        },\n      });\n    }\n\n    this.scene.addCallback(this.onSceneUpdated);\n    this.addEventListeners();\n\n    if (this.props.autoFocus && this.excalidrawContainerRef.current) {\n      this.focusContainer();\n    }\n\n    if (\n      this.excalidrawContainerRef.current &&\n      // bounding rects don't work in tests so updating\n      // the state on init would result in making the test enviro run\n      // in mobile breakpoint (0 width/height), making everything fail\n      process.env.NODE_ENV !== \"test\"\n    ) {\n      this.refreshDeviceState(this.excalidrawContainerRef.current);\n    }\n\n    if (\"ResizeObserver\" in window && this.excalidrawContainerRef?.current) {\n      this.resizeObserver = new ResizeObserver(() => {\n        THROTTLE_NEXT_RENDER = false;\n        // recompute device dimensions state\n        // ---------------------------------------------------------------------\n        this.refreshDeviceState(this.excalidrawContainerRef.current!);\n        // refresh offsets\n        // ---------------------------------------------------------------------\n        this.updateDOMRect();\n      });\n      this.resizeObserver?.observe(this.excalidrawContainerRef.current);\n    } else if (window.matchMedia) {\n      const mdScreenQuery = window.matchMedia(\n        `(max-width: ${MQ_MAX_WIDTH_PORTRAIT}px), (max-height: ${MQ_MAX_HEIGHT_LANDSCAPE}px) and (max-width: ${MQ_MAX_WIDTH_LANDSCAPE}px)`,\n      );\n      const smScreenQuery = window.matchMedia(\n        `(max-width: ${MQ_SM_MAX_WIDTH}px)`,\n      );\n      const canDeviceFitSidebarMediaQuery = window.matchMedia(\n        `(min-width: ${\n          // NOTE this won't update if a different breakpoint is supplied\n          // after mount\n          this.props.UIOptions.dockedSidebarBreakpoint != null\n            ? this.props.UIOptions.dockedSidebarBreakpoint\n            : MQ_RIGHT_SIDEBAR_MIN_WIDTH\n        }px)`,\n      );\n      const handler = () => {\n        this.excalidrawContainerRef.current!.getBoundingClientRect();\n        this.device = updateObject(this.device, {\n          isSmScreen: smScreenQuery.matches,\n          isMobile: mdScreenQuery.matches,\n          canDeviceFitSidebar: canDeviceFitSidebarMediaQuery.matches,\n        });\n      };\n      mdScreenQuery.addListener(handler);\n      this.detachIsMobileMqHandler = () =>\n        mdScreenQuery.removeListener(handler);\n    }\n\n    const searchParams = new URLSearchParams(window.location.search.slice(1));\n\n    if (searchParams.has(\"web-share-target\")) {\n      // Obtain a file that was shared via the Web Share Target API.\n      this.restoreFileFromShare();\n    } else {\n      this.updateDOMRect(this.initializeScene);\n    }\n\n    // note that this check seems to always pass in localhost\n    if (isBrave() && !isMeasureTextSupported()) {\n      this.setState({\n        errorMessage: <BraveMeasureTextError />,\n      });\n    }\n  }\n\n  public componentWillUnmount() {\n    this.files = {};\n    this.imageCache.clear();\n    this.resizeObserver?.disconnect();\n    this.unmounted = true;\n    this.removeEventListeners();\n    this.scene.destroy();\n    this.library.destroy();\n    clearTimeout(touchTimeout);\n    isSomeElementSelected.clearCache();\n    touchTimeout = 0;\n  }\n\n  private onResize = withBatchedUpdates(() => {\n    this.scene\n      .getElementsIncludingDeleted()\n      .forEach((element) => invalidateShapeForElement(element));\n    this.setState({});\n  });\n\n  private removeEventListeners() {\n    document.removeEventListener(EVENT.POINTER_UP, this.removePointer);\n    document.removeEventListener(EVENT.COPY, this.onCopy);\n    document.removeEventListener(EVENT.PASTE, this.pasteFromClipboard);\n    document.removeEventListener(EVENT.CUT, this.onCut);\n    this.excalidrawContainerRef.current?.removeEventListener(\n      EVENT.WHEEL,\n      this.onWheel,\n    );\n    this.nearestScrollableContainer?.removeEventListener(\n      EVENT.SCROLL,\n      this.onScroll,\n    );\n    document.removeEventListener(EVENT.KEYDOWN, this.onKeyDown, false);\n    document.removeEventListener(\n      EVENT.MOUSE_MOVE,\n      this.updateCurrentCursorPosition,\n      false,\n    );\n    document.removeEventListener(EVENT.KEYUP, this.onKeyUp);\n    window.removeEventListener(EVENT.RESIZE, this.onResize, false);\n    window.removeEventListener(EVENT.UNLOAD, this.onUnload, false);\n    window.removeEventListener(EVENT.BLUR, this.onBlur, false);\n    this.excalidrawContainerRef.current?.removeEventListener(\n      EVENT.DRAG_OVER,\n      this.disableEvent,\n      false,\n    );\n    this.excalidrawContainerRef.current?.removeEventListener(\n      EVENT.DROP,\n      this.disableEvent,\n      false,\n    );\n\n    document.removeEventListener(\n      EVENT.GESTURE_START,\n      this.onGestureStart as any,\n      false,\n    );\n    document.removeEventListener(\n      EVENT.GESTURE_CHANGE,\n      this.onGestureChange as any,\n      false,\n    );\n    document.removeEventListener(\n      EVENT.GESTURE_END,\n      this.onGestureEnd as any,\n      false,\n    );\n\n    this.detachIsMobileMqHandler?.();\n  }\n\n  private addEventListeners() {\n    this.removeEventListeners();\n    document.addEventListener(EVENT.POINTER_UP, this.removePointer); // #3553\n    document.addEventListener(EVENT.COPY, this.onCopy);\n    this.excalidrawContainerRef.current?.addEventListener(\n      EVENT.WHEEL,\n      this.onWheel,\n      { passive: false },\n    );\n\n    if (this.props.handleKeyboardGlobally) {\n      document.addEventListener(EVENT.KEYDOWN, this.onKeyDown, false);\n    }\n    document.addEventListener(EVENT.KEYUP, this.onKeyUp, { passive: true });\n    document.addEventListener(\n      EVENT.MOUSE_MOVE,\n      this.updateCurrentCursorPosition,\n    );\n    // rerender text elements on font load to fix #637 && #1553\n    document.fonts?.addEventListener?.(\"loadingdone\", (event) => {\n      const loadedFontFaces = (event as FontFaceSetLoadEvent).fontfaces;\n      this.fonts.onFontsLoaded(loadedFontFaces);\n    });\n\n    // Safari-only desktop pinch zoom\n    document.addEventListener(\n      EVENT.GESTURE_START,\n      this.onGestureStart as any,\n      false,\n    );\n    document.addEventListener(\n      EVENT.GESTURE_CHANGE,\n      this.onGestureChange as any,\n      false,\n    );\n    document.addEventListener(\n      EVENT.GESTURE_END,\n      this.onGestureEnd as any,\n      false,\n    );\n    if (this.state.viewModeEnabled) {\n      return;\n    }\n\n    document.addEventListener(EVENT.PASTE, this.pasteFromClipboard);\n    document.addEventListener(EVENT.CUT, this.onCut);\n    if (this.props.detectScroll) {\n      this.nearestScrollableContainer = getNearestScrollableContainer(\n        this.excalidrawContainerRef.current!,\n      );\n      this.nearestScrollableContainer.addEventListener(\n        EVENT.SCROLL,\n        this.onScroll,\n      );\n    }\n    window.addEventListener(EVENT.RESIZE, this.onResize, false);\n    window.addEventListener(EVENT.UNLOAD, this.onUnload, false);\n    window.addEventListener(EVENT.BLUR, this.onBlur, false);\n    this.excalidrawContainerRef.current?.addEventListener(\n      EVENT.DRAG_OVER,\n      this.disableEvent,\n      false,\n    );\n    this.excalidrawContainerRef.current?.addEventListener(\n      EVENT.DROP,\n      this.disableEvent,\n      false,\n    );\n  }\n\n  componentDidUpdate(prevProps: AppProps, prevState: AppState) {\n    if (\n      !this.state.showWelcomeScreen &&\n      !this.scene.getElementsIncludingDeleted().length\n    ) {\n      this.setState({ showWelcomeScreen: true });\n    }\n\n    if (\n      this.excalidrawContainerRef.current &&\n      prevProps.UIOptions.dockedSidebarBreakpoint !==\n        this.props.UIOptions.dockedSidebarBreakpoint\n    ) {\n      this.refreshDeviceState(this.excalidrawContainerRef.current);\n    }\n\n    if (\n      prevState.scrollX !== this.state.scrollX ||\n      prevState.scrollY !== this.state.scrollY\n    ) {\n      this.props?.onScrollChange?.(this.state.scrollX, this.state.scrollY);\n    }\n\n    if (\n      Object.keys(this.state.selectedElementIds).length &&\n      isEraserActive(this.state)\n    ) {\n      this.setState({\n        activeTool: updateActiveTool(this.state, { type: \"selection\" }),\n      });\n    }\n    if (\n      this.state.activeTool.type === \"eraser\" &&\n      prevState.theme !== this.state.theme\n    ) {\n      setEraserCursor(this.canvas, this.state.theme);\n    }\n    // Hide hyperlink popup if shown when element type is not selection\n    if (\n      prevState.activeTool.type === \"selection\" &&\n      this.state.activeTool.type !== \"selection\" &&\n      this.state.showHyperlinkPopup\n    ) {\n      this.setState({ showHyperlinkPopup: false });\n    }\n    if (prevProps.langCode !== this.props.langCode) {\n      this.updateLanguage();\n    }\n\n    if (prevProps.viewModeEnabled !== this.props.viewModeEnabled) {\n      this.setState({ viewModeEnabled: !!this.props.viewModeEnabled });\n    }\n\n    if (prevState.viewModeEnabled !== this.state.viewModeEnabled) {\n      this.addEventListeners();\n      this.deselectElements();\n    }\n\n    if (prevProps.zenModeEnabled !== this.props.zenModeEnabled) {\n      this.setState({ zenModeEnabled: !!this.props.zenModeEnabled });\n    }\n\n    if (prevProps.theme !== this.props.theme && this.props.theme) {\n      this.setState({ theme: this.props.theme });\n    }\n\n    if (prevProps.gridModeEnabled !== this.props.gridModeEnabled) {\n      this.setState({\n        gridSize: this.props.gridModeEnabled ? GRID_SIZE : null,\n      });\n    }\n\n    if (this.props.name && prevProps.name !== this.props.name) {\n      this.setState({\n        name: this.props.name,\n      });\n    }\n\n    this.excalidrawContainerRef.current?.classList.toggle(\n      \"theme--dark\",\n      this.state.theme === \"dark\",\n    );\n\n    if (\n      this.state.editingLinearElement &&\n      !this.state.selectedElementIds[this.state.editingLinearElement.elementId]\n    ) {\n      // defer so that the commitToHistory flag isn't reset via current update\n      setTimeout(() => {\n        // execute only if the condition still holds when the deferred callback\n        // executes (it can be scheduled multiple times depending on how\n        // many times the component renders)\n        this.state.editingLinearElement &&\n          this.actionManager.executeAction(actionFinalize);\n      });\n    }\n\n    // failsafe in case the state is being updated in incorrect order resulting\n    // in the editingElement being now a deleted element\n    if (this.state.editingElement?.isDeleted) {\n      this.setState({ editingElement: null });\n    }\n\n    if (\n      this.state.selectedLinearElement &&\n      !this.state.selectedElementIds[this.state.selectedLinearElement.elementId]\n    ) {\n      // To make sure `selectedLinearElement` is in sync with `selectedElementIds`, however this shouldn't be needed once\n      // we have a single API to update `selectedElementIds`\n      this.setState({ selectedLinearElement: null });\n    }\n\n    const { multiElement } = prevState;\n    if (\n      prevState.activeTool !== this.state.activeTool &&\n      multiElement != null &&\n      isBindingEnabled(this.state) &&\n      isBindingElement(multiElement, false)\n    ) {\n      maybeBindLinearElement(\n        multiElement,\n        this.state,\n        this.scene,\n        tupleToCoors(\n          LinearElementEditor.getPointAtIndexGlobalCoordinates(\n            multiElement,\n            -1,\n          ),\n        ),\n      );\n    }\n    this.renderScene();\n    this.history.record(this.state, this.scene.getElementsIncludingDeleted());\n\n    // Do not notify consumers if we're still loading the scene. Among other\n    // potential issues, this fixes a case where the tab isn't focused during\n    // init, which would trigger onChange with empty elements, which would then\n    // override whatever is in localStorage currently.\n    if (!this.state.isLoading) {\n      this.props.onChange?.(\n        this.scene.getElementsIncludingDeleted(),\n        this.state,\n        this.files,\n      );\n    }\n  }\n\n  private renderScene = () => {\n    const cursorButton: {\n      [id: string]: string | undefined;\n    } = {};\n    const pointerViewportCoords: RenderConfig[\"remotePointerViewportCoords\"] =\n      {};\n    const remoteSelectedElementIds: RenderConfig[\"remoteSelectedElementIds\"] =\n      {};\n    const pointerUsernames: { [id: string]: string } = {};\n    const pointerUserStates: { [id: string]: string } = {};\n    this.state.collaborators.forEach((user, socketId) => {\n      if (user.selectedElementIds) {\n        for (const id of Object.keys(user.selectedElementIds)) {\n          if (!(id in remoteSelectedElementIds)) {\n            remoteSelectedElementIds[id] = [];\n          }\n          remoteSelectedElementIds[id].push(socketId);\n        }\n      }\n      if (!user.pointer) {\n        return;\n      }\n      if (user.username) {\n        pointerUsernames[socketId] = user.username;\n      }\n      if (user.userState) {\n        pointerUserStates[socketId] = user.userState;\n      }\n      pointerViewportCoords[socketId] = sceneCoordsToViewportCoords(\n        {\n          sceneX: user.pointer.x,\n          sceneY: user.pointer.y,\n        },\n        this.state,\n      );\n      cursorButton[socketId] = user.button;\n    });\n\n    const renderingElements = this.scene\n      .getNonDeletedElements()\n      .filter((element) => {\n        if (isImageElement(element)) {\n          if (\n            // not placed on canvas yet (but in elements array)\n            this.state.pendingImageElementId === element.id\n          ) {\n            return false;\n          }\n        }\n        // don't render text element that's being currently edited (it's\n        // rendered on remote only)\n        return (\n          !this.state.editingElement ||\n          this.state.editingElement.type !== \"text\" ||\n          element.id !== this.state.editingElement.id\n        );\n      });\n\n    const selectionColor = getComputedStyle(\n      document.querySelector(\".excalidraw\")!,\n    ).getPropertyValue(\"--color-selection\");\n\n    renderScene(\n      {\n        elements: renderingElements,\n        appState: this.state,\n        scale: window.devicePixelRatio,\n        rc: this.rc!,\n        canvas: this.canvas!,\n        renderConfig: {\n          selectionColor,\n          scrollX: this.state.scrollX,\n          scrollY: this.state.scrollY,\n          viewBackgroundColor: this.state.viewBackgroundColor,\n          zoom: this.state.zoom,\n          remotePointerViewportCoords: pointerViewportCoords,\n          remotePointerButton: cursorButton,\n          remoteSelectedElementIds,\n          remotePointerUsernames: pointerUsernames,\n          remotePointerUserStates: pointerUserStates,\n          shouldCacheIgnoreZoom: this.state.shouldCacheIgnoreZoom,\n          theme: this.state.theme,\n          imageCache: this.imageCache,\n          isExporting: false,\n          renderScrollbars: false,\n        },\n        callback: ({ atLeastOneVisibleElement, scrollBars }) => {\n          if (scrollBars) {\n            currentScrollBars = scrollBars;\n          }\n          const scrolledOutside =\n            // hide when editing text\n            isTextElement(this.state.editingElement)\n              ? false\n              : !atLeastOneVisibleElement && renderingElements.length > 0;\n          if (this.state.scrolledOutside !== scrolledOutside) {\n            this.setState({ scrolledOutside });\n          }\n\n          this.scheduleImageRefresh();\n        },\n      },\n      THROTTLE_NEXT_RENDER && window.EXCALIDRAW_THROTTLE_RENDER === true,\n    );\n\n    if (!THROTTLE_NEXT_RENDER) {\n      THROTTLE_NEXT_RENDER = true;\n    }\n  };\n\n  private onScroll = debounce(() => {\n    const { offsetTop, offsetLeft } = this.getCanvasOffsets();\n    this.setState((state) => {\n      if (state.offsetLeft === offsetLeft && state.offsetTop === offsetTop) {\n        return null;\n      }\n      return { offsetTop, offsetLeft };\n    });\n  }, SCROLL_TIMEOUT);\n\n  // Copy/paste\n\n  private onCut = withBatchedUpdates((event: ClipboardEvent) => {\n    const isExcalidrawActive = this.excalidrawContainerRef.current?.contains(\n      document.activeElement,\n    );\n    if (!isExcalidrawActive || isWritableElement(event.target)) {\n      return;\n    }\n    this.cutAll();\n    event.preventDefault();\n    event.stopPropagation();\n  });\n\n  private onCopy = withBatchedUpdates((event: ClipboardEvent) => {\n    const isExcalidrawActive = this.excalidrawContainerRef.current?.contains(\n      document.activeElement,\n    );\n    if (!isExcalidrawActive || isWritableElement(event.target)) {\n      return;\n    }\n    this.copyAll();\n    event.preventDefault();\n    event.stopPropagation();\n  });\n\n  private cutAll = () => {\n    this.actionManager.executeAction(actionCut, \"keyboard\");\n  };\n\n  private copyAll = () => {\n    this.actionManager.executeAction(actionCopy, \"keyboard\");\n  };\n\n  private static resetTapTwice() {\n    didTapTwice = false;\n  }\n\n  private onTapStart = (event: TouchEvent) => {\n    // fix for Apple Pencil Scribble\n    // On Android, preventing the event would disable contextMenu on tap-hold\n    if (!isAndroid) {\n      event.preventDefault();\n    }\n\n    if (!didTapTwice) {\n      didTapTwice = true;\n      clearTimeout(tappedTwiceTimer);\n      tappedTwiceTimer = window.setTimeout(\n        App.resetTapTwice,\n        TAP_TWICE_TIMEOUT,\n      );\n      return;\n    }\n    // insert text only if we tapped twice with a single finger\n    // event.touches.length === 1 will also prevent inserting text when user's zooming\n    if (didTapTwice && event.touches.length === 1) {\n      const [touch] = event.touches;\n      // @ts-ignore\n      this.handleCanvasDoubleClick({\n        clientX: touch.clientX,\n        clientY: touch.clientY,\n      });\n      didTapTwice = false;\n      clearTimeout(tappedTwiceTimer);\n    }\n    if (isAndroid) {\n      event.preventDefault();\n    }\n\n    if (event.touches.length === 2) {\n      this.setState({\n        selectedElementIds: makeNextSelectedElementIds({}, this.state),\n      });\n    }\n  };\n\n  private onTapEnd = (event: TouchEvent) => {\n    this.resetContextMenuTimer();\n    if (event.touches.length > 0) {\n      this.setState({\n        previousSelectedElementIds: {},\n        selectedElementIds: makeNextSelectedElementIds(\n          this.state.previousSelectedElementIds,\n          this.state,\n        ),\n      });\n    } else {\n      gesture.pointers.clear();\n    }\n  };\n\n  public pasteFromClipboard = withBatchedUpdates(\n    async (event: ClipboardEvent | null) => {\n      const isPlainPaste = !!(IS_PLAIN_PASTE && event);\n\n      // #686\n      const target = document.activeElement;\n      const isExcalidrawActive =\n        this.excalidrawContainerRef.current?.contains(target);\n      if (event && !isExcalidrawActive) {\n        return;\n      }\n\n      const elementUnderCursor = document.elementFromPoint(\n        this.lastViewportPosition.x,\n        this.lastViewportPosition.y,\n      );\n      if (\n        event &&\n        (!(elementUnderCursor instanceof HTMLCanvasElement) ||\n          isWritableElement(target))\n      ) {\n        return;\n      }\n\n      // must be called in the same frame (thus before any awaits) as the paste\n      // event else some browsers (FF...) will clear the clipboardData\n      // (something something security)\n      let file = event?.clipboardData?.files[0];\n\n      const data = await parseClipboard(event, isPlainPaste);\n\n      if (!file && data.text && !isPlainPaste) {\n        const string = data.text.trim();\n        if (string.startsWith(\"<svg\") && string.endsWith(\"</svg>\")) {\n          // ignore SVG validation/normalization which will be done during image\n          // initialization\n          file = SVGStringToFile(string);\n        }\n      }\n\n      // prefer spreadsheet data over image file (MS Office/Libre Office)\n      if (isSupportedImageFile(file) && !data.spreadsheet) {\n        const { x: sceneX, y: sceneY } = viewportCoordsToSceneCoords(\n          {\n            clientX: this.lastViewportPosition.x,\n            clientY: this.lastViewportPosition.y,\n          },\n          this.state,\n        );\n\n        const imageElement = this.createImageElement({ sceneX, sceneY });\n        this.insertImageElement(imageElement, file);\n        this.initializeImageDimensions(imageElement);\n        this.setState({\n          selectedElementIds: makeNextSelectedElementIds(\n            {\n              [imageElement.id]: true,\n            },\n            this.state,\n          ),\n        });\n\n        return;\n      }\n\n      if (this.props.onPaste) {\n        try {\n          if ((await this.props.onPaste(data, event)) === false) {\n            return;\n          }\n        } catch (error: any) {\n          console.error(error);\n        }\n      }\n\n      if (data.errorMessage) {\n        this.setState({ errorMessage: data.errorMessage });\n      } else if (data.spreadsheet && !isPlainPaste) {\n        this.setState({\n          pasteDialog: {\n            data: data.spreadsheet,\n            shown: true,\n          },\n        });\n      } else if (data.elements) {\n        // TODO remove formatting from elements if isPlainPaste\n        this.addElementsFromPasteOrLibrary({\n          elements: data.elements,\n          files: data.files || null,\n          position: \"cursor\",\n          retainSeed: isPlainPaste,\n        });\n      } else if (data.text) {\n        this.addTextFromPaste(data.text, isPlainPaste);\n      }\n      this.setActiveTool({ type: \"selection\" });\n      event?.preventDefault();\n    },\n  );\n\n  private addElementsFromPasteOrLibrary = (opts: {\n    elements: readonly ExcalidrawElement[];\n    files: BinaryFiles | null;\n    position: { clientX: number; clientY: number } | \"cursor\" | \"center\";\n    retainSeed?: boolean;\n  }) => {\n    const elements = restoreElements(opts.elements, null);\n    const [minX, minY, maxX, maxY] = getCommonBounds(elements);\n\n    const elementsCenterX = distance(minX, maxX) / 2;\n    const elementsCenterY = distance(minY, maxY) / 2;\n\n    const clientX =\n      typeof opts.position === \"object\"\n        ? opts.position.clientX\n        : opts.position === \"cursor\"\n        ? this.lastViewportPosition.x\n        : this.state.width / 2 + this.state.offsetLeft;\n    const clientY =\n      typeof opts.position === \"object\"\n        ? opts.position.clientY\n        : opts.position === \"cursor\"\n        ? this.lastViewportPosition.y\n        : this.state.height / 2 + this.state.offsetTop;\n\n    const { x, y } = viewportCoordsToSceneCoords(\n      { clientX, clientY },\n      this.state,\n    );\n\n    const dx = x - elementsCenterX;\n    const dy = y - elementsCenterY;\n\n    const [gridX, gridY] = getGridPoint(dx, dy, this.state.gridSize);\n\n    const newElements = duplicateElements(\n      elements.map((element) => {\n        return newElementWith(element, {\n          x: element.x + gridX - minX,\n          y: element.y + gridY - minY,\n        });\n      }),\n      {\n        randomizeSeed: !opts.retainSeed,\n      },\n    );\n\n    const nextElements = [\n      ...this.scene.getElementsIncludingDeleted(),\n      ...newElements,\n    ];\n\n    this.scene.replaceAllElements(nextElements);\n\n    newElements.forEach((newElement) => {\n      if (isTextElement(newElement) && isBoundToContainer(newElement)) {\n        const container = getContainerElement(newElement);\n        redrawTextBoundingBox(newElement, container);\n      }\n    });\n\n    if (opts.files) {\n      this.files = { ...this.files, ...opts.files };\n    }\n\n    this.history.resumeRecording();\n\n    const nextElementsToSelect =\n      excludeElementsInFramesFromSelection(newElements);\n\n    this.setState(\n      selectGroupsForSelectedElements(\n        {\n          ...this.state,\n          // keep sidebar (presumably the library) open if it's docked and\n          // can fit.\n          //\n          // Note, we should close the sidebar only if we're dropping items\n          // from library, not when pasting from clipboard. Alas.\n          openSidebar:\n            this.state.openSidebar &&\n            this.device.canDeviceFitSidebar &&\n            jotaiStore.get(isSidebarDockedAtom)\n              ? this.state.openSidebar\n              : null,\n          selectedElementIds: nextElementsToSelect.reduce(\n            (acc: Record<ExcalidrawElement[\"id\"], true>, element) => {\n              if (!isBoundToContainer(element)) {\n                acc[element.id] = true;\n              }\n              return acc;\n            },\n            {},\n          ),\n          selectedGroupIds: {},\n        },\n        this.scene.getNonDeletedElements(),\n        this.state,\n        this,\n      ),\n      () => {\n        if (opts.files) {\n          this.addNewImagesToImageCache();\n        }\n      },\n    );\n    this.setActiveTool({ type: \"selection\" });\n  };\n\n  private addTextFromPaste(text: string, isPlainPaste = false) {\n    const { x, y } = viewportCoordsToSceneCoords(\n      {\n        clientX: this.lastViewportPosition.x,\n        clientY: this.lastViewportPosition.y,\n      },\n      this.state,\n    );\n\n    const textElementProps = {\n      x,\n      y,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roundness: null,\n      roughness: this.state.currentItemRoughness,\n      opacity: this.state.currentItemOpacity,\n      text,\n      fontSize: this.state.currentItemFontSize,\n      fontFamily: this.state.currentItemFontFamily,\n      textAlign: this.state.currentItemTextAlign,\n      verticalAlign: DEFAULT_VERTICAL_ALIGN,\n      locked: false,\n    };\n\n    const LINE_GAP = 10;\n    let currentY = y;\n\n    const lines = isPlainPaste ? [text] : text.split(\"\\n\");\n    const textElements = lines.reduce(\n      (acc: ExcalidrawTextElement[], line, idx) => {\n        const text = line.trim();\n\n        const lineHeight = getDefaultLineHeight(textElementProps.fontFamily);\n        if (text.length) {\n          const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n            x,\n            y: currentY,\n          });\n\n          const element = newTextElement({\n            ...textElementProps,\n            x,\n            y: currentY,\n            text,\n            lineHeight,\n            frameId: topLayerFrame ? topLayerFrame.id : null,\n          });\n          acc.push(element);\n          currentY += element.height + LINE_GAP;\n        } else {\n          const prevLine = lines[idx - 1]?.trim();\n          // add paragraph only if previous line was not empty, IOW don't add\n          // more than one empty line\n          if (prevLine) {\n            currentY +=\n              getLineHeightInPx(textElementProps.fontSize, lineHeight) +\n              LINE_GAP;\n          }\n        }\n\n        return acc;\n      },\n      [],\n    );\n\n    if (textElements.length === 0) {\n      return;\n    }\n\n    const frameId = textElements[0].frameId;\n\n    if (frameId) {\n      this.scene.insertElementsAtIndex(\n        textElements,\n        this.scene.getElementIndex(frameId),\n      );\n    } else {\n      this.scene.replaceAllElements([\n        ...this.scene.getElementsIncludingDeleted(),\n        ...textElements,\n      ]);\n    }\n\n    this.setState({\n      selectedElementIds: makeNextSelectedElementIds(\n        Object.fromEntries(textElements.map((el) => [el.id, true])),\n        this.state,\n      ),\n    });\n\n    if (\n      !isPlainPaste &&\n      textElements.length > 1 &&\n      PLAIN_PASTE_TOAST_SHOWN === false &&\n      !this.device.isMobile\n    ) {\n      this.setToast({\n        message: t(\"toast.pasteAsSingleElement\", {\n          shortcut: getShortcutKey(\"CtrlOrCmd+Shift+V\"),\n        }),\n        duration: 5000,\n      });\n      PLAIN_PASTE_TOAST_SHOWN = true;\n    }\n\n    this.history.resumeRecording();\n  }\n\n  setAppState: React.Component<any, AppState>[\"setState\"] = (\n    state,\n    callback,\n  ) => {\n    this.setState(state, callback);\n  };\n\n  removePointer = (event: React.PointerEvent<HTMLElement> | PointerEvent) => {\n    if (touchTimeout) {\n      this.resetContextMenuTimer();\n    }\n\n    gesture.pointers.delete(event.pointerId);\n  };\n\n  toggleLock = (source: \"keyboard\" | \"ui\" = \"ui\") => {\n    if (!this.state.activeTool.locked) {\n      trackEvent(\n        \"toolbar\",\n        \"toggleLock\",\n        `${source} (${this.device.isMobile ? \"mobile\" : \"desktop\"})`,\n      );\n    }\n    this.setState((prevState) => {\n      return {\n        activeTool: {\n          ...prevState.activeTool,\n          ...updateActiveTool(\n            this.state,\n            prevState.activeTool.locked\n              ? { type: \"selection\" }\n              : prevState.activeTool,\n          ),\n          locked: !prevState.activeTool.locked,\n        },\n      };\n    });\n  };\n\n  updateFrameRendering = (\n    opts:\n      | Partial<AppState[\"frameRendering\"]>\n      | ((\n          prevState: AppState[\"frameRendering\"],\n        ) => Partial<AppState[\"frameRendering\"]>),\n  ) => {\n    this.setState((prevState) => {\n      const next =\n        typeof opts === \"function\" ? opts(prevState.frameRendering) : opts;\n      return {\n        frameRendering: {\n          enabled: next?.enabled ?? prevState.frameRendering.enabled,\n          clip: next?.clip ?? prevState.frameRendering.clip,\n          name: next?.name ?? prevState.frameRendering.name,\n          outline: next?.outline ?? prevState.frameRendering.outline,\n        },\n      };\n    });\n  };\n\n  togglePenMode = () => {\n    this.setState((prevState) => {\n      return {\n        penMode: !prevState.penMode,\n      };\n    });\n  };\n\n  onHandToolToggle = () => {\n    this.actionManager.executeAction(actionToggleHandTool);\n  };\n\n  /**\n   * Zooms on canvas viewport center\n   */\n  zoomCanvas = (\n    /** decimal fraction between 0.1 (10% zoom) and 30 (3000% zoom) */\n    value: number,\n  ) => {\n    this.setState({\n      ...getStateForZoom(\n        {\n          viewportX: this.state.width / 2 + this.state.offsetLeft,\n          viewportY: this.state.height / 2 + this.state.offsetTop,\n          nextZoom: getNormalizedZoom(value),\n        },\n        this.state,\n      ),\n    });\n  };\n\n  private cancelInProgresAnimation: (() => void) | null = null;\n\n  scrollToContent = (\n    target:\n      | ExcalidrawElement\n      | readonly ExcalidrawElement[] = this.scene.getNonDeletedElements(),\n    opts?:\n      | {\n          fitToContent?: boolean;\n          fitToViewport?: never;\n          viewportZoomFactor?: never;\n          animate?: boolean;\n          duration?: number;\n        }\n      | {\n          fitToContent?: never;\n          fitToViewport?: boolean;\n          /** when fitToViewport=true, how much screen should the content cover,\n           * between 0.1 (10%) and 1 (100%)\n           */\n          viewportZoomFactor?: number;\n          animate?: boolean;\n          duration?: number;\n        },\n  ) => {\n    this.cancelInProgresAnimation?.();\n\n    // convert provided target into ExcalidrawElement[] if necessary\n    const targetElements = Array.isArray(target) ? target : [target];\n\n    let zoom = this.state.zoom;\n    let scrollX = this.state.scrollX;\n    let scrollY = this.state.scrollY;\n\n    if (opts?.fitToContent || opts?.fitToViewport) {\n      const { appState } = zoomToFit({\n        targetElements,\n        appState: this.state,\n        fitToViewport: !!opts?.fitToViewport,\n        viewportZoomFactor: opts?.viewportZoomFactor,\n      });\n      zoom = appState.zoom;\n      scrollX = appState.scrollX;\n      scrollY = appState.scrollY;\n    } else {\n      // compute only the viewport location, without any zoom adjustment\n      const scroll = calculateScrollCenter(\n        targetElements,\n        this.state,\n        this.canvas,\n      );\n      scrollX = scroll.scrollX;\n      scrollY = scroll.scrollY;\n    }\n\n    // when animating, we use RequestAnimationFrame to prevent the animation\n    // from slowing down other processes\n    if (opts?.animate) {\n      const origScrollX = this.state.scrollX;\n      const origScrollY = this.state.scrollY;\n      const origZoom = this.state.zoom.value;\n\n      const cancel = easeToValuesRAF({\n        fromValues: {\n          scrollX: origScrollX,\n          scrollY: origScrollY,\n          zoom: origZoom,\n        },\n        toValues: { scrollX, scrollY, zoom: zoom.value },\n        interpolateValue: (from, to, progress, key) => {\n          // for zoom, use different easing\n          if (key === \"zoom\") {\n            return from * Math.pow(to / from, easeOut(progress));\n          }\n          // handle using default\n          return undefined;\n        },\n        onStep: ({ scrollX, scrollY, zoom }) => {\n          this.setState({\n            scrollX,\n            scrollY,\n            zoom: { value: zoom },\n          });\n        },\n        onStart: () => {\n          this.setState({ shouldCacheIgnoreZoom: true });\n        },\n        onEnd: () => {\n          this.setState({ shouldCacheIgnoreZoom: false });\n        },\n        onCancel: () => {\n          this.setState({ shouldCacheIgnoreZoom: false });\n        },\n        duration: opts?.duration ?? 500,\n      });\n\n      this.cancelInProgresAnimation = () => {\n        cancel();\n        this.cancelInProgresAnimation = null;\n      };\n    } else {\n      this.setState({ scrollX, scrollY, zoom });\n    }\n  };\n\n  /** use when changing scrollX/scrollY/zoom based on user interaction */\n  private translateCanvas: React.Component<any, AppState>[\"setState\"] = (\n    state,\n  ) => {\n    this.cancelInProgresAnimation?.();\n    this.setState(state);\n  };\n\n  setToast = (\n    toast: {\n      message: string;\n      closable?: boolean;\n      duration?: number;\n    } | null,\n  ) => {\n    this.setState({ toast });\n  };\n\n  restoreFileFromShare = async () => {\n    try {\n      const webShareTargetCache = await caches.open(\"web-share-target\");\n\n      const response = await webShareTargetCache.match(\"shared-file\");\n      if (response) {\n        const blob = await response.blob();\n        const file = new File([blob], blob.name || \"\", { type: blob.type });\n        this.loadFileToCanvas(file, null);\n        await webShareTargetCache.delete(\"shared-file\");\n        window.history.replaceState(null, APP_NAME, window.location.pathname);\n      }\n    } catch (error: any) {\n      this.setState({ errorMessage: error.message });\n    }\n  };\n\n  /** adds supplied files to existing files in the appState */\n  public addFiles: ExcalidrawImperativeAPI[\"addFiles\"] = withBatchedUpdates(\n    (files) => {\n      const filesMap = files.reduce((acc, fileData) => {\n        acc.set(fileData.id, fileData);\n        return acc;\n      }, new Map<FileId, BinaryFileData>());\n\n      this.files = { ...this.files, ...Object.fromEntries(filesMap) };\n\n      this.scene.getNonDeletedElements().forEach((element) => {\n        if (\n          isInitializedImageElement(element) &&\n          filesMap.has(element.fileId)\n        ) {\n          this.imageCache.delete(element.fileId);\n          invalidateShapeForElement(element);\n        }\n      });\n      this.scene.informMutation();\n\n      this.addNewImagesToImageCache();\n    },\n  );\n\n  public updateScene = withBatchedUpdates(\n    <K extends keyof AppState>(sceneData: {\n      elements?: SceneData[\"elements\"];\n      appState?: Pick<AppState, K> | null;\n      collaborators?: SceneData[\"collaborators\"];\n      commitToHistory?: SceneData[\"commitToHistory\"];\n    }) => {\n      if (sceneData.commitToHistory) {\n        this.history.resumeRecording();\n      }\n\n      if (sceneData.appState) {\n        this.setState(sceneData.appState);\n      }\n\n      if (sceneData.elements) {\n        this.scene.replaceAllElements(sceneData.elements);\n      }\n\n      if (sceneData.collaborators) {\n        this.setState({ collaborators: sceneData.collaborators });\n      }\n    },\n  );\n\n  private onSceneUpdated = () => {\n    this.setState({});\n  };\n\n  /**\n   * @returns whether the menu was toggled on or off\n   */\n  public toggleSidebar = ({\n    name,\n    tab,\n    force,\n  }: {\n    name: SidebarName;\n    tab?: SidebarTabName;\n    force?: boolean;\n  }): boolean => {\n    let nextName;\n    if (force === undefined) {\n      nextName = this.state.openSidebar?.name === name ? null : name;\n    } else {\n      nextName = force ? name : null;\n    }\n    this.setState({ openSidebar: nextName ? { name: nextName, tab } : null });\n\n    return !!nextName;\n  };\n\n  private updateCurrentCursorPosition = withBatchedUpdates(\n    (event: MouseEvent) => {\n      this.lastViewportPosition.x = event.clientX;\n      this.lastViewportPosition.y = event.clientY;\n    },\n  );\n\n  // Input handling\n  private onKeyDown = withBatchedUpdates(\n    (event: React.KeyboardEvent | KeyboardEvent) => {\n      // normalize `event.key` when CapsLock is pressed #2372\n\n      if (\n        \"Proxy\" in window &&\n        ((!event.shiftKey && /^[A-Z]$/.test(event.key)) ||\n          (event.shiftKey && /^[a-z]$/.test(event.key)))\n      ) {\n        event = new Proxy(event, {\n          get(ev: any, prop) {\n            const value = ev[prop];\n            if (typeof value === \"function\") {\n              // fix for Proxies hijacking `this`\n              return value.bind(ev);\n            }\n            return prop === \"key\"\n              ? // CapsLock inverts capitalization based on ShiftKey, so invert\n                // it back\n                event.shiftKey\n                ? ev.key.toUpperCase()\n                : ev.key.toLowerCase()\n              : value;\n          },\n        });\n      }\n\n      if (event[KEYS.CTRL_OR_CMD] && event.key.toLowerCase() === KEYS.V) {\n        IS_PLAIN_PASTE = event.shiftKey;\n        clearTimeout(IS_PLAIN_PASTE_TIMER);\n        // reset (100ms to be safe that we it runs after the ensuing\n        // paste event). Though, technically unnecessary to reset since we\n        // (re)set the flag before each paste event.\n        IS_PLAIN_PASTE_TIMER = window.setTimeout(() => {\n          IS_PLAIN_PASTE = false;\n        }, 100);\n      }\n\n      // prevent browser zoom in input fields\n      if (event[KEYS.CTRL_OR_CMD] && isWritableElement(event.target)) {\n        if (event.code === CODES.MINUS || event.code === CODES.EQUAL) {\n          event.preventDefault();\n          return;\n        }\n      }\n\n      // bail if\n      if (\n        // inside an input\n        (isWritableElement(event.target) &&\n          // unless pressing escape (finalize action)\n          event.key !== KEYS.ESCAPE) ||\n        // or unless using arrows (to move between buttons)\n        (isArrowKey(event.key) && isInputLike(event.target))\n      ) {\n        return;\n      }\n\n      if (event.key === KEYS.QUESTION_MARK) {\n        this.setState({\n          openDialog: \"help\",\n        });\n        return;\n      } else if (\n        event.key.toLowerCase() === KEYS.E &&\n        event.shiftKey &&\n        event[KEYS.CTRL_OR_CMD]\n      ) {\n        event.preventDefault();\n        this.setState({ openDialog: \"imageExport\" });\n        return;\n      }\n\n      if (event.key === KEYS.PAGE_UP || event.key === KEYS.PAGE_DOWN) {\n        let offset =\n          (event.shiftKey ? this.state.width : this.state.height) /\n          this.state.zoom.value;\n        if (event.key === KEYS.PAGE_DOWN) {\n          offset = -offset;\n        }\n        if (event.shiftKey) {\n          this.translateCanvas((state) => ({\n            scrollX: state.scrollX + offset,\n          }));\n        } else {\n          this.translateCanvas((state) => ({\n            scrollY: state.scrollY + offset,\n          }));\n        }\n      }\n\n      if (this.actionManager.handleKeyDown(event)) {\n        return;\n      }\n\n      if (this.state.viewModeEnabled) {\n        return;\n      }\n\n      if (event[KEYS.CTRL_OR_CMD] && this.state.isBindingEnabled) {\n        this.setState({ isBindingEnabled: false });\n      }\n\n      if (isArrowKey(event.key)) {\n        const step =\n          (this.state.gridSize &&\n            (event.shiftKey\n              ? ELEMENT_TRANSLATE_AMOUNT\n              : this.state.gridSize)) ||\n          (event.shiftKey\n            ? ELEMENT_SHIFT_TRANSLATE_AMOUNT\n            : ELEMENT_TRANSLATE_AMOUNT);\n\n        let offsetX = 0;\n        let offsetY = 0;\n\n        if (event.key === KEYS.ARROW_LEFT) {\n          offsetX = -step;\n        } else if (event.key === KEYS.ARROW_RIGHT) {\n          offsetX = step;\n        } else if (event.key === KEYS.ARROW_UP) {\n          offsetY = -step;\n        } else if (event.key === KEYS.ARROW_DOWN) {\n          offsetY = step;\n        }\n\n        const selectedElements = this.scene.getSelectedElements({\n          selectedElementIds: this.state.selectedElementIds,\n          includeBoundTextElement: true,\n          includeElementsInFrames: true,\n        });\n\n        selectedElements.forEach((element) => {\n          mutateElement(element, {\n            x: element.x + offsetX,\n            y: element.y + offsetY,\n          });\n\n          updateBoundElements(element, {\n            simultaneouslyUpdated: selectedElements,\n          });\n        });\n\n        this.maybeSuggestBindingForAll(selectedElements);\n\n        event.preventDefault();\n      } else if (event.key === KEYS.ENTER) {\n        const selectedElements = this.scene.getSelectedElements(this.state);\n        if (selectedElements.length === 1) {\n          const selectedElement = selectedElements[0];\n          if (event[KEYS.CTRL_OR_CMD]) {\n            if (isLinearElement(selectedElement)) {\n              if (\n                !this.state.editingLinearElement ||\n                this.state.editingLinearElement.elementId !==\n                  selectedElements[0].id\n              ) {\n                this.history.resumeRecording();\n                this.setState({\n                  editingLinearElement: new LinearElementEditor(\n                    selectedElement,\n                    this.scene,\n                  ),\n                });\n              }\n            }\n          } else if (\n            isTextElement(selectedElement) ||\n            isValidTextContainer(selectedElement)\n          ) {\n            let container;\n            if (!isTextElement(selectedElement)) {\n              container = selectedElement as ExcalidrawTextContainer;\n            }\n            const midPoint = getContainerCenter(selectedElement, this.state);\n            const sceneX = midPoint.x;\n            const sceneY = midPoint.y;\n            this.startTextEditing({\n              sceneX,\n              sceneY,\n              container,\n            });\n            event.preventDefault();\n            return;\n          } else if (isFrameElement(selectedElement)) {\n            this.setState({\n              editingFrame: selectedElement.id,\n            });\n          }\n        }\n      } else if (\n        !event.ctrlKey &&\n        !event.altKey &&\n        !event.metaKey &&\n        this.state.draggingElement === null\n      ) {\n        const shape = findShapeByKey(event.key);\n        if (shape) {\n          if (this.state.activeTool.type !== shape) {\n            trackEvent(\n              \"toolbar\",\n              shape,\n              `keyboard (${this.device.isMobile ? \"mobile\" : \"desktop\"})`,\n            );\n          }\n          this.setActiveTool({ type: shape });\n          event.stopPropagation();\n        } else if (event.key === KEYS.Q) {\n          this.toggleLock(\"keyboard\");\n          event.stopPropagation();\n        }\n      }\n      if (event.key === KEYS.SPACE && gesture.pointers.size === 0) {\n        isHoldingSpace = true;\n        setCursor(this.canvas, CURSOR_TYPE.GRAB);\n        event.preventDefault();\n      }\n\n      if (\n        (event.key === KEYS.G || event.key === KEYS.S) &&\n        !event.altKey &&\n        !event[KEYS.CTRL_OR_CMD]\n      ) {\n        const selectedElements = this.scene.getSelectedElements(this.state);\n        if (\n          this.state.activeTool.type === \"selection\" &&\n          !selectedElements.length\n        ) {\n          return;\n        }\n\n        if (\n          event.key === KEYS.G &&\n          (hasBackground(this.state.activeTool.type) ||\n            selectedElements.some((element) => hasBackground(element.type)))\n        ) {\n          this.setState({ openPopup: \"elementBackground\" });\n          event.stopPropagation();\n        }\n        if (event.key === KEYS.S) {\n          this.setState({ openPopup: \"elementStroke\" });\n          event.stopPropagation();\n        }\n      }\n\n      if (\n        event[KEYS.CTRL_OR_CMD] &&\n        (event.key === KEYS.BACKSPACE || event.key === KEYS.DELETE)\n      ) {\n        jotaiStore.set(activeConfirmDialogAtom, \"clearCanvas\");\n      }\n\n      // eye dropper\n      // -----------------------------------------------------------------------\n      const lowerCased = event.key.toLocaleLowerCase();\n      const isPickingStroke = lowerCased === KEYS.S && event.shiftKey;\n      const isPickingBackground =\n        event.key === KEYS.I || (lowerCased === KEYS.G && event.shiftKey);\n\n      if (isPickingStroke || isPickingBackground) {\n        this.openEyeDropper({\n          type: isPickingStroke ? \"stroke\" : \"background\",\n        });\n      }\n      // -----------------------------------------------------------------------\n    },\n  );\n\n  private onWheel = withBatchedUpdates((event: WheelEvent) => {\n    // prevent browser pinch zoom on DOM elements\n    if (!(event.target instanceof HTMLCanvasElement) && event.ctrlKey) {\n      event.preventDefault();\n    }\n  });\n\n  private onKeyUp = withBatchedUpdates((event: KeyboardEvent) => {\n    if (event.key === KEYS.SPACE) {\n      if (this.state.viewModeEnabled) {\n        setCursor(this.canvas, CURSOR_TYPE.GRAB);\n      } else if (this.state.activeTool.type === \"selection\") {\n        resetCursor(this.canvas);\n      } else {\n        setCursorForShape(this.canvas, this.state);\n        this.setState({\n          selectedElementIds: makeNextSelectedElementIds({}, this.state),\n          selectedGroupIds: {},\n          editingGroupId: null,\n        });\n      }\n      isHoldingSpace = false;\n    }\n    if (!event[KEYS.CTRL_OR_CMD] && !this.state.isBindingEnabled) {\n      this.setState({ isBindingEnabled: true });\n    }\n    if (isArrowKey(event.key)) {\n      const selectedElements = this.scene.getSelectedElements(this.state);\n      isBindingEnabled(this.state)\n        ? bindOrUnbindSelectedElements(selectedElements)\n        : unbindLinearElements(selectedElements);\n      this.setState({ suggestedBindings: [] });\n    }\n  });\n\n  private setActiveTool = (\n    tool:\n      | { type: typeof SHAPES[number][\"value\"] | \"eraser\" | \"hand\" | \"frame\" }\n      | { type: \"custom\"; customType: string },\n  ) => {\n    const nextActiveTool = updateActiveTool(this.state, tool);\n    if (nextActiveTool.type === \"hand\") {\n      setCursor(this.canvas, CURSOR_TYPE.GRAB);\n    } else if (!isHoldingSpace) {\n      setCursorForShape(this.canvas, this.state);\n    }\n    if (isToolIcon(document.activeElement)) {\n      this.focusContainer();\n    }\n    if (!isLinearElementType(nextActiveTool.type)) {\n      this.setState({ suggestedBindings: [] });\n    }\n    if (nextActiveTool.type === \"image\") {\n      this.onImageAction();\n    }\n    if (nextActiveTool.type !== \"selection\") {\n      this.setState({\n        activeTool: nextActiveTool,\n        selectedElementIds: makeNextSelectedElementIds({}, this.state),\n        selectedGroupIds: {},\n        editingGroupId: null,\n      });\n    } else {\n      this.setState({ activeTool: nextActiveTool });\n    }\n  };\n\n  private setCursor = (cursor: string) => {\n    setCursor(this.canvas, cursor);\n  };\n\n  private resetCursor = () => {\n    resetCursor(this.canvas);\n  };\n  /**\n   * returns whether user is making a gesture with >= 2 fingers (points)\n   * on o touch screen (not on a trackpad). Currently only relates to Darwin\n   * (iOS/iPadOS,MacOS), but may work on other devices in the future if\n   * GestureEvent is standardized.\n   */\n  private isTouchScreenMultiTouchGesture = () => {\n    // we don't want to deselect when using trackpad, and multi-point gestures\n    // only work on touch screens, so checking for >= pointers means we're on a\n    // touchscreen\n    return gesture.pointers.size >= 2;\n  };\n\n  // fires only on Safari\n  private onGestureStart = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n\n    // we only want to deselect on touch screens because user may have selected\n    // elements by mistake while zooming\n    if (this.isTouchScreenMultiTouchGesture()) {\n      this.setState({\n        selectedElementIds: makeNextSelectedElementIds({}, this.state),\n      });\n    }\n    gesture.initialScale = this.state.zoom.value;\n  });\n\n  // fires only on Safari\n  private onGestureChange = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n\n    // onGestureChange only has zoom factor but not the center.\n    // If we're on iPad or iPhone, then we recognize multi-touch and will\n    // zoom in at the right location in the touchmove handler\n    // (handleCanvasPointerMove).\n    //\n    // On Macbook trackpad, we don't have those events so will zoom in at the\n    // current location instead.\n    //\n    // As such, bail from this handler on touch devices.\n    if (this.isTouchScreenMultiTouchGesture()) {\n      return;\n    }\n\n    const initialScale = gesture.initialScale;\n    if (initialScale) {\n      this.setState((state) => ({\n        ...getStateForZoom(\n          {\n            viewportX: this.lastViewportPosition.x,\n            viewportY: this.lastViewportPosition.y,\n            nextZoom: getNormalizedZoom(initialScale * event.scale),\n          },\n          state,\n        ),\n      }));\n    }\n  });\n\n  // fires only on Safari\n  private onGestureEnd = withBatchedUpdates((event: GestureEvent) => {\n    event.preventDefault();\n    // reselect elements only on touch screens (see onGestureStart)\n    if (this.isTouchScreenMultiTouchGesture()) {\n      this.setState({\n        previousSelectedElementIds: {},\n        selectedElementIds: makeNextSelectedElementIds(\n          this.state.previousSelectedElementIds,\n          this.state,\n        ),\n      });\n    }\n    gesture.initialScale = null;\n  });\n\n  private handleTextWysiwyg(\n    element: ExcalidrawTextElement,\n    {\n      isExistingElement = false,\n    }: {\n      isExistingElement?: boolean;\n    },\n  ) {\n    const updateElement = (\n      text: string,\n      originalText: string,\n      isDeleted: boolean,\n    ) => {\n      this.scene.replaceAllElements([\n        ...this.scene.getElementsIncludingDeleted().map((_element) => {\n          if (_element.id === element.id && isTextElement(_element)) {\n            return updateTextElement(_element, {\n              text,\n              isDeleted,\n              originalText,\n            });\n          }\n          return _element;\n        }),\n      ]);\n    };\n\n    textWysiwyg({\n      id: element.id,\n      canvas: this.canvas,\n      getViewportCoords: (x, y) => {\n        const { x: viewportX, y: viewportY } = sceneCoordsToViewportCoords(\n          {\n            sceneX: x,\n            sceneY: y,\n          },\n          this.state,\n        );\n        return [\n          viewportX - this.state.offsetLeft,\n          viewportY - this.state.offsetTop,\n        ];\n      },\n      onChange: withBatchedUpdates((text) => {\n        updateElement(text, text, false);\n        if (isNonDeletedElement(element)) {\n          updateBoundElements(element);\n        }\n      }),\n      onSubmit: withBatchedUpdates(({ text, viaKeyboard, originalText }) => {\n        const isDeleted = !text.trim();\n        updateElement(text, originalText, isDeleted);\n        // select the created text element only if submitting via keyboard\n        // (when submitting via click it should act as signal to deselect)\n        if (!isDeleted && viaKeyboard) {\n          const elementIdToSelect = element.containerId\n            ? element.containerId\n            : element.id;\n          this.setState((prevState) => ({\n            selectedElementIds: makeNextSelectedElementIds(\n              {\n                ...prevState.selectedElementIds,\n                [elementIdToSelect]: true,\n              },\n              prevState,\n            ),\n          }));\n        }\n        if (isDeleted) {\n          fixBindingsAfterDeletion(this.scene.getNonDeletedElements(), [\n            element,\n          ]);\n        }\n        if (!isDeleted || isExistingElement) {\n          this.history.resumeRecording();\n        }\n\n        this.setState({\n          draggingElement: null,\n          editingElement: null,\n        });\n        if (this.state.activeTool.locked) {\n          setCursorForShape(this.canvas, this.state);\n        }\n\n        this.focusContainer();\n      }),\n      element,\n      excalidrawContainer: this.excalidrawContainerRef.current,\n      app: this,\n    });\n    // deselect all other elements when inserting text\n    this.deselectElements();\n\n    // do an initial update to re-initialize element position since we were\n    // modifying element's x/y for sake of editor (case: syncing to remote)\n    updateElement(element.text, element.originalText, false);\n  }\n\n  private deselectElements() {\n    this.setState({\n      selectedElementIds: makeNextSelectedElementIds({}, this.state),\n      selectedGroupIds: {},\n      editingGroupId: null,\n    });\n  }\n\n  private getTextElementAtPosition(\n    x: number,\n    y: number,\n  ): NonDeleted<ExcalidrawTextElement> | null {\n    const element = this.getElementAtPosition(x, y, {\n      includeBoundTextElement: true,\n    });\n    if (element && isTextElement(element) && !element.isDeleted) {\n      return element;\n    }\n    return null;\n  }\n\n  private getElementAtPosition(\n    x: number,\n    y: number,\n    opts?: {\n      /** if true, returns the first selected element (with highest z-index)\n        of all hit elements */\n      preferSelected?: boolean;\n      includeBoundTextElement?: boolean;\n      includeLockedElements?: boolean;\n    },\n  ): NonDeleted<ExcalidrawElement> | null {\n    const allHitElements = this.getElementsAtPosition(\n      x,\n      y,\n      opts?.includeBoundTextElement,\n      opts?.includeLockedElements,\n    );\n    if (allHitElements.length > 1) {\n      if (opts?.preferSelected) {\n        for (let index = allHitElements.length - 1; index > -1; index--) {\n          if (this.state.selectedElementIds[allHitElements[index].id]) {\n            return allHitElements[index];\n          }\n        }\n      }\n      const elementWithHighestZIndex =\n        allHitElements[allHitElements.length - 1];\n      // If we're hitting element with highest z-index only on its bounding box\n      // while also hitting other element figure, the latter should be considered.\n      return isHittingElementBoundingBoxWithoutHittingElement(\n        elementWithHighestZIndex,\n        this.state,\n        this.frameNameBoundsCache,\n        x,\n        y,\n      )\n        ? allHitElements[allHitElements.length - 2]\n        : elementWithHighestZIndex;\n    }\n    if (allHitElements.length === 1) {\n      return allHitElements[0];\n    }\n    return null;\n  }\n\n  private getElementsAtPosition(\n    x: number,\n    y: number,\n    includeBoundTextElement: boolean = false,\n    includeLockedElements: boolean = false,\n  ): NonDeleted<ExcalidrawElement>[] {\n    const elements =\n      includeBoundTextElement && includeLockedElements\n        ? this.scene.getNonDeletedElements()\n        : this.scene\n            .getNonDeletedElements()\n            .filter(\n              (element) =>\n                (includeLockedElements || !element.locked) &&\n                (includeBoundTextElement ||\n                  !(isTextElement(element) && element.containerId)),\n            );\n\n    return getElementsAtPosition(elements, (element) =>\n      hitTest(element, this.state, this.frameNameBoundsCache, x, y),\n    ).filter((element) => {\n      // hitting a frame's element from outside the frame is not considered a hit\n      const containingFrame = getContainingFrame(element);\n      return containingFrame &&\n        this.state.frameRendering.enabled &&\n        this.state.frameRendering.clip\n        ? isCursorInFrame({ x, y }, containingFrame)\n        : true;\n    });\n  }\n\n  private startTextEditing = ({\n    sceneX,\n    sceneY,\n    insertAtParentCenter = true,\n    container,\n  }: {\n    /** X position to insert text at */\n    sceneX: number;\n    /** Y position to insert text at */\n    sceneY: number;\n    /** whether to attempt to insert at element center if applicable */\n    insertAtParentCenter?: boolean;\n    container?: ExcalidrawTextContainer | null;\n  }) => {\n    let shouldBindToContainer = false;\n\n    let parentCenterPosition =\n      insertAtParentCenter &&\n      this.getTextWysiwygSnappedToCenterPosition(\n        sceneX,\n        sceneY,\n        this.state,\n        container,\n      );\n    if (container && parentCenterPosition) {\n      const boundTextElementToContainer = getBoundTextElement(container);\n      if (!boundTextElementToContainer) {\n        shouldBindToContainer = true;\n      }\n    }\n    let existingTextElement: NonDeleted<ExcalidrawTextElement> | null = null;\n\n    const selectedElements = this.scene.getSelectedElements(this.state);\n\n    if (selectedElements.length === 1) {\n      if (isTextElement(selectedElements[0])) {\n        existingTextElement = selectedElements[0];\n      } else if (container) {\n        existingTextElement = getBoundTextElement(selectedElements[0]);\n      } else {\n        existingTextElement = this.getTextElementAtPosition(sceneX, sceneY);\n      }\n    } else {\n      existingTextElement = this.getTextElementAtPosition(sceneX, sceneY);\n    }\n\n    const fontFamily =\n      existingTextElement?.fontFamily || this.state.currentItemFontFamily;\n\n    const lineHeight =\n      existingTextElement?.lineHeight || getDefaultLineHeight(fontFamily);\n    const fontSize = this.state.currentItemFontSize;\n\n    if (\n      !existingTextElement &&\n      shouldBindToContainer &&\n      container &&\n      !isArrowElement(container)\n    ) {\n      const fontString = {\n        fontSize,\n        fontFamily,\n      };\n      const minWidth = getApproxMinLineWidth(\n        getFontString(fontString),\n        lineHeight,\n      );\n      const minHeight = getApproxMinLineHeight(fontSize, lineHeight);\n      const containerDims = getContainerDims(container);\n      const newHeight = Math.max(containerDims.height, minHeight);\n      const newWidth = Math.max(containerDims.width, minWidth);\n      mutateElement(container, { height: newHeight, width: newWidth });\n      sceneX = container.x + newWidth / 2;\n      sceneY = container.y + newHeight / 2;\n      if (parentCenterPosition) {\n        parentCenterPosition = this.getTextWysiwygSnappedToCenterPosition(\n          sceneX,\n          sceneY,\n          this.state,\n          container,\n        );\n      }\n    }\n\n    const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n      x: sceneX,\n      y: sceneY,\n    });\n\n    const element = existingTextElement\n      ? existingTextElement\n      : newTextElement({\n          x: parentCenterPosition\n            ? parentCenterPosition.elementCenterX\n            : sceneX,\n          y: parentCenterPosition\n            ? parentCenterPosition.elementCenterY\n            : sceneY,\n          strokeColor: this.state.currentItemStrokeColor,\n          backgroundColor: this.state.currentItemBackgroundColor,\n          fillStyle: this.state.currentItemFillStyle,\n          strokeWidth: this.state.currentItemStrokeWidth,\n          strokeStyle: this.state.currentItemStrokeStyle,\n          roughness: this.state.currentItemRoughness,\n          opacity: this.state.currentItemOpacity,\n          text: \"\",\n          fontSize,\n          fontFamily,\n          textAlign: parentCenterPosition\n            ? \"center\"\n            : this.state.currentItemTextAlign,\n          verticalAlign: parentCenterPosition\n            ? VERTICAL_ALIGN.MIDDLE\n            : DEFAULT_VERTICAL_ALIGN,\n          containerId: shouldBindToContainer ? container?.id : undefined,\n          groupIds: container?.groupIds ?? [],\n          lineHeight,\n          angle: container?.angle ?? 0,\n          frameId: topLayerFrame ? topLayerFrame.id : null,\n        });\n\n    if (!existingTextElement && shouldBindToContainer && container) {\n      mutateElement(container, {\n        boundElements: (container.boundElements || []).concat({\n          type: \"text\",\n          id: element.id,\n        }),\n      });\n    }\n    this.setState({ editingElement: element });\n\n    if (!existingTextElement) {\n      if (container && shouldBindToContainer) {\n        const containerIndex = this.scene.getElementIndex(container.id);\n        this.scene.insertElementAtIndex(element, containerIndex + 1);\n      } else {\n        this.scene.addNewElement(element);\n      }\n    }\n\n    this.setState({\n      editingElement: element,\n    });\n\n    this.handleTextWysiwyg(element, {\n      isExistingElement: !!existingTextElement,\n    });\n  };\n\n  private handleCanvasDoubleClick = (\n    event: React.MouseEvent<HTMLCanvasElement>,\n  ) => {\n    // case: double-clicking with arrow/line tool selected would both create\n    // text and enter multiElement mode\n    if (this.state.multiElement) {\n      return;\n    }\n    // we should only be able to double click when mode is selection\n    if (this.state.activeTool.type !== \"selection\") {\n      return;\n    }\n\n    const selectedElements = this.scene.getSelectedElements(this.state);\n\n    if (selectedElements.length === 1 && isLinearElement(selectedElements[0])) {\n      if (\n        event[KEYS.CTRL_OR_CMD] &&\n        (!this.state.editingLinearElement ||\n          this.state.editingLinearElement.elementId !== selectedElements[0].id)\n      ) {\n        this.history.resumeRecording();\n        this.setState({\n          editingLinearElement: new LinearElementEditor(\n            selectedElements[0],\n            this.scene,\n          ),\n        });\n        return;\n      } else if (\n        this.state.editingLinearElement &&\n        this.state.editingLinearElement.elementId === selectedElements[0].id\n      ) {\n        return;\n      }\n    }\n\n    resetCursor(this.canvas);\n\n    let { x: sceneX, y: sceneY } = viewportCoordsToSceneCoords(\n      event,\n      this.state,\n    );\n\n    const selectedGroupIds = getSelectedGroupIds(this.state);\n\n    if (selectedGroupIds.length > 0) {\n      const hitElement = this.getElementAtPosition(sceneX, sceneY);\n\n      const selectedGroupId =\n        hitElement &&\n        getSelectedGroupIdForElement(hitElement, this.state.selectedGroupIds);\n\n      if (selectedGroupId) {\n        this.setState((prevState) =>\n          selectGroupsForSelectedElements(\n            {\n              ...prevState,\n              editingGroupId: selectedGroupId,\n              selectedElementIds: { [hitElement!.id]: true },\n              selectedGroupIds: {},\n            },\n            this.scene.getNonDeletedElements(),\n            prevState,\n            this,\n          ),\n        );\n        return;\n      }\n    }\n\n    resetCursor(this.canvas);\n    if (!event[KEYS.CTRL_OR_CMD] && !this.state.viewModeEnabled) {\n      const container = getTextBindableContainerAtPosition(\n        this.scene.getNonDeletedElements(),\n        this.state,\n        sceneX,\n        sceneY,\n      );\n      if (container) {\n        if (\n          hasBoundTextElement(container) ||\n          !isTransparent(container.backgroundColor) ||\n          isHittingElementNotConsideringBoundingBox(\n            container,\n            this.state,\n            this.frameNameBoundsCache,\n            [sceneX, sceneY],\n          )\n        ) {\n          const midPoint = getContainerCenter(container, this.state);\n\n          sceneX = midPoint.x;\n          sceneY = midPoint.y;\n        }\n      }\n      this.startTextEditing({\n        sceneX,\n        sceneY,\n        insertAtParentCenter: !event.altKey,\n        container,\n      });\n    }\n  };\n\n  private getElementLinkAtPosition = (\n    scenePointer: Readonly<{ x: number; y: number }>,\n    hitElement: NonDeletedExcalidrawElement | null,\n  ): ExcalidrawElement | undefined => {\n    // Reversing so we traverse the elements in decreasing order\n    // of z-index\n    const elements = this.scene.getNonDeletedElements().slice().reverse();\n    let hitElementIndex = Infinity;\n\n    return elements.find((element, index) => {\n      if (hitElement && element.id === hitElement.id) {\n        hitElementIndex = index;\n      }\n      return (\n        element.link &&\n        index <= hitElementIndex &&\n        isPointHittingLinkIcon(\n          element,\n          this.state,\n          [scenePointer.x, scenePointer.y],\n          this.device.isMobile,\n        )\n      );\n    });\n  };\n\n  private redirectToLink = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n    isTouchScreen: boolean,\n  ) => {\n    const draggedDistance = distance2d(\n      this.lastPointerDown!.clientX,\n      this.lastPointerDown!.clientY,\n      this.lastPointerUp!.clientX,\n      this.lastPointerUp!.clientY,\n    );\n    if (\n      !this.hitLinkElement ||\n      // For touch screen allow dragging threshold else strict check\n      (isTouchScreen && draggedDistance > DRAGGING_THRESHOLD) ||\n      (!isTouchScreen && draggedDistance !== 0)\n    ) {\n      return;\n    }\n    const lastPointerDownCoords = viewportCoordsToSceneCoords(\n      this.lastPointerDown!,\n      this.state,\n    );\n    const lastPointerDownHittingLinkIcon = isPointHittingLinkIcon(\n      this.hitLinkElement,\n      this.state,\n      [lastPointerDownCoords.x, lastPointerDownCoords.y],\n      this.device.isMobile,\n    );\n    const lastPointerUpCoords = viewportCoordsToSceneCoords(\n      this.lastPointerUp!,\n      this.state,\n    );\n    const lastPointerUpHittingLinkIcon = isPointHittingLinkIcon(\n      this.hitLinkElement,\n      this.state,\n      [lastPointerUpCoords.x, lastPointerUpCoords.y],\n      this.device.isMobile,\n    );\n    if (lastPointerDownHittingLinkIcon && lastPointerUpHittingLinkIcon) {\n      let url = this.hitLinkElement.link;\n      if (url) {\n        url = normalizeLink(url);\n        let customEvent;\n        if (this.props.onLinkOpen) {\n          customEvent = wrapEvent(EVENT.EXCALIDRAW_LINK, event.nativeEvent);\n          this.props.onLinkOpen(\n            {\n              ...this.hitLinkElement,\n              link: url,\n            },\n            customEvent,\n          );\n        }\n        if (!customEvent?.defaultPrevented) {\n          const target = isLocalLink(url) ? \"_self\" : \"_blank\";\n          const newWindow = window.open(undefined, target);\n          // https://mathiasbynens.github.io/rel-noopener/\n          if (newWindow) {\n            newWindow.opener = null;\n            newWindow.location = url;\n          }\n        }\n      }\n    }\n  };\n\n  private getTopLayerFrameAtSceneCoords = (sceneCoords: {\n    x: number;\n    y: number;\n  }) => {\n    const frames = this.scene\n      .getNonDeletedFrames()\n      .filter((frame) =>\n        isCursorInFrame(sceneCoords, frame as ExcalidrawFrameElement),\n      );\n\n    return frames.length ? frames[frames.length - 1] : null;\n  };\n\n  private handleCanvasPointerMove = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ) => {\n    this.savePointer(event.clientX, event.clientY, this.state.cursorButton);\n\n    if (gesture.pointers.has(event.pointerId)) {\n      gesture.pointers.set(event.pointerId, {\n        x: event.clientX,\n        y: event.clientY,\n      });\n    }\n\n    const initialScale = gesture.initialScale;\n    if (\n      gesture.pointers.size === 2 &&\n      gesture.lastCenter &&\n      initialScale &&\n      gesture.initialDistance\n    ) {\n      const center = getCenter(gesture.pointers);\n      const deltaX = center.x - gesture.lastCenter.x;\n      const deltaY = center.y - gesture.lastCenter.y;\n      gesture.lastCenter = center;\n\n      const distance = getDistance(Array.from(gesture.pointers.values()));\n      const scaleFactor =\n        this.state.activeTool.type === \"freedraw\" && this.state.penMode\n          ? 1\n          : distance / gesture.initialDistance;\n\n      const nextZoom = scaleFactor\n        ? getNormalizedZoom(initialScale * scaleFactor)\n        : this.state.zoom.value;\n\n      this.setState((state) => {\n        const zoomState = getStateForZoom(\n          {\n            viewportX: center.x,\n            viewportY: center.y,\n            nextZoom,\n          },\n          state,\n        );\n\n        this.translateCanvas({\n          zoom: zoomState.zoom,\n          scrollX: zoomState.scrollX + deltaX / nextZoom,\n          scrollY: zoomState.scrollY + deltaY / nextZoom,\n          shouldCacheIgnoreZoom: true,\n        });\n      });\n      this.resetShouldCacheIgnoreZoomDebounced();\n    } else {\n      gesture.lastCenter =\n        gesture.initialDistance =\n        gesture.initialScale =\n          null;\n    }\n\n    if (\n      isHoldingSpace ||\n      isPanning ||\n      isDraggingScrollBar ||\n      isHandToolActive(this.state)\n    ) {\n      return;\n    }\n\n    const isPointerOverScrollBars = isOverScrollBars(\n      currentScrollBars,\n      event.clientX - this.state.offsetLeft,\n      event.clientY - this.state.offsetTop,\n    );\n    const isOverScrollBar = isPointerOverScrollBars.isOverEither;\n    if (!this.state.draggingElement && !this.state.multiElement) {\n      if (isOverScrollBar) {\n        resetCursor(this.canvas);\n      } else {\n        setCursorForShape(this.canvas, this.state);\n      }\n    }\n\n    const scenePointer = viewportCoordsToSceneCoords(event, this.state);\n    const { x: scenePointerX, y: scenePointerY } = scenePointer;\n\n    if (\n      this.state.editingLinearElement &&\n      !this.state.editingLinearElement.isDragging\n    ) {\n      const editingLinearElement = LinearElementEditor.handlePointerMove(\n        event,\n        scenePointerX,\n        scenePointerY,\n        this.state,\n      );\n\n      if (\n        editingLinearElement &&\n        editingLinearElement !== this.state.editingLinearElement\n      ) {\n        // Since we are reading from previous state which is not possible with\n        // automatic batching in React 18 hence using flush sync to synchronously\n        // update the state. Check https://github.com/excalidraw/excalidraw/pull/5508 for more details.\n        flushSync(() => {\n          this.setState({\n            editingLinearElement,\n          });\n        });\n      }\n      if (editingLinearElement?.lastUncommittedPoint != null) {\n        this.maybeSuggestBindingAtCursor(scenePointer);\n      } else {\n        // causes stack overflow if not sync\n        flushSync(() => {\n          this.setState({ suggestedBindings: [] });\n        });\n      }\n    }\n\n    if (isBindingElementType(this.state.activeTool.type)) {\n      // Hovering with a selected tool or creating new linear element via click\n      // and point\n      const { draggingElement } = this.state;\n      if (isBindingElement(draggingElement, false)) {\n        this.maybeSuggestBindingsForLinearElementAtCoords(\n          draggingElement,\n          [scenePointer],\n          this.state.startBoundElement,\n        );\n      } else {\n        this.maybeSuggestBindingAtCursor(scenePointer);\n      }\n    }\n\n    if (this.state.multiElement) {\n      const { multiElement } = this.state;\n      const { x: rx, y: ry } = multiElement;\n\n      const { points, lastCommittedPoint } = multiElement;\n      const lastPoint = points[points.length - 1];\n\n      setCursorForShape(this.canvas, this.state);\n\n      if (lastPoint === lastCommittedPoint) {\n        // if we haven't yet created a temp point and we're beyond commit-zone\n        // threshold, add a point\n        if (\n          distance2d(\n            scenePointerX - rx,\n            scenePointerY - ry,\n            lastPoint[0],\n            lastPoint[1],\n          ) >= LINE_CONFIRM_THRESHOLD\n        ) {\n          mutateElement(multiElement, {\n            points: [...points, [scenePointerX - rx, scenePointerY - ry]],\n          });\n        } else {\n          setCursor(this.canvas, CURSOR_TYPE.POINTER);\n          // in this branch, we're inside the commit zone, and no uncommitted\n          // point exists. Thus do nothing (don't add/remove points).\n        }\n      } else if (\n        points.length > 2 &&\n        lastCommittedPoint &&\n        distance2d(\n          scenePointerX - rx,\n          scenePointerY - ry,\n          lastCommittedPoint[0],\n          lastCommittedPoint[1],\n        ) < LINE_CONFIRM_THRESHOLD\n      ) {\n        setCursor(this.canvas, CURSOR_TYPE.POINTER);\n        mutateElement(multiElement, {\n          points: points.slice(0, -1),\n        });\n      } else {\n        const [gridX, gridY] = getGridPoint(\n          scenePointerX,\n          scenePointerY,\n          this.state.gridSize,\n        );\n\n        const [lastCommittedX, lastCommittedY] =\n          multiElement?.lastCommittedPoint ?? [0, 0];\n\n        let dxFromLastCommitted = gridX - rx - lastCommittedX;\n        let dyFromLastCommitted = gridY - ry - lastCommittedY;\n\n        if (shouldRotateWithDiscreteAngle(event)) {\n          ({ width: dxFromLastCommitted, height: dyFromLastCommitted } =\n            getLockedLinearCursorAlignSize(\n              // actual coordinate of the last committed point\n              lastCommittedX + rx,\n              lastCommittedY + ry,\n              // cursor-grid coordinate\n              gridX,\n              gridY,\n            ));\n        }\n\n        if (isPathALoop(points, this.state.zoom.value)) {\n          setCursor(this.canvas, CURSOR_TYPE.POINTER);\n        }\n        // update last uncommitted point\n        mutateElement(multiElement, {\n          points: [\n            ...points.slice(0, -1),\n            [\n              lastCommittedX + dxFromLastCommitted,\n              lastCommittedY + dyFromLastCommitted,\n            ],\n          ],\n        });\n      }\n\n      return;\n    }\n\n    const hasDeselectedButton = Boolean(event.buttons);\n    if (\n      hasDeselectedButton ||\n      (this.state.activeTool.type !== \"selection\" &&\n        this.state.activeTool.type !== \"text\" &&\n        this.state.activeTool.type !== \"eraser\")\n    ) {\n      return;\n    }\n\n    const elements = this.scene.getNonDeletedElements();\n\n    const selectedElements = this.scene.getSelectedElements(this.state);\n    if (\n      selectedElements.length === 1 &&\n      !isOverScrollBar &&\n      !this.state.editingLinearElement\n    ) {\n      const elementWithTransformHandleType = getElementWithTransformHandleType(\n        elements,\n        this.state,\n        scenePointerX,\n        scenePointerY,\n        this.state.zoom,\n        event.pointerType,\n      );\n      if (\n        elementWithTransformHandleType &&\n        elementWithTransformHandleType.transformHandleType\n      ) {\n        setCursor(\n          this.canvas,\n          getCursorForResizingElement(elementWithTransformHandleType),\n        );\n        return;\n      }\n    } else if (selectedElements.length > 1 && !isOverScrollBar) {\n      const transformHandleType = getTransformHandleTypeFromCoords(\n        getCommonBounds(selectedElements),\n        scenePointerX,\n        scenePointerY,\n        this.state.zoom,\n        event.pointerType,\n      );\n      if (transformHandleType) {\n        setCursor(\n          this.canvas,\n          getCursorForResizingElement({\n            transformHandleType,\n          }),\n        );\n        return;\n      }\n    }\n\n    const hitElement = this.getElementAtPosition(\n      scenePointer.x,\n      scenePointer.y,\n    );\n    this.hitLinkElement = this.getElementLinkAtPosition(\n      scenePointer,\n      hitElement,\n    );\n    if (isEraserActive(this.state)) {\n      return;\n    }\n    if (\n      this.hitLinkElement &&\n      !this.state.selectedElementIds[this.hitLinkElement.id]\n    ) {\n      setCursor(this.canvas, CURSOR_TYPE.POINTER);\n      showHyperlinkTooltip(this.hitLinkElement, this.state);\n    } else {\n      hideHyperlinkToolip();\n      if (\n        hitElement &&\n        hitElement.link &&\n        this.state.selectedElementIds[hitElement.id] &&\n        !this.state.contextMenu &&\n        !this.state.showHyperlinkPopup\n      ) {\n        this.setState({ showHyperlinkPopup: \"info\" });\n      } else if (this.state.activeTool.type === \"text\") {\n        setCursor(\n          this.canvas,\n          isTextElement(hitElement) ? CURSOR_TYPE.TEXT : CURSOR_TYPE.CROSSHAIR,\n        );\n      } else if (this.state.viewModeEnabled) {\n        setCursor(this.canvas, CURSOR_TYPE.GRAB);\n      } else if (isOverScrollBar) {\n        setCursor(this.canvas, CURSOR_TYPE.AUTO);\n      } else if (this.state.selectedLinearElement) {\n        this.handleHoverSelectedLinearElement(\n          this.state.selectedLinearElement,\n          scenePointerX,\n          scenePointerY,\n        );\n      } else if (\n        // if using cmd/ctrl, we're not dragging\n        !event[KEYS.CTRL_OR_CMD]\n      ) {\n        if (\n          (hitElement ||\n            this.isHittingCommonBoundingBoxOfSelectedElements(\n              scenePointer,\n              selectedElements,\n            )) &&\n          !hitElement?.locked\n        ) {\n          setCursor(this.canvas, CURSOR_TYPE.MOVE);\n        }\n      } else {\n        setCursor(this.canvas, CURSOR_TYPE.AUTO);\n      }\n    }\n  };\n\n  private handleEraser = (\n    event: PointerEvent,\n    pointerDownState: PointerDownState,\n    scenePointer: { x: number; y: number },\n  ) => {\n    const updateElementIds = (elements: ExcalidrawElement[]) => {\n      elements.forEach((element) => {\n        if (element.locked) {\n          return;\n        }\n\n        idsToUpdate.push(element.id);\n        if (event.altKey) {\n          if (\n            pointerDownState.elementIdsToErase[element.id] &&\n            pointerDownState.elementIdsToErase[element.id].erase\n          ) {\n            pointerDownState.elementIdsToErase[element.id].erase = false;\n          }\n        } else if (!pointerDownState.elementIdsToErase[element.id]) {\n          pointerDownState.elementIdsToErase[element.id] = {\n            erase: true,\n            opacity: element.opacity,\n          };\n        }\n      });\n    };\n\n    const idsToUpdate: Array<string> = [];\n\n    const distance = distance2d(\n      pointerDownState.lastCoords.x,\n      pointerDownState.lastCoords.y,\n      scenePointer.x,\n      scenePointer.y,\n    );\n    const threshold = 10 / this.state.zoom.value;\n    const point = { ...pointerDownState.lastCoords };\n    let samplingInterval = 0;\n    while (samplingInterval <= distance) {\n      const hitElements = this.getElementsAtPosition(point.x, point.y);\n      updateElementIds(hitElements);\n\n      // Exit since we reached current point\n      if (samplingInterval === distance) {\n        break;\n      }\n\n      // Calculate next point in the line at a distance of sampling interval\n      samplingInterval = Math.min(samplingInterval + threshold, distance);\n\n      const distanceRatio = samplingInterval / distance;\n      const nextX =\n        (1 - distanceRatio) * point.x + distanceRatio * scenePointer.x;\n      const nextY =\n        (1 - distanceRatio) * point.y + distanceRatio * scenePointer.y;\n      point.x = nextX;\n      point.y = nextY;\n    }\n\n    const elements = this.scene.getElementsIncludingDeleted().map((ele) => {\n      const id =\n        isBoundToContainer(ele) && idsToUpdate.includes(ele.containerId)\n          ? ele.containerId\n          : ele.id;\n      if (idsToUpdate.includes(id)) {\n        if (event.altKey) {\n          if (\n            pointerDownState.elementIdsToErase[id] &&\n            pointerDownState.elementIdsToErase[id].erase === false\n          ) {\n            return newElementWith(ele, {\n              opacity: pointerDownState.elementIdsToErase[id].opacity,\n            });\n          }\n        } else {\n          return newElementWith(ele, {\n            opacity: ELEMENT_READY_TO_ERASE_OPACITY,\n          });\n        }\n      }\n      return ele;\n    });\n\n    this.scene.replaceAllElements(elements);\n\n    pointerDownState.lastCoords.x = scenePointer.x;\n    pointerDownState.lastCoords.y = scenePointer.y;\n  };\n  // set touch moving for mobile context menu\n  private handleTouchMove = (event: React.TouchEvent<HTMLCanvasElement>) => {\n    invalidateContextMenu = true;\n  };\n\n  handleHoverSelectedLinearElement(\n    linearElementEditor: LinearElementEditor,\n    scenePointerX: number,\n    scenePointerY: number,\n  ) {\n    const element = LinearElementEditor.getElement(\n      linearElementEditor.elementId,\n    );\n\n    const boundTextElement = getBoundTextElement(element);\n\n    if (!element) {\n      return;\n    }\n    if (this.state.selectedLinearElement) {\n      let hoverPointIndex = -1;\n      let segmentMidPointHoveredCoords = null;\n      if (\n        isHittingElementNotConsideringBoundingBox(\n          element,\n          this.state,\n          this.frameNameBoundsCache,\n          [scenePointerX, scenePointerY],\n        )\n      ) {\n        hoverPointIndex = LinearElementEditor.getPointIndexUnderCursor(\n          element,\n          this.state.zoom,\n          scenePointerX,\n          scenePointerY,\n        );\n        segmentMidPointHoveredCoords =\n          LinearElementEditor.getSegmentMidpointHitCoords(\n            linearElementEditor,\n            { x: scenePointerX, y: scenePointerY },\n            this.state,\n          );\n\n        if (hoverPointIndex >= 0 || segmentMidPointHoveredCoords) {\n          setCursor(this.canvas, CURSOR_TYPE.POINTER);\n        } else {\n          setCursor(this.canvas, CURSOR_TYPE.MOVE);\n        }\n      } else if (\n        shouldShowBoundingBox([element], this.state) &&\n        isHittingElementBoundingBoxWithoutHittingElement(\n          element,\n          this.state,\n          this.frameNameBoundsCache,\n          scenePointerX,\n          scenePointerY,\n        )\n      ) {\n        setCursor(this.canvas, CURSOR_TYPE.MOVE);\n      } else if (\n        boundTextElement &&\n        hitTest(\n          boundTextElement,\n          this.state,\n          this.frameNameBoundsCache,\n          scenePointerX,\n          scenePointerY,\n        )\n      ) {\n        setCursor(this.canvas, CURSOR_TYPE.MOVE);\n      }\n\n      if (\n        this.state.selectedLinearElement.hoverPointIndex !== hoverPointIndex\n      ) {\n        this.setState({\n          selectedLinearElement: {\n            ...this.state.selectedLinearElement,\n            hoverPointIndex,\n          },\n        });\n      }\n\n      if (\n        !LinearElementEditor.arePointsEqual(\n          this.state.selectedLinearElement.segmentMidPointHoveredCoords,\n          segmentMidPointHoveredCoords,\n        )\n      ) {\n        this.setState({\n          selectedLinearElement: {\n            ...this.state.selectedLinearElement,\n            segmentMidPointHoveredCoords,\n          },\n        });\n      }\n    } else {\n      setCursor(this.canvas, CURSOR_TYPE.AUTO);\n    }\n  }\n  private handleCanvasPointerDown = (\n    event: React.PointerEvent<HTMLElement>,\n  ) => {\n    // since contextMenu options are potentially evaluated on each render,\n    // and an contextMenu action may depend on selection state, we must\n    // close the contextMenu before we update the selection on pointerDown\n    // (e.g. resetting selection)\n    if (this.state.contextMenu) {\n      this.setState({ contextMenu: null });\n    }\n\n    this.updateGestureOnPointerDown(event);\n\n    // if dragging element is freedraw and another pointerdown event occurs\n    // a second finger is on the screen\n    // discard the freedraw element if it is very short because it is likely\n    // just a spike, otherwise finalize the freedraw element when the second\n    // finger is lifted\n    if (\n      event.pointerType === \"touch\" &&\n      this.state.draggingElement &&\n      this.state.draggingElement.type === \"freedraw\"\n    ) {\n      const element = this.state.draggingElement as ExcalidrawFreeDrawElement;\n      this.updateScene({\n        ...(element.points.length < 10\n          ? {\n              elements: this.scene\n                .getElementsIncludingDeleted()\n                .filter((el) => el.id !== element.id),\n            }\n          : {}),\n        appState: {\n          draggingElement: null,\n          editingElement: null,\n          startBoundElement: null,\n          suggestedBindings: [],\n          selectedElementIds: makeNextSelectedElementIds(\n            Object.keys(this.state.selectedElementIds)\n              .filter((key) => key !== element.id)\n              .reduce((obj: { [id: string]: true }, key) => {\n                obj[key] = this.state.selectedElementIds[key];\n                return obj;\n              }, {}),\n            this.state,\n          ),\n        },\n      });\n      return;\n    }\n\n    // remove any active selection when we start to interact with canvas\n    // (mainly, we care about removing selection outside the component which\n    //  would prevent our copy handling otherwise)\n    const selection = document.getSelection();\n    if (selection?.anchorNode) {\n      selection.removeAllRanges();\n    }\n    this.maybeOpenContextMenuAfterPointerDownOnTouchDevices(event);\n    this.maybeCleanupAfterMissingPointerUp(event);\n\n    //fires only once, if pen is detected, penMode is enabled\n    //the user can disable this by toggling the penMode button\n    if (!this.state.penDetected && event.pointerType === \"pen\") {\n      this.setState((prevState) => {\n        return {\n          penMode: true,\n          penDetected: true,\n        };\n      });\n    }\n\n    if (\n      !this.device.isTouchScreen &&\n      [\"pen\", \"touch\"].includes(event.pointerType)\n    ) {\n      this.device = updateObject(this.device, { isTouchScreen: true });\n    }\n\n    if (isPanning) {\n      return;\n    }\n\n    this.lastPointerDown = event;\n    this.setState({\n      lastPointerDownWith: event.pointerType,\n      cursorButton: \"down\",\n    });\n    this.savePointer(event.clientX, event.clientY, \"down\");\n\n    if (this.handleCanvasPanUsingWheelOrSpaceDrag(event)) {\n      return;\n    }\n\n    // only handle left mouse button or touch\n    if (\n      event.button !== POINTER_BUTTON.MAIN &&\n      event.button !== POINTER_BUTTON.TOUCH\n    ) {\n      return;\n    }\n\n    // don't select while panning\n    if (gesture.pointers.size > 1) {\n      return;\n    }\n\n    // State for the duration of a pointer interaction, which starts with a\n    // pointerDown event, ends with a pointerUp event (or another pointerDown)\n    const pointerDownState = this.initialPointerDownState(event);\n\n    this.setState({\n      selectedElementsAreBeingDragged: false,\n    });\n\n    if (this.handleDraggingScrollBar(event, pointerDownState)) {\n      return;\n    }\n\n    this.clearSelectionIfNotUsingSelection();\n    this.updateBindingEnabledOnPointerMove(event);\n\n    if (this.handleSelectionOnPointerDown(event, pointerDownState)) {\n      return;\n    }\n\n    const allowOnPointerDown =\n      !this.state.penMode ||\n      event.pointerType !== \"touch\" ||\n      this.state.activeTool.type === \"selection\" ||\n      this.state.activeTool.type === \"text\" ||\n      this.state.activeTool.type === \"image\";\n\n    if (!allowOnPointerDown) {\n      return;\n    }\n\n    if (this.state.activeTool.type === \"text\") {\n      this.handleTextOnPointerDown(event, pointerDownState);\n      return;\n    } else if (\n      this.state.activeTool.type === \"arrow\" ||\n      this.state.activeTool.type === \"line\"\n    ) {\n      this.handleLinearElementOnPointerDown(\n        event,\n        this.state.activeTool.type,\n        pointerDownState,\n      );\n    } else if (this.state.activeTool.type === \"image\") {\n      // reset image preview on pointerdown\n      setCursor(this.canvas, CURSOR_TYPE.CROSSHAIR);\n\n      // retrieve the latest element as the state may be stale\n      const pendingImageElement =\n        this.state.pendingImageElementId &&\n        this.scene.getElement(this.state.pendingImageElementId);\n\n      if (!pendingImageElement) {\n        return;\n      }\n\n      this.setState({\n        draggingElement: pendingImageElement,\n        editingElement: pendingImageElement,\n        pendingImageElementId: null,\n        multiElement: null,\n      });\n\n      const { x, y } = viewportCoordsToSceneCoords(event, this.state);\n      mutateElement(pendingImageElement, {\n        x,\n        y,\n      });\n    } else if (this.state.activeTool.type === \"freedraw\") {\n      this.handleFreeDrawElementOnPointerDown(\n        event,\n        this.state.activeTool.type,\n        pointerDownState,\n      );\n    } else if (this.state.activeTool.type === \"custom\") {\n      setCursor(this.canvas, CURSOR_TYPE.AUTO);\n    } else if (this.state.activeTool.type === \"frame\") {\n      this.createFrameElementOnPointerDown(pointerDownState);\n    } else if (\n      this.state.activeTool.type !== \"eraser\" &&\n      this.state.activeTool.type !== \"hand\"\n    ) {\n      this.createGenericElementOnPointerDown(\n        this.state.activeTool.type,\n        pointerDownState,\n      );\n    }\n\n    this.props?.onPointerDown?.(this.state.activeTool, pointerDownState);\n\n    const onPointerMove =\n      this.onPointerMoveFromPointerDownHandler(pointerDownState);\n\n    const onPointerUp =\n      this.onPointerUpFromPointerDownHandler(pointerDownState);\n\n    const onKeyDown = this.onKeyDownFromPointerDownHandler(pointerDownState);\n    const onKeyUp = this.onKeyUpFromPointerDownHandler(pointerDownState);\n\n    lastPointerUp = onPointerUp;\n\n    if (!this.state.viewModeEnabled) {\n      window.addEventListener(EVENT.POINTER_MOVE, onPointerMove);\n      window.addEventListener(EVENT.POINTER_UP, onPointerUp);\n      window.addEventListener(EVENT.KEYDOWN, onKeyDown);\n      window.addEventListener(EVENT.KEYUP, onKeyUp);\n      pointerDownState.eventListeners.onMove = onPointerMove;\n      pointerDownState.eventListeners.onUp = onPointerUp;\n      pointerDownState.eventListeners.onKeyUp = onKeyUp;\n      pointerDownState.eventListeners.onKeyDown = onKeyDown;\n    }\n  };\n\n  private handleCanvasPointerUp = (\n    event: React.PointerEvent<HTMLCanvasElement>,\n  ) => {\n    this.lastPointerUp = event;\n\n    if (this.device.isTouchScreen) {\n      const scenePointer = viewportCoordsToSceneCoords(\n        { clientX: event.clientX, clientY: event.clientY },\n        this.state,\n      );\n      const hitElement = this.getElementAtPosition(\n        scenePointer.x,\n        scenePointer.y,\n      );\n      this.hitLinkElement = this.getElementLinkAtPosition(\n        scenePointer,\n        hitElement,\n      );\n    }\n    if (\n      this.hitLinkElement &&\n      !this.state.selectedElementIds[this.hitLinkElement.id]\n    ) {\n      this.redirectToLink(event, this.device.isTouchScreen);\n    }\n\n    this.removePointer(event);\n  };\n\n  private maybeOpenContextMenuAfterPointerDownOnTouchDevices = (\n    event: React.PointerEvent<HTMLElement>,\n  ): void => {\n    // deal with opening context menu on touch devices\n    if (event.pointerType === \"touch\") {\n      invalidateContextMenu = false;\n\n      if (touchTimeout) {\n        // If there's already a touchTimeout, this means that there's another\n        // touch down and we are doing another touch, so we shouldn't open the\n        // context menu.\n        invalidateContextMenu = true;\n      } else {\n        // open the context menu with the first touch's clientX and clientY\n        // if the touch is not moving\n        touchTimeout = window.setTimeout(() => {\n          touchTimeout = 0;\n          if (!invalidateContextMenu) {\n            this.handleCanvasContextMenu(event);\n          }\n        }, TOUCH_CTX_MENU_TIMEOUT);\n      }\n    }\n  };\n\n  private resetContextMenuTimer = () => {\n    clearTimeout(touchTimeout);\n    touchTimeout = 0;\n    invalidateContextMenu = false;\n  };\n\n  private maybeCleanupAfterMissingPointerUp(\n    event: React.PointerEvent<HTMLElement>,\n  ): void {\n    if (lastPointerUp !== null) {\n      // Unfortunately, sometimes we don't get a pointerup after a pointerdown,\n      // this can happen when a contextual menu or alert is triggered. In order to avoid\n      // being in a weird state, we clean up on the next pointerdown\n      lastPointerUp(event);\n    }\n  }\n\n  // Returns whether the event is a panning\n  private handleCanvasPanUsingWheelOrSpaceDrag = (\n    event: React.PointerEvent<HTMLElement>,\n  ): boolean => {\n    if (\n      !(\n        gesture.pointers.size <= 1 &&\n        (event.button === POINTER_BUTTON.WHEEL ||\n          (event.button === POINTER_BUTTON.MAIN && isHoldingSpace) ||\n          isHandToolActive(this.state) ||\n          this.state.viewModeEnabled)\n      ) ||\n      isTextElement(this.state.editingElement)\n    ) {\n      return false;\n    }\n    isPanning = true;\n    event.preventDefault();\n\n    let nextPastePrevented = false;\n    const isLinux = /Linux/.test(window.navigator.platform);\n\n    setCursor(this.canvas, CURSOR_TYPE.GRABBING);\n    let { clientX: lastX, clientY: lastY } = event;\n    const onPointerMove = withBatchedUpdatesThrottled((event: PointerEvent) => {\n      const deltaX = lastX - event.clientX;\n      const deltaY = lastY - event.clientY;\n      lastX = event.clientX;\n      lastY = event.clientY;\n\n      /*\n       * Prevent paste event if we move while middle clicking on Linux.\n       * See issue #1383.\n       */\n      if (\n        isLinux &&\n        !nextPastePrevented &&\n        (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1)\n      ) {\n        nextPastePrevented = true;\n\n        /* Prevent the next paste event */\n        const preventNextPaste = (event: ClipboardEvent) => {\n          document.body.removeEventListener(EVENT.PASTE, preventNextPaste);\n          event.stopPropagation();\n        };\n\n        /*\n         * Reenable next paste in case of disabled middle click paste for\n         * any reason:\n         * - right click paste\n         * - empty clipboard\n         */\n        const enableNextPaste = () => {\n          setTimeout(() => {\n            document.body.removeEventListener(EVENT.PASTE, preventNextPaste);\n            window.removeEventListener(EVENT.POINTER_UP, enableNextPaste);\n          }, 100);\n        };\n\n        document.body.addEventListener(EVENT.PASTE, preventNextPaste);\n        window.addEventListener(EVENT.POINTER_UP, enableNextPaste);\n      }\n\n      this.translateCanvas({\n        scrollX: this.state.scrollX - deltaX / this.state.zoom.value,\n        scrollY: this.state.scrollY - deltaY / this.state.zoom.value,\n      });\n    });\n    const teardown = withBatchedUpdates(\n      (lastPointerUp = () => {\n        lastPointerUp = null;\n        isPanning = false;\n        if (!isHoldingSpace) {\n          if (this.state.viewModeEnabled) {\n            setCursor(this.canvas, CURSOR_TYPE.GRAB);\n          } else {\n            setCursorForShape(this.canvas, this.state);\n          }\n        }\n        this.setState({\n          cursorButton: \"up\",\n        });\n        this.savePointer(event.clientX, event.clientY, \"up\");\n        window.removeEventListener(EVENT.POINTER_MOVE, onPointerMove);\n        window.removeEventListener(EVENT.POINTER_UP, teardown);\n        window.removeEventListener(EVENT.BLUR, teardown);\n        onPointerMove.flush();\n      }),\n    );\n    window.addEventListener(EVENT.BLUR, teardown);\n    window.addEventListener(EVENT.POINTER_MOVE, onPointerMove, {\n      passive: true,\n    });\n    window.addEventListener(EVENT.POINTER_UP, teardown);\n    return true;\n  };\n\n  private updateGestureOnPointerDown(\n    event: React.PointerEvent<HTMLElement>,\n  ): void {\n    gesture.pointers.set(event.pointerId, {\n      x: event.clientX,\n      y: event.clientY,\n    });\n\n    if (gesture.pointers.size === 2) {\n      gesture.lastCenter = getCenter(gesture.pointers);\n      gesture.initialScale = this.state.zoom.value;\n      gesture.initialDistance = getDistance(\n        Array.from(gesture.pointers.values()),\n      );\n    }\n  }\n\n  private initialPointerDownState(\n    event: React.PointerEvent<HTMLElement>,\n  ): PointerDownState {\n    const origin = viewportCoordsToSceneCoords(event, this.state);\n    const selectedElements = this.scene.getSelectedElements(this.state);\n    const [minX, minY, maxX, maxY] = getCommonBounds(selectedElements);\n\n    return {\n      origin,\n      withCmdOrCtrl: event[KEYS.CTRL_OR_CMD],\n      originInGrid: tupleToCoors(\n        getGridPoint(origin.x, origin.y, this.state.gridSize),\n      ),\n      scrollbars: isOverScrollBars(\n        currentScrollBars,\n        event.clientX - this.state.offsetLeft,\n        event.clientY - this.state.offsetTop,\n      ),\n      // we need to duplicate because we'll be updating this state\n      lastCoords: { ...origin },\n      originalElements: this.scene\n        .getNonDeletedElements()\n        .reduce((acc, element) => {\n          acc.set(element.id, deepCopyElement(element));\n          return acc;\n        }, new Map() as PointerDownState[\"originalElements\"]),\n      resize: {\n        handleType: false,\n        isResizing: false,\n        offset: { x: 0, y: 0 },\n        arrowDirection: \"origin\",\n        center: { x: (maxX + minX) / 2, y: (maxY + minY) / 2 },\n      },\n      hit: {\n        element: null,\n        allHitElements: [],\n        wasAddedToSelection: false,\n        hasBeenDuplicated: false,\n        hasHitCommonBoundingBoxOfSelectedElements:\n          this.isHittingCommonBoundingBoxOfSelectedElements(\n            origin,\n            selectedElements,\n          ),\n      },\n      drag: {\n        hasOccurred: false,\n        offset: null,\n      },\n      eventListeners: {\n        onMove: null,\n        onUp: null,\n        onKeyUp: null,\n        onKeyDown: null,\n      },\n      boxSelection: {\n        hasOccurred: false,\n      },\n      elementIdsToErase: {},\n    };\n  }\n\n  // Returns whether the event is a dragging a scrollbar\n  private handleDraggingScrollBar(\n    event: React.PointerEvent<HTMLElement>,\n    pointerDownState: PointerDownState,\n  ): boolean {\n    if (\n      !(pointerDownState.scrollbars.isOverEither && !this.state.multiElement)\n    ) {\n      return false;\n    }\n    isDraggingScrollBar = true;\n    pointerDownState.lastCoords.x = event.clientX;\n    pointerDownState.lastCoords.y = event.clientY;\n    const onPointerMove = withBatchedUpdatesThrottled((event: PointerEvent) => {\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) {\n        return;\n      }\n\n      this.handlePointerMoveOverScrollbars(event, pointerDownState);\n    });\n\n    const onPointerUp = withBatchedUpdates(() => {\n      isDraggingScrollBar = false;\n      setCursorForShape(this.canvas, this.state);\n      lastPointerUp = null;\n      this.setState({\n        cursorButton: \"up\",\n      });\n      this.savePointer(event.clientX, event.clientY, \"up\");\n      window.removeEventListener(EVENT.POINTER_MOVE, onPointerMove);\n      window.removeEventListener(EVENT.POINTER_UP, onPointerUp);\n      onPointerMove.flush();\n    });\n\n    lastPointerUp = onPointerUp;\n\n    window.addEventListener(EVENT.POINTER_MOVE, onPointerMove);\n    window.addEventListener(EVENT.POINTER_UP, onPointerUp);\n    return true;\n  }\n\n  private clearSelectionIfNotUsingSelection = (): void => {\n    if (this.state.activeTool.type !== \"selection\") {\n      this.setState({\n        selectedElementIds: makeNextSelectedElementIds({}, this.state),\n        selectedGroupIds: {},\n        editingGroupId: null,\n      });\n    }\n  };\n\n  /**\n   * @returns whether the pointer event has been completely handled\n   */\n  private handleSelectionOnPointerDown = (\n    event: React.PointerEvent<HTMLElement>,\n    pointerDownState: PointerDownState,\n  ): boolean => {\n    if (this.state.activeTool.type === \"selection\") {\n      const elements = this.scene.getNonDeletedElements();\n      const selectedElements = this.scene.getSelectedElements(this.state);\n      if (selectedElements.length === 1 && !this.state.editingLinearElement) {\n        const elementWithTransformHandleType =\n          getElementWithTransformHandleType(\n            elements,\n            this.state,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n            this.state.zoom,\n            event.pointerType,\n          );\n        if (elementWithTransformHandleType != null) {\n          this.setState({\n            resizingElement: elementWithTransformHandleType.element,\n          });\n          pointerDownState.resize.handleType =\n            elementWithTransformHandleType.transformHandleType;\n        }\n      } else if (selectedElements.length > 1) {\n        pointerDownState.resize.handleType = getTransformHandleTypeFromCoords(\n          getCommonBounds(selectedElements),\n          pointerDownState.origin.x,\n          pointerDownState.origin.y,\n          this.state.zoom,\n          event.pointerType,\n        );\n      }\n      if (pointerDownState.resize.handleType) {\n        pointerDownState.resize.isResizing = true;\n        pointerDownState.resize.offset = tupleToCoors(\n          getResizeOffsetXY(\n            pointerDownState.resize.handleType,\n            selectedElements,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ),\n        );\n        if (\n          selectedElements.length === 1 &&\n          isLinearElement(selectedElements[0]) &&\n          selectedElements[0].points.length === 2\n        ) {\n          pointerDownState.resize.arrowDirection = getResizeArrowDirection(\n            pointerDownState.resize.handleType,\n            selectedElements[0],\n          );\n        }\n      } else {\n        if (this.state.selectedLinearElement) {\n          const linearElementEditor =\n            this.state.editingLinearElement || this.state.selectedLinearElement;\n          const ret = LinearElementEditor.handlePointerDown(\n            event,\n            this.state,\n            this.history,\n            pointerDownState.origin,\n            linearElementEditor,\n          );\n          if (ret.hitElement) {\n            pointerDownState.hit.element = ret.hitElement;\n          }\n          if (ret.linearElementEditor) {\n            this.setState({ selectedLinearElement: ret.linearElementEditor });\n\n            if (this.state.editingLinearElement) {\n              this.setState({ editingLinearElement: ret.linearElementEditor });\n            }\n          }\n          if (ret.didAddPoint) {\n            return true;\n          }\n        }\n        // hitElement may already be set above, so check first\n        pointerDownState.hit.element =\n          pointerDownState.hit.element ??\n          this.getElementAtPosition(\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          );\n\n        if (pointerDownState.hit.element) {\n          // Early return if pointer is hitting link icon\n          const hitLinkElement = this.getElementLinkAtPosition(\n            {\n              x: pointerDownState.origin.x,\n              y: pointerDownState.origin.y,\n            },\n            pointerDownState.hit.element,\n          );\n          if (hitLinkElement) {\n            return false;\n          }\n        }\n\n        // For overlapped elements one position may hit\n        // multiple elements\n        pointerDownState.hit.allHitElements = this.getElementsAtPosition(\n          pointerDownState.origin.x,\n          pointerDownState.origin.y,\n        );\n\n        const hitElement = pointerDownState.hit.element;\n        const someHitElementIsSelected =\n          pointerDownState.hit.allHitElements.some((element) =>\n            this.isASelectedElement(element),\n          );\n        if (\n          (hitElement === null || !someHitElementIsSelected) &&\n          !event.shiftKey &&\n          !pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements\n        ) {\n          this.clearSelection(hitElement);\n        }\n\n        if (this.state.editingLinearElement) {\n          this.setState({\n            selectedElementIds: makeNextSelectedElementIds(\n              {\n                [this.state.editingLinearElement.elementId]: true,\n              },\n              this.state,\n            ),\n          });\n          // If we click on something\n        } else if (hitElement != null) {\n          // on CMD/CTRL, drill down to hit element regardless of groups etc.\n          if (event[KEYS.CTRL_OR_CMD]) {\n            if (!this.state.selectedElementIds[hitElement.id]) {\n              pointerDownState.hit.wasAddedToSelection = true;\n            }\n            this.setState((prevState) => ({\n              ...editGroupForSelectedElement(prevState, hitElement),\n              previousSelectedElementIds: this.state.selectedElementIds,\n            }));\n            // mark as not completely handled so as to allow dragging etc.\n            return false;\n          }\n\n          // deselect if item is selected\n          // if shift is not clicked, this will always return true\n          // otherwise, it will trigger selection based on current\n          // state of the box\n          if (!this.state.selectedElementIds[hitElement.id]) {\n            // if we are currently editing a group, exiting editing mode and deselect the group.\n            if (\n              this.state.editingGroupId &&\n              !isElementInGroup(hitElement, this.state.editingGroupId)\n            ) {\n              this.setState({\n                selectedElementIds: makeNextSelectedElementIds({}, this.state),\n                selectedGroupIds: {},\n                editingGroupId: null,\n              });\n            }\n\n            // Add hit element to selection. At this point if we're not holding\n            // SHIFT the previously selected element(s) were deselected above\n            // (make sure you use setState updater to use latest state)\n            // With shift-selection, we want to make sure that frames and their containing\n            // elements are not selected at the same time.\n            if (\n              !someHitElementIsSelected &&\n              !pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements\n            ) {\n              this.setState((prevState) => {\n                const nextSelectedElementIds: { [id: string]: true } = {\n                  ...prevState.selectedElementIds,\n                  [hitElement.id]: true,\n                };\n\n                const previouslySelectedElements: ExcalidrawElement[] = [];\n\n                Object.keys(prevState.selectedElementIds).forEach((id) => {\n                  const element = this.scene.getElement(id);\n                  element && previouslySelectedElements.push(element);\n                });\n\n                // if hitElement is frame, deselect all of its elements if they are selected\n                if (hitElement.type === \"frame\") {\n                  getFrameElements(\n                    previouslySelectedElements,\n                    hitElement.id,\n                  ).forEach((element) => {\n                    delete nextSelectedElementIds[element.id];\n                  });\n                } else if (hitElement.frameId) {\n                  // if hitElement is in a frame and its frame has been selected\n                  // disable selection for the given element\n                  if (nextSelectedElementIds[hitElement.frameId]) {\n                    delete nextSelectedElementIds[hitElement.id];\n                  }\n                } else {\n                  // hitElement is neither a frame nor an element in a frame\n                  // but since hitElement could be in a group with some frames\n                  // this means selecting hitElement will have the frames selected as well\n                  // because we want to keep the invariant:\n                  // - frames and their elements are not selected at the same time\n                  // we deselect elements in those frames that were previously selected\n\n                  const groupIds = hitElement.groupIds;\n                  const framesInGroups = new Set(\n                    groupIds\n                      .flatMap((gid) =>\n                        getElementsInGroup(\n                          this.scene.getNonDeletedElements(),\n                          gid,\n                        ),\n                      )\n                      .filter((element) => element.type === \"frame\")\n                      .map((frame) => frame.id),\n                  );\n\n                  if (framesInGroups.size > 0) {\n                    previouslySelectedElements.forEach((element) => {\n                      if (\n                        element.frameId &&\n                        framesInGroups.has(element.frameId)\n                      ) {\n                        // deselect element and groups containing the element\n                        delete nextSelectedElementIds[element.id];\n                        element.groupIds\n                          .flatMap((gid) =>\n                            getElementsInGroup(\n                              this.scene.getNonDeletedElements(),\n                              gid,\n                            ),\n                          )\n                          .forEach((element) => {\n                            delete nextSelectedElementIds[element.id];\n                          });\n                      }\n                    });\n                  }\n                }\n\n                return selectGroupsForSelectedElements(\n                  {\n                    ...prevState,\n                    selectedElementIds: nextSelectedElementIds,\n                    showHyperlinkPopup: hitElement.link ? \"info\" : false,\n                  },\n                  this.scene.getNonDeletedElements(),\n                  prevState,\n                  this,\n                );\n              });\n              pointerDownState.hit.wasAddedToSelection = true;\n            }\n          }\n        }\n\n        this.setState({\n          previousSelectedElementIds: this.state.selectedElementIds,\n        });\n      }\n    }\n    return false;\n  };\n\n  private isASelectedElement(hitElement: ExcalidrawElement | null): boolean {\n    return hitElement != null && this.state.selectedElementIds[hitElement.id];\n  }\n\n  private isHittingCommonBoundingBoxOfSelectedElements(\n    point: Readonly<{ x: number; y: number }>,\n    selectedElements: readonly ExcalidrawElement[],\n  ): boolean {\n    if (selectedElements.length < 2) {\n      return false;\n    }\n\n    // How many pixels off the shape boundary we still consider a hit\n    const threshold = 10 / this.state.zoom.value;\n    const [x1, y1, x2, y2] = getCommonBounds(selectedElements);\n    return (\n      point.x > x1 - threshold &&\n      point.x < x2 + threshold &&\n      point.y > y1 - threshold &&\n      point.y < y2 + threshold\n    );\n  }\n\n  private handleTextOnPointerDown = (\n    event: React.PointerEvent<HTMLElement>,\n    pointerDownState: PointerDownState,\n  ): void => {\n    // if we're currently still editing text, clicking outside\n    // should only finalize it, not create another (irrespective\n    // of state.activeTool.locked)\n    if (isTextElement(this.state.editingElement)) {\n      return;\n    }\n    let sceneX = pointerDownState.origin.x;\n    let sceneY = pointerDownState.origin.y;\n\n    const element = this.getElementAtPosition(sceneX, sceneY, {\n      includeBoundTextElement: true,\n    });\n\n    let container = getTextBindableContainerAtPosition(\n      this.scene.getNonDeletedElements(),\n      this.state,\n      sceneX,\n      sceneY,\n    );\n\n    if (hasBoundTextElement(element)) {\n      container = element as ExcalidrawTextContainer;\n      sceneX = element.x + element.width / 2;\n      sceneY = element.y + element.height / 2;\n    }\n    this.startTextEditing({\n      sceneX,\n      sceneY,\n      insertAtParentCenter: !event.altKey,\n      container,\n    });\n\n    resetCursor(this.canvas);\n    if (!this.state.activeTool.locked) {\n      this.setState({\n        activeTool: updateActiveTool(this.state, { type: \"selection\" }),\n      });\n    }\n  };\n\n  private handleFreeDrawElementOnPointerDown = (\n    event: React.PointerEvent<HTMLElement>,\n    elementType: ExcalidrawFreeDrawElement[\"type\"],\n    pointerDownState: PointerDownState,\n  ) => {\n    // Begin a mark capture. This does not have to update state yet.\n    const [gridX, gridY] = getGridPoint(\n      pointerDownState.origin.x,\n      pointerDownState.origin.y,\n      null,\n    );\n\n    const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n      x: gridX,\n      y: gridY,\n    });\n\n    const element = newFreeDrawElement({\n      type: elementType,\n      x: gridX,\n      y: gridY,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roughness: this.state.currentItemRoughness,\n      opacity: this.state.currentItemOpacity,\n      roundness: null,\n      simulatePressure: event.pressure === 0.5,\n      locked: false,\n      frameId: topLayerFrame ? topLayerFrame.id : null,\n    });\n\n    this.setState((prevState) => {\n      const nextSelectedElementIds = {\n        ...prevState.selectedElementIds,\n      };\n      delete nextSelectedElementIds[element.id];\n      return {\n        selectedElementIds: makeNextSelectedElementIds(\n          nextSelectedElementIds,\n          prevState,\n        ),\n      };\n    });\n\n    const pressures = element.simulatePressure\n      ? element.pressures\n      : [...element.pressures, event.pressure];\n\n    mutateElement(element, {\n      points: [[0, 0]],\n      pressures,\n    });\n\n    const boundElement = getHoveredElementForBinding(\n      pointerDownState.origin,\n      this.scene,\n    );\n    this.scene.addNewElement(element);\n    this.setState({\n      draggingElement: element,\n      editingElement: element,\n      startBoundElement: boundElement,\n      suggestedBindings: [],\n    });\n  };\n\n  private createImageElement = ({\n    sceneX,\n    sceneY,\n  }: {\n    sceneX: number;\n    sceneY: number;\n  }) => {\n    const [gridX, gridY] = getGridPoint(sceneX, sceneY, this.state.gridSize);\n\n    const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n      x: gridX,\n      y: gridY,\n    });\n\n    const element = newImageElement({\n      type: \"image\",\n      x: gridX,\n      y: gridY,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roughness: this.state.currentItemRoughness,\n      roundness: null,\n      opacity: this.state.currentItemOpacity,\n      locked: false,\n      frameId: topLayerFrame ? topLayerFrame.id : null,\n    });\n\n    return element;\n  };\n\n  private handleLinearElementOnPointerDown = (\n    event: React.PointerEvent<HTMLElement>,\n    elementType: ExcalidrawLinearElement[\"type\"],\n    pointerDownState: PointerDownState,\n  ): void => {\n    if (this.state.multiElement) {\n      const { multiElement } = this.state;\n\n      // finalize if completing a loop\n      if (\n        multiElement.type === \"line\" &&\n        isPathALoop(multiElement.points, this.state.zoom.value)\n      ) {\n        mutateElement(multiElement, {\n          lastCommittedPoint:\n            multiElement.points[multiElement.points.length - 1],\n        });\n        this.actionManager.executeAction(actionFinalize);\n        return;\n      }\n\n      const { x: rx, y: ry, lastCommittedPoint } = multiElement;\n\n      // clicking inside commit zone  finalize arrow\n      if (\n        multiElement.points.length > 1 &&\n        lastCommittedPoint &&\n        distance2d(\n          pointerDownState.origin.x - rx,\n          pointerDownState.origin.y - ry,\n          lastCommittedPoint[0],\n          lastCommittedPoint[1],\n        ) < LINE_CONFIRM_THRESHOLD\n      ) {\n        this.actionManager.executeAction(actionFinalize);\n        return;\n      }\n\n      this.setState((prevState) => ({\n        selectedElementIds: makeNextSelectedElementIds(\n          {\n            ...prevState.selectedElementIds,\n            [multiElement.id]: true,\n          },\n          prevState,\n        ),\n      }));\n      // clicking outside commit zone  update reference for last committed\n      // point\n      mutateElement(multiElement, {\n        lastCommittedPoint: multiElement.points[multiElement.points.length - 1],\n      });\n      setCursor(this.canvas, CURSOR_TYPE.POINTER);\n    } else {\n      const [gridX, gridY] = getGridPoint(\n        pointerDownState.origin.x,\n        pointerDownState.origin.y,\n        this.state.gridSize,\n      );\n\n      const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n        x: gridX,\n        y: gridY,\n      });\n\n      /* If arrow is pre-arrowheads, it will have undefined for both start and end arrowheads.\n      If so, we want it to be null for start and \"arrow\" for end. If the linear item is not\n      an arrow, we want it to be null for both. Otherwise, we want it to use the\n      values from appState. */\n\n      const { currentItemStartArrowhead, currentItemEndArrowhead } = this.state;\n      const [startArrowhead, endArrowhead] =\n        elementType === \"arrow\"\n          ? [currentItemStartArrowhead, currentItemEndArrowhead]\n          : [null, null];\n\n      const element = newLinearElement({\n        type: elementType,\n        x: gridX,\n        y: gridY,\n        strokeColor: this.state.currentItemStrokeColor,\n        backgroundColor: this.state.currentItemBackgroundColor,\n        fillStyle: this.state.currentItemFillStyle,\n        strokeWidth: this.state.currentItemStrokeWidth,\n        strokeStyle: this.state.currentItemStrokeStyle,\n        roughness: this.state.currentItemRoughness,\n        opacity: this.state.currentItemOpacity,\n        roundness:\n          this.state.currentItemRoundness === \"round\"\n            ? { type: ROUNDNESS.PROPORTIONAL_RADIUS }\n            : null,\n        startArrowhead,\n        endArrowhead,\n        locked: false,\n        frameId: topLayerFrame ? topLayerFrame.id : null,\n      });\n      this.setState((prevState) => {\n        const nextSelectedElementIds = {\n          ...prevState.selectedElementIds,\n        };\n        delete nextSelectedElementIds[element.id];\n        return {\n          selectedElementIds: makeNextSelectedElementIds(\n            nextSelectedElementIds,\n            prevState,\n          ),\n        };\n      });\n      mutateElement(element, {\n        points: [...element.points, [0, 0]],\n      });\n      const boundElement = getHoveredElementForBinding(\n        pointerDownState.origin,\n        this.scene,\n      );\n\n      this.scene.addNewElement(element);\n      this.setState({\n        draggingElement: element,\n        editingElement: element,\n        startBoundElement: boundElement,\n        suggestedBindings: [],\n      });\n    }\n  };\n\n  private createGenericElementOnPointerDown = (\n    elementType: ExcalidrawGenericElement[\"type\"],\n    pointerDownState: PointerDownState,\n  ): void => {\n    const [gridX, gridY] = getGridPoint(\n      pointerDownState.origin.x,\n      pointerDownState.origin.y,\n      this.state.gridSize,\n    );\n\n    const topLayerFrame = this.getTopLayerFrameAtSceneCoords({\n      x: gridX,\n      y: gridY,\n    });\n\n    const element = newElement({\n      type: elementType,\n      x: gridX,\n      y: gridY,\n      strokeColor: this.state.currentItemStrokeColor,\n      backgroundColor: this.state.currentItemBackgroundColor,\n      fillStyle: this.state.currentItemFillStyle,\n      strokeWidth: this.state.currentItemStrokeWidth,\n      strokeStyle: this.state.currentItemStrokeStyle,\n      roughness: this.state.currentItemRoughness,\n      opacity: this.state.currentItemOpacity,\n      roundness:\n        this.state.currentItemRoundness === \"round\"\n          ? {\n              type: isUsingAdaptiveRadius(elementType)\n                ? ROUNDNESS.ADAPTIVE_RADIUS\n                : ROUNDNESS.PROPORTIONAL_RADIUS,\n            }\n          : null,\n      locked: false,\n      frameId: topLayerFrame ? topLayerFrame.id : null,\n    });\n\n    if (element.type === \"selection\") {\n      this.setState({\n        selectionElement: element,\n        draggingElement: element,\n      });\n    } else {\n      this.scene.addNewElement(element);\n      this.setState({\n        multiElement: null,\n        draggingElement: element,\n        editingElement: element,\n      });\n    }\n  };\n\n  private createFrameElementOnPointerDown = (\n    pointerDownState: PointerDownState,\n  ): void => {\n    const [gridX, gridY] = getGridPoint(\n      pointerDownState.origin.x,\n      pointerDownState.origin.y,\n      this.state.gridSize,\n    );\n\n    const frame = newFrameElement({\n      x: gridX,\n      y: gridY,\n      opacity: this.state.currentItemOpacity,\n      locked: false,\n      ...FRAME_STYLE,\n    });\n\n    this.scene.replaceAllElements([\n      ...this.scene.getElementsIncludingDeleted(),\n      frame,\n    ]);\n\n    this.setState({\n      multiElement: null,\n      draggingElement: frame,\n      editingElement: frame,\n    });\n  };\n\n  private onKeyDownFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ): (event: KeyboardEvent) => void {\n    return withBatchedUpdates((event: KeyboardEvent) => {\n      if (this.maybeHandleResize(pointerDownState, event)) {\n        return;\n      }\n      this.maybeDragNewGenericElement(pointerDownState, event);\n    });\n  }\n\n  private onKeyUpFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ): (event: KeyboardEvent) => void {\n    return withBatchedUpdates((event: KeyboardEvent) => {\n      // Prevents focus from escaping excalidraw tab\n      event.key === KEYS.ALT && event.preventDefault();\n      if (this.maybeHandleResize(pointerDownState, event)) {\n        return;\n      }\n      this.maybeDragNewGenericElement(pointerDownState, event);\n    });\n  }\n\n  private onPointerMoveFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ) {\n    return withBatchedUpdatesThrottled((event: PointerEvent) => {\n      // We need to initialize dragOffsetXY only after we've updated\n      // `state.selectedElementIds` on pointerDown. Doing it here in pointerMove\n      // event handler should hopefully ensure we're already working with\n      // the updated state.\n      if (pointerDownState.drag.offset === null) {\n        pointerDownState.drag.offset = tupleToCoors(\n          getDragOffsetXY(\n            this.scene.getSelectedElements(this.state),\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ),\n        );\n      }\n      const target = event.target;\n      if (!(target instanceof HTMLElement)) {\n        return;\n      }\n\n      if (this.handlePointerMoveOverScrollbars(event, pointerDownState)) {\n        return;\n      }\n\n      const pointerCoords = viewportCoordsToSceneCoords(event, this.state);\n\n      if (isEraserActive(this.state)) {\n        this.handleEraser(event, pointerDownState, pointerCoords);\n        return;\n      }\n\n      const [gridX, gridY] = getGridPoint(\n        pointerCoords.x,\n        pointerCoords.y,\n        this.state.gridSize,\n      );\n\n      // for arrows/lines, don't start dragging until a given threshold\n      // to ensure we don't create a 2-point arrow by mistake when\n      // user clicks mouse in a way that it moves a tiny bit (thus\n      // triggering pointermove)\n      if (\n        !pointerDownState.drag.hasOccurred &&\n        (this.state.activeTool.type === \"arrow\" ||\n          this.state.activeTool.type === \"line\")\n      ) {\n        if (\n          distance2d(\n            pointerCoords.x,\n            pointerCoords.y,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          ) < DRAGGING_THRESHOLD\n        ) {\n          return;\n        }\n      }\n      if (pointerDownState.resize.isResizing) {\n        pointerDownState.lastCoords.x = pointerCoords.x;\n        pointerDownState.lastCoords.y = pointerCoords.y;\n        if (this.maybeHandleResize(pointerDownState, event)) {\n          return true;\n        }\n      }\n\n      if (this.state.selectedLinearElement) {\n        const linearElementEditor =\n          this.state.editingLinearElement || this.state.selectedLinearElement;\n\n        if (\n          LinearElementEditor.shouldAddMidpoint(\n            this.state.selectedLinearElement,\n            pointerCoords,\n            this.state,\n          )\n        ) {\n          const ret = LinearElementEditor.addMidpoint(\n            this.state.selectedLinearElement,\n            pointerCoords,\n            this.state,\n          );\n          if (!ret) {\n            return;\n          }\n\n          // Since we are reading from previous state which is not possible with\n          // automatic batching in React 18 hence using flush sync to synchronously\n          // update the state. Check https://github.com/excalidraw/excalidraw/pull/5508 for more details.\n\n          flushSync(() => {\n            if (this.state.selectedLinearElement) {\n              this.setState({\n                selectedLinearElement: {\n                  ...this.state.selectedLinearElement,\n                  pointerDownState: ret.pointerDownState,\n                  selectedPointsIndices: ret.selectedPointsIndices,\n                },\n              });\n            }\n            if (this.state.editingLinearElement) {\n              this.setState({\n                editingLinearElement: {\n                  ...this.state.editingLinearElement,\n                  pointerDownState: ret.pointerDownState,\n                  selectedPointsIndices: ret.selectedPointsIndices,\n                },\n              });\n            }\n          });\n\n          return;\n        } else if (\n          linearElementEditor.pointerDownState.segmentMidpoint.value !== null &&\n          !linearElementEditor.pointerDownState.segmentMidpoint.added\n        ) {\n          return;\n        }\n\n        const didDrag = LinearElementEditor.handlePointDragging(\n          event,\n          this.state,\n          pointerCoords.x,\n          pointerCoords.y,\n          (element, pointsSceneCoords) => {\n            this.maybeSuggestBindingsForLinearElementAtCoords(\n              element,\n              pointsSceneCoords,\n            );\n          },\n          linearElementEditor,\n        );\n        if (didDrag) {\n          pointerDownState.lastCoords.x = pointerCoords.x;\n          pointerDownState.lastCoords.y = pointerCoords.y;\n          pointerDownState.drag.hasOccurred = true;\n          if (\n            this.state.editingLinearElement &&\n            !this.state.editingLinearElement.isDragging\n          ) {\n            this.setState({\n              editingLinearElement: {\n                ...this.state.editingLinearElement,\n                isDragging: true,\n              },\n            });\n          }\n          if (!this.state.selectedLinearElement.isDragging) {\n            this.setState({\n              selectedLinearElement: {\n                ...this.state.selectedLinearElement,\n                isDragging: true,\n              },\n            });\n          }\n          return;\n        }\n      }\n\n      const hasHitASelectedElement = pointerDownState.hit.allHitElements.some(\n        (element) => this.isASelectedElement(element),\n      );\n\n      const isSelectingPointsInLineEditor =\n        this.state.editingLinearElement &&\n        event.shiftKey &&\n        this.state.editingLinearElement.elementId ===\n          pointerDownState.hit.element?.id;\n      if (\n        (hasHitASelectedElement ||\n          pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements) &&\n        !isSelectingPointsInLineEditor\n      ) {\n        const selectedElements = this.scene.getSelectedElements(this.state);\n\n        if (selectedElements.every((element) => element.locked)) {\n          return;\n        }\n\n        const selectedElementsHasAFrame = selectedElements.find((e) =>\n          isFrameElement(e),\n        );\n        const topLayerFrame = this.getTopLayerFrameAtSceneCoords(pointerCoords);\n        this.setState({\n          frameToHighlight:\n            topLayerFrame && !selectedElementsHasAFrame ? topLayerFrame : null,\n        });\n\n        // Marking that click was used for dragging to check\n        // if elements should be deselected on pointerup\n        pointerDownState.drag.hasOccurred = true;\n        this.setState({\n          selectedElementsAreBeingDragged: true,\n        });\n        // prevent dragging even if we're no longer holding cmd/ctrl otherwise\n        // it would have weird results (stuff jumping all over the screen)\n        // Checking for editingElement to avoid jump while editing on mobile #6503\n        if (\n          selectedElements.length > 0 &&\n          !pointerDownState.withCmdOrCtrl &&\n          !this.state.editingElement\n        ) {\n          const [dragX, dragY] = getGridPoint(\n            pointerCoords.x - pointerDownState.drag.offset.x,\n            pointerCoords.y - pointerDownState.drag.offset.y,\n            this.state.gridSize,\n          );\n\n          const [dragDistanceX, dragDistanceY] = [\n            Math.abs(pointerCoords.x - pointerDownState.origin.x),\n            Math.abs(pointerCoords.y - pointerDownState.origin.y),\n          ];\n\n          // We only drag in one direction if shift is pressed\n          const lockDirection = event.shiftKey;\n          // when we're editing the name of a frame, we want the user to be\n          // able to select and interact with the text input\n          !this.state.editingFrame &&\n            dragSelectedElements(\n              pointerDownState,\n              selectedElements,\n              dragX,\n              dragY,\n              lockDirection,\n              dragDistanceX,\n              dragDistanceY,\n              this.state,\n              this.scene,\n            );\n          this.maybeSuggestBindingForAll(selectedElements);\n\n          // We duplicate the selected element if alt is pressed on pointer move\n          if (event.altKey && !pointerDownState.hit.hasBeenDuplicated) {\n            // Move the currently selected elements to the top of the z index stack, and\n            // put the duplicates where the selected elements used to be.\n            // (the origin point where the dragging started)\n\n            pointerDownState.hit.hasBeenDuplicated = true;\n\n            const nextElements = [];\n            const elementsToAppend = [];\n            const groupIdMap = new Map();\n            const oldIdToDuplicatedId = new Map();\n            const hitElement = pointerDownState.hit.element;\n            const selectedElementIds = new Set(\n              this.scene\n                .getSelectedElements({\n                  selectedElementIds: this.state.selectedElementIds,\n                  includeBoundTextElement: true,\n                  includeElementsInFrames: true,\n                })\n                .map((element) => element.id),\n            );\n\n            const elements = this.scene.getNonDeletedElements();\n\n            for (const element of elements) {\n              if (\n                selectedElementIds.has(element.id) ||\n                // case: the state.selectedElementIds might not have been\n                // updated yet by the time this mousemove event is fired\n                (element.id === hitElement?.id &&\n                  pointerDownState.hit.wasAddedToSelection)\n              ) {\n                const duplicatedElement = duplicateElement(\n                  this.state.editingGroupId,\n                  groupIdMap,\n                  element,\n                );\n                const [originDragX, originDragY] = getGridPoint(\n                  pointerDownState.origin.x - pointerDownState.drag.offset.x,\n                  pointerDownState.origin.y - pointerDownState.drag.offset.y,\n                  this.state.gridSize,\n                );\n                mutateElement(duplicatedElement, {\n                  x: duplicatedElement.x + (originDragX - dragX),\n                  y: duplicatedElement.y + (originDragY - dragY),\n                });\n                nextElements.push(duplicatedElement);\n                elementsToAppend.push(element);\n                oldIdToDuplicatedId.set(element.id, duplicatedElement.id);\n              } else {\n                nextElements.push(element);\n              }\n            }\n            const nextSceneElements = [...nextElements, ...elementsToAppend];\n            bindTextToShapeAfterDuplication(\n              nextElements,\n              elementsToAppend,\n              oldIdToDuplicatedId,\n            );\n            fixBindingsAfterDuplication(\n              nextSceneElements,\n              elementsToAppend,\n              oldIdToDuplicatedId,\n              \"duplicatesServeAsOld\",\n            );\n            bindElementsToFramesAfterDuplication(\n              nextSceneElements,\n              elementsToAppend,\n              oldIdToDuplicatedId,\n            );\n            this.scene.replaceAllElements(nextSceneElements);\n          }\n          return;\n        }\n      }\n\n      // It is very important to read this.state within each move event,\n      // otherwise we would read a stale one!\n      const draggingElement = this.state.draggingElement;\n      if (!draggingElement) {\n        return;\n      }\n\n      if (draggingElement.type === \"freedraw\") {\n        const points = draggingElement.points;\n        const dx = pointerCoords.x - draggingElement.x;\n        const dy = pointerCoords.y - draggingElement.y;\n\n        const lastPoint = points.length > 0 && points[points.length - 1];\n        const discardPoint =\n          lastPoint && lastPoint[0] === dx && lastPoint[1] === dy;\n\n        if (!discardPoint) {\n          const pressures = draggingElement.simulatePressure\n            ? draggingElement.pressures\n            : [...draggingElement.pressures, event.pressure];\n\n          mutateElement(draggingElement, {\n            points: [...points, [dx, dy]],\n            pressures,\n          });\n        }\n      } else if (isLinearElement(draggingElement)) {\n        pointerDownState.drag.hasOccurred = true;\n        this.setState({\n          selectedElementsAreBeingDragged: true,\n        });\n        const points = draggingElement.points;\n        let dx = gridX - draggingElement.x;\n        let dy = gridY - draggingElement.y;\n\n        if (shouldRotateWithDiscreteAngle(event) && points.length === 2) {\n          ({ width: dx, height: dy } = getLockedLinearCursorAlignSize(\n            draggingElement.x,\n            draggingElement.y,\n            pointerCoords.x,\n            pointerCoords.y,\n          ));\n        }\n\n        if (points.length === 1) {\n          mutateElement(draggingElement, {\n            points: [...points, [dx, dy]],\n          });\n        } else if (points.length === 2) {\n          mutateElement(draggingElement, {\n            points: [...points.slice(0, -1), [dx, dy]],\n          });\n        }\n\n        if (isBindingElement(draggingElement, false)) {\n          // When creating a linear element by dragging\n          this.maybeSuggestBindingsForLinearElementAtCoords(\n            draggingElement,\n            [pointerCoords],\n            this.state.startBoundElement,\n          );\n        }\n      } else {\n        pointerDownState.lastCoords.x = pointerCoords.x;\n        pointerDownState.lastCoords.y = pointerCoords.y;\n        this.maybeDragNewGenericElement(pointerDownState, event);\n      }\n\n      if (this.state.activeTool.type === \"selection\") {\n        pointerDownState.boxSelection.hasOccurred = true;\n\n        const elements = this.scene.getNonDeletedElements();\n        if (\n          !event.shiftKey &&\n          // allows for box-selecting points (without shift)\n          !this.state.editingLinearElement &&\n          isSomeElementSelected(elements, this.state)\n        ) {\n          if (pointerDownState.withCmdOrCtrl && pointerDownState.hit.element) {\n            this.setState((prevState) =>\n              selectGroupsForSelectedElements(\n                {\n                  ...prevState,\n                  selectedElementIds: {\n                    [pointerDownState.hit.element!.id]: true,\n                  },\n                },\n                this.scene.getNonDeletedElements(),\n                prevState,\n                this,\n              ),\n            );\n          }\n        }\n        // box-select line editor points\n        if (this.state.editingLinearElement) {\n          LinearElementEditor.handleBoxSelection(\n            event,\n            this.state,\n            this.setState.bind(this),\n          );\n          // regular box-select\n        } else {\n          const elementsWithinSelection = getElementsWithinSelection(\n            elements,\n            draggingElement,\n          );\n          this.setState((prevState) => {\n            const nextSelectedElementIds = elementsWithinSelection.reduce(\n              (acc: Record<ExcalidrawElement[\"id\"], true>, element) => {\n                acc[element.id] = true;\n                return acc;\n              },\n              {},\n            );\n\n            if (pointerDownState.hit.element) {\n              // if using ctrl/cmd, select the hitElement only if we\n              // haven't box-selected anything else\n              if (!elementsWithinSelection.length) {\n                nextSelectedElementIds[pointerDownState.hit.element.id] = true;\n              } else {\n                delete nextSelectedElementIds[pointerDownState.hit.element.id];\n              }\n            }\n\n            return selectGroupsForSelectedElements(\n              {\n                ...prevState,\n                selectedElementIds: nextSelectedElementIds,\n                showHyperlinkPopup:\n                  elementsWithinSelection.length === 1 &&\n                  elementsWithinSelection[0].link\n                    ? \"info\"\n                    : false,\n                // select linear element only when we haven't box-selected anything else\n                selectedLinearElement:\n                  elementsWithinSelection.length === 1 &&\n                  isLinearElement(elementsWithinSelection[0])\n                    ? new LinearElementEditor(\n                        elementsWithinSelection[0],\n                        this.scene,\n                      )\n                    : null,\n              },\n              this.scene.getNonDeletedElements(),\n              prevState,\n              this,\n            );\n          });\n        }\n      }\n    });\n  }\n\n  // Returns whether the pointer move happened over either scrollbar\n  private handlePointerMoveOverScrollbars(\n    event: PointerEvent,\n    pointerDownState: PointerDownState,\n  ): boolean {\n    if (pointerDownState.scrollbars.isOverHorizontal) {\n      const x = event.clientX;\n      const dx = x - pointerDownState.lastCoords.x;\n      this.translateCanvas({\n        scrollX: this.state.scrollX - dx / this.state.zoom.value,\n      });\n      pointerDownState.lastCoords.x = x;\n      return true;\n    }\n\n    if (pointerDownState.scrollbars.isOverVertical) {\n      const y = event.clientY;\n      const dy = y - pointerDownState.lastCoords.y;\n      this.translateCanvas({\n        scrollY: this.state.scrollY - dy / this.state.zoom.value,\n      });\n      pointerDownState.lastCoords.y = y;\n      return true;\n    }\n    return false;\n  }\n\n  private onPointerUpFromPointerDownHandler(\n    pointerDownState: PointerDownState,\n  ): (event: PointerEvent) => void {\n    return withBatchedUpdates((childEvent: PointerEvent) => {\n      if (pointerDownState.eventListeners.onMove) {\n        pointerDownState.eventListeners.onMove.flush();\n      }\n\n      const {\n        draggingElement,\n        resizingElement,\n        multiElement,\n        activeTool,\n        isResizing,\n        isRotating,\n      } = this.state;\n      this.setState({\n        isResizing: false,\n        isRotating: false,\n        resizingElement: null,\n        selectionElement: null,\n        frameToHighlight: null,\n        elementsToHighlight: null,\n        cursorButton: \"up\",\n        // text elements are reset on finalize, and resetting on pointerup\n        // may cause issues with double taps\n        editingElement:\n          multiElement || isTextElement(this.state.editingElement)\n            ? this.state.editingElement\n            : null,\n      });\n\n      this.savePointer(childEvent.clientX, childEvent.clientY, \"up\");\n\n      this.setState({\n        selectedElementsAreBeingDragged: false,\n      });\n\n      // Handle end of dragging a point of a linear element, might close a loop\n      // and sets binding element\n      if (this.state.editingLinearElement) {\n        if (\n          !pointerDownState.boxSelection.hasOccurred &&\n          pointerDownState.hit?.element?.id !==\n            this.state.editingLinearElement.elementId\n        ) {\n          this.actionManager.executeAction(actionFinalize);\n        } else {\n          const editingLinearElement = LinearElementEditor.handlePointerUp(\n            childEvent,\n            this.state.editingLinearElement,\n            this.state,\n          );\n          if (editingLinearElement !== this.state.editingLinearElement) {\n            this.setState({\n              editingLinearElement,\n              suggestedBindings: [],\n            });\n          }\n        }\n      } else if (this.state.selectedLinearElement) {\n        if (\n          pointerDownState.hit?.element?.id !==\n          this.state.selectedLinearElement.elementId\n        ) {\n          const selectedELements = this.scene.getSelectedElements(this.state);\n          // set selectedLinearElement to null if there is more than one element selected since we don't want to show linear element handles\n          if (selectedELements.length > 1) {\n            this.setState({ selectedLinearElement: null });\n          }\n        } else {\n          const linearElementEditor = LinearElementEditor.handlePointerUp(\n            childEvent,\n            this.state.selectedLinearElement,\n            this.state,\n          );\n\n          const { startBindingElement, endBindingElement } =\n            linearElementEditor;\n          const element = this.scene.getElement(linearElementEditor.elementId);\n          if (isBindingElement(element)) {\n            bindOrUnbindLinearElement(\n              element,\n              startBindingElement,\n              endBindingElement,\n            );\n          }\n\n          if (linearElementEditor !== this.state.selectedLinearElement) {\n            this.setState({\n              selectedLinearElement: {\n                ...linearElementEditor,\n                selectedPointsIndices: null,\n              },\n              suggestedBindings: [],\n            });\n          }\n        }\n      }\n\n      lastPointerUp = null;\n\n      window.removeEventListener(\n        EVENT.POINTER_MOVE,\n        pointerDownState.eventListeners.onMove!,\n      );\n      window.removeEventListener(\n        EVENT.POINTER_UP,\n        pointerDownState.eventListeners.onUp!,\n      );\n      window.removeEventListener(\n        EVENT.KEYDOWN,\n        pointerDownState.eventListeners.onKeyDown!,\n      );\n      window.removeEventListener(\n        EVENT.KEYUP,\n        pointerDownState.eventListeners.onKeyUp!,\n      );\n\n      if (this.state.pendingImageElementId) {\n        this.setState({ pendingImageElementId: null });\n      }\n\n      if (draggingElement?.type === \"freedraw\") {\n        const pointerCoords = viewportCoordsToSceneCoords(\n          childEvent,\n          this.state,\n        );\n\n        const points = draggingElement.points;\n        let dx = pointerCoords.x - draggingElement.x;\n        let dy = pointerCoords.y - draggingElement.y;\n\n        // Allows dots to avoid being flagged as infinitely small\n        if (dx === points[0][0] && dy === points[0][1]) {\n          dy += 0.0001;\n          dx += 0.0001;\n        }\n\n        const pressures = draggingElement.simulatePressure\n          ? []\n          : [...draggingElement.pressures, childEvent.pressure];\n\n        mutateElement(draggingElement, {\n          points: [...points, [dx, dy]],\n          pressures,\n          lastCommittedPoint: [dx, dy],\n        });\n\n        this.actionManager.executeAction(actionFinalize);\n\n        return;\n      }\n      if (isImageElement(draggingElement)) {\n        const imageElement = draggingElement;\n        try {\n          this.initializeImageDimensions(imageElement);\n          this.setState(\n            {\n              selectedElementIds: makeNextSelectedElementIds(\n                { [imageElement.id]: true },\n                this.state,\n              ),\n            },\n            () => {\n              this.actionManager.executeAction(actionFinalize);\n            },\n          );\n        } catch (error: any) {\n          console.error(error);\n          this.scene.replaceAllElements(\n            this.scene\n              .getElementsIncludingDeleted()\n              .filter((el) => el.id !== imageElement.id),\n          );\n          this.actionManager.executeAction(actionFinalize);\n        }\n        return;\n      }\n\n      if (isLinearElement(draggingElement)) {\n        if (draggingElement!.points.length > 1) {\n          this.history.resumeRecording();\n        }\n        const pointerCoords = viewportCoordsToSceneCoords(\n          childEvent,\n          this.state,\n        );\n\n        if (\n          !pointerDownState.drag.hasOccurred &&\n          draggingElement &&\n          !multiElement\n        ) {\n          mutateElement(draggingElement, {\n            points: [\n              ...draggingElement.points,\n              [\n                pointerCoords.x - draggingElement.x,\n                pointerCoords.y - draggingElement.y,\n              ],\n            ],\n          });\n          this.setState({\n            multiElement: draggingElement,\n            editingElement: this.state.draggingElement,\n          });\n        } else if (pointerDownState.drag.hasOccurred && !multiElement) {\n          if (\n            isBindingEnabled(this.state) &&\n            isBindingElement(draggingElement, false)\n          ) {\n            maybeBindLinearElement(\n              draggingElement,\n              this.state,\n              this.scene,\n              pointerCoords,\n            );\n          }\n          this.setState({ suggestedBindings: [], startBoundElement: null });\n          if (!activeTool.locked) {\n            resetCursor(this.canvas);\n            this.setState((prevState) => ({\n              draggingElement: null,\n              activeTool: updateActiveTool(this.state, {\n                type: \"selection\",\n              }),\n              selectedElementIds: makeNextSelectedElementIds(\n                {\n                  ...prevState.selectedElementIds,\n                  [draggingElement.id]: true,\n                },\n                prevState,\n              ),\n              selectedLinearElement: new LinearElementEditor(\n                draggingElement,\n                this.scene,\n              ),\n            }));\n          } else {\n            this.setState((prevState) => ({\n              draggingElement: null,\n            }));\n          }\n        }\n        return;\n      }\n\n      if (\n        activeTool.type !== \"selection\" &&\n        draggingElement &&\n        isInvisiblySmallElement(draggingElement)\n      ) {\n        // remove invisible element which was added in onPointerDown\n        this.scene.replaceAllElements(\n          this.scene.getElementsIncludingDeleted().slice(0, -1),\n        );\n        this.setState({\n          draggingElement: null,\n        });\n        return;\n      }\n\n      if (draggingElement) {\n        if (pointerDownState.drag.hasOccurred) {\n          const sceneCoords = viewportCoordsToSceneCoords(\n            childEvent,\n            this.state,\n          );\n\n          // when editing the points of a linear element, we check if the\n          // linear element still is in the frame afterwards\n          // if not, the linear element will be removed from its frame (if any)\n          if (\n            this.state.selectedLinearElement &&\n            this.state.selectedLinearElement.isDragging\n          ) {\n            const linearElement = this.scene.getElement(\n              this.state.selectedLinearElement.elementId,\n            );\n\n            if (linearElement?.frameId) {\n              const frame = getContainingFrame(linearElement);\n\n              if (frame && linearElement) {\n                if (!elementOverlapsWithFrame(linearElement, frame)) {\n                  // remove the linear element from all groups\n                  // before removing it from the frame as well\n                  mutateElement(linearElement, {\n                    groupIds: [],\n                  });\n\n                  this.scene.replaceAllElements(\n                    removeElementsFromFrame(\n                      this.scene.getElementsIncludingDeleted(),\n                      [linearElement],\n                      this.state,\n                    ),\n                  );\n                }\n              }\n            }\n          } else {\n            // update the relationships between selected elements and frames\n            const topLayerFrame =\n              this.getTopLayerFrameAtSceneCoords(sceneCoords);\n\n            const selectedElements = this.scene.getSelectedElements(this.state);\n            let nextElements = this.scene.getElementsIncludingDeleted();\n\n            const updateGroupIdsAfterEditingGroup = (\n              elements: ExcalidrawElement[],\n            ) => {\n              if (elements.length > 0) {\n                for (const element of elements) {\n                  const index = element.groupIds.indexOf(\n                    this.state.editingGroupId!,\n                  );\n\n                  mutateElement(\n                    element,\n                    {\n                      groupIds: element.groupIds.slice(0, index),\n                    },\n                    false,\n                  );\n                }\n\n                nextElements.forEach((element) => {\n                  if (\n                    element.groupIds.length &&\n                    getElementsInGroup(\n                      nextElements,\n                      element.groupIds[element.groupIds.length - 1],\n                    ).length < 2\n                  ) {\n                    mutateElement(\n                      element,\n                      {\n                        groupIds: [],\n                      },\n                      false,\n                    );\n                  }\n                });\n\n                this.setState({\n                  editingGroupId: null,\n                });\n              }\n            };\n\n            if (\n              topLayerFrame &&\n              !this.state.selectedElementIds[topLayerFrame.id]\n            ) {\n              const elementsToAdd = selectedElements.filter(\n                (element) =>\n                  element.frameId !== topLayerFrame.id &&\n                  isElementInFrame(element, nextElements, this.state),\n              );\n\n              if (this.state.editingGroupId) {\n                updateGroupIdsAfterEditingGroup(elementsToAdd);\n              }\n\n              nextElements = addElementsToFrame(\n                nextElements,\n                elementsToAdd,\n                topLayerFrame,\n              );\n            } else if (!topLayerFrame) {\n              if (this.state.editingGroupId) {\n                const elementsToRemove = selectedElements.filter(\n                  (element) =>\n                    element.frameId &&\n                    !isElementInFrame(element, nextElements, this.state),\n                );\n\n                updateGroupIdsAfterEditingGroup(elementsToRemove);\n              }\n            }\n\n            nextElements = updateFrameMembershipOfSelectedElements(\n              this.scene.getElementsIncludingDeleted(),\n              this.state,\n              this,\n            );\n\n            this.scene.replaceAllElements(nextElements);\n          }\n        }\n\n        if (draggingElement.type === \"frame\") {\n          const elementsInsideFrame = getElementsInNewFrame(\n            this.scene.getElementsIncludingDeleted(),\n            draggingElement,\n          );\n\n          this.scene.replaceAllElements(\n            addElementsToFrame(\n              this.scene.getElementsIncludingDeleted(),\n              elementsInsideFrame,\n              draggingElement,\n            ),\n          );\n        }\n\n        mutateElement(\n          draggingElement,\n          getNormalizedDimensions(draggingElement),\n        );\n      }\n\n      if (resizingElement) {\n        this.history.resumeRecording();\n      }\n\n      if (resizingElement && isInvisiblySmallElement(resizingElement)) {\n        this.scene.replaceAllElements(\n          this.scene\n            .getElementsIncludingDeleted()\n            .filter((el) => el.id !== resizingElement.id),\n        );\n      }\n\n      // handle frame membership for resizing frames and/or selected elements\n      if (pointerDownState.resize.isResizing) {\n        let nextElements = updateFrameMembershipOfSelectedElements(\n          this.scene.getElementsIncludingDeleted(),\n          this.state,\n          this,\n        );\n\n        const selectedFrames = this.scene\n          .getSelectedElements(this.state)\n          .filter(\n            (element) => element.type === \"frame\",\n          ) as ExcalidrawFrameElement[];\n\n        for (const frame of selectedFrames) {\n          nextElements = replaceAllElementsInFrame(\n            nextElements,\n            getElementsInResizingFrame(\n              this.scene.getElementsIncludingDeleted(),\n              frame,\n              this.state,\n            ),\n            frame,\n            this.state,\n          );\n        }\n\n        this.scene.replaceAllElements(nextElements);\n      }\n\n      // Code below handles selection when element(s) weren't\n      // drag or added to selection on pointer down phase.\n      const hitElement = pointerDownState.hit.element;\n      if (\n        this.state.selectedLinearElement?.elementId !== hitElement?.id &&\n        isLinearElement(hitElement)\n      ) {\n        const selectedELements = this.scene.getSelectedElements(this.state);\n        // set selectedLinearElement when no other element selected except\n        // the one we've hit\n        if (selectedELements.length === 1) {\n          this.setState({\n            selectedLinearElement: new LinearElementEditor(\n              hitElement,\n              this.scene,\n            ),\n          });\n        }\n      }\n      if (isEraserActive(this.state)) {\n        const draggedDistance = distance2d(\n          this.lastPointerDown!.clientX,\n          this.lastPointerDown!.clientY,\n          this.lastPointerUp!.clientX,\n          this.lastPointerUp!.clientY,\n        );\n\n        if (draggedDistance === 0) {\n          const scenePointer = viewportCoordsToSceneCoords(\n            {\n              clientX: this.lastPointerUp!.clientX,\n              clientY: this.lastPointerUp!.clientY,\n            },\n            this.state,\n          );\n          const hitElements = this.getElementsAtPosition(\n            scenePointer.x,\n            scenePointer.y,\n          );\n          hitElements.forEach(\n            (hitElement) =>\n              (pointerDownState.elementIdsToErase[hitElement.id] = {\n                erase: true,\n                opacity: hitElement.opacity,\n              }),\n          );\n        }\n        this.eraseElements(pointerDownState);\n        return;\n      } else if (Object.keys(pointerDownState.elementIdsToErase).length) {\n        this.restoreReadyToEraseElements(pointerDownState);\n      }\n\n      if (\n        hitElement &&\n        !pointerDownState.drag.hasOccurred &&\n        !pointerDownState.hit.wasAddedToSelection &&\n        // if we're editing a line, pointerup shouldn't switch selection if\n        // box selected\n        (!this.state.editingLinearElement ||\n          !pointerDownState.boxSelection.hasOccurred)\n      ) {\n        // when inside line editor, shift selects points instead\n        if (childEvent.shiftKey && !this.state.editingLinearElement) {\n          if (this.state.selectedElementIds[hitElement.id]) {\n            if (isSelectedViaGroup(this.state, hitElement)) {\n              this.setState((_prevState) => {\n                const nextSelectedElementIds = {\n                  ..._prevState.selectedElementIds,\n                };\n\n                // We want to unselect all groups hitElement is part of\n                // as well as all elements that are part of the groups\n                // hitElement is part of\n                for (const groupedElement of hitElement.groupIds.flatMap(\n                  (groupId) =>\n                    getElementsInGroup(\n                      this.scene.getNonDeletedElements(),\n                      groupId,\n                    ),\n                )) {\n                  delete nextSelectedElementIds[groupedElement.id];\n                }\n\n                return {\n                  selectedGroupIds: {\n                    ..._prevState.selectedElementIds,\n                    ...hitElement.groupIds\n                      .map((gId) => ({ [gId]: false }))\n                      .reduce((prev, acc) => ({ ...prev, ...acc }), {}),\n                  },\n                  selectedElementIds: makeNextSelectedElementIds(\n                    nextSelectedElementIds,\n                    _prevState,\n                  ),\n                };\n              });\n              // if not gragging a linear element point (outside editor)\n            } else if (!this.state.selectedLinearElement?.isDragging) {\n              // remove element from selection while\n              // keeping prev elements selected\n\n              this.setState((prevState) => {\n                const newSelectedElementIds = {\n                  ...prevState.selectedElementIds,\n                };\n                delete newSelectedElementIds[hitElement!.id];\n                const newSelectedElements = getSelectedElements(\n                  this.scene.getNonDeletedElements(),\n                  { selectedElementIds: newSelectedElementIds },\n                );\n\n                return selectGroupsForSelectedElements(\n                  {\n                    ...prevState,\n                    selectedElementIds: newSelectedElementIds,\n                    // set selectedLinearElement only if thats the only element selected\n                    selectedLinearElement:\n                      newSelectedElements.length === 1 &&\n                      isLinearElement(newSelectedElements[0])\n                        ? new LinearElementEditor(\n                            newSelectedElements[0],\n                            this.scene,\n                          )\n                        : prevState.selectedLinearElement,\n                  },\n                  this.scene.getNonDeletedElements(),\n                  prevState,\n                  this,\n                );\n              });\n            }\n          } else if (\n            hitElement.frameId &&\n            this.state.selectedElementIds[hitElement.frameId]\n          ) {\n            // when hitElement is part of a selected frame, deselect the frame\n            // to avoid frame and containing elements selected simultaneously\n            this.setState((prevState) => {\n              const nextSelectedElementIds: {\n                [id: string]: true;\n              } = {\n                ...prevState.selectedElementIds,\n                [hitElement.id]: true,\n              };\n              // deselect the frame\n              delete nextSelectedElementIds[hitElement.frameId!];\n\n              // deselect groups containing the frame\n              (this.scene.getElement(hitElement.frameId!)?.groupIds ?? [])\n                .flatMap((gid) =>\n                  getElementsInGroup(this.scene.getNonDeletedElements(), gid),\n                )\n                .forEach((element) => {\n                  delete nextSelectedElementIds[element.id];\n                });\n\n              return selectGroupsForSelectedElements(\n                {\n                  ...prevState,\n                  selectedElementIds: nextSelectedElementIds,\n                  showHyperlinkPopup: hitElement.link ? \"info\" : false,\n                },\n                this.scene.getNonDeletedElements(),\n                prevState,\n                this,\n              );\n            });\n          } else {\n            // add element to selection while keeping prev elements selected\n            this.setState((_prevState) => ({\n              selectedElementIds: makeNextSelectedElementIds(\n                {\n                  ..._prevState.selectedElementIds,\n                  [hitElement!.id]: true,\n                },\n                _prevState,\n              ),\n            }));\n          }\n        } else {\n          this.setState((prevState) => ({\n            ...selectGroupsForSelectedElements(\n              {\n                ...prevState,\n                selectedElementIds: { [hitElement.id]: true },\n                selectedLinearElement:\n                  isLinearElement(hitElement) &&\n                  // Don't set `selectedLinearElement` if its same as the hitElement, this is mainly to prevent resetting the `hoverPointIndex` to -1.\n                  // Future we should update the API to take care of setting the correct `hoverPointIndex` when initialized\n                  prevState.selectedLinearElement?.elementId !== hitElement.id\n                    ? new LinearElementEditor(hitElement, this.scene)\n                    : prevState.selectedLinearElement,\n              },\n              this.scene.getNonDeletedElements(),\n              prevState,\n              this,\n            ),\n          }));\n        }\n      }\n\n      if (\n        !pointerDownState.drag.hasOccurred &&\n        !this.state.isResizing &&\n        ((hitElement &&\n          isHittingElementBoundingBoxWithoutHittingElement(\n            hitElement,\n            this.state,\n            this.frameNameBoundsCache,\n            pointerDownState.origin.x,\n            pointerDownState.origin.y,\n          )) ||\n          (!hitElement &&\n            pointerDownState.hit.hasHitCommonBoundingBoxOfSelectedElements))\n      ) {\n        if (this.state.editingLinearElement) {\n          this.setState({ editingLinearElement: null });\n        } else {\n          // Deselect selected elements\n          this.setState({\n            selectedElementIds: makeNextSelectedElementIds({}, this.state),\n            selectedGroupIds: {},\n            editingGroupId: null,\n          });\n        }\n        return;\n      }\n\n      if (\n        !activeTool.locked &&\n        activeTool.type !== \"freedraw\" &&\n        draggingElement &&\n        draggingElement.type !== \"selection\"\n      ) {\n        this.setState((prevState) => ({\n          selectedElementIds: makeNextSelectedElementIds(\n            {\n              ...prevState.selectedElementIds,\n              [draggingElement.id]: true,\n            },\n            prevState,\n          ),\n        }));\n      }\n\n      if (\n        activeTool.type !== \"selection\" ||\n        isSomeElementSelected(this.scene.getNonDeletedElements(), this.state)\n      ) {\n        this.history.resumeRecording();\n      }\n\n      if (pointerDownState.drag.hasOccurred || isResizing || isRotating) {\n        (isBindingEnabled(this.state)\n          ? bindOrUnbindSelectedElements\n          : unbindLinearElements)(this.scene.getSelectedElements(this.state));\n      }\n\n      if (!activeTool.locked && activeTool.type !== \"freedraw\") {\n        resetCursor(this.canvas);\n        this.setState({\n          draggingElement: null,\n          suggestedBindings: [],\n          activeTool: updateActiveTool(this.state, { type: \"selection\" }),\n        });\n      } else {\n        this.setState({\n          draggingElement: null,\n          suggestedBindings: [],\n        });\n      }\n    });\n  }\n\n  private restoreReadyToEraseElements = (\n    pointerDownState: PointerDownState,\n  ) => {\n    const elements = this.scene.getElementsIncludingDeleted().map((ele) => {\n      if (\n        pointerDownState.elementIdsToErase[ele.id] &&\n        pointerDownState.elementIdsToErase[ele.id].erase\n      ) {\n        return newElementWith(ele, {\n          opacity: pointerDownState.elementIdsToErase[ele.id].opacity,\n        });\n      } else if (\n        isBoundToContainer(ele) &&\n        pointerDownState.elementIdsToErase[ele.containerId] &&\n        pointerDownState.elementIdsToErase[ele.containerId].erase\n      ) {\n        return newElementWith(ele, {\n          opacity: pointerDownState.elementIdsToErase[ele.containerId].opacity,\n        });\n      } else if (\n        ele.frameId &&\n        pointerDownState.elementIdsToErase[ele.frameId] &&\n        pointerDownState.elementIdsToErase[ele.frameId].erase\n      ) {\n        return newElementWith(ele, {\n          opacity: pointerDownState.elementIdsToErase[ele.frameId].opacity,\n        });\n      }\n      return ele;\n    });\n\n    this.scene.replaceAllElements(elements);\n  };\n\n  private eraseElements = (pointerDownState: PointerDownState) => {\n    const elements = this.scene.getElementsIncludingDeleted().map((ele) => {\n      if (\n        pointerDownState.elementIdsToErase[ele.id] &&\n        pointerDownState.elementIdsToErase[ele.id].erase\n      ) {\n        return newElementWith(ele, { isDeleted: true });\n      } else if (\n        isBoundToContainer(ele) &&\n        pointerDownState.elementIdsToErase[ele.containerId] &&\n        pointerDownState.elementIdsToErase[ele.containerId].erase\n      ) {\n        return newElementWith(ele, { isDeleted: true });\n      } else if (\n        ele.frameId &&\n        pointerDownState.elementIdsToErase[ele.frameId] &&\n        pointerDownState.elementIdsToErase[ele.frameId].erase\n      ) {\n        return newElementWith(ele, { isDeleted: true });\n      }\n      return ele;\n    });\n\n    this.history.resumeRecording();\n    this.scene.replaceAllElements(elements);\n  };\n\n  private initializeImage = async ({\n    imageFile,\n    imageElement: _imageElement,\n    showCursorImagePreview = false,\n  }: {\n    imageFile: File;\n    imageElement: ExcalidrawImageElement;\n    showCursorImagePreview?: boolean;\n  }) => {\n    // at this point this should be guaranteed image file, but we do this check\n    // to satisfy TS down the line\n    if (!isSupportedImageFile(imageFile)) {\n      throw new Error(t(\"errors.unsupportedFileType\"));\n    }\n    const mimeType = imageFile.type;\n\n    setCursor(this.canvas, \"wait\");\n\n    if (mimeType === MIME_TYPES.svg) {\n      try {\n        imageFile = SVGStringToFile(\n          await normalizeSVG(await imageFile.text()),\n          imageFile.name,\n        );\n      } catch (error: any) {\n        console.warn(error);\n        throw new Error(t(\"errors.svgImageInsertError\"));\n      }\n    }\n\n    // generate image id (by default the file digest) before any\n    // resizing/compression takes place to keep it more portable\n    const fileId = await ((this.props.generateIdForFile?.(\n      imageFile,\n    ) as Promise<FileId>) || generateIdFromFile(imageFile));\n\n    if (!fileId) {\n      console.warn(\n        \"Couldn't generate file id or the supplied `generateIdForFile` didn't resolve to one.\",\n      );\n      throw new Error(t(\"errors.imageInsertError\"));\n    }\n\n    const existingFileData = this.files[fileId];\n    if (!existingFileData?.dataURL) {\n      try {\n        imageFile = await resizeImageFile(imageFile, {\n          maxWidthOrHeight: DEFAULT_MAX_IMAGE_WIDTH_OR_HEIGHT,\n        });\n      } catch (error: any) {\n        console.error(\"error trying to resing image file on insertion\", error);\n      }\n\n      if (imageFile.size > MAX_ALLOWED_FILE_BYTES) {\n        throw new Error(\n          t(\"errors.fileTooBig\", {\n            maxSize: `${Math.trunc(MAX_ALLOWED_FILE_BYTES / 1024 / 1024)}MB`,\n          }),\n        );\n      }\n    }\n\n    if (showCursorImagePreview) {\n      const dataURL = this.files[fileId]?.dataURL;\n      // optimization so that we don't unnecessarily resize the original\n      // full-size file for cursor preview\n      // (it's much faster to convert the resized dataURL to File)\n      const resizedFile = dataURL && dataURLToFile(dataURL);\n\n      this.setImagePreviewCursor(resizedFile || imageFile);\n    }\n\n    const dataURL =\n      this.files[fileId]?.dataURL || (await getDataURL(imageFile));\n\n    const imageElement = mutateElement(\n      _imageElement,\n      {\n        fileId,\n      },\n      false,\n    ) as NonDeleted<InitializedExcalidrawImageElement>;\n\n    return new Promise<NonDeleted<InitializedExcalidrawImageElement>>(\n      async (resolve, reject) => {\n        try {\n          this.files = {\n            ...this.files,\n            [fileId]: {\n              mimeType,\n              id: fileId,\n              dataURL,\n              created: Date.now(),\n              lastRetrieved: Date.now(),\n            },\n          };\n          const cachedImageData = this.imageCache.get(fileId);\n          if (!cachedImageData) {\n            this.addNewImagesToImageCache();\n            await this.updateImageCache([imageElement]);\n          }\n          if (cachedImageData?.image instanceof Promise) {\n            await cachedImageData.image;\n          }\n          if (\n            this.state.pendingImageElementId !== imageElement.id &&\n            this.state.draggingElement?.id !== imageElement.id\n          ) {\n            this.initializeImageDimensions(imageElement, true);\n          }\n          resolve(imageElement);\n        } catch (error: any) {\n          console.error(error);\n          reject(new Error(t(\"errors.imageInsertError\")));\n        } finally {\n          if (!showCursorImagePreview) {\n            resetCursor(this.canvas);\n          }\n        }\n      },\n    );\n  };\n\n  /**\n   * inserts image into elements array and rerenders\n   */\n  private insertImageElement = async (\n    imageElement: ExcalidrawImageElement,\n    imageFile: File,\n    showCursorImagePreview?: boolean,\n  ) => {\n    this.scene.addNewElement(imageElement);\n\n    try {\n      await this.initializeImage({\n        imageFile,\n        imageElement,\n        showCursorImagePreview,\n      });\n    } catch (error: any) {\n      mutateElement(imageElement, {\n        isDeleted: true,\n      });\n      this.actionManager.executeAction(actionFinalize);\n      this.setState({\n        errorMessage: error.message || t(\"errors.imageInsertError\"),\n      });\n    }\n  };\n\n  private setImagePreviewCursor = async (imageFile: File) => {\n    // mustn't be larger than 128 px\n    // https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Basic_User_Interface/Using_URL_values_for_the_cursor_property\n    const cursorImageSizePx = 96;\n\n    const imagePreview = await resizeImageFile(imageFile, {\n      maxWidthOrHeight: cursorImageSizePx,\n    });\n\n    let previewDataURL = await getDataURL(imagePreview);\n\n    // SVG cannot be resized via `resizeImageFile` so we resize by rendering to\n    // a small canvas\n    if (imageFile.type === MIME_TYPES.svg) {\n      const img = await loadHTMLImageElement(previewDataURL);\n\n      let height = Math.min(img.height, cursorImageSizePx);\n      let width = height * (img.width / img.height);\n\n      if (width > cursorImageSizePx) {\n        width = cursorImageSizePx;\n        height = width * (img.height / img.width);\n      }\n\n      const canvas = document.createElement(\"canvas\");\n      canvas.height = height;\n      canvas.width = width;\n      const context = canvas.getContext(\"2d\")!;\n\n      context.drawImage(img, 0, 0, width, height);\n\n      previewDataURL = canvas.toDataURL(MIME_TYPES.svg) as DataURL;\n    }\n\n    if (this.state.pendingImageElementId) {\n      setCursor(this.canvas, `url(${previewDataURL}) 4 4, auto`);\n    }\n  };\n\n  private onImageAction = async (\n    { insertOnCanvasDirectly } = { insertOnCanvasDirectly: false },\n  ) => {\n    try {\n      const clientX = this.state.width / 2 + this.state.offsetLeft;\n      const clientY = this.state.height / 2 + this.state.offsetTop;\n\n      const { x, y } = viewportCoordsToSceneCoords(\n        { clientX, clientY },\n        this.state,\n      );\n\n      const imageFile = await fileOpen({\n        description: \"Image\",\n        extensions: Object.keys(\n          IMAGE_MIME_TYPES,\n        ) as (keyof typeof IMAGE_MIME_TYPES)[],\n      });\n\n      const imageElement = this.createImageElement({\n        sceneX: x,\n        sceneY: y,\n      });\n\n      if (insertOnCanvasDirectly) {\n        this.insertImageElement(imageElement, imageFile);\n        this.initializeImageDimensions(imageElement);\n        this.setState(\n          {\n            selectedElementIds: makeNextSelectedElementIds(\n              { [imageElement.id]: true },\n              this.state,\n            ),\n          },\n          () => {\n            this.actionManager.executeAction(actionFinalize);\n          },\n        );\n      } else {\n        this.setState(\n          {\n            pendingImageElementId: imageElement.id,\n          },\n          () => {\n            this.insertImageElement(\n              imageElement,\n              imageFile,\n              /* showCursorImagePreview */ true,\n            );\n          },\n        );\n      }\n    } catch (error: any) {\n      if (error.name !== \"AbortError\") {\n        console.error(error);\n      } else {\n        console.warn(error);\n      }\n      this.setState(\n        {\n          pendingImageElementId: null,\n          editingElement: null,\n          activeTool: updateActiveTool(this.state, { type: \"selection\" }),\n        },\n        () => {\n          this.actionManager.executeAction(actionFinalize);\n        },\n      );\n    }\n  };\n\n  private initializeImageDimensions = (\n    imageElement: ExcalidrawImageElement,\n    forceNaturalSize = false,\n  ) => {\n    const image =\n      isInitializedImageElement(imageElement) &&\n      this.imageCache.get(imageElement.fileId)?.image;\n\n    if (!image || image instanceof Promise) {\n      if (\n        imageElement.width < DRAGGING_THRESHOLD / this.state.zoom.value &&\n        imageElement.height < DRAGGING_THRESHOLD / this.state.zoom.value\n      ) {\n        const placeholderSize = 100 / this.state.zoom.value;\n        mutateElement(imageElement, {\n          x: imageElement.x - placeholderSize / 2,\n          y: imageElement.y - placeholderSize / 2,\n          width: placeholderSize,\n          height: placeholderSize,\n        });\n      }\n\n      return;\n    }\n\n    if (\n      forceNaturalSize ||\n      // if user-created bounding box is below threshold, assume the\n      // intention was to click instead of drag, and use the image's\n      // intrinsic size\n      (imageElement.width < DRAGGING_THRESHOLD / this.state.zoom.value &&\n        imageElement.height < DRAGGING_THRESHOLD / this.state.zoom.value)\n    ) {\n      const minHeight = Math.max(this.state.height - 120, 160);\n      // max 65% of canvas height, clamped to <300px, vh - 120px>\n      const maxHeight = Math.min(\n        minHeight,\n        Math.floor(this.state.height * 0.5) / this.state.zoom.value,\n      );\n\n      const height = Math.min(image.naturalHeight, maxHeight);\n      const width = height * (image.naturalWidth / image.naturalHeight);\n\n      // add current imageElement width/height to account for previous centering\n      // of the placeholder image\n      const x = imageElement.x + imageElement.width / 2 - width / 2;\n      const y = imageElement.y + imageElement.height / 2 - height / 2;\n\n      mutateElement(imageElement, { x, y, width, height });\n    }\n  };\n\n  /** updates image cache, refreshing updated elements and/or setting status\n      to error for images that fail during <img> element creation */\n  private updateImageCache = async (\n    elements: readonly InitializedExcalidrawImageElement[],\n    files = this.files,\n  ) => {\n    const { updatedFiles, erroredFiles } = await _updateImageCache({\n      imageCache: this.imageCache,\n      fileIds: elements.map((element) => element.fileId),\n      files,\n    });\n    if (updatedFiles.size || erroredFiles.size) {\n      for (const element of elements) {\n        if (updatedFiles.has(element.fileId)) {\n          invalidateShapeForElement(element);\n        }\n      }\n    }\n    if (erroredFiles.size) {\n      this.scene.replaceAllElements(\n        this.scene.getElementsIncludingDeleted().map((element) => {\n          if (\n            isInitializedImageElement(element) &&\n            erroredFiles.has(element.fileId)\n          ) {\n            return newElementWith(element, {\n              status: \"error\",\n            });\n          }\n          return element;\n        }),\n      );\n    }\n\n    return { updatedFiles, erroredFiles };\n  };\n\n  /** adds new images to imageCache and re-renders if needed */\n  private addNewImagesToImageCache = async (\n    imageElements: InitializedExcalidrawImageElement[] = getInitializedImageElements(\n      this.scene.getNonDeletedElements(),\n    ),\n    files: BinaryFiles = this.files,\n  ) => {\n    const uncachedImageElements = imageElements.filter(\n      (element) => !element.isDeleted && !this.imageCache.has(element.fileId),\n    );\n\n    if (uncachedImageElements.length) {\n      const { updatedFiles } = await this.updateImageCache(\n        uncachedImageElements,\n        files,\n      );\n      if (updatedFiles.size) {\n        this.scene.informMutation();\n      }\n    }\n  };\n\n  /** generally you should use `addNewImagesToImageCache()` directly if you need\n   *  to render new images. This is just a failsafe  */\n  private scheduleImageRefresh = throttle(() => {\n    this.addNewImagesToImageCache();\n  }, IMAGE_RENDER_TIMEOUT);\n\n  private updateBindingEnabledOnPointerMove = (\n    event: React.PointerEvent<HTMLElement>,\n  ) => {\n    const shouldEnableBinding = shouldEnableBindingForPointerEvent(event);\n    if (this.state.isBindingEnabled !== shouldEnableBinding) {\n      this.setState({ isBindingEnabled: shouldEnableBinding });\n    }\n  };\n\n  private maybeSuggestBindingAtCursor = (pointerCoords: {\n    x: number;\n    y: number;\n  }): void => {\n    const hoveredBindableElement = getHoveredElementForBinding(\n      pointerCoords,\n      this.scene,\n    );\n    this.setState({\n      suggestedBindings:\n        hoveredBindableElement != null ? [hoveredBindableElement] : [],\n    });\n  };\n\n  private maybeSuggestBindingsForLinearElementAtCoords = (\n    linearElement: NonDeleted<ExcalidrawLinearElement>,\n    /** scene coords */\n    pointerCoords: {\n      x: number;\n      y: number;\n    }[],\n    // During line creation the start binding hasn't been written yet\n    // into `linearElement`\n    oppositeBindingBoundElement?: ExcalidrawBindableElement | null,\n  ): void => {\n    if (!pointerCoords.length) {\n      return;\n    }\n\n    const suggestedBindings = pointerCoords.reduce(\n      (acc: NonDeleted<ExcalidrawBindableElement>[], coords) => {\n        const hoveredBindableElement = getHoveredElementForBinding(\n          coords,\n          this.scene,\n        );\n        if (\n          hoveredBindableElement != null &&\n          !isLinearElementSimpleAndAlreadyBound(\n            linearElement,\n            oppositeBindingBoundElement?.id,\n            hoveredBindableElement,\n          )\n        ) {\n          acc.push(hoveredBindableElement);\n        }\n        return acc;\n      },\n      [],\n    );\n\n    this.setState({ suggestedBindings });\n  };\n\n  private maybeSuggestBindingForAll(\n    selectedElements: NonDeleted<ExcalidrawElement>[],\n  ): void {\n    const suggestedBindings = getEligibleElementsForBinding(selectedElements);\n    this.setState({ suggestedBindings });\n  }\n\n  private clearSelection(hitElement: ExcalidrawElement | null): void {\n    this.setState((prevState) => ({\n      selectedElementIds: makeNextSelectedElementIds({}, prevState),\n      selectedGroupIds: {},\n      // Continue editing the same group if the user selected a different\n      // element from it\n      editingGroupId:\n        prevState.editingGroupId &&\n        hitElement != null &&\n        isElementInGroup(hitElement, prevState.editingGroupId)\n          ? prevState.editingGroupId\n          : null,\n    }));\n    this.setState({\n      selectedElementIds: makeNextSelectedElementIds({}, this.state),\n      previousSelectedElementIds: this.state.selectedElementIds,\n    });\n  }\n\n  private handleCanvasRef = (canvas: HTMLCanvasElement) => {\n    // canvas is null when unmounting\n    if (canvas !== null) {\n      this.canvas = canvas;\n      this.rc = rough.canvas(this.canvas);\n\n      this.canvas.addEventListener(EVENT.WHEEL, this.handleWheel, {\n        passive: false,\n      });\n      this.canvas.addEventListener(EVENT.TOUCH_START, this.onTapStart);\n      this.canvas.addEventListener(EVENT.TOUCH_END, this.onTapEnd);\n    } else {\n      this.canvas?.removeEventListener(EVENT.WHEEL, this.handleWheel);\n      this.canvas?.removeEventListener(EVENT.TOUCH_START, this.onTapStart);\n      this.canvas?.removeEventListener(EVENT.TOUCH_END, this.onTapEnd);\n    }\n  };\n\n  private handleAppOnDrop = async (event: React.DragEvent<HTMLDivElement>) => {\n    // must be retrieved first, in the same frame\n    const { file, fileHandle } = await getFileFromEvent(event);\n\n    try {\n      if (isSupportedImageFile(file)) {\n        // first attempt to decode scene from the image if it's embedded\n        // ---------------------------------------------------------------------\n\n        if (file?.type === MIME_TYPES.png || file?.type === MIME_TYPES.svg) {\n          try {\n            const scene = await loadFromBlob(\n              file,\n              this.state,\n              this.scene.getElementsIncludingDeleted(),\n              fileHandle,\n            );\n            this.syncActionResult({\n              ...scene,\n              appState: {\n                ...(scene.appState || this.state),\n                isLoading: false,\n              },\n              replaceFiles: true,\n              commitToHistory: true,\n            });\n            return;\n          } catch (error: any) {\n            if (error.name !== \"EncodingError\") {\n              throw error;\n            }\n          }\n        }\n\n        // if no scene is embedded or we fail for whatever reason, fall back\n        // to importing as regular image\n        // ---------------------------------------------------------------------\n\n        const { x: sceneX, y: sceneY } = viewportCoordsToSceneCoords(\n          event,\n          this.state,\n        );\n\n        const imageElement = this.createImageElement({ sceneX, sceneY });\n        this.insertImageElement(imageElement, file);\n        this.initializeImageDimensions(imageElement);\n        this.setState({\n          selectedElementIds: makeNextSelectedElementIds(\n            { [imageElement.id]: true },\n            this.state,\n          ),\n        });\n\n        return;\n      }\n    } catch (error: any) {\n      return this.setState({\n        isLoading: false,\n        errorMessage: error.message,\n      });\n    }\n\n    const libraryJSON = event.dataTransfer.getData(MIME_TYPES.excalidrawlib);\n    if (libraryJSON && typeof libraryJSON === \"string\") {\n      try {\n        const libraryItems = parseLibraryJSON(libraryJSON);\n        this.addElementsFromPasteOrLibrary({\n          elements: distributeLibraryItemsOnSquareGrid(libraryItems),\n          position: event,\n          files: null,\n        });\n      } catch (error: any) {\n        this.setState({ errorMessage: error.message });\n      }\n      return;\n    }\n\n    if (file) {\n      // atetmpt to parse an excalidraw/excalidrawlib file\n      await this.loadFileToCanvas(file, fileHandle);\n    }\n  };\n\n  loadFileToCanvas = async (\n    file: File,\n    fileHandle: FileSystemHandle | null,\n  ) => {\n    file = await normalizeFile(file);\n    try {\n      const ret = await loadSceneOrLibraryFromBlob(\n        file,\n        this.state,\n        this.scene.getElementsIncludingDeleted(),\n        fileHandle,\n      );\n      if (ret.type === MIME_TYPES.excalidraw) {\n        this.setState({ isLoading: true });\n        this.syncActionResult({\n          ...ret.data,\n          appState: {\n            ...(ret.data.appState || this.state),\n            isLoading: false,\n          },\n          replaceFiles: true,\n          commitToHistory: true,\n        });\n      } else if (ret.type === MIME_TYPES.excalidrawlib) {\n        await this.library\n          .updateLibrary({\n            libraryItems: file,\n            merge: true,\n            openLibraryMenu: true,\n          })\n          .catch((error) => {\n            console.error(error);\n            this.setState({ errorMessage: t(\"errors.importLibraryError\") });\n          });\n      }\n    } catch (error: any) {\n      this.setState({ isLoading: false, errorMessage: error.message });\n    }\n  };\n\n  private handleCanvasContextMenu = (\n    event: React.PointerEvent<HTMLElement>,\n  ) => {\n    event.preventDefault();\n\n    if (\n      (event.nativeEvent.pointerType === \"touch\" ||\n        (event.nativeEvent.pointerType === \"pen\" &&\n          // always allow if user uses a pen secondary button\n          event.button !== POINTER_BUTTON.SECONDARY)) &&\n      this.state.activeTool.type !== \"selection\"\n    ) {\n      return;\n    }\n\n    const { x, y } = viewportCoordsToSceneCoords(event, this.state);\n    const element = this.getElementAtPosition(x, y, {\n      preferSelected: true,\n      includeLockedElements: true,\n    });\n\n    const selectedElements = this.scene.getSelectedElements(this.state);\n    const isHittignCommonBoundBox =\n      this.isHittingCommonBoundingBoxOfSelectedElements(\n        { x, y },\n        selectedElements,\n      );\n\n    const type = element || isHittignCommonBoundBox ? \"element\" : \"canvas\";\n\n    const container = this.excalidrawContainerRef.current!;\n    const { top: offsetTop, left: offsetLeft } =\n      container.getBoundingClientRect();\n    const left = event.clientX - offsetLeft;\n    const top = event.clientY - offsetTop;\n\n    trackEvent(\"contextMenu\", \"openContextMenu\", type);\n\n    this.setState(\n      {\n        ...(element && !this.state.selectedElementIds[element.id]\n          ? selectGroupsForSelectedElements(\n              {\n                ...this.state,\n                selectedElementIds: { [element.id]: true },\n                selectedLinearElement: isLinearElement(element)\n                  ? new LinearElementEditor(element, this.scene)\n                  : null,\n              },\n              this.scene.getNonDeletedElements(),\n              this.state,\n              this,\n            )\n          : this.state),\n        showHyperlinkPopup: false,\n      },\n      () => {\n        this.setState({\n          contextMenu: { top, left, items: this.getContextMenuItems(type) },\n        });\n      },\n    );\n  };\n\n  private maybeDragNewGenericElement = (\n    pointerDownState: PointerDownState,\n    event: MouseEvent | KeyboardEvent,\n  ): void => {\n    const draggingElement = this.state.draggingElement;\n    const pointerCoords = pointerDownState.lastCoords;\n    if (!draggingElement) {\n      return;\n    }\n    if (\n      draggingElement.type === \"selection\" &&\n      this.state.activeTool.type !== \"eraser\"\n    ) {\n      dragNewElement(\n        draggingElement,\n        this.state.activeTool.type,\n        pointerDownState.origin.x,\n        pointerDownState.origin.y,\n        pointerCoords.x,\n        pointerCoords.y,\n        distance(pointerDownState.origin.x, pointerCoords.x),\n        distance(pointerDownState.origin.y, pointerCoords.y),\n        shouldMaintainAspectRatio(event),\n        shouldResizeFromCenter(event),\n      );\n    } else {\n      const [gridX, gridY] = getGridPoint(\n        pointerCoords.x,\n        pointerCoords.y,\n        this.state.gridSize,\n      );\n\n      const image =\n        isInitializedImageElement(draggingElement) &&\n        this.imageCache.get(draggingElement.fileId)?.image;\n      const aspectRatio =\n        image && !(image instanceof Promise)\n          ? image.width / image.height\n          : null;\n\n      dragNewElement(\n        draggingElement,\n        this.state.activeTool.type,\n        pointerDownState.originInGrid.x,\n        pointerDownState.originInGrid.y,\n        gridX,\n        gridY,\n        distance(pointerDownState.originInGrid.x, gridX),\n        distance(pointerDownState.originInGrid.y, gridY),\n        isImageElement(draggingElement)\n          ? !shouldMaintainAspectRatio(event)\n          : shouldMaintainAspectRatio(event),\n        shouldResizeFromCenter(event),\n        aspectRatio,\n      );\n\n      this.maybeSuggestBindingForAll([draggingElement]);\n\n      // highlight elements that are to be added to frames on frames creation\n      if (this.state.activeTool.type === \"frame\") {\n        this.setState({\n          elementsToHighlight: getElementsInResizingFrame(\n            this.scene.getNonDeletedElements(),\n            draggingElement as ExcalidrawFrameElement,\n            this.state,\n          ),\n        });\n      }\n    }\n  };\n\n  private maybeHandleResize = (\n    pointerDownState: PointerDownState,\n    event: MouseEvent | KeyboardEvent,\n  ): boolean => {\n    const selectedElements = this.scene.getSelectedElements(this.state);\n    const selectedFrames = selectedElements.filter(\n      (element) => element.type === \"frame\",\n    ) as ExcalidrawFrameElement[];\n\n    const transformHandleType = pointerDownState.resize.handleType;\n\n    if (selectedFrames.length > 0 && transformHandleType === \"rotation\") {\n      return false;\n    }\n\n    this.setState({\n      // TODO: rename this state field to \"isScaling\" to distinguish\n      // it from the generic \"isResizing\" which includes scaling and\n      // rotating\n      isResizing: transformHandleType && transformHandleType !== \"rotation\",\n      isRotating: transformHandleType === \"rotation\",\n    });\n    const pointerCoords = pointerDownState.lastCoords;\n    const [resizeX, resizeY] = getGridPoint(\n      pointerCoords.x - pointerDownState.resize.offset.x,\n      pointerCoords.y - pointerDownState.resize.offset.y,\n      this.state.gridSize,\n    );\n\n    const frameElementsOffsetsMap = new Map<\n      string,\n      {\n        x: number;\n        y: number;\n      }\n    >();\n\n    selectedFrames.forEach((frame) => {\n      const elementsInFrame = getFrameElements(\n        this.scene.getNonDeletedElements(),\n        frame.id,\n      );\n\n      elementsInFrame.forEach((element) => {\n        frameElementsOffsetsMap.set(frame.id + element.id, {\n          x: element.x - frame.x,\n          y: element.y - frame.y,\n        });\n      });\n    });\n\n    if (\n      transformElements(\n        pointerDownState,\n        transformHandleType,\n        selectedElements,\n        pointerDownState.resize.arrowDirection,\n        shouldRotateWithDiscreteAngle(event),\n        shouldResizeFromCenter(event),\n        selectedElements.length === 1 && isImageElement(selectedElements[0])\n          ? !shouldMaintainAspectRatio(event)\n          : shouldMaintainAspectRatio(event),\n        resizeX,\n        resizeY,\n        pointerDownState.resize.center.x,\n        pointerDownState.resize.center.y,\n      )\n    ) {\n      this.maybeSuggestBindingForAll(selectedElements);\n\n      const elementsToHighlight = new Set<ExcalidrawElement>();\n      selectedFrames.forEach((frame) => {\n        const elementsInFrame = getFrameElements(\n          this.scene.getNonDeletedElements(),\n          frame.id,\n        );\n\n        // keep elements' positions relative to their frames on frames resizing\n        if (transformHandleType) {\n          if (transformHandleType.includes(\"w\")) {\n            elementsInFrame.forEach((element) => {\n              mutateElement(element, {\n                x:\n                  frame.x +\n                  (frameElementsOffsetsMap.get(frame.id + element.id)?.x || 0),\n                y:\n                  frame.y +\n                  (frameElementsOffsetsMap.get(frame.id + element.id)?.y || 0),\n              });\n            });\n          }\n          if (transformHandleType.includes(\"n\")) {\n            elementsInFrame.forEach((element) => {\n              mutateElement(element, {\n                x:\n                  frame.x +\n                  (frameElementsOffsetsMap.get(frame.id + element.id)?.x || 0),\n                y:\n                  frame.y +\n                  (frameElementsOffsetsMap.get(frame.id + element.id)?.y || 0),\n              });\n            });\n          }\n        }\n\n        getElementsInResizingFrame(\n          this.scene.getNonDeletedElements(),\n          frame,\n          this.state,\n        ).forEach((element) => elementsToHighlight.add(element));\n      });\n\n      this.setState({\n        elementsToHighlight: [...elementsToHighlight],\n      });\n\n      return true;\n    }\n    return false;\n  };\n\n  private getContextMenuItems = (\n    type: \"canvas\" | \"element\",\n  ): ContextMenuItems => {\n    const options: ContextMenuItems = [];\n\n    options.push(actionCopyAsPng, actionCopyAsSvg);\n\n    // canvas contextMenu\n    // -------------------------------------------------------------------------\n\n    if (type === \"canvas\") {\n      if (this.state.viewModeEnabled) {\n        return [\n          ...options,\n          actionToggleGridMode,\n          actionToggleZenMode,\n          actionToggleViewMode,\n          actionToggleStats,\n        ];\n      }\n\n      return [\n        actionPaste,\n        CONTEXT_MENU_SEPARATOR,\n        actionCopyAsPng,\n        actionCopyAsSvg,\n        copyText,\n        CONTEXT_MENU_SEPARATOR,\n        actionSelectAll,\n        actionUnlockAllElements,\n        CONTEXT_MENU_SEPARATOR,\n        actionToggleGridMode,\n        actionToggleZenMode,\n        actionToggleViewMode,\n        actionToggleStats,\n      ];\n    }\n\n    // element contextMenu\n    // -------------------------------------------------------------------------\n\n    options.push(copyText);\n\n    if (this.state.viewModeEnabled) {\n      return [actionCopy, ...options];\n    }\n\n    return [\n      actionCut,\n      actionCopy,\n      actionPaste,\n      actionSelectAllElementsInFrame,\n      actionRemoveAllElementsFromFrame,\n      CONTEXT_MENU_SEPARATOR,\n      ...options,\n      CONTEXT_MENU_SEPARATOR,\n      actionCopyStyles,\n      actionPasteStyles,\n      CONTEXT_MENU_SEPARATOR,\n      actionGroup,\n      actionUnbindText,\n      actionBindText,\n      actionWrapTextInContainer,\n      actionUngroup,\n      CONTEXT_MENU_SEPARATOR,\n      actionAddToLibrary,\n      CONTEXT_MENU_SEPARATOR,\n      actionSendBackward,\n      actionBringForward,\n      actionSendToBack,\n      actionBringToFront,\n      CONTEXT_MENU_SEPARATOR,\n      actionFlipHorizontal,\n      actionFlipVertical,\n      CONTEXT_MENU_SEPARATOR,\n      actionToggleLinearEditor,\n      actionLink,\n      actionDuplicateSelection,\n      actionToggleElementLock,\n      CONTEXT_MENU_SEPARATOR,\n      actionDeleteSelected,\n    ];\n  };\n\n  private handleWheel = withBatchedUpdates(\n    (event: WheelEvent | React.WheelEvent<HTMLDivElement>) => {\n      event.preventDefault();\n      if (isPanning) {\n        return;\n      }\n\n      const { deltaX, deltaY } = event;\n      // note that event.ctrlKey is necessary to handle pinch zooming\n      if (event.metaKey || event.ctrlKey) {\n        const sign = Math.sign(deltaY);\n        const MAX_STEP = ZOOM_STEP * 100;\n        const absDelta = Math.abs(deltaY);\n        let delta = deltaY;\n        if (absDelta > MAX_STEP) {\n          delta = MAX_STEP * sign;\n        }\n\n        let newZoom = this.state.zoom.value - delta / 100;\n        // increase zoom steps the more zoomed-in we are (applies to >100% only)\n        newZoom +=\n          Math.log10(Math.max(1, this.state.zoom.value)) *\n          -sign *\n          // reduced amplification for small deltas (small movements on a trackpad)\n          Math.min(1, absDelta / 20);\n\n        this.translateCanvas((state) => ({\n          ...getStateForZoom(\n            {\n              viewportX: this.lastViewportPosition.x,\n              viewportY: this.lastViewportPosition.y,\n              nextZoom: getNormalizedZoom(newZoom),\n            },\n            state,\n          ),\n          shouldCacheIgnoreZoom: true,\n        }));\n        this.resetShouldCacheIgnoreZoomDebounced();\n        return;\n      }\n\n      // scroll horizontally when shift pressed\n      if (event.shiftKey) {\n        this.translateCanvas(({ zoom, scrollX }) => ({\n          // on Mac, shift+wheel tends to result in deltaX\n          scrollX: scrollX - (deltaY || deltaX) / zoom.value,\n        }));\n        return;\n      }\n\n      this.translateCanvas(({ zoom, scrollX, scrollY }) => ({\n        scrollX: scrollX - deltaX / zoom.value,\n        scrollY: scrollY - deltaY / zoom.value,\n      }));\n    },\n  );\n\n  private getTextWysiwygSnappedToCenterPosition(\n    x: number,\n    y: number,\n    appState: AppState,\n    container?: ExcalidrawTextContainer | null,\n  ) {\n    if (container) {\n      let elementCenterX = container.x + container.width / 2;\n      let elementCenterY = container.y + container.height / 2;\n\n      const elementCenter = getContainerCenter(container, appState);\n      if (elementCenter) {\n        elementCenterX = elementCenter.x;\n        elementCenterY = elementCenter.y;\n      }\n      const distanceToCenter = Math.hypot(\n        x - elementCenterX,\n        y - elementCenterY,\n      );\n      const isSnappedToCenter =\n        distanceToCenter < TEXT_TO_CENTER_SNAP_THRESHOLD;\n      if (isSnappedToCenter) {\n        const { x: viewportX, y: viewportY } = sceneCoordsToViewportCoords(\n          { sceneX: elementCenterX, sceneY: elementCenterY },\n          appState,\n        );\n        return { viewportX, viewportY, elementCenterX, elementCenterY };\n      }\n    }\n  }\n\n  private savePointer = (x: number, y: number, button: \"up\" | \"down\") => {\n    if (!x || !y) {\n      return;\n    }\n    const pointer = viewportCoordsToSceneCoords(\n      { clientX: x, clientY: y },\n      this.state,\n    );\n\n    if (isNaN(pointer.x) || isNaN(pointer.y)) {\n      // sometimes the pointer goes off screen\n    }\n\n    this.props.onPointerUpdate?.({\n      pointer,\n      button,\n      pointersMap: gesture.pointers,\n    });\n  };\n\n  private resetShouldCacheIgnoreZoomDebounced = debounce(() => {\n    if (!this.unmounted) {\n      this.setState({ shouldCacheIgnoreZoom: false });\n    }\n  }, 300);\n\n  private updateDOMRect = (cb?: () => void) => {\n    if (this.excalidrawContainerRef?.current) {\n      const excalidrawContainer = this.excalidrawContainerRef.current;\n      const {\n        width,\n        height,\n        left: offsetLeft,\n        top: offsetTop,\n      } = excalidrawContainer.getBoundingClientRect();\n      const {\n        width: currentWidth,\n        height: currentHeight,\n        offsetTop: currentOffsetTop,\n        offsetLeft: currentOffsetLeft,\n      } = this.state;\n\n      if (\n        width === currentWidth &&\n        height === currentHeight &&\n        offsetLeft === currentOffsetLeft &&\n        offsetTop === currentOffsetTop\n      ) {\n        if (cb) {\n          cb();\n        }\n        return;\n      }\n\n      this.setState(\n        {\n          width,\n          height,\n          offsetLeft,\n          offsetTop,\n        },\n        () => {\n          cb && cb();\n        },\n      );\n    }\n  };\n\n  public refresh = () => {\n    this.setState({ ...this.getCanvasOffsets() });\n  };\n\n  private getCanvasOffsets(): Pick<AppState, \"offsetTop\" | \"offsetLeft\"> {\n    if (this.excalidrawContainerRef?.current) {\n      const excalidrawContainer = this.excalidrawContainerRef.current;\n      const { left, top } = excalidrawContainer.getBoundingClientRect();\n      return {\n        offsetLeft: left,\n        offsetTop: top,\n      };\n    }\n    return {\n      offsetLeft: 0,\n      offsetTop: 0,\n    };\n  }\n\n  private async updateLanguage() {\n    const currentLang =\n      languages.find((lang) => lang.code === this.props.langCode) ||\n      defaultLang;\n    await setLanguage(currentLang);\n    this.setAppState({});\n  }\n}\n\n// -----------------------------------------------------------------------------\n// TEST HOOKS\n// -----------------------------------------------------------------------------\n\ndeclare global {\n  interface Window {\n    h: {\n      elements: readonly ExcalidrawElement[];\n      state: AppState;\n      setState: React.Component<any, AppState>[\"setState\"];\n      app: InstanceType<typeof App>;\n      history: History;\n    };\n  }\n}\n\nif (\n  process.env.NODE_ENV === ENV.TEST ||\n  process.env.NODE_ENV === ENV.DEVELOPMENT\n) {\n  window.h = window.h || ({} as Window[\"h\"]);\n\n  Object.defineProperties(window.h, {\n    elements: {\n      configurable: true,\n      get() {\n        return this.app?.scene.getElementsIncludingDeleted();\n      },\n      set(elements: ExcalidrawElement[]) {\n        return this.app?.scene.replaceAllElements(elements);\n      },\n    },\n  });\n}\n\nexport default App;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}