{"ast":null,"code":"import _toConsumableArray from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import{fileOpen as _fileOpen,fileSave as _fileSave,supported as nativeFileSystemSupported}from\"browser-fs-access\";import{EVENT,MIME_TYPES}from\"../constants\";import{AbortError}from\"../errors\";import{debounce}from\"../utils\";var INPUT_CHANGE_INTERVAL_MS=500;export var fileOpen=function fileOpen(opts){var _opts$extensions,_opts$extensions2,_opts$multiple;// an unsafe TS hack, alas not much we can do AFAIK\nvar mimeTypes=(_opts$extensions=opts.extensions)===null||_opts$extensions===void 0?void 0:_opts$extensions.reduce(function(mimeTypes,type){mimeTypes.push(MIME_TYPES[type]);return mimeTypes;},[]);var extensions=(_opts$extensions2=opts.extensions)===null||_opts$extensions2===void 0?void 0:_opts$extensions2.reduce(function(acc,ext){if(ext===\"jpg\"){return acc.concat(\".jpg\",\".jpeg\");}return acc.concat(\".\".concat(ext));},[]);return _fileOpen({description:opts.description,extensions:extensions,mimeTypes:mimeTypes,multiple:(_opts$multiple=opts.multiple)!==null&&_opts$multiple!==void 0?_opts$multiple:false,legacySetup:function legacySetup(resolve,reject,input){var scheduleRejection=debounce(reject,INPUT_CHANGE_INTERVAL_MS);var focusHandler=function focusHandler(){checkForFile();document.addEventListener(EVENT.KEYUP,scheduleRejection);document.addEventListener(EVENT.POINTER_UP,scheduleRejection);scheduleRejection();};var checkForFile=function checkForFile(){var _input$files;// this hack might not work when expecting multiple files\nif((_input$files=input.files)!==null&&_input$files!==void 0&&_input$files.length){var ret=opts.multiple?_toConsumableArray(input.files):input.files[0];resolve(ret);}};requestAnimationFrame(function(){window.addEventListener(EVENT.FOCUS,focusHandler);});var interval=window.setInterval(function(){checkForFile();},INPUT_CHANGE_INTERVAL_MS);return function(rejectPromise){clearInterval(interval);scheduleRejection.cancel();window.removeEventListener(EVENT.FOCUS,focusHandler);document.removeEventListener(EVENT.KEYUP,scheduleRejection);document.removeEventListener(EVENT.POINTER_UP,scheduleRejection);if(rejectPromise){// so that something is shown in console if we need to debug this\nconsole.warn(\"Opening the file was canceled (legacy-fs).\");rejectPromise(new AbortError());}};}});};export var fileSave=function fileSave(blob,opts){return _fileSave(blob,{fileName:\"\".concat(opts.name,\".\").concat(opts.extension),description:opts.description,extensions:[\".\".concat(opts.extension)]},opts.fileHandle);};export{nativeFileSystemSupported};","map":{"version":3,"names":["fileOpen","_fileOpen","fileSave","_fileSave","supported","nativeFileSystemSupported","EVENT","MIME_TYPES","AbortError","debounce","INPUT_CHANGE_INTERVAL_MS","opts","_opts$extensions","_opts$extensions2","_opts$multiple","mimeTypes","extensions","reduce","type","push","acc","ext","concat","description","multiple","legacySetup","resolve","reject","input","scheduleRejection","focusHandler","checkForFile","document","addEventListener","KEYUP","POINTER_UP","_input$files","files","length","ret","_toConsumableArray","requestAnimationFrame","window","FOCUS","interval","setInterval","rejectPromise","clearInterval","cancel","removeEventListener","console","warn","blob","fileName","name","extension","fileHandle"],"sources":["D:/project/excalidraw-cn/src/data/filesystem.ts"],"sourcesContent":["import {\n  fileOpen as _fileOpen,\n  fileSave as _fileSave,\n  FileSystemHandle,\n  supported as nativeFileSystemSupported,\n} from \"browser-fs-access\";\nimport { EVENT, MIME_TYPES } from \"../constants\";\nimport { AbortError } from \"../errors\";\nimport { debounce } from \"../utils\";\n\ntype FILE_EXTENSION = Exclude<keyof typeof MIME_TYPES, \"binary\">;\n\nconst INPUT_CHANGE_INTERVAL_MS = 500;\n\nexport const fileOpen = <M extends boolean | undefined = false>(opts: {\n  extensions?: FILE_EXTENSION[];\n  description: string;\n  multiple?: M;\n}): Promise<M extends false | undefined ? File : File[]> => {\n  // an unsafe TS hack, alas not much we can do AFAIK\n  type RetType = M extends false | undefined ? File : File[];\n\n  const mimeTypes = opts.extensions?.reduce((mimeTypes, type) => {\n    mimeTypes.push(MIME_TYPES[type]);\n\n    return mimeTypes;\n  }, [] as string[]);\n\n  const extensions = opts.extensions?.reduce((acc, ext) => {\n    if (ext === \"jpg\") {\n      return acc.concat(\".jpg\", \".jpeg\");\n    }\n    return acc.concat(`.${ext}`);\n  }, [] as string[]);\n\n  return _fileOpen({\n    description: opts.description,\n    extensions,\n    mimeTypes,\n    multiple: opts.multiple ?? false,\n    legacySetup: (resolve, reject, input) => {\n      const scheduleRejection = debounce(reject, INPUT_CHANGE_INTERVAL_MS);\n      const focusHandler = () => {\n        checkForFile();\n        document.addEventListener(EVENT.KEYUP, scheduleRejection);\n        document.addEventListener(EVENT.POINTER_UP, scheduleRejection);\n        scheduleRejection();\n      };\n      const checkForFile = () => {\n        // this hack might not work when expecting multiple files\n        if (input.files?.length) {\n          const ret = opts.multiple ? [...input.files] : input.files[0];\n          resolve(ret as RetType);\n        }\n      };\n      requestAnimationFrame(() => {\n        window.addEventListener(EVENT.FOCUS, focusHandler);\n      });\n      const interval = window.setInterval(() => {\n        checkForFile();\n      }, INPUT_CHANGE_INTERVAL_MS);\n      return (rejectPromise) => {\n        clearInterval(interval);\n        scheduleRejection.cancel();\n        window.removeEventListener(EVENT.FOCUS, focusHandler);\n        document.removeEventListener(EVENT.KEYUP, scheduleRejection);\n        document.removeEventListener(EVENT.POINTER_UP, scheduleRejection);\n        if (rejectPromise) {\n          // so that something is shown in console if we need to debug this\n          console.warn(\"Opening the file was canceled (legacy-fs).\");\n          rejectPromise(new AbortError());\n        }\n      };\n    },\n  }) as Promise<RetType>;\n};\n\nexport const fileSave = (\n  blob: Blob,\n  opts: {\n    /** supply without the extension */\n    name: string;\n    /** file extension */\n    extension: FILE_EXTENSION;\n    description: string;\n    /** existing FileSystemHandle */\n    fileHandle?: FileSystemHandle | null;\n  },\n) => {\n  return _fileSave(\n    blob,\n    {\n      fileName: `${opts.name}.${opts.extension}`,\n      description: opts.description,\n      extensions: [`.${opts.extension}`],\n    },\n    opts.fileHandle,\n  );\n};\n\nexport type { FileSystemHandle };\nexport { nativeFileSystemSupported };\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}