{"ast":null,"code":"import _regeneratorRuntime from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{ENCRYPTION_KEY_BITS}from\"../constants\";import{blobToArrayBuffer}from\"./blob\";export var IV_LENGTH_BYTES=12;export var createIV=function createIV(){var arr=new Uint8Array(IV_LENGTH_BYTES);return window.crypto.getRandomValues(arr);};export var generateEncryptionKey=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(returnAs){var key;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return window.crypto.subtle.generateKey({name:\"AES-GCM\",length:ENCRYPTION_KEY_BITS},true,// extractable\n[\"encrypt\",\"decrypt\"]);case 2:key=_context.sent;if(!(returnAs===\"cryptoKey\")){_context.next=7;break;}_context.t0=key;_context.next=10;break;case 7:_context.next=9;return window.crypto.subtle.exportKey(\"jwk\",key);case 9:_context.t0=_context.sent.k;case 10:return _context.abrupt(\"return\",_context.t0);case 11:case\"end\":return _context.stop();}},_callee);}));return function generateEncryptionKey(_x){return _ref.apply(this,arguments);};}();export var getCryptoKey=function getCryptoKey(key,usage){return window.crypto.subtle.importKey(\"jwk\",{alg:\"A128GCM\",ext:true,k:key,key_ops:[\"encrypt\",\"decrypt\"],kty:\"oct\"},{name:\"AES-GCM\",length:ENCRYPTION_KEY_BITS},false,// extractable\n[usage]);};export var encryptData=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(key,data){var importedKey,iv,buffer,encryptedBuffer;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:if(!(typeof key===\"string\")){_context2.next=6;break;}_context2.next=3;return getCryptoKey(key,\"encrypt\");case 3:_context2.t0=_context2.sent;_context2.next=7;break;case 6:_context2.t0=key;case 7:importedKey=_context2.t0;iv=createIV();if(!(typeof data===\"string\")){_context2.next=13;break;}_context2.t1=new TextEncoder().encode(data);_context2.next=26;break;case 13:if(!(data instanceof Uint8Array)){_context2.next=17;break;}_context2.t2=data;_context2.next=25;break;case 17:if(!(data instanceof Blob)){_context2.next=23;break;}_context2.next=20;return blobToArrayBuffer(data);case 20:_context2.t3=_context2.sent;_context2.next=24;break;case 23:_context2.t3=data;case 24:_context2.t2=_context2.t3;case 25:_context2.t1=_context2.t2;case 26:buffer=_context2.t1;_context2.next=29;return window.crypto.subtle.encrypt({name:\"AES-GCM\",iv:iv},importedKey,buffer);case 29:encryptedBuffer=_context2.sent;return _context2.abrupt(\"return\",{encryptedBuffer:encryptedBuffer,iv:iv});case 31:case\"end\":return _context2.stop();}},_callee2);}));return function encryptData(_x2,_x3){return _ref2.apply(this,arguments);};}();export var decryptData=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(iv,encrypted,privateKey){var key;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:_context3.next=2;return getCryptoKey(privateKey,\"decrypt\");case 2:key=_context3.sent;return _context3.abrupt(\"return\",window.crypto.subtle.decrypt({name:\"AES-GCM\",iv:iv},key,encrypted));case 4:case\"end\":return _context3.stop();}},_callee3);}));return function decryptData(_x4,_x5,_x6){return _ref3.apply(this,arguments);};}();","map":{"version":3,"names":["ENCRYPTION_KEY_BITS","blobToArrayBuffer","IV_LENGTH_BYTES","createIV","arr","Uint8Array","window","crypto","getRandomValues","generateEncryptionKey","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","returnAs","key","wrap","_callee$","_context","prev","next","subtle","generateKey","name","length","sent","t0","exportKey","k","abrupt","stop","_x","apply","arguments","getCryptoKey","usage","importKey","alg","ext","key_ops","kty","encryptData","_ref2","_callee2","data","importedKey","iv","buffer","encryptedBuffer","_callee2$","_context2","t1","TextEncoder","encode","t2","Blob","t3","encrypt","_x2","_x3","decryptData","_ref3","_callee3","encrypted","privateKey","_callee3$","_context3","decrypt","_x4","_x5","_x6"],"sources":["D:/project/excalidraw-cn/src/data/encryption.ts"],"sourcesContent":["import { ENCRYPTION_KEY_BITS } from \"../constants\";\nimport { blobToArrayBuffer } from \"./blob\";\n\nexport const IV_LENGTH_BYTES = 12;\n\nexport const createIV = () => {\n  const arr = new Uint8Array(IV_LENGTH_BYTES);\n  return window.crypto.getRandomValues(arr);\n};\n\nexport const generateEncryptionKey = async <\n  T extends \"string\" | \"cryptoKey\" = \"string\",\n>(\n  returnAs?: T,\n): Promise<T extends \"cryptoKey\" ? CryptoKey : string> => {\n  const key = await window.crypto.subtle.generateKey(\n    {\n      name: \"AES-GCM\",\n      length: ENCRYPTION_KEY_BITS,\n    },\n    true, // extractable\n    [\"encrypt\", \"decrypt\"],\n  );\n  return (\n    returnAs === \"cryptoKey\"\n      ? key\n      : (await window.crypto.subtle.exportKey(\"jwk\", key)).k\n  ) as T extends \"cryptoKey\" ? CryptoKey : string;\n};\n\nexport const getCryptoKey = (key: string, usage: KeyUsage) =>\n  window.crypto.subtle.importKey(\n    \"jwk\",\n    {\n      alg: \"A128GCM\",\n      ext: true,\n      k: key,\n      key_ops: [\"encrypt\", \"decrypt\"],\n      kty: \"oct\",\n    },\n    {\n      name: \"AES-GCM\",\n      length: ENCRYPTION_KEY_BITS,\n    },\n    false, // extractable\n    [usage],\n  );\n\nexport const encryptData = async (\n  key: string | CryptoKey,\n  data: Uint8Array | ArrayBuffer | Blob | File | string,\n): Promise<{ encryptedBuffer: ArrayBuffer; iv: Uint8Array }> => {\n  const importedKey =\n    typeof key === \"string\" ? await getCryptoKey(key, \"encrypt\") : key;\n  const iv = createIV();\n  const buffer: ArrayBuffer | Uint8Array =\n    typeof data === \"string\"\n      ? new TextEncoder().encode(data)\n      : data instanceof Uint8Array\n      ? data\n      : data instanceof Blob\n      ? await blobToArrayBuffer(data)\n      : data;\n\n  // We use symmetric encryption. AES-GCM is the recommended algorithm and\n  // includes checks that the ciphertext has not been modified by an attacker.\n  const encryptedBuffer = await window.crypto.subtle.encrypt(\n    {\n      name: \"AES-GCM\",\n      iv,\n    },\n    importedKey,\n    buffer as ArrayBuffer | Uint8Array,\n  );\n\n  return { encryptedBuffer, iv };\n};\n\nexport const decryptData = async (\n  iv: Uint8Array,\n  encrypted: Uint8Array | ArrayBuffer,\n  privateKey: string,\n): Promise<ArrayBuffer> => {\n  const key = await getCryptoKey(privateKey, \"decrypt\");\n  return window.crypto.subtle.decrypt(\n    {\n      name: \"AES-GCM\",\n      iv,\n    },\n    key,\n    encrypted,\n  );\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}