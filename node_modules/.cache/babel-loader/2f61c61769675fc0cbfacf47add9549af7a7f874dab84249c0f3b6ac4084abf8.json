{"ast":null,"code":"import { __values } from \"tslib\";\nimport { API } from '@sentry/core';\nimport { Status } from '@sentry/types';\nimport { logger, parseRetryAfterHeader, PromiseBuffer, SentryError } from '@sentry/utils';\nvar CATEGORY_MAPPING = {\n  event: 'error',\n  transaction: 'transaction',\n  session: 'session'\n};\n/** Base Transport class implementation */\nvar BaseTransport = /** @class */function () {\n  function BaseTransport(options) {\n    this.options = options;\n    /** A simple buffer holding all requests. */\n    this._buffer = new PromiseBuffer(30);\n    /** Locks transport after receiving rate limits in a response */\n    this._rateLimits = {};\n    this._api = new API(options.dsn, options._metadata);\n    // eslint-disable-next-line deprecation/deprecation\n    this.url = this._api.getStoreEndpointWithUrlEncodedAuth();\n  }\n  /**\n   * @inheritDoc\n   */\n  BaseTransport.prototype.sendEvent = function (_) {\n    throw new SentryError('Transport Class has to implement `sendEvent` method');\n  };\n  /**\n   * @inheritDoc\n   */\n  BaseTransport.prototype.close = function (timeout) {\n    return this._buffer.drain(timeout);\n  };\n  /**\n   * Handle Sentry repsonse for promise-based transports.\n   */\n  BaseTransport.prototype._handleResponse = function (_a) {\n    var requestType = _a.requestType,\n      response = _a.response,\n      headers = _a.headers,\n      resolve = _a.resolve,\n      reject = _a.reject;\n    var status = Status.fromHttpCode(response.status);\n    /**\n     * \"The name is case-insensitive.\"\n     * https://developer.mozilla.org/en-US/docs/Web/API/Headers/get\n     */\n    var limited = this._handleRateLimit(headers);\n    if (limited) logger.warn(\"Too many requests, backing off until: \" + this._disabledUntil(requestType));\n    if (status === Status.Success) {\n      resolve({\n        status: status\n      });\n      return;\n    }\n    reject(response);\n  };\n  /**\n   * Gets the time that given category is disabled until for rate limiting\n   */\n  BaseTransport.prototype._disabledUntil = function (requestType) {\n    var category = CATEGORY_MAPPING[requestType];\n    return this._rateLimits[category] || this._rateLimits.all;\n  };\n  /**\n   * Checks if a category is rate limited\n   */\n  BaseTransport.prototype._isRateLimited = function (requestType) {\n    return this._disabledUntil(requestType) > new Date(Date.now());\n  };\n  /**\n   * Sets internal _rateLimits from incoming headers. Returns true if headers contains a non-empty rate limiting header.\n   */\n  BaseTransport.prototype._handleRateLimit = function (headers) {\n    var e_1, _a, e_2, _b;\n    var now = Date.now();\n    var rlHeader = headers['x-sentry-rate-limits'];\n    var raHeader = headers['retry-after'];\n    if (rlHeader) {\n      try {\n        // rate limit headers are of the form\n        //     <header>,<header>,..\n        // where each <header> is of the form\n        //     <retry_after>: <categories>: <scope>: <reason_code>\n        // where\n        //     <retry_after> is a delay in ms\n        //     <categories> is the event type(s) (error, transaction, etc) being rate limited and is of the form\n        //         <category>;<category>;...\n        //     <scope> is what's being limited (org, project, or key) - ignored by SDK\n        //     <reason_code> is an arbitrary string like \"org_quota\" - ignored by SDK\n        for (var _c = __values(rlHeader.trim().split(',')), _d = _c.next(); !_d.done; _d = _c.next()) {\n          var limit = _d.value;\n          var parameters = limit.split(':', 2);\n          var headerDelay = parseInt(parameters[0], 10);\n          var delay = (!isNaN(headerDelay) ? headerDelay : 60) * 1000; // 60sec default\n          try {\n            for (var _e = (e_2 = void 0, __values(parameters[1].split(';'))), _f = _e.next(); !_f.done; _f = _e.next()) {\n              var category = _f.value;\n              this._rateLimits[category || 'all'] = new Date(now + delay);\n            }\n          } catch (e_2_1) {\n            e_2 = {\n              error: e_2_1\n            };\n          } finally {\n            try {\n              if (_f && !_f.done && (_b = _e.return)) _b.call(_e);\n            } finally {\n              if (e_2) throw e_2.error;\n            }\n          }\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (_d && !_d.done && (_a = _c.return)) _a.call(_c);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n      return true;\n    } else if (raHeader) {\n      this._rateLimits.all = new Date(now + parseRetryAfterHeader(now, raHeader));\n      return true;\n    }\n    return false;\n  };\n  return BaseTransport;\n}();\nexport { BaseTransport };","map":{"version":3,"names":["API","Status","logger","parseRetryAfterHeader","PromiseBuffer","SentryError","CATEGORY_MAPPING","event","transaction","session","BaseTransport","options","_buffer","_rateLimits","_api","dsn","_metadata","url","getStoreEndpointWithUrlEncodedAuth","prototype","sendEvent","_","close","timeout","drain","_handleResponse","_a","requestType","response","headers","resolve","reject","status","fromHttpCode","limited","_handleRateLimit","warn","_disabledUntil","Success","category","all","_isRateLimited","Date","now","rlHeader","raHeader","_c","__values","trim","split","_d","next","done","limit","value","parameters","headerDelay","parseInt","delay","isNaN","_e","e_2","_f"],"sources":["D:\\project\\excalidraw-cn\\node_modules\\@sentry\\browser\\src\\transports\\base.ts"],"sourcesContent":["import { API } from '@sentry/core';\nimport {\n  Event,\n  Response as SentryResponse,\n  SentryRequestType,\n  Status,\n  Transport,\n  TransportOptions,\n} from '@sentry/types';\nimport { logger, parseRetryAfterHeader, PromiseBuffer, SentryError } from '@sentry/utils';\n\nconst CATEGORY_MAPPING: {\n  [key in SentryRequestType]: string;\n} = {\n  event: 'error',\n  transaction: 'transaction',\n  session: 'session',\n};\n\n/** Base Transport class implementation */\nexport abstract class BaseTransport implements Transport {\n  /**\n   * @deprecated\n   */\n  public url: string;\n\n  /** Helper to get Sentry API endpoints. */\n  protected readonly _api: API;\n\n  /** A simple buffer holding all requests. */\n  protected readonly _buffer: PromiseBuffer<SentryResponse> = new PromiseBuffer(30);\n\n  /** Locks transport after receiving rate limits in a response */\n  protected readonly _rateLimits: Record<string, Date> = {};\n\n  public constructor(public options: TransportOptions) {\n    this._api = new API(options.dsn, options._metadata);\n    // eslint-disable-next-line deprecation/deprecation\n    this.url = this._api.getStoreEndpointWithUrlEncodedAuth();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public sendEvent(_: Event): PromiseLike<SentryResponse> {\n    throw new SentryError('Transport Class has to implement `sendEvent` method');\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public close(timeout?: number): PromiseLike<boolean> {\n    return this._buffer.drain(timeout);\n  }\n\n  /**\n   * Handle Sentry repsonse for promise-based transports.\n   */\n  protected _handleResponse({\n    requestType,\n    response,\n    headers,\n    resolve,\n    reject,\n  }: {\n    requestType: SentryRequestType;\n    response: Response | XMLHttpRequest;\n    headers: Record<string, string | null>;\n    resolve: (value?: SentryResponse | PromiseLike<SentryResponse> | null | undefined) => void;\n    reject: (reason?: unknown) => void;\n  }): void {\n    const status = Status.fromHttpCode(response.status);\n    /**\n     * \"The name is case-insensitive.\"\n     * https://developer.mozilla.org/en-US/docs/Web/API/Headers/get\n     */\n    const limited = this._handleRateLimit(headers);\n    if (limited) logger.warn(`Too many requests, backing off until: ${this._disabledUntil(requestType)}`);\n\n    if (status === Status.Success) {\n      resolve({ status });\n      return;\n    }\n\n    reject(response);\n  }\n\n  /**\n   * Gets the time that given category is disabled until for rate limiting\n   */\n  protected _disabledUntil(requestType: SentryRequestType): Date {\n    const category = CATEGORY_MAPPING[requestType];\n    return this._rateLimits[category] || this._rateLimits.all;\n  }\n\n  /**\n   * Checks if a category is rate limited\n   */\n  protected _isRateLimited(requestType: SentryRequestType): boolean {\n    return this._disabledUntil(requestType) > new Date(Date.now());\n  }\n\n  /**\n   * Sets internal _rateLimits from incoming headers. Returns true if headers contains a non-empty rate limiting header.\n   */\n  protected _handleRateLimit(headers: Record<string, string | null>): boolean {\n    const now = Date.now();\n    const rlHeader = headers['x-sentry-rate-limits'];\n    const raHeader = headers['retry-after'];\n\n    if (rlHeader) {\n      // rate limit headers are of the form\n      //     <header>,<header>,..\n      // where each <header> is of the form\n      //     <retry_after>: <categories>: <scope>: <reason_code>\n      // where\n      //     <retry_after> is a delay in ms\n      //     <categories> is the event type(s) (error, transaction, etc) being rate limited and is of the form\n      //         <category>;<category>;...\n      //     <scope> is what's being limited (org, project, or key) - ignored by SDK\n      //     <reason_code> is an arbitrary string like \"org_quota\" - ignored by SDK\n      for (const limit of rlHeader.trim().split(',')) {\n        const parameters = limit.split(':', 2);\n        const headerDelay = parseInt(parameters[0], 10);\n        const delay = (!isNaN(headerDelay) ? headerDelay : 60) * 1000; // 60sec default\n        for (const category of parameters[1].split(';')) {\n          this._rateLimits[category || 'all'] = new Date(now + delay);\n        }\n      }\n      return true;\n    } else if (raHeader) {\n      this._rateLimits.all = new Date(now + parseRetryAfterHeader(now, raHeader));\n      return true;\n    }\n    return false;\n  }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}