{"ast":null,"code":"import _toConsumableArray from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _createClass from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _classCallCheck from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _regeneratorRuntime from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{getSceneVersion}from\"../../element\";import{restoreElements}from\"../../data/restore\";import{FILE_CACHE_MAX_AGE_SEC}from\"../app_constants\";import{decompressData}from\"../../data/encode\";import{encryptData,decryptData}from\"../../data/encryption\";import{MIME_TYPES}from\"../../constants\";import{reconcileElements}from\"../collab/reconciliation\";import{getSyncableElements}from\".\";// private\n// -----------------------------------------------------------------------------\nvar FIREBASE_CONFIG;try{FIREBASE_CONFIG=JSON.parse(process.env.REACT_APP_FIREBASE_CONFIG);}catch(error){console.warn(\"Error JSON parsing firebase config. Supplied value: \".concat(process.env.REACT_APP_FIREBASE_CONFIG));FIREBASE_CONFIG={};}var firebasePromise=null;var firestorePromise=null;var firebaseStoragePromise=null;var isFirebaseInitialized=false;var _loadFirebase=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){var firebase;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return import(/* webpackChunkName: \"firebase\" */\"firebase/app\");case 2:firebase=_context.sent.default;if(isFirebaseInitialized){_context.next=16;break;}_context.prev=4;firebase.initializeApp(FIREBASE_CONFIG);_context.next=15;break;case 8:_context.prev=8;_context.t0=_context[\"catch\"](4);if(!(_context.t0.code===\"app/duplicate-app\")){_context.next=14;break;}console.warn(_context.t0.name,_context.t0.code);_context.next=15;break;case 14:throw _context.t0;case 15:isFirebaseInitialized=true;case 16:return _context.abrupt(\"return\",firebase);case 17:case\"end\":return _context.stop();}},_callee,null,[[4,8]]);}));return function _loadFirebase(){return _ref.apply(this,arguments);};}();var _getFirebase=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:if(!firebasePromise){firebasePromise=_loadFirebase();}return _context2.abrupt(\"return\",firebasePromise);case 2:case\"end\":return _context2.stop();}},_callee2);}));return function _getFirebase(){return _ref2.apply(this,arguments);};}();// -----------------------------------------------------------------------------\nvar loadFirestore=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var firebase;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _getFirebase();case 2:firebase=_context3.sent;if(!firestorePromise){firestorePromise=import(/* webpackChunkName: \"firestore\" */\"firebase/firestore\");}if(!(firestorePromise!==true)){_context3.next=8;break;}_context3.next=7;return firestorePromise;case 7:firestorePromise=true;case 8:return _context3.abrupt(\"return\",firebase);case 9:case\"end\":return _context3.stop();}},_callee3);}));return function loadFirestore(){return _ref3.apply(this,arguments);};}();export var loadFirebaseStorage=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(){var firebase;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:_context4.next=2;return _getFirebase();case 2:firebase=_context4.sent;if(!firebaseStoragePromise){firebaseStoragePromise=import(/* webpackChunkName: \"storage\" */\"firebase/storage\");}if(!(firebaseStoragePromise!==true)){_context4.next=8;break;}_context4.next=7;return firebaseStoragePromise;case 7:firebaseStoragePromise=true;case 8:return _context4.abrupt(\"return\",firebase);case 9:case\"end\":return _context4.stop();}},_callee4);}));return function loadFirebaseStorage(){return _ref4.apply(this,arguments);};}();var encryptElements=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(key,elements){var json,encoded,_yield$encryptData,encryptedBuffer,iv;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:json=JSON.stringify(elements);encoded=new TextEncoder().encode(json);_context5.next=4;return encryptData(key,encoded);case 4:_yield$encryptData=_context5.sent;encryptedBuffer=_yield$encryptData.encryptedBuffer;iv=_yield$encryptData.iv;return _context5.abrupt(\"return\",{ciphertext:encryptedBuffer,iv:iv});case 8:case\"end\":return _context5.stop();}},_callee5);}));return function encryptElements(_x,_x2){return _ref5.apply(this,arguments);};}();var decryptElements=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(data,roomKey){var ciphertext,iv,decrypted,decodedData;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:ciphertext=data.ciphertext.toUint8Array();iv=data.iv.toUint8Array();_context6.next=4;return decryptData(iv,ciphertext,roomKey);case 4:decrypted=_context6.sent;decodedData=new TextDecoder(\"utf-8\").decode(new Uint8Array(decrypted));return _context6.abrupt(\"return\",JSON.parse(decodedData));case 7:case\"end\":return _context6.stop();}},_callee6);}));return function decryptElements(_x3,_x4){return _ref6.apply(this,arguments);};}();var FirebaseSceneVersionCache=/*#__PURE__*/_createClass(function FirebaseSceneVersionCache(){_classCallCheck(this,FirebaseSceneVersionCache);});FirebaseSceneVersionCache.cache=new WeakMap();FirebaseSceneVersionCache.get=function(socket){return FirebaseSceneVersionCache.cache.get(socket);};FirebaseSceneVersionCache.set=function(socket,elements){FirebaseSceneVersionCache.cache.set(socket,getSceneVersion(elements));};export var isSavedToFirebase=function isSavedToFirebase(portal,elements){if(portal.socket&&portal.roomId&&portal.roomKey){var sceneVersion=getSceneVersion(elements);return FirebaseSceneVersionCache.get(portal.socket)===sceneVersion;}// if no room exists, consider the room saved so that we don't unnecessarily\n// prevent unload (there's nothing we could do at that point anyway)\nreturn true;};export var saveFilesToFirebase=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(_ref7){var prefix,files,firebase,erroredFiles,savedFiles;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:prefix=_ref7.prefix,files=_ref7.files;_context8.next=3;return loadFirebaseStorage();case 3:firebase=_context8.sent;erroredFiles=new Map();savedFiles=new Map();_context8.next=8;return Promise.all(files.map(/*#__PURE__*/function(){var _ref10=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(_ref9){var id,buffer;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:id=_ref9.id,buffer=_ref9.buffer;_context7.prev=1;_context7.next=4;return firebase.storage().ref(\"\".concat(prefix,\"/\").concat(id)).put(new Blob([buffer],{type:MIME_TYPES.binary}),{cacheControl:\"public, max-age=\".concat(FILE_CACHE_MAX_AGE_SEC)});case 4:savedFiles.set(id,true);_context7.next=10;break;case 7:_context7.prev=7;_context7.t0=_context7[\"catch\"](1);erroredFiles.set(id,true);case 10:case\"end\":return _context7.stop();}},_callee7,null,[[1,7]]);}));return function(_x6){return _ref10.apply(this,arguments);};}()));case 8:return _context8.abrupt(\"return\",{savedFiles:savedFiles,erroredFiles:erroredFiles});case 9:case\"end\":return _context8.stop();}},_callee8);}));return function saveFilesToFirebase(_x5){return _ref8.apply(this,arguments);};}();var createFirebaseSceneDocument=/*#__PURE__*/function(){var _ref11=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(firebase,elements,roomKey){var sceneVersion,_yield$encryptElement,ciphertext,iv;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:sceneVersion=getSceneVersion(elements);_context9.next=3;return encryptElements(roomKey,elements);case 3:_yield$encryptElement=_context9.sent;ciphertext=_yield$encryptElement.ciphertext;iv=_yield$encryptElement.iv;return _context9.abrupt(\"return\",{sceneVersion:sceneVersion,ciphertext:firebase.firestore.Blob.fromUint8Array(new Uint8Array(ciphertext)),iv:firebase.firestore.Blob.fromUint8Array(iv)});case 7:case\"end\":return _context9.stop();}},_callee9);}));return function createFirebaseSceneDocument(_x7,_x8,_x9){return _ref11.apply(this,arguments);};}();export var saveToFirebase=/*#__PURE__*/function(){var _ref12=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(portal,elements,appState){var roomId,roomKey,socket,firebase,firestore,docRef,savedData;return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:roomId=portal.roomId,roomKey=portal.roomKey,socket=portal.socket;if(!(// bail if no room exists as there's nothing we can do at this point\n!roomId||!roomKey||!socket||isSavedToFirebase(portal,elements))){_context11.next=3;break;}return _context11.abrupt(\"return\",false);case 3:_context11.next=5;return loadFirestore();case 5:firebase=_context11.sent;firestore=firebase.firestore();docRef=firestore.collection(\"scenes\").doc(roomId);_context11.next=10;return firestore.runTransaction(/*#__PURE__*/function(){var _ref13=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(transaction){var snapshot,_sceneDocument,prevDocData,prevElements,reconciledElements,sceneDocument;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:_context10.next=2;return transaction.get(docRef);case 2:snapshot=_context10.sent;if(snapshot.exists){_context10.next=9;break;}_context10.next=6;return createFirebaseSceneDocument(firebase,elements,roomKey);case 6:_sceneDocument=_context10.sent;transaction.set(docRef,_sceneDocument);return _context10.abrupt(\"return\",{elements:elements,reconciledElements:null});case 9:prevDocData=snapshot.data();_context10.t0=getSyncableElements;_context10.next=13;return decryptElements(prevDocData,roomKey);case 13:_context10.t1=_context10.sent;prevElements=(0,_context10.t0)(_context10.t1);reconciledElements=getSyncableElements(reconcileElements(elements,prevElements,appState));_context10.next=18;return createFirebaseSceneDocument(firebase,reconciledElements,roomKey);case 18:sceneDocument=_context10.sent;transaction.update(docRef,sceneDocument);return _context10.abrupt(\"return\",{elements:elements,reconciledElements:reconciledElements});case 21:case\"end\":return _context10.stop();}},_callee10);}));return function(_x13){return _ref13.apply(this,arguments);};}());case 10:savedData=_context11.sent;FirebaseSceneVersionCache.set(socket,savedData.elements);return _context11.abrupt(\"return\",{reconciledElements:savedData.reconciledElements});case 13:case\"end\":return _context11.stop();}},_callee11);}));return function saveToFirebase(_x10,_x11,_x12){return _ref12.apply(this,arguments);};}();export var loadFromFirebase=/*#__PURE__*/function(){var _ref14=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(roomId,roomKey,socket){var firebase,db,docRef,doc,storedScene,elements;return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:_context12.next=2;return loadFirestore();case 2:firebase=_context12.sent;db=firebase.firestore();docRef=db.collection(\"scenes\").doc(roomId);_context12.next=7;return docRef.get();case 7:doc=_context12.sent;if(doc.exists){_context12.next=10;break;}return _context12.abrupt(\"return\",null);case 10:storedScene=doc.data();_context12.t0=getSyncableElements;_context12.next=14;return decryptElements(storedScene,roomKey);case 14:_context12.t1=_context12.sent;elements=(0,_context12.t0)(_context12.t1);if(socket){FirebaseSceneVersionCache.set(socket,elements);}return _context12.abrupt(\"return\",restoreElements(elements,null));case 18:case\"end\":return _context12.stop();}},_callee12);}));return function loadFromFirebase(_x14,_x15,_x16){return _ref14.apply(this,arguments);};}();export var loadFilesFromFirebase=/*#__PURE__*/function(){var _ref15=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(prefix,decryptionKey,filesIds){var loadedFiles,erroredFiles;return _regeneratorRuntime().wrap(function _callee14$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:loadedFiles=[];erroredFiles=new Map();_context14.next=4;return Promise.all(_toConsumableArray(new Set(filesIds)).map(/*#__PURE__*/function(){var _ref16=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(id){var url,response,arrayBuffer,_yield$decompressData,data,metadata,dataURL;return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:_context13.prev=0;url=\"https://firebasestorage.googleapis.com/v0/b/\".concat(FIREBASE_CONFIG.storageBucket,\"/o/\").concat(encodeURIComponent(prefix.replace(/^\\//,\"\")),\"%2F\").concat(id);_context13.next=4;return fetch(\"\".concat(url,\"?alt=media\"));case 4:response=_context13.sent;if(!(response.status<400)){_context13.next=18;break;}_context13.next=8;return response.arrayBuffer();case 8:arrayBuffer=_context13.sent;_context13.next=11;return decompressData(new Uint8Array(arrayBuffer),{decryptionKey:decryptionKey});case 11:_yield$decompressData=_context13.sent;data=_yield$decompressData.data;metadata=_yield$decompressData.metadata;dataURL=new TextDecoder().decode(data);loadedFiles.push({mimeType:metadata.mimeType||MIME_TYPES.binary,id:id,dataURL:dataURL,created:(metadata===null||metadata===void 0?void 0:metadata.created)||Date.now(),lastRetrieved:(metadata===null||metadata===void 0?void 0:metadata.created)||Date.now()});_context13.next=19;break;case 18:erroredFiles.set(id,true);case 19:_context13.next=25;break;case 21:_context13.prev=21;_context13.t0=_context13[\"catch\"](0);erroredFiles.set(id,true);console.error(_context13.t0);case 25:case\"end\":return _context13.stop();}},_callee13,null,[[0,21]]);}));return function(_x20){return _ref16.apply(this,arguments);};}()));case 4:return _context14.abrupt(\"return\",{loadedFiles:loadedFiles,erroredFiles:erroredFiles});case 5:case\"end\":return _context14.stop();}},_callee14);}));return function loadFilesFromFirebase(_x17,_x18,_x19){return _ref15.apply(this,arguments);};}();","map":{"version":3,"names":["getSceneVersion","restoreElements","FILE_CACHE_MAX_AGE_SEC","decompressData","encryptData","decryptData","MIME_TYPES","reconcileElements","getSyncableElements","FIREBASE_CONFIG","JSON","parse","process","env","REACT_APP_FIREBASE_CONFIG","error","console","warn","concat","firebasePromise","firestorePromise","firebaseStoragePromise","isFirebaseInitialized","_loadFirebase","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","firebase","wrap","_callee$","_context","prev","next","sent","default","initializeApp","t0","code","name","abrupt","stop","apply","arguments","_getFirebase","_ref2","_callee2","_callee2$","_context2","loadFirestore","_ref3","_callee3","_callee3$","_context3","loadFirebaseStorage","_ref4","_callee4","_callee4$","_context4","encryptElements","_ref5","_callee5","key","elements","json","encoded","_yield$encryptData","encryptedBuffer","iv","_callee5$","_context5","stringify","TextEncoder","encode","ciphertext","_x","_x2","decryptElements","_ref6","_callee6","data","roomKey","decrypted","decodedData","_callee6$","_context6","toUint8Array","TextDecoder","decode","Uint8Array","_x3","_x4","FirebaseSceneVersionCache","_createClass","_classCallCheck","cache","WeakMap","get","socket","set","isSavedToFirebase","portal","roomId","sceneVersion","saveFilesToFirebase","_ref8","_callee8","_ref7","prefix","files","erroredFiles","savedFiles","_callee8$","_context8","Map","Promise","all","map","_ref10","_callee7","_ref9","id","buffer","_callee7$","_context7","storage","ref","put","Blob","type","binary","cacheControl","_x6","_x5","createFirebaseSceneDocument","_ref11","_callee9","_yield$encryptElement","_callee9$","_context9","firestore","fromUint8Array","_x7","_x8","_x9","saveToFirebase","_ref12","_callee11","appState","docRef","savedData","_callee11$","_context11","collection","doc","runTransaction","_ref13","_callee10","transaction","snapshot","_sceneDocument","prevDocData","prevElements","reconciledElements","sceneDocument","_callee10$","_context10","exists","t1","update","_x13","_x10","_x11","_x12","loadFromFirebase","_ref14","_callee12","db","storedScene","_callee12$","_context12","_x14","_x15","_x16","loadFilesFromFirebase","_ref15","_callee14","decryptionKey","filesIds","loadedFiles","_callee14$","_context14","_toConsumableArray","Set","_ref16","_callee13","url","response","arrayBuffer","_yield$decompressData","metadata","dataURL","_callee13$","_context13","storageBucket","encodeURIComponent","replace","fetch","status","push","mimeType","created","Date","now","lastRetrieved","_x20","_x17","_x18","_x19"],"sources":["D:/project/excalidraw-cn/src/excalidraw-app/data/firebase.ts"],"sourcesContent":["import { ExcalidrawElement, FileId } from \"../../element/types\";\nimport { getSceneVersion } from \"../../element\";\nimport Portal from \"../collab/Portal\";\nimport { restoreElements } from \"../../data/restore\";\nimport {\n  AppState,\n  BinaryFileData,\n  BinaryFileMetadata,\n  DataURL,\n} from \"../../types\";\nimport { FILE_CACHE_MAX_AGE_SEC } from \"../app_constants\";\nimport { decompressData } from \"../../data/encode\";\nimport { encryptData, decryptData } from \"../../data/encryption\";\nimport { MIME_TYPES } from \"../../constants\";\nimport { reconcileElements } from \"../collab/reconciliation\";\nimport { getSyncableElements, SyncableExcalidrawElement } from \".\";\nimport { ResolutionType } from \"../../utility-types\";\n\n// private\n// -----------------------------------------------------------------------------\n\nlet FIREBASE_CONFIG: Record<string, any>;\ntry {\n  FIREBASE_CONFIG = JSON.parse(process.env.REACT_APP_FIREBASE_CONFIG);\n} catch (error: any) {\n  console.warn(\n    `Error JSON parsing firebase config. Supplied value: ${process.env.REACT_APP_FIREBASE_CONFIG}`,\n  );\n  FIREBASE_CONFIG = {};\n}\n\nlet firebasePromise: Promise<typeof import(\"firebase/app\").default> | null =\n  null;\nlet firestorePromise: Promise<any> | null | true = null;\nlet firebaseStoragePromise: Promise<any> | null | true = null;\n\nlet isFirebaseInitialized = false;\n\nconst _loadFirebase = async () => {\n  const firebase = (\n    await import(/* webpackChunkName: \"firebase\" */ \"firebase/app\")\n  ).default;\n\n  if (!isFirebaseInitialized) {\n    try {\n      firebase.initializeApp(FIREBASE_CONFIG);\n    } catch (error: any) {\n      // trying initialize again throws. Usually this is harmless, and happens\n      // mainly in dev (HMR)\n      if (error.code === \"app/duplicate-app\") {\n        console.warn(error.name, error.code);\n      } else {\n        throw error;\n      }\n    }\n    isFirebaseInitialized = true;\n  }\n\n  return firebase;\n};\n\nconst _getFirebase = async (): Promise<\n  typeof import(\"firebase/app\").default\n> => {\n  if (!firebasePromise) {\n    firebasePromise = _loadFirebase();\n  }\n  return firebasePromise;\n};\n\n// -----------------------------------------------------------------------------\n\nconst loadFirestore = async () => {\n  const firebase = await _getFirebase();\n  if (!firestorePromise) {\n    firestorePromise = import(\n      /* webpackChunkName: \"firestore\" */ \"firebase/firestore\"\n    );\n  }\n  if (firestorePromise !== true) {\n    await firestorePromise;\n    firestorePromise = true;\n  }\n  return firebase;\n};\n\nexport const loadFirebaseStorage = async () => {\n  const firebase = await _getFirebase();\n  if (!firebaseStoragePromise) {\n    firebaseStoragePromise = import(\n      /* webpackChunkName: \"storage\" */ \"firebase/storage\"\n    );\n  }\n  if (firebaseStoragePromise !== true) {\n    await firebaseStoragePromise;\n    firebaseStoragePromise = true;\n  }\n  return firebase;\n};\n\ninterface FirebaseStoredScene {\n  sceneVersion: number;\n  iv: firebase.default.firestore.Blob;\n  ciphertext: firebase.default.firestore.Blob;\n}\n\nconst encryptElements = async (\n  key: string,\n  elements: readonly ExcalidrawElement[],\n): Promise<{ ciphertext: ArrayBuffer; iv: Uint8Array }> => {\n  const json = JSON.stringify(elements);\n  const encoded = new TextEncoder().encode(json);\n  const { encryptedBuffer, iv } = await encryptData(key, encoded);\n\n  return { ciphertext: encryptedBuffer, iv };\n};\n\nconst decryptElements = async (\n  data: FirebaseStoredScene,\n  roomKey: string,\n): Promise<readonly ExcalidrawElement[]> => {\n  const ciphertext = data.ciphertext.toUint8Array();\n  const iv = data.iv.toUint8Array();\n\n  const decrypted = await decryptData(iv, ciphertext, roomKey);\n  const decodedData = new TextDecoder(\"utf-8\").decode(\n    new Uint8Array(decrypted),\n  );\n  return JSON.parse(decodedData);\n};\n\nclass FirebaseSceneVersionCache {\n  private static cache = new WeakMap<SocketIOClient.Socket, number>();\n  static get = (socket: SocketIOClient.Socket) => {\n    return FirebaseSceneVersionCache.cache.get(socket);\n  };\n  static set = (\n    socket: SocketIOClient.Socket,\n    elements: readonly SyncableExcalidrawElement[],\n  ) => {\n    FirebaseSceneVersionCache.cache.set(socket, getSceneVersion(elements));\n  };\n}\n\nexport const isSavedToFirebase = (\n  portal: Portal,\n  elements: readonly ExcalidrawElement[],\n): boolean => {\n  if (portal.socket && portal.roomId && portal.roomKey) {\n    const sceneVersion = getSceneVersion(elements);\n\n    return FirebaseSceneVersionCache.get(portal.socket) === sceneVersion;\n  }\n  // if no room exists, consider the room saved so that we don't unnecessarily\n  // prevent unload (there's nothing we could do at that point anyway)\n  return true;\n};\n\nexport const saveFilesToFirebase = async ({\n  prefix,\n  files,\n}: {\n  prefix: string;\n  files: { id: FileId; buffer: Uint8Array }[];\n}) => {\n  const firebase = await loadFirebaseStorage();\n\n  const erroredFiles = new Map<FileId, true>();\n  const savedFiles = new Map<FileId, true>();\n\n  await Promise.all(\n    files.map(async ({ id, buffer }) => {\n      try {\n        await firebase\n          .storage()\n          .ref(`${prefix}/${id}`)\n          .put(\n            new Blob([buffer], {\n              type: MIME_TYPES.binary,\n            }),\n            {\n              cacheControl: `public, max-age=${FILE_CACHE_MAX_AGE_SEC}`,\n            },\n          );\n        savedFiles.set(id, true);\n      } catch (error: any) {\n        erroredFiles.set(id, true);\n      }\n    }),\n  );\n\n  return { savedFiles, erroredFiles };\n};\n\nconst createFirebaseSceneDocument = async (\n  firebase: ResolutionType<typeof loadFirestore>,\n  elements: readonly SyncableExcalidrawElement[],\n  roomKey: string,\n) => {\n  const sceneVersion = getSceneVersion(elements);\n  const { ciphertext, iv } = await encryptElements(roomKey, elements);\n  return {\n    sceneVersion,\n    ciphertext: firebase.firestore.Blob.fromUint8Array(\n      new Uint8Array(ciphertext),\n    ),\n    iv: firebase.firestore.Blob.fromUint8Array(iv),\n  } as FirebaseStoredScene;\n};\n\nexport const saveToFirebase = async (\n  portal: Portal,\n  elements: readonly SyncableExcalidrawElement[],\n  appState: AppState,\n) => {\n  const { roomId, roomKey, socket } = portal;\n  if (\n    // bail if no room exists as there's nothing we can do at this point\n    !roomId ||\n    !roomKey ||\n    !socket ||\n    isSavedToFirebase(portal, elements)\n  ) {\n    return false;\n  }\n\n  const firebase = await loadFirestore();\n  const firestore = firebase.firestore();\n\n  const docRef = firestore.collection(\"scenes\").doc(roomId);\n\n  const savedData = await firestore.runTransaction(async (transaction) => {\n    const snapshot = await transaction.get(docRef);\n\n    if (!snapshot.exists) {\n      const sceneDocument = await createFirebaseSceneDocument(\n        firebase,\n        elements,\n        roomKey,\n      );\n\n      transaction.set(docRef, sceneDocument);\n\n      return {\n        elements,\n        reconciledElements: null,\n      };\n    }\n\n    const prevDocData = snapshot.data() as FirebaseStoredScene;\n    const prevElements = getSyncableElements(\n      await decryptElements(prevDocData, roomKey),\n    );\n\n    const reconciledElements = getSyncableElements(\n      reconcileElements(elements, prevElements, appState),\n    );\n\n    const sceneDocument = await createFirebaseSceneDocument(\n      firebase,\n      reconciledElements,\n      roomKey,\n    );\n\n    transaction.update(docRef, sceneDocument);\n    return {\n      elements,\n      reconciledElements,\n    };\n  });\n\n  FirebaseSceneVersionCache.set(socket, savedData.elements);\n\n  return { reconciledElements: savedData.reconciledElements };\n};\n\nexport const loadFromFirebase = async (\n  roomId: string,\n  roomKey: string,\n  socket: SocketIOClient.Socket | null,\n): Promise<readonly ExcalidrawElement[] | null> => {\n  const firebase = await loadFirestore();\n  const db = firebase.firestore();\n\n  const docRef = db.collection(\"scenes\").doc(roomId);\n  const doc = await docRef.get();\n  if (!doc.exists) {\n    return null;\n  }\n  const storedScene = doc.data() as FirebaseStoredScene;\n  const elements = getSyncableElements(\n    await decryptElements(storedScene, roomKey),\n  );\n\n  if (socket) {\n    FirebaseSceneVersionCache.set(socket, elements);\n  }\n\n  return restoreElements(elements, null);\n};\n\nexport const loadFilesFromFirebase = async (\n  prefix: string,\n  decryptionKey: string,\n  filesIds: readonly FileId[],\n) => {\n  const loadedFiles: BinaryFileData[] = [];\n  const erroredFiles = new Map<FileId, true>();\n\n  await Promise.all(\n    [...new Set(filesIds)].map(async (id) => {\n      try {\n        const url = `https://firebasestorage.googleapis.com/v0/b/${\n          FIREBASE_CONFIG.storageBucket\n        }/o/${encodeURIComponent(prefix.replace(/^\\//, \"\"))}%2F${id}`;\n        const response = await fetch(`${url}?alt=media`);\n        if (response.status < 400) {\n          const arrayBuffer = await response.arrayBuffer();\n\n          const { data, metadata } = await decompressData<BinaryFileMetadata>(\n            new Uint8Array(arrayBuffer),\n            {\n              decryptionKey,\n            },\n          );\n\n          const dataURL = new TextDecoder().decode(data) as DataURL;\n\n          loadedFiles.push({\n            mimeType: metadata.mimeType || MIME_TYPES.binary,\n            id,\n            dataURL,\n            created: metadata?.created || Date.now(),\n            lastRetrieved: metadata?.created || Date.now(),\n          });\n        } else {\n          erroredFiles.set(id, true);\n        }\n      } catch (error: any) {\n        erroredFiles.set(id, true);\n        console.error(error);\n      }\n    }),\n  );\n\n  return { loadedFiles, erroredFiles };\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}