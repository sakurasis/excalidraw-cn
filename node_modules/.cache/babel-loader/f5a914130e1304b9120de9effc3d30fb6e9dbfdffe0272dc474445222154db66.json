{"ast":null,"code":"import _classCallCheck from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/createClass.js\";import React from\"react\";import{trackEvent}from\"../analytics\";import{jsx as _jsx}from\"react/jsx-runtime\";var trackAction=function trackAction(action,source,appState,elements,app,value){if(action.trackEvent){try{if(typeof action.trackEvent===\"object\"){var shouldTrack=action.trackEvent.predicate?action.trackEvent.predicate(appState,elements,value):true;if(shouldTrack){trackEvent(action.trackEvent.category,action.trackEvent.action||action.name,\"\".concat(source,\" (\").concat(app.device.isMobile?\"mobile\":\"desktop\",\")\"));}}}catch(error){console.error(\"error while logging action:\",error);}}};export var ActionManager=/*#__PURE__*/function(){function ActionManager(updater,getAppState,getElementsIncludingDeleted,app){var _this=this;_classCallCheck(this,ActionManager);this.actions={};this.updater=void 0;this.getAppState=void 0;this.getElementsIncludingDeleted=void 0;this.app=void 0;/**\n   * @param data additional data sent to the PanelComponent\n   */this.renderAction=function(name,data){var canvasActions=_this.app.props.UIOptions.canvasActions;if(_this.actions[name]&&\"PanelComponent\"in _this.actions[name]&&(name in canvasActions?canvasActions[name]:true)){var action=_this.actions[name];var PanelComponent=action.PanelComponent;PanelComponent.displayName=\"PanelComponent\";var elements=_this.getElementsIncludingDeleted();var appState=_this.getAppState();var updateData=function updateData(formState){trackAction(action,\"ui\",appState,elements,_this.app,formState);_this.updater(action.perform(_this.getElementsIncludingDeleted(),_this.getAppState(),formState,_this.app));};return/*#__PURE__*/_jsx(PanelComponent,{elements:_this.getElementsIncludingDeleted(),appState:_this.getAppState(),updateData:updateData,appProps:_this.app.props,app:_this.app,data:data});}return null;};this.isActionEnabled=function(action){var elements=_this.getElementsIncludingDeleted();var appState=_this.getAppState();return!action.predicate||action.predicate(elements,appState,_this.app.props,_this.app);};this.updater=function(actionResult){if(actionResult&&\"then\"in actionResult){actionResult.then(function(actionResult){return updater(actionResult);});}else{return updater(actionResult);}};this.getAppState=getAppState;this.getElementsIncludingDeleted=getElementsIncludingDeleted;this.app=app;}_createClass(ActionManager,[{key:\"registerAction\",value:function registerAction(action){this.actions[action.name]=action;}},{key:\"registerAll\",value:function registerAll(actions){var _this2=this;actions.forEach(function(action){return _this2.registerAction(action);});}},{key:\"handleKeyDown\",value:function handleKeyDown(event){var _this3=this;var canvasActions=this.app.props.UIOptions.canvasActions;var data=Object.values(this.actions).sort(function(a,b){return(b.keyPriority||0)-(a.keyPriority||0);}).filter(function(action){return(action.name in canvasActions?canvasActions[action.name]:true)&&action.keyTest&&action.keyTest(event,_this3.getAppState(),_this3.getElementsIncludingDeleted(),_this3.app);});if(data.length!==1){if(data.length>1){console.warn(\"Canceling as multiple actions match this shortcut\",data);}return false;}var action=data[0];if(this.getAppState().viewModeEnabled&&action.viewMode!==true){return false;}var elements=this.getElementsIncludingDeleted();var appState=this.getAppState();var value=null;trackAction(action,\"keyboard\",appState,elements,this.app,null);event.preventDefault();event.stopPropagation();this.updater(data[0].perform(elements,appState,value,this.app));return true;}},{key:\"executeAction\",value:function executeAction(action){var source=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"api\";var value=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var elements=this.getElementsIncludingDeleted();var appState=this.getAppState();trackAction(action,source,appState,elements,this.app,value);this.updater(action.perform(elements,appState,value,this.app));}}]);return ActionManager;}();","map":{"version":3,"names":["React","trackEvent","jsx","_jsx","trackAction","action","source","appState","elements","app","value","shouldTrack","predicate","category","name","concat","device","isMobile","error","console","ActionManager","updater","getAppState","getElementsIncludingDeleted","_this","_classCallCheck","actions","renderAction","data","canvasActions","props","UIOptions","PanelComponent","displayName","updateData","formState","perform","appProps","isActionEnabled","actionResult","then","_createClass","key","registerAction","registerAll","_this2","forEach","handleKeyDown","event","_this3","Object","values","sort","a","b","keyPriority","filter","keyTest","length","warn","viewModeEnabled","viewMode","preventDefault","stopPropagation","executeAction","arguments","undefined"],"sources":["D:/project/excalidraw-cn/src/actions/manager.tsx"],"sourcesContent":["import React from \"react\";\nimport {\n  Action,\n  UpdaterFn,\n  ActionName,\n  ActionResult,\n  PanelComponentProps,\n  ActionSource,\n} from \"./types\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppClassProperties, AppState } from \"../types\";\nimport { trackEvent } from \"../analytics\";\n\nconst trackAction = (\n  action: Action,\n  source: ActionSource,\n  appState: Readonly<AppState>,\n  elements: readonly ExcalidrawElement[],\n  app: AppClassProperties,\n  value: any,\n) => {\n  if (action.trackEvent) {\n    try {\n      if (typeof action.trackEvent === \"object\") {\n        const shouldTrack = action.trackEvent.predicate\n          ? action.trackEvent.predicate(appState, elements, value)\n          : true;\n        if (shouldTrack) {\n          trackEvent(\n            action.trackEvent.category,\n            action.trackEvent.action || action.name,\n            `${source} (${app.device.isMobile ? \"mobile\" : \"desktop\"})`,\n          );\n        }\n      }\n    } catch (error) {\n      console.error(\"error while logging action:\", error);\n    }\n  }\n};\n\nexport class ActionManager {\n  actions = {} as Record<ActionName, Action>;\n\n  updater: (actionResult: ActionResult | Promise<ActionResult>) => void;\n\n  getAppState: () => Readonly<AppState>;\n  getElementsIncludingDeleted: () => readonly ExcalidrawElement[];\n  app: AppClassProperties;\n\n  constructor(\n    updater: UpdaterFn,\n    getAppState: () => AppState,\n    getElementsIncludingDeleted: () => readonly ExcalidrawElement[],\n    app: AppClassProperties,\n  ) {\n    this.updater = (actionResult) => {\n      if (actionResult && \"then\" in actionResult) {\n        actionResult.then((actionResult) => {\n          return updater(actionResult);\n        });\n      } else {\n        return updater(actionResult);\n      }\n    };\n    this.getAppState = getAppState;\n    this.getElementsIncludingDeleted = getElementsIncludingDeleted;\n    this.app = app;\n  }\n\n  registerAction(action: Action) {\n    this.actions[action.name] = action;\n  }\n\n  registerAll(actions: readonly Action[]) {\n    actions.forEach((action) => this.registerAction(action));\n  }\n\n  handleKeyDown(event: React.KeyboardEvent | KeyboardEvent) {\n    const canvasActions = this.app.props.UIOptions.canvasActions;\n    const data = Object.values(this.actions)\n      .sort((a, b) => (b.keyPriority || 0) - (a.keyPriority || 0))\n      .filter(\n        (action) =>\n          (action.name in canvasActions\n            ? canvasActions[action.name as keyof typeof canvasActions]\n            : true) &&\n          action.keyTest &&\n          action.keyTest(\n            event,\n            this.getAppState(),\n            this.getElementsIncludingDeleted(),\n            this.app,\n          ),\n      );\n\n    if (data.length !== 1) {\n      if (data.length > 1) {\n        console.warn(\"Canceling as multiple actions match this shortcut\", data);\n      }\n      return false;\n    }\n\n    const action = data[0];\n\n    if (this.getAppState().viewModeEnabled && action.viewMode !== true) {\n      return false;\n    }\n\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n    const value = null;\n\n    trackAction(action, \"keyboard\", appState, elements, this.app, null);\n\n    event.preventDefault();\n    event.stopPropagation();\n    this.updater(data[0].perform(elements, appState, value, this.app));\n    return true;\n  }\n\n  executeAction(\n    action: Action,\n    source: ActionSource = \"api\",\n    value: any = null,\n  ) {\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n\n    trackAction(action, source, appState, elements, this.app, value);\n\n    this.updater(action.perform(elements, appState, value, this.app));\n  }\n\n  /**\n   * @param data additional data sent to the PanelComponent\n   */\n  renderAction = (name: ActionName, data?: PanelComponentProps[\"data\"]) => {\n    const canvasActions = this.app.props.UIOptions.canvasActions;\n\n    if (\n      this.actions[name] &&\n      \"PanelComponent\" in this.actions[name] &&\n      (name in canvasActions\n        ? canvasActions[name as keyof typeof canvasActions]\n        : true)\n    ) {\n      const action = this.actions[name];\n      const PanelComponent = action.PanelComponent!;\n      PanelComponent.displayName = \"PanelComponent\";\n      const elements = this.getElementsIncludingDeleted();\n      const appState = this.getAppState();\n      const updateData = (formState?: any) => {\n        trackAction(action, \"ui\", appState, elements, this.app, formState);\n\n        this.updater(\n          action.perform(\n            this.getElementsIncludingDeleted(),\n            this.getAppState(),\n            formState,\n            this.app,\n          ),\n        );\n      };\n\n      return (\n        <PanelComponent\n          elements={this.getElementsIncludingDeleted()}\n          appState={this.getAppState()}\n          updateData={updateData}\n          appProps={this.app.props}\n          app={this.app}\n          data={data}\n        />\n      );\n    }\n\n    return null;\n  };\n\n  isActionEnabled = (action: Action) => {\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n\n    return (\n      !action.predicate ||\n      action.predicate(elements, appState, this.app.props, this.app)\n    );\n  };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}