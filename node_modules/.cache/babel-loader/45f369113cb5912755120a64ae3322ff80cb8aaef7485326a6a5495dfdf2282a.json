{"ast":null,"code":"var _jsxFileName = \"D:\\\\project\\\\excalidraw-cn\\\\src\\\\actions\\\\manager.tsx\";\nimport React from \"react\";\nimport { trackEvent } from \"../analytics\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst trackAction = (action, source, appState, elements, app, value) => {\n  if (action.trackEvent) {\n    try {\n      if (typeof action.trackEvent === \"object\") {\n        const shouldTrack = action.trackEvent.predicate ? action.trackEvent.predicate(appState, elements, value) : true;\n        if (shouldTrack) {\n          trackEvent(action.trackEvent.category, action.trackEvent.action || action.name, `${source} (${app.device.isMobile ? \"mobile\" : \"desktop\"})`);\n        }\n      }\n    } catch (error) {\n      console.error(\"error while logging action:\", error);\n    }\n  }\n};\nexport class ActionManager {\n  constructor(updater, getAppState, getElementsIncludingDeleted, app) {\n    this.actions = {};\n    this.updater = void 0;\n    this.getAppState = void 0;\n    this.getElementsIncludingDeleted = void 0;\n    this.app = void 0;\n    /**\n     * @param data additional data sent to the PanelComponent\n     */\n    this.renderAction = (name, data) => {\n      const canvasActions = this.app.props.UIOptions.canvasActions;\n      if (this.actions[name] && \"PanelComponent\" in this.actions[name] && (name in canvasActions ? canvasActions[name] : true)) {\n        const action = this.actions[name];\n        const PanelComponent = action.PanelComponent;\n        PanelComponent.displayName = \"PanelComponent\";\n        const elements = this.getElementsIncludingDeleted();\n        const appState = this.getAppState();\n        const updateData = formState => {\n          trackAction(action, \"ui\", appState, elements, this.app, formState);\n          this.updater(action.perform(this.getElementsIncludingDeleted(), this.getAppState(), formState, this.app));\n        };\n        return /*#__PURE__*/_jsxDEV(PanelComponent, {\n          elements: this.getElementsIncludingDeleted(),\n          appState: this.getAppState(),\n          updateData: updateData,\n          appProps: this.app.props,\n          app: this.app,\n          data: data\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 167,\n          columnNumber: 9\n        }, this);\n      }\n      return null;\n    };\n    this.isActionEnabled = action => {\n      const elements = this.getElementsIncludingDeleted();\n      const appState = this.getAppState();\n      return !action.predicate || action.predicate(elements, appState, this.app.props, this.app);\n    };\n    this.updater = actionResult => {\n      if (actionResult && \"then\" in actionResult) {\n        actionResult.then(actionResult => {\n          return updater(actionResult);\n        });\n      } else {\n        return updater(actionResult);\n      }\n    };\n    this.getAppState = getAppState;\n    this.getElementsIncludingDeleted = getElementsIncludingDeleted;\n    this.app = app;\n  }\n  registerAction(action) {\n    this.actions[action.name] = action;\n  }\n  registerAll(actions) {\n    actions.forEach(action => this.registerAction(action));\n  }\n  handleKeyDown(event) {\n    const canvasActions = this.app.props.UIOptions.canvasActions;\n    const data = Object.values(this.actions).sort((a, b) => (b.keyPriority || 0) - (a.keyPriority || 0)).filter(action => (action.name in canvasActions ? canvasActions[action.name] : true) && action.keyTest && action.keyTest(event, this.getAppState(), this.getElementsIncludingDeleted(), this.app));\n    if (data.length !== 1) {\n      if (data.length > 1) {\n        console.warn(\"Canceling as multiple actions match this shortcut\", data);\n      }\n      return false;\n    }\n    const action = data[0];\n    if (this.getAppState().viewModeEnabled && action.viewMode !== true) {\n      return false;\n    }\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n    const value = null;\n    trackAction(action, \"keyboard\", appState, elements, this.app, null);\n    event.preventDefault();\n    event.stopPropagation();\n    this.updater(data[0].perform(elements, appState, value, this.app));\n    return true;\n  }\n  executeAction(action) {\n    let source = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : \"api\";\n    let value = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : null;\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n    trackAction(action, source, appState, elements, this.app, value);\n    this.updater(action.perform(elements, appState, value, this.app));\n  }\n}","map":{"version":3,"names":["React","trackEvent","jsxDEV","_jsxDEV","trackAction","action","source","appState","elements","app","value","shouldTrack","predicate","category","name","device","isMobile","error","console","ActionManager","constructor","updater","getAppState","getElementsIncludingDeleted","actions","renderAction","data","canvasActions","props","UIOptions","PanelComponent","displayName","updateData","formState","perform","appProps","fileName","_jsxFileName","lineNumber","columnNumber","isActionEnabled","actionResult","then","registerAction","registerAll","forEach","handleKeyDown","event","Object","values","sort","a","b","keyPriority","filter","keyTest","length","warn","viewModeEnabled","viewMode","preventDefault","stopPropagation","executeAction","arguments","undefined"],"sources":["D:/project/excalidraw-cn/src/actions/manager.tsx"],"sourcesContent":["import React from \"react\";\nimport {\n  Action,\n  UpdaterFn,\n  ActionName,\n  ActionResult,\n  PanelComponentProps,\n  ActionSource,\n} from \"./types\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppClassProperties, AppState } from \"../types\";\nimport { trackEvent } from \"../analytics\";\n\nconst trackAction = (\n  action: Action,\n  source: ActionSource,\n  appState: Readonly<AppState>,\n  elements: readonly ExcalidrawElement[],\n  app: AppClassProperties,\n  value: any,\n) => {\n  if (action.trackEvent) {\n    try {\n      if (typeof action.trackEvent === \"object\") {\n        const shouldTrack = action.trackEvent.predicate\n          ? action.trackEvent.predicate(appState, elements, value)\n          : true;\n        if (shouldTrack) {\n          trackEvent(\n            action.trackEvent.category,\n            action.trackEvent.action || action.name,\n            `${source} (${app.device.isMobile ? \"mobile\" : \"desktop\"})`,\n          );\n        }\n      }\n    } catch (error) {\n      console.error(\"error while logging action:\", error);\n    }\n  }\n};\n\nexport class ActionManager {\n  actions = {} as Record<ActionName, Action>;\n\n  updater: (actionResult: ActionResult | Promise<ActionResult>) => void;\n\n  getAppState: () => Readonly<AppState>;\n  getElementsIncludingDeleted: () => readonly ExcalidrawElement[];\n  app: AppClassProperties;\n\n  constructor(\n    updater: UpdaterFn,\n    getAppState: () => AppState,\n    getElementsIncludingDeleted: () => readonly ExcalidrawElement[],\n    app: AppClassProperties,\n  ) {\n    this.updater = (actionResult) => {\n      if (actionResult && \"then\" in actionResult) {\n        actionResult.then((actionResult) => {\n          return updater(actionResult);\n        });\n      } else {\n        return updater(actionResult);\n      }\n    };\n    this.getAppState = getAppState;\n    this.getElementsIncludingDeleted = getElementsIncludingDeleted;\n    this.app = app;\n  }\n\n  registerAction(action: Action) {\n    this.actions[action.name] = action;\n  }\n\n  registerAll(actions: readonly Action[]) {\n    actions.forEach((action) => this.registerAction(action));\n  }\n\n  handleKeyDown(event: React.KeyboardEvent | KeyboardEvent) {\n    const canvasActions = this.app.props.UIOptions.canvasActions;\n    const data = Object.values(this.actions)\n      .sort((a, b) => (b.keyPriority || 0) - (a.keyPriority || 0))\n      .filter(\n        (action) =>\n          (action.name in canvasActions\n            ? canvasActions[action.name as keyof typeof canvasActions]\n            : true) &&\n          action.keyTest &&\n          action.keyTest(\n            event,\n            this.getAppState(),\n            this.getElementsIncludingDeleted(),\n            this.app,\n          ),\n      );\n\n    if (data.length !== 1) {\n      if (data.length > 1) {\n        console.warn(\"Canceling as multiple actions match this shortcut\", data);\n      }\n      return false;\n    }\n\n    const action = data[0];\n\n    if (this.getAppState().viewModeEnabled && action.viewMode !== true) {\n      return false;\n    }\n\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n    const value = null;\n\n    trackAction(action, \"keyboard\", appState, elements, this.app, null);\n\n    event.preventDefault();\n    event.stopPropagation();\n    this.updater(data[0].perform(elements, appState, value, this.app));\n    return true;\n  }\n\n  executeAction(\n    action: Action,\n    source: ActionSource = \"api\",\n    value: any = null,\n  ) {\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n\n    trackAction(action, source, appState, elements, this.app, value);\n\n    this.updater(action.perform(elements, appState, value, this.app));\n  }\n\n  /**\n   * @param data additional data sent to the PanelComponent\n   */\n  renderAction = (name: ActionName, data?: PanelComponentProps[\"data\"]) => {\n    const canvasActions = this.app.props.UIOptions.canvasActions;\n\n    if (\n      this.actions[name] &&\n      \"PanelComponent\" in this.actions[name] &&\n      (name in canvasActions\n        ? canvasActions[name as keyof typeof canvasActions]\n        : true)\n    ) {\n      const action = this.actions[name];\n      const PanelComponent = action.PanelComponent!;\n      PanelComponent.displayName = \"PanelComponent\";\n      const elements = this.getElementsIncludingDeleted();\n      const appState = this.getAppState();\n      const updateData = (formState?: any) => {\n        trackAction(action, \"ui\", appState, elements, this.app, formState);\n\n        this.updater(\n          action.perform(\n            this.getElementsIncludingDeleted(),\n            this.getAppState(),\n            formState,\n            this.app,\n          ),\n        );\n      };\n\n      return (\n        <PanelComponent\n          elements={this.getElementsIncludingDeleted()}\n          appState={this.getAppState()}\n          updateData={updateData}\n          appProps={this.app.props}\n          app={this.app}\n          data={data}\n        />\n      );\n    }\n\n    return null;\n  };\n\n  isActionEnabled = (action: Action) => {\n    const elements = this.getElementsIncludingDeleted();\n    const appState = this.getAppState();\n\n    return (\n      !action.predicate ||\n      action.predicate(elements, appState, this.app.props, this.app)\n    );\n  };\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}