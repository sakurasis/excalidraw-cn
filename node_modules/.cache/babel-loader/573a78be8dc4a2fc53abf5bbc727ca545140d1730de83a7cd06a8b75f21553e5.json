{"ast":null,"code":"import _objectSpread from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{UndoIcon,RedoIcon}from\"../components/icons\";import{ToolButton}from\"../components/ToolButton\";import{t}from\"../i18n\";import{KEYS}from\"../keys\";import{newElementWith}from\"../element/mutateElement\";import{fixBindingsAfterDeletion}from\"../element/binding\";import{arrayToMap}from\"../utils\";import{isWindows}from\"../constants\";import{jsx as _jsx}from\"react/jsx-runtime\";var writeData=function writeData(prevElements,appState,updater){var commitToHistory=false;if(!appState.multiElement&&!appState.resizingElement&&!appState.editingElement&&!appState.draggingElement){var data=updater();if(data===null){return{commitToHistory:commitToHistory};}var prevElementMap=arrayToMap(prevElements);var nextElements=data.elements;var nextElementMap=arrayToMap(nextElements);var deletedElements=prevElements.filter(function(prevElement){return!nextElementMap.has(prevElement.id);});var elements=nextElements.map(function(nextElement){return newElementWith(prevElementMap.get(nextElement.id)||nextElement,nextElement);}).concat(deletedElements.map(function(prevElement){return newElementWith(prevElement,{isDeleted:true});}));fixBindingsAfterDeletion(elements,deletedElements);return{elements:elements,appState:_objectSpread(_objectSpread({},appState),data.appState),commitToHistory:commitToHistory,syncHistory:true};}return{commitToHistory:commitToHistory};};export var createUndoAction=function createUndoAction(history){return{name:\"undo\",trackEvent:{category:\"history\"},perform:function perform(elements,appState){return writeData(elements,appState,function(){return history.undoOnce();});},keyTest:function keyTest(event){return event[KEYS.CTRL_OR_CMD]&&event.key.toLowerCase()===KEYS.Z&&!event.shiftKey;},PanelComponent:function PanelComponent(_ref){var updateData=_ref.updateData,data=_ref.data;return/*#__PURE__*/_jsx(ToolButton,{type:\"button\",icon:UndoIcon,\"aria-label\":t(\"buttons.undo\"),onClick:updateData,size:(data===null||data===void 0?void 0:data.size)||\"medium\"});},commitToHistory:function commitToHistory(){return false;}};};export var createRedoAction=function createRedoAction(history){return{name:\"redo\",trackEvent:{category:\"history\"},perform:function perform(elements,appState){return writeData(elements,appState,function(){return history.redoOnce();});},keyTest:function keyTest(event){return event[KEYS.CTRL_OR_CMD]&&event.shiftKey&&event.key.toLowerCase()===KEYS.Z||isWindows&&event.ctrlKey&&!event.shiftKey&&event.key===KEYS.Y;},PanelComponent:function PanelComponent(_ref2){var updateData=_ref2.updateData,data=_ref2.data;return/*#__PURE__*/_jsx(ToolButton,{type:\"button\",icon:RedoIcon,\"aria-label\":t(\"buttons.redo\"),onClick:updateData,size:(data===null||data===void 0?void 0:data.size)||\"medium\"});},commitToHistory:function commitToHistory(){return false;}};};","map":{"version":3,"names":["UndoIcon","RedoIcon","ToolButton","t","KEYS","newElementWith","fixBindingsAfterDeletion","arrayToMap","isWindows","jsx","_jsx","writeData","prevElements","appState","updater","commitToHistory","multiElement","resizingElement","editingElement","draggingElement","data","prevElementMap","nextElements","elements","nextElementMap","deletedElements","filter","prevElement","has","id","map","nextElement","get","concat","isDeleted","_objectSpread","syncHistory","createUndoAction","history","name","trackEvent","category","perform","undoOnce","keyTest","event","CTRL_OR_CMD","key","toLowerCase","Z","shiftKey","PanelComponent","_ref","updateData","type","icon","onClick","size","createRedoAction","redoOnce","ctrlKey","Y","_ref2"],"sources":["D:/project/excalidraw-cn/src/actions/actionHistory.tsx"],"sourcesContent":["import { Action, ActionResult } from \"./types\";\nimport { UndoIcon, RedoIcon } from \"../components/icons\";\nimport { ToolButton } from \"../components/ToolButton\";\nimport { t } from \"../i18n\";\nimport History, { HistoryEntry } from \"../history\";\nimport { ExcalidrawElement } from \"../element/types\";\nimport { AppState } from \"../types\";\nimport { KEYS } from \"../keys\";\nimport { newElementWith } from \"../element/mutateElement\";\nimport { fixBindingsAfterDeletion } from \"../element/binding\";\nimport { arrayToMap } from \"../utils\";\nimport { isWindows } from \"../constants\";\n\nconst writeData = (\n  prevElements: readonly ExcalidrawElement[],\n  appState: AppState,\n  updater: () => HistoryEntry | null,\n): ActionResult => {\n  const commitToHistory = false;\n  if (\n    !appState.multiElement &&\n    !appState.resizingElement &&\n    !appState.editingElement &&\n    !appState.draggingElement\n  ) {\n    const data = updater();\n    if (data === null) {\n      return { commitToHistory };\n    }\n\n    const prevElementMap = arrayToMap(prevElements);\n    const nextElements = data.elements;\n    const nextElementMap = arrayToMap(nextElements);\n\n    const deletedElements = prevElements.filter(\n      (prevElement) => !nextElementMap.has(prevElement.id),\n    );\n    const elements = nextElements\n      .map((nextElement) =>\n        newElementWith(\n          prevElementMap.get(nextElement.id) || nextElement,\n          nextElement,\n        ),\n      )\n      .concat(\n        deletedElements.map((prevElement) =>\n          newElementWith(prevElement, { isDeleted: true }),\n        ),\n      );\n    fixBindingsAfterDeletion(elements, deletedElements);\n\n    return {\n      elements,\n      appState: { ...appState, ...data.appState },\n      commitToHistory,\n      syncHistory: true,\n    };\n  }\n  return { commitToHistory };\n};\n\ntype ActionCreator = (history: History) => Action;\n\nexport const createUndoAction: ActionCreator = (history) => ({\n  name: \"undo\",\n  trackEvent: { category: \"history\" },\n  perform: (elements, appState) =>\n    writeData(elements, appState, () => history.undoOnce()),\n  keyTest: (event) =>\n    event[KEYS.CTRL_OR_CMD] &&\n    event.key.toLowerCase() === KEYS.Z &&\n    !event.shiftKey,\n  PanelComponent: ({ updateData, data }) => (\n    <ToolButton\n      type=\"button\"\n      icon={UndoIcon}\n      aria-label={t(\"buttons.undo\")}\n      onClick={updateData}\n      size={data?.size || \"medium\"}\n    />\n  ),\n  commitToHistory: () => false,\n});\n\nexport const createRedoAction: ActionCreator = (history) => ({\n  name: \"redo\",\n  trackEvent: { category: \"history\" },\n  perform: (elements, appState) =>\n    writeData(elements, appState, () => history.redoOnce()),\n  keyTest: (event) =>\n    (event[KEYS.CTRL_OR_CMD] &&\n      event.shiftKey &&\n      event.key.toLowerCase() === KEYS.Z) ||\n    (isWindows && event.ctrlKey && !event.shiftKey && event.key === KEYS.Y),\n  PanelComponent: ({ updateData, data }) => (\n    <ToolButton\n      type=\"button\"\n      icon={RedoIcon}\n      aria-label={t(\"buttons.redo\")}\n      onClick={updateData}\n      size={data?.size || \"medium\"}\n    />\n  ),\n  commitToHistory: () => false,\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}