{"ast":null,"code":"import _slicedToArray from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/project/excalidraw-cn/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import{atom,useAtom}from\"jotai\";import{useEffect,useState}from\"react\";import{COLOR_PALETTE}from\"../colors\";import{jotaiScope}from\"../jotai\";import{exportToSvg}from\"../packages/utils\";export var libraryItemSvgsCache=atom(new Map());var exportLibraryItemToSvg=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(elements){return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:_context.next=2;return exportToSvg({elements:elements,appState:{exportBackground:false,viewBackgroundColor:COLOR_PALETTE.white},files:null});case 2:return _context.abrupt(\"return\",_context.sent);case 3:case\"end\":return _context.stop();}},_callee);}));return function exportLibraryItemToSvg(_x){return _ref.apply(this,arguments);};}();export var useLibraryItemSvg=function useLibraryItemSvg(id,elements,svgCache){var _useState=useState(),_useState2=_slicedToArray(_useState,2),svg=_useState2[0],setSvg=_useState2[1];useEffect(function(){if(elements){if(id){// Try to load cached svg\nvar cachedSvg=svgCache.get(id);if(cachedSvg){setSvg(cachedSvg);}else{// When there is no svg in cache export it and save to cache\n_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){var _exportedSvg$querySel;var exportedSvg;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:_context2.next=2;return exportLibraryItemToSvg(elements);case 2:exportedSvg=_context2.sent;(_exportedSvg$querySel=exportedSvg.querySelector(\".style-fonts\"))===null||_exportedSvg$querySel===void 0?void 0:_exportedSvg$querySel.remove();if(exportedSvg){svgCache.set(id,exportedSvg);setSvg(exportedSvg);}case 5:case\"end\":return _context2.stop();}},_callee2);}))();}}else{// When we have no id (usualy selected items from canvas) just export the svg\n_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var exportedSvg;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:_context3.next=2;return exportLibraryItemToSvg(elements);case 2:exportedSvg=_context3.sent;setSvg(exportedSvg);case 4:case\"end\":return _context3.stop();}},_callee3);}))();}}},[id,elements,svgCache,setSvg]);return svg;};export var useLibraryCache=function useLibraryCache(){var _useAtom=useAtom(libraryItemSvgsCache,jotaiScope),_useAtom2=_slicedToArray(_useAtom,1),svgCache=_useAtom2[0];var clearLibraryCache=function clearLibraryCache(){return svgCache.clear();};var deleteItemsFromLibraryCache=function deleteItemsFromLibraryCache(items){items.forEach(function(item){return svgCache.delete(item);});};return{clearLibraryCache:clearLibraryCache,deleteItemsFromLibraryCache:deleteItemsFromLibraryCache,svgCache:svgCache};};","map":{"version":3,"names":["atom","useAtom","useEffect","useState","COLOR_PALETTE","jotaiScope","exportToSvg","libraryItemSvgsCache","Map","exportLibraryItemToSvg","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","elements","wrap","_callee$","_context","prev","next","appState","exportBackground","viewBackgroundColor","white","files","abrupt","sent","stop","_x","apply","arguments","useLibraryItemSvg","id","svgCache","_useState","_useState2","_slicedToArray","svg","setSvg","cachedSvg","get","_callee2","_exportedSvg$querySel","exportedSvg","_callee2$","_context2","querySelector","remove","set","_callee3","_callee3$","_context3","useLibraryCache","_useAtom","_useAtom2","clearLibraryCache","clear","deleteItemsFromLibraryCache","items","forEach","item","delete"],"sources":["D:/project/excalidraw-cn/src/hooks/useLibraryItemSvg.ts"],"sourcesContent":["import { atom, useAtom } from \"jotai\";\nimport { useEffect, useState } from \"react\";\nimport { COLOR_PALETTE } from \"../colors\";\nimport { jotaiScope } from \"../jotai\";\nimport { exportToSvg } from \"../packages/utils\";\nimport { LibraryItem } from \"../types\";\n\nexport type SvgCache = Map<LibraryItem[\"id\"], SVGSVGElement>;\n\nexport const libraryItemSvgsCache = atom<SvgCache>(new Map());\n\nconst exportLibraryItemToSvg = async (elements: LibraryItem[\"elements\"]) => {\n  return await exportToSvg({\n    elements,\n    appState: {\n      exportBackground: false,\n      viewBackgroundColor: COLOR_PALETTE.white,\n    },\n    files: null,\n  });\n};\n\nexport const useLibraryItemSvg = (\n  id: LibraryItem[\"id\"] | null,\n  elements: LibraryItem[\"elements\"] | undefined,\n  svgCache: SvgCache,\n): SVGSVGElement | undefined => {\n  const [svg, setSvg] = useState<SVGSVGElement>();\n\n  useEffect(() => {\n    if (elements) {\n      if (id) {\n        // Try to load cached svg\n        const cachedSvg = svgCache.get(id);\n\n        if (cachedSvg) {\n          setSvg(cachedSvg);\n        } else {\n          // When there is no svg in cache export it and save to cache\n          (async () => {\n            const exportedSvg = await exportLibraryItemToSvg(elements);\n            exportedSvg.querySelector(\".style-fonts\")?.remove();\n\n            if (exportedSvg) {\n              svgCache.set(id, exportedSvg);\n              setSvg(exportedSvg);\n            }\n          })();\n        }\n      } else {\n        // When we have no id (usualy selected items from canvas) just export the svg\n        (async () => {\n          const exportedSvg = await exportLibraryItemToSvg(elements);\n          setSvg(exportedSvg);\n        })();\n      }\n    }\n  }, [id, elements, svgCache, setSvg]);\n\n  return svg;\n};\n\nexport const useLibraryCache = () => {\n  const [svgCache] = useAtom(libraryItemSvgsCache, jotaiScope);\n\n  const clearLibraryCache = () => svgCache.clear();\n\n  const deleteItemsFromLibraryCache = (items: LibraryItem[\"id\"][]) => {\n    items.forEach((item) => svgCache.delete(item));\n  };\n\n  return {\n    clearLibraryCache,\n    deleteItemsFromLibraryCache,\n    svgCache,\n  };\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}